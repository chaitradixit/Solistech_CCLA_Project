  
  /* ADDED ACCOUNT CODE COLS TO VIEW*/
  CREATE OR REPLACE FORCE VIEW "UCMADMIN"."CCLA_INTERACTIONS_EXT" ("INTERACTION_ID", "USER_ID", "JOB_ID", "INTERACTION_DATE", "ORGANISATION_ID", "PERSON_ID", "CONFIRM_TYPES", "CONFIRM_OTHER", "INTERACTION_TYPE", "SUBJECT", "CATEGORY", "IS_QUERY", "IS_COMPLAINT", "IS_BREACH", "IS_ERROR", "CAMPAIGN_ID", "OUTCOME", "INTERACTION_STATUS", "ASSIGNEE", "DEADLINE", "LAST_UPDATED", "NAME", "FULL_NAME", "TITLE", "FIRST_NAME", "SECOND_NAME", "ORG_ACCOUNT_CODE", "PERSON_ACCOUNT_CODE")
AS
  SELECT I."INTERACTION_ID",
    I."USER_ID",
    I."JOB_ID",
    I."INTERACTION_DATE",
    I."ORGANISATION_ID",
    I."PERSON_ID",
    I."CONFIRM_TYPES",
    I."CONFIRM_OTHER",
    I."INTERACTION_TYPE",
    S."SUBJECT",
    C."CATEGORY",
    I."IS_QUERY",
    I."IS_COMPLAINT",
    I."IS_BREACH",
    I."IS_ERROR",
    I."CAMPAIGN_ID",
    IO."OUTCOME",
    I."INTERACTION_STATUS",
    I."ASSIGNEE",
    I."DEADLINE",
    I."LAST_UPDATED",
    O.ORGANISATION_NAME,
    P.FULL_NAME,
    T.TITLE,
    P.FIRST_NAME,
    P.SECOND_NAME,
    O.ORG_ACCOUNT_CODE,
    P.PERSON_ACCOUNT_CODE
  FROM CCLA_INTERACTION I
  LEFT JOIN ORGANISATION O
  ON (I.ORGANISATION_ID = O.ORGANISATION_ID)
  LEFT JOIN PERSON P
  ON (I.PERSON_ID = P.PERSON_ID)
  LEFT JOIN CCLA_INTERACTION_CATEGORY C
  ON (I.CATEGORY_ID = C.INTERACTION_CATEGORY_ID)
  LEFT JOIN CCLA_INTERACTION_SUBJECT S
  ON (I.SUBJECT_ID = S.INTERACTION_SUBJECT_ID)
  LEFT JOIN REF_TITLE T
  ON (P.TITLE_ID = T.TITLE_ID)
  LEFT JOIN CCLA_INTERACTION_OUTCOME IO
  ON (I.OUTCOME_ID = IO.OUTCOME_ID);
 
 
/* New column in PERSON table. Run in CCLA tablespace */

ALTER TABLE "PERSON" ADD ("SOURCE_ID" NUMBER(6,0));
ALTER TABLE "PERSON" ADD CONSTRAINT "PERSON_SOURCE_FK" FOREIGN KEY ("SOURCE_ID") REFERENCES "REF_ORG_SOURCE" ("ORG_SOURCE_ID");

/* new INTERACTION OUTCOME TABLES*/
CREATE TABLE "CCLA_INTERACTION_OUTCOME"
(
	"OUTCOME_ID"	NUMBER(15,0) NOT NULL,
	"OUTCOME"			VARCHAR2(50 CHAR) NOT NULL,
	
	CONSTRAINT "OUTCOME_PK" PRIMARY KEY ("OUTCOME_ID") ENABLE
);
CREATE TABLE "CCLA_INTERACTION_OUTCOME_TYPE"
(
	"OUTCOME_TYPE_ID"	NUMBER(15,0) NOT NULL,
  "OUTCOME_ID"	NUMBER(15,0) NOT NULL,
	"OUTCOME_TYPE"			VARCHAR2(50 CHAR) NOT NULL,
	
	CONSTRAINT "CCLA_OUTCOME_TYPE_PK" PRIMARY KEY ("OUTCOME_TYPE_ID") ENABLE,
  CONSTRAINT	"CCLA_OUTCOME_TYPE_FK"			FOREIGN KEY ("OUTCOME_ID") REFERENCES "CCLA_INTERACTION_OUTCOME" ("OUTCOME_ID") ENABLE
);

/*  ALTER CCLA_INTERACTIONS TO ADD OUTCOME_ID AND OUTCOME_TYPE_ID */
alter table CCLA_INTERACTION add OUTCOME_ID NUMBER(15,0);

alter table
   CCLA_INTERACTION
add constraint
   CCLA_INTERACTION_OUTCOME_FK FOREIGN KEY (OUTCOME_ID)
references
   CCLA_INTERACTION_OUTCOME (OUTCOME_ID) ENABLE;
   
 alter table CCLA_INTERACTION add OUTCOME_TYPE_ID NUMBER(15,0);
 
 alter table CCLA_INTERACTION add OUTCOME_TEXT VARCHAR2(500 CHAR);
 
  alter table CCLA_INTERACTION add CLOSED_BY NUMBER(15,0);
 
alter table
   CCLA_INTERACTION
add constraint
   CCLA_INTER_OUTCOME_TYPE_FK FOREIGN KEY (OUTCOME_TYPE_ID)
references
   CCLA_INTERACTION_OUTCOME_TYPE (OUTCOME_TYPE_ID) ENABLE;

CREATE SEQUENCE "UCMADMIN"."SEQ_INTERACTION_OUTCOME_ID" MINVALUE 1 MAXVALUE 999999999999999999999999999 INCREMENT BY 1 START WITH 392 CACHE 20 NOORDER NOCYCLE ;

CREATE SEQUENCE "UCMADMIN"."SEQ_INTER_OUTCOME_TYPE_ID" MINVALUE 1 MAXVALUE 999999999999999999999999999 INCREMENT BY 1 START WITH 392 CACHE 20 NOORDER NOCYCLE ;

/*OUTCOME VALUES*/
REM INSERTING into CCLA_INTERACTION_OUTCOME
Insert into CCLA_INTERACTION_OUTCOME (OUTCOME_ID,OUTCOME) values (1,'Completed');
Insert into CCLA_INTERACTION_OUTCOME (OUTCOME_ID,OUTCOME) values (2,'Waiting on correspondent callback');
Insert into CCLA_INTERACTION_OUTCOME (OUTCOME_ID,OUTCOME) values (3,'Correspondent callback required');
Insert into CCLA_INTERACTION_OUTCOME (OUTCOME_ID,OUTCOME) values (4,'Further action required');
Insert into CCLA_INTERACTION_OUTCOME (OUTCOME_ID,OUTCOME) values (5,'Disconnected');

/* UPDATE EXISTING INTERACTIONS TO SET OUTCOME_ID*/
update CCLA_INTERACTION set OUTCOME_ID=1,OUTCOME=NULL WHERE UPPER(OUTCOME) like '%COMPLETED%';
update CCLA_INTERACTION set OUTCOME_ID=2, OUTCOME=NULL WHERE UPPER(OUTCOME) like '%WAITING ON CORRESPONDENT CALLBACK%'
update CCLA_INTERACTION set OUTCOME_ID=3, OUTCOME=NULL WHERE UPPER(OUTCOME) like '%CORRESPONDENT CALLBACK REQUIRED%';
update CCLA_INTERACTION set OUTCOME_ID=4,OUTCOME=NULL WHERE UPPER(OUTCOME) like '%FURTHER ACTION REQUIRED%';
update CCLA_INTERACTION set OUTCOME_ID=5,OUTCOME=NULL WHERE UPPER(OUTCOME) like '%DISCONNECTED%';

/* run select to ensure there are no rows with outcome data left*/
SELECT COUNT(*) FROM CCLA_INTERACTION WHERE OUTCOME IS NOT NULL;

/* DROP OUTCOME COLUMN (ONLY RUN IF PREVIOUS SELECT RETURNED 0) */
alter table CCLA_INTERACTION DROP COLUMN OUTCOME;

/* remove annoying full stop!*/
update ref_org_identifiers set identifier_name = 'ONS No' where org_identifier_id=2;

/* Add new Org-Person relation: Guidestar correspondent */
/*
REM INSERTING into REF_RELATION_NAMES
Insert into REF_RELATION_NAMES (RELATION_NAME_ID,ELEMENT_RELATION_TYPE_ID,RELATION,SHORT_NAME,IS_SINGLETON) values (9,1,'Guidestar Correspondent','G.Corr',1);
*/

/* SEQUENCE FOR GROUP_ID FOR CCLA_INTERACTION_GROUP TABLE */
CREATE SEQUENCE "UCMADMIN"."SEQ_INTERACTION_GROUP_ID" MINVALUE 1 MAXVALUE 999999999999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER NOCYCLE ;

/* ADD NEW CCLA_INTERACTION_GROUP TABLE */
CREATE TABLE "CCLA_INTERACTION_GROUP"
(
	"GROUP_ID" 			NUMBER(15,0) NOT NULL,
	"INTERACTION_ID" 	NUMBER(15,0) NOT NULL,
    "USER_ID"        	VARCHAR2(48 CHAR),
	"LAST_UPDATED" 		TIMESTAMP (6),

	CONSTRAINT "INTERACTION_ID_FK" FOREIGN KEY ("INTERACTION_ID") REFERENCES "CCLA_INTERACTION" ("INTERACTION_ID") ENABLE
);
