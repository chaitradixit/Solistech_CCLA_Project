/* New view which displays full account info, along with the name/ID numbers of the owning client. */

CREATE OR REPLACE FORCE VIEW "UCMADMIN"."ACCOUNT_EXTENDED_CLIENT" ("ACCOUNT_ID", "ACC_ACCOUNT_CODE", "MANDATED_ACCOUNT_ID", "INCOME_DISTRIBUTION_METHOD", "FUND_CODE", "ACCOUNT_STATUS_ID", "AURORA_ACCOUNT", "ACCOUNTNUMBER", "ACCNUMEXT", "SUBTITLE", "DATE_OPENED", "SHARE_CLASS", "REQ_SIGNATURES", "IS_EXCLUSIVE", "AML_CHECK_OVERRIDE_USER", "LAST_UPDATED", "ACCOUNT_STATUS_NAME", "SHORT_NAME", "IDM_NAME", "ACC_CASH", "ACC_UNITS", "DATE_LAST_REFRESH", "ORGANISATION_ID", "ORG_ACCOUNT_CODE", "ORGANISATION_NAME", "CLIENT_NUMBER")
AS
SELECT acc."ACCOUNT_ID",
    acc."ACC_ACCOUNT_CODE",
    acc."MANDATED_ACCOUNT_ID",
    acc."INCOME_DISTRIBUTION_METHOD",
    acc."FUND_CODE",
    acc."ACCOUNT_STATUS_ID",
    acc."AURORA_ACCOUNT",
    acc."ACCOUNTNUMBER",
    acc."ACCNUMEXT",
    acc."SUBTITLE",
    acc."DATE_OPENED",
    acc."SHARE_CLASS",
    acc."REQ_SIGNATURES",
    acc."IS_EXCLUSIVE",
    acc."AML_CHECK_OVERRIDE_USER",
    acc."LAST_UPDATED",
    accStatus.ACCOUNT_STATUS_NAME,
    accStatus.SHORT_NAME,
    incDistMethod.IDM_NAME,
    accValue.ACC_CASH,
    accValue.ACC_UNITS,
    accValue.DATE_LAST_REFRESH,
    org.ORGANISATION_ID,
    org.ORG_ACCOUNT_CODE,
    org.ORGANISATION_NAME,
    cli.CLIENT_NUMBER
  FROM ACCOUNT acc
  INNER JOIN REF_ACCOUNT_STATUS accStatus
  ON (acc.ACCOUNT_STATUS_ID = accStatus.ACCOUNT_STATUS_ID)
  INNER JOIN REF_INCOME_DIST_METHOD incDistMethod
  ON (acc.INCOME_DISTRIBUTION_METHOD = incDistMethod.IDM_CODE)
  LEFT JOIN ACCOUNT_VALUE accValue
  ON (acc.ACCOUNT_ID = accValue.ACCOUNT_ID)
  INNER JOIN RELATIONS rel ON (acc.ACCOUNT_ID = rel.ELEMENT_ID2 AND rel.RELATION_NAME_ID = 20)
  INNER JOIN ORGANISATION org ON (org.ORGANISATION_ID = rel.ELEMENT_ID1)
  INNER JOIN CLIENT_AURORA_MAP cli ON (org.ORGANISATION_ID = cli.ORGANISATION_ID)
  ORDER BY org.ORGANISATION_ID, acc.fund_code, acc.accountnumber;
  
  /* correct typo*/
  UPDATE REF_TITLE SET TITLE = 'Wing Commander' where title_id=36;
  
  /* ADDED ACCOUNT CODE COLS TO VIEW*/
  CREATE OR REPLACE FORCE VIEW "UCMADMIN"."CCLA_INTERACTIONS_EXT" ("INTERACTION_ID", "USER_ID", "JOB_ID", "INTERACTION_DATE", "ORGANISATION_ID", "PERSON_ID", "CONFIRM_TYPES", "CONFIRM_OTHER", "INTERACTION_TYPE", "SUBJECT", "CATEGORY", "IS_QUERY", "IS_COMPLAINT", "IS_BREACH", "IS_ERROR", "CAMPAIGN_ID", "OUTCOME", "INTERACTION_STATUS", "ASSIGNEE", "DEADLINE", "LAST_UPDATED", "NAME", "FULL_NAME", "TITLE", "FIRST_NAME", "SECOND_NAME", "ORG_ACCOUNT_CODE", "PERSON_ACCOUNT_CODE")
AS
  SELECT I."INTERACTION_ID",
    I."USER_ID",
    I."JOB_ID",
    I."INTERACTION_DATE",
    I."ORGANISATION_ID",
    I."PERSON_ID",
    I."CONFIRM_TYPES",
    I."CONFIRM_OTHER",
    I."INTERACTION_TYPE",
    S."SUBJECT",
    C."CATEGORY",
    I."IS_QUERY",
    I."IS_COMPLAINT",
    I."IS_BREACH",
    I."IS_ERROR",
    I."CAMPAIGN_ID",
    I."OUTCOME",
    I."INTERACTION_STATUS",
    I."ASSIGNEE",
    I."DEADLINE",
    I."LAST_UPDATED",
    O.ORGANISATION_NAME,
    P.FULL_NAME,
    T.TITLE,
    P.FIRST_NAME,
    P.SECOND_NAME,
    O.ORG_ACCOUNT_CODE,
    P.PERSON_ACCOUNT_CODE
  FROM CCLA_INTERACTION I
  LEFT JOIN ORGANISATION O
  ON (I.ORGANISATION_ID = O.ORGANISATION_ID)
  LEFT JOIN PERSON P
  ON (I.PERSON_ID = P.PERSON_ID)
  LEFT JOIN CCLA_INTERACTION_CATEGORY C
  ON (I.CATEGORY_ID = C.INTERACTION_CATEGORY_ID)
  LEFT JOIN CCLA_INTERACTION_SUBJECT S
  ON (I.SUBJECT_ID = S.INTERACTION_SUBJECT_ID)
  LEFT JOIN REF_TITLE T
  ON (P.TITLE_ID = T.TITLE_ID);
 