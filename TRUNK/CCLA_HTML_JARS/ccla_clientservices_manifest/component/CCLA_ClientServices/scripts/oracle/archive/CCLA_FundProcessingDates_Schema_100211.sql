/*
Created: 01/11/2010
Modified: 03/02/2011
Model: RE Oracle 11g Release 1
Version: 2.7
Database: Oracle 11g Release 1
*/

-- Create tables section -------------------------------------------------

-- Table SYSTEM_CONFIG

CREATE TABLE SYSTEM_CONFIG(
  SYSTEM_CONFIG_NAME Varchar2(30 ) NOT NULL,
  SYSTEM_CONFIG_SETTING Varchar2(50 ),
  SYSTEM_CONFIG_DESCRIPTION Varchar2(200 )
)
/

-- Add keys for table SYSTEM_CONFIG

ALTER TABLE SYSTEM_CONFIG ADD CONSTRAINT SYSTEMCONFIG_PK PRIMARY KEY (SYSTEM_CONFIG_NAME)
/

-- Table and Columns comments section
  
COMMENT ON TABLE SYSTEM_CONFIG IS 'Used to store any system wide settings or configuration (e.g. Transaction Processing Rollback Date)'
/

-- Table FUND_DEALING_DATES

CREATE TABLE FUND_DEALING_DATES(
  DEALING_DATE_ID Number(15,0) NOT NULL,
  FUND_CODE Varchar2(2 CHAR) NOT NULL,
  DEALING_DATE Date NOT NULL
)
/

-- Add keys for table FUND_DEALING_DATES

ALTER TABLE FUND_DEALING_DATES ADD CONSTRAINT FUNDDEALINGDATES_PK PRIMARY KEY (DEALING_DATE_ID)
/

-- Table FUND_PROCESS_DETAILS

CREATE TABLE FUND_PROCESS_DETAILS(
  PROCESS_DETAILS Number(15,0) NOT NULL,
  FUND_CODE Varchar2(2 CHAR) NOT NULL,
  ROLLOVER_TIME Char(5 ),
  OVERRIDE_DATE Date,
  PROCESS_DETAILS_DESCRIPTION Varchar2(200 )
)
/

-- Add keys for table FUND_PROCESS_DETAILS

ALTER TABLE FUND_PROCESS_DETAILS ADD CONSTRAINT FUNDPROCESSDETAILS_PK PRIMARY KEY (PROCESS_DETAILS)
/

-- Table and Columns comments section
  
COMMENT ON COLUMN FUND_PROCESS_DETAILS.ROLLOVER_TIME IS 'The cutoff time that transactions for this fund will rollover to the next processing day. Format hh24:mi'
/
COMMENT ON COLUMN FUND_PROCESS_DETAILS.OVERRIDE_DATE IS 'Date and time of any override processing date. If this columns is populated, then any transactions for this fund will have a process date of the date that is set here. Otherwise they get the appropriate next processing date for the transaction/fund, as defined in the FUND_DEALING_DATE table.'
/

-- Create relationships section ------------------------------------------------- 

CREATE INDEX IX_FUND_FUNDDEALINGDATES_FK ON FUND_DEALING_DATES (FUND_CODE) 
/
ALTER TABLE FUND_DEALING_DATES ADD CONSTRAINT FUND_FUNDDEALINGDATES_FK FOREIGN KEY (FUND_CODE) REFERENCES FUND (FUND_CODE)
/

CREATE INDEX IX_FUND_FUNDPROCESSDETAILS_FK ON FUND_PROCESS_DETAILS (FUND_CODE) 
/
ALTER TABLE FUND_PROCESS_DETAILS ADD CONSTRAINT FUND_FUNDPROCESSDETAILS_FK FOREIGN KEY (FUND_CODE) REFERENCES FUND (FUND_CODE)
/

/* Synonyms */
CREATE OR REPLACE PUBLIC SYNONYM FUND_PROCESS_DETAILS FOR CCLA.FUND_PROCESS_DETAILS;
CREATE OR REPLACE PUBLIC SYNONYM FUND_DEALING_DATES FOR CCLA.FUND_DEALING_DATES;
CREATE OR REPLACE PUBLIC SYNONYM SYSTEM_CONFIG FOR CCLA.SYSTEM_CONFIG;

/* Grant Access */
GRANT ALL ON FUND_PROCESS_DETAILS TO UCMADMIN;
GRANT ALL ON FUND_DEALING_DATES TO UCMADMIN;
GRANT ALL ON SYSTEM_CONFIG TO UCMADMIN;

/* Sequences */
CREATE SEQUENCE  SEQ_FUND_PROCESS_DETAILS MINVALUE 1 MAXVALUE 999 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER NOCYCLE;

/* Insert Data to Tables */
INSERT INTO FUND_DEALING_DATES (SELECT * FROM CCLA_FUND_DEALING_DATES);

INSERT INTO FUND_PROCESS_DETAILS (
SELECT 
  SEQ_FUND_PROCESS_DETAILS.NEXTVAL,
  F.FUND_CODE, 
  (CASE F.FUND_TYPECODE_ID  
    WHEN 1 THEN '11:30'
    WHEN 2 THEN '09:35'
    ELSE '11:30'
  END) AS ROLLOVER_TIME,
  NULL AS OVERRIDE_DATE,
  F.DISPLAYNAME AS PROCESS_DETAILS_DESCRIPTION
FROM FUND F
INNER JOIN REF_FUND_TYPECODE FT ON (F.FUND_TYPECODE_ID = FT.FUND_TYPECODE_ID)
);

INSERT INTO SYSTEM_CONFIG (SYSTEM_CONFIG_NAME, SYSTEM_CONFIG_SETTING, SYSTEM_CONFIG_DESCRIPTION)
VALUES ('PSDFTime','11:30','PSDF Processing Time');

INSERT INTO SYSTEM_CONFIG (SYSTEM_CONFIG_NAME, SYSTEM_CONFIG_SETTING, SYSTEM_CONFIG_DESCRIPTION)
VALUES ('DepositTime','09:35','Deposit Funds Processing Time');

INSERT INTO SYSTEM_CONFIG (SYSTEM_CONFIG_NAME, SYSTEM_CONFIG_SETTING, SYSTEM_CONFIG_DESCRIPTION)
VALUES ('UnitisedTime','11:30','Unitised Fund Processing Time');

INSERT INTO SYSTEM_CONFIG (SYSTEM_CONFIG_NAME, SYSTEM_CONFIG_SETTING, SYSTEM_CONFIG_DESCRIPTION)
VALUES ('OverrideDate',null,'Override date, Allows User to specify a constant datetime [DD/MM/YYYY HH:MM] to process against. Press Clear to revert to current datetime');

INSERT INTO SYSTEM_CONFIG (SYSTEM_CONFIG_NAME, SYSTEM_CONFIG_SETTING, SYSTEM_CONFIG_DESCRIPTION)
VALUES ('RolloverTime','09:30','Rollover time for base processing date. After this time has been reached, the base processing date will roll-over to the next day.');

