/* Modifies the BANK_ACCOUNT.ACCOUNT_NO and SORT_CODE columns to
   be CHAR datatypes, instead of numeric. */

-- Create new temp table to store padded account nos/sort codes
CREATE TABLE BANK_ACCOUNT_TEMP (
  BANK_ACCOUNT_ID NUMBER(15,0),
  ACCOUNT_NO_PADDED CHAR(8),
  SORT_CODE_PADDED CHAR(6)
);

-- Fill up temp table with padded data
INSERT INTO BANK_ACCOUNT_TEMP
SELECT BANK_ACCOUNT_ID, LPAD(ACCOUNT_NO, 8, '0'),  LPAD(SORT_CODE, 6, '0')
FROM BANK_ACCOUNT;

CREATE TABLE BANK_ACCOUNT_BAK AS
SELECT * FROM BANK_ACCOUNT;

-- Disable NN constraints
ALTER TABLE BANK_ACCOUNT DISABLE CONSTRAINT ACCOUNTNO_NN;
ALTER TABLE BANK_ACCOUNT DISABLE CONSTRAINT SORTCODE_NN;

--Nullify original columns
UPDATE BANK_ACCOUNT SET ACCOUNT_NO = NULL, SORT_CODE = NULL;

--Modify data types of original columns
ALTER TABLE BANK_ACCOUNT MODIFY (
  ACCOUNT_NO CHAR(8),
  SORT_CODE CHAR(6)
);

--Set new column values
UPDATE BANK_ACCOUNT SET (ACCOUNT_NO, SORT_CODE) = 
(SELECT ACCOUNT_NO_PADDED, SORT_CODE_PADDED FROM BANK_ACCOUNT_TEMP tmp 
WHERE tmp.BANK_ACCOUNT_ID = BANK_ACCOUNT.BANK_ACCOUNT_ID);

-- Add RegExp constraints to enforce decimal format
ALTER TABLE BANK_ACCOUNT  ADD CONSTRAINT ACCOUNTNO_CHK CHECK (REGEXP_LIKE(ACCOUNT_NO, '^\d{8}$'));
ALTER TABLE BANK_ACCOUNT  ADD CONSTRAINT SORTCODE_CHK CHECK (REGEXP_LIKE(SORT_CODE, '^\d{6}$'));

-- Re-enable NN constraints
ALTER TABLE BANK_ACCOUNT ENABLE CONSTRAINT ACCOUNTNO_NN;
ALTER TABLE BANK_ACCOUNT ENABLE CONSTRAINT SORTCODE_NN;

-- Drop temp table
DROP TABLE BANK_ACCOUNT_TEMP;