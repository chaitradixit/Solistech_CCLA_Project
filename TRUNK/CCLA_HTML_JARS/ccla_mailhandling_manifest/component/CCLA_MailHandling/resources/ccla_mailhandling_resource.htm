<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>
CCLA_MailHandling htmlIncludeOrString
</title>
</head>
<body>
	
<!-- Title for Document Listing page. -->
<@dynamichtml iris_doc_listing_title@>Scanned Envelopes<@end@>

<!-- Adds a link to Iris in the Content Management drop-down menu (standard UCM) -->
<@dynamichtml custom_finish_layout_init@>

	navBuilder.addChildNodeTo('CONTENT_MANAGEMENT','item','id==iris','url==<$HttpCgiPath$>?IdcService=DOC_LISTING<$include add_idc_token_to_url$>','label==IRIS')

	<$include super.custom_finish_layout_init$>
  	
<@end@>

<@dynamichtml iris_header@>

	<$cacheInclude("ccla_documentClasses_cache", "application", 1800)$> 
	
	<$isIris=1$>
	<$if not userAccessResolved$>
		<$include iris_resolve_user_access$>
	<$endif$>
	
	<$include ccla_common_js$>
	
	<!-- Script and CSS required to support pop-up menus -->
	<$include float_menu_header$>
        <script>
                function irisLogin() {
					var frm = document.forms['irisLogin'];
					<$if #active.IdcService$>
							frm.submit();
					<$else$>
							window.location.href=window.location.href+"idcplg?IdcService=LOGIN";
					<$endif$>
                }
        </script>

	<!-- Container div for all Iris header elements -->
	<div id="irisheader" class="header-small">

		<table cellpadding=0 cellspacing=0 border=0 width='100%'>

			<tr height='35'>
				<td width='259'>

					<!-- Left-floated div displaying logo graphic -->
					<a href="?IdcService=CCLA_CS_HOME<$include add_idc_token_to_url$>" title="CCLA - Home">
					<div class="logo-small"></div>
					</a>
					
				</td>
				<td>
					
					<!-- Special include only relevant on dev/UAT systems. Displays text i.e. 'Dev Server', 'UAT Server'
						 to clearly indicate which server you're on! -->
					<$include ccla_cs_environment_header$>
	
					<!-- This div contains a Search button and input field, plus a 'logged-in' message -->
					
					<div style="position: absolute; right: 4px; height: 30px; top: 2px">

						<table width='500' align=left cellpadding=1>
							<tr>
								<td align=right>
										<$if IsLoggedIn$>
												<span style="font-size: 1em; z-index: 90">Logged in as <b><$UserName$></b>&nbsp;<$if #active.idcToken$><a target="_top" href="/ucm/logout.htm">[Logout]</a><$endif$></span>
										<$else$>

												<form name='irisLogin' method="post">
														<input type="hidden" name="IdcService" value="LOGIN">
														<$include add_idc_token_to_form$>
														<input type="hidden" name="RedirectUrl">

														You are not logged in.&nbsp;
																<a class=pneHeader href="javascript:irisLogin()">Login</a>
												</form>

										<$endif$>
								</td>

								<$if IsLoggedIn$>
									<td align=right>
										<$include iris_header_quicksearch$>
									</td>
								<$endif$>
							</tr>

						</table>

					</div>


						<$if Iris_companyLogo$>
							<$inc(Iris_companyLogo)$>
						<$else$>
							<!-- Display default ECS logo -->

							<!--[if lte IE 6]>
								<span style="position: absolute; right: 5px; width=195px; height=78px ; top: -5px;display:inline-block;filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src='<$HttpWebRoot$>images/iris/ECS_logo.png');">
									<div style="position: absolute; right: 5px; width: 195px; height: 78px ; filter:progid:DXImageTransform.Microsoft.Alpha(opacity=0);top: -5px; background-image: url(<$HttpWebRoot$>images/iris/ECS_logo.png);">
								</span>
							<![endif]-->

							

						<$endif$>



				</td>
			</tr>
		</table>

	</div>
	
	<$include ccla_menubar$>
	<$if false$>
	<$cacheInclude("ccla_menubar", "session", 3600)$>
	<$endif$>
<@end@>

<!-- Overridden hook include to include generic validation JavaScript -->
<@dynamichtml doc_approval_extra@>
	<$include super.doc_approval_extra$>
	
	<$include ccla_indexing_js$>
	<$include ccla_field_validation_js$>
	<$include ccla_doc_panel_validation_extra_js$>
<@end@>

<!-- Extra Javascript that is used to validate fields in the DOC_APPROVAL page. 
	 
	 TODO: move into ccla_indexing.js
	 
	 -->
<@dynamichtml ccla_doc_panel_validation_extra_js@>
<$if #active.IsDebug$>ccla_doc_panel_validation_extra_js<$endif$>

<script type="text/javascript">

	var lastPanelLoadTime; 

	function performPanelValidationExtra() {
			//general variables
			var dID 		= $('#doc_fields [name=dID]').val();
			
			//Used for process date checks
			var fundCode 	= $('#doc_fields [name=xFund]').val();
			var docClass	= $('#doc_fields [name=xDocumentClass]').val();
			var userProcessDate = $('#doc_fields [name=xProcessDate]').val();
			var source = $('#doc_fields [name=xSource]').val();

			
			//Used for nominated Bank Details check
			var bankAccNum = "", sortCode = "";
			
			if ($('#doc_fields [name=xBankAccountNumber]').size() > 0) {
				bankAccNum 	= $('#doc_fields [name=xBankAccountNumber]').val();
				sortCode	= $('#doc_fields [name=xSortCode]').val();
			}
			
			lastPanelLoadTime = new Date().getTime();
			
			var formId = "";
			
			if ($('#doc_fields [name=xFormId]').size() > 0)
				formId		= $('#doc_fields [name=xFormId]').val();
			
			var currentDate = new Date().getTime();
			if (currentDate - lastPanelLoadTime < 500) {

				if(docClass || bankAccNum) {
					$.getJSON("?IdcService=CCLA_PANEL_VALIDATION_EXTRA<$include add_idc_token_to_url$>", 
						{ 	
							"dID":				dID,
							"docClass":			docClass,
							"fundCode":			fundCode,
							"userProcessDate":	userProcessDate,
							"source":			source,
							"FORM_ID":			formId,
							
							//bank account fields
							"bankAccNum":		bankAccNum,
							"sortCode":			sortCode,
							"TYPE_OF_ACCOUNT":	"WITHDRAWAL",
							"timeStamp": 		currentDate,
							
							"ts":				new Date().getTime(),
							"IsJson": 1
						}, function(jsonData) {
							// as users can click around quickly before the service response 
							// has returned. We need to check if the document currently being 
							// viewed is the one the request was originally sent to verify.

							var currentDiD = $('#doc_fields [name=dID]').val();
							if (jsonData.LocalData.dID == currentDiD){
								updatePanelFromValidationExtra(jsonData);
							}
						});
						
					setNominatedContactPointOptionListLoading();
				}
					
				
			}
		}
		
		// Add all the custom post ajax service call methods here
		function updatePanelFromValidationExtra(jsonData){
			
			var jsonErrorMsg  = getJsonErrorMsg(jsonData);
			if(jsonErrorMsg){
				$("#statusText").html("<div id='err_saveError' class='validation_error error_icon'>" +
				 "<div class='validation_error_title'>Error validating data</div><p>"+jsonErrorMsg+"</p></div>");
			} else {
				colorProcessDateField(jsonData);
				colorBankFields(jsonData);
				
				// Check response data for rsForm ResultSet, derived from the
				// indexed xFormId value. If the ResultSet is present, extract
				// the SUBSCRIPTION_ID and display the 'View subscription' link.
				if (jsonData.ResultSets.rsForm) {
					var subscriptionId = getJsonResultSetValue
					 (jsonData.ResultSets.rsForm, "SUBSCRIPTION_ID");
					
					var formId = getJsonResultSetValue
					 (jsonData.ResultSets.rsForm, "FORM_ID");
					
					returnedFormId = formId;
					
					if (subscriptionId)
						displayEditSubscriptionLink(subscriptionId); 
					
					/*					
					var isValid = getJsonResultSetValue
					 (jsonData.ResultSets.rsForm, "IS_VALID");
					 
					displayFormValidityCheckbox(isValid);
					*/
					
				}
			}
			
			populateNominatedContactPointOptionList(jsonData);
		}
		
		// Clears then adds a special 'Loading...' option to xNominatedContactPoint field.	
		// The current value is set here in case the user quickly saves the item before 
		// the options are loaded in.
		function setNominatedContactPointOptionListLoading() {
			// Clear and hide the corr. name link.
			$("#nominatedCorrespondentLink").css("display","none").html("");

			// Remove any existing contact lookup error message
			$("#doc_fields select[name='xNominatedContactPoint']").removeClass("validation_error_field");
			$("#docFieldError_xNominatedContactPoint").remove();
		
			// Disable and empty out the select list
			$("#xNominatedContactPoint").attr("disabled", "disabled").empty();
			
			// Add single loading option
			$("#xNominatedContactPoint").append
			 ("<option value='" + $("#selectedContactPointId").val() + "'>Loading...</option>");
		}
		
		// Nominated Contact Point option list population.
		//
		// Should be called on metadata panel load, account lookup and document class update.
		//
		// The passed jsonData object is expected to contain an rsContactPoints ResultSet - 
		// this is used to populate the option list, otherwise it will be blanked out.
		function populateNominatedContactPointOptionList(jsonData) {
			
			// First set the Correspondent link text/href. This is displayed below the option list.
			var corrId, corrName, contactFetchError;
			
			if (jsonData.LocalData) {
				corrId   = jsonData.LocalData.AccountCorrespondentId;
				corrName = jsonData.LocalData.AccountCorrespondentName;
				
				if (corrId && corrName) {
					$("#nominatedCorrespondentLink").html(corrName);
					
					// Set href and display the link.
					$("#nominatedCorrespondentLink").attr
					 ("href", "?IdcService=CCLA_CS_PERSON_EDIT&PERSON_ID=" + corrId)
					 .css("display","");
				}
				
				// Check for an error message.
				contactFetchError   = jsonData.LocalData.CONTACT_POINT_FETCH_ERROR;
			}

			if (contactFetchError)
				displayFieldErrorMsg("xNominatedContactPoint","Error",contactFetchError);
			
			if (jsonData && jsonData.ResultSets.rsContactPoints) {
				// Insert all fetched address Contact Points to the xNominatedContactPoint option list
				var selectedContactPointId = $("#selectedContactPointId").val();
					
				// Build up the <option> elements here before appending them all at once at the end.
				var optionsHtml = "<option></option>";
				
				var rsContactPoints = jsonData.ResultSets.rsContactPoints;
				var foundAddressContact = false;
				
				for (var i=0; i<rsContactPoints.rows.length; i++) {
					var addressId = getJsonResultSetValue(rsContactPoints, "ADDRESS_ID", i);
					
					if (addressId) {
						foundAddressContact = true;
					
						// Found a postal address Contact Point. Add an option to the list.
						var contactPointId = getJsonResultSetValue(rsContactPoints, "CONTACT_ID", i);
						
						// The address string contains the House Name or Number/Street, Post Code and 
						// sub-method name in brackets
						var houseName = getJsonResultSetValue(rsContactPoints, "HOUSENAME", i);
						var houseNumber = getJsonResultSetValue(rsContactPoints, "HOUSENUMBER", i);
						var street = getJsonResultSetValue(rsContactPoints, "STREET", i);
						var postCode = getJsonResultSetValue(rsContactPoints, "POSTCODE", i);
						var typeLabel = getJsonResultSetValue(rsContactPoints, "TYPE_LABEL", i);
						
						var addressStr = "";
						
						// Add either house name or number/street
						if (houseName) {
							addressStr = houseName;
						} else if (street) {
							if (houseNumber)
								addressStr = houseNumber + " " + street;
							else
								addressStr = street;
						}
						
						// Append post code
						if (addressStr) addressStr += ", ";
						addressStr += postCode;
						
						// Append type label (e.g. 'Home address')
						addressStr += " (" + typeLabel + ")";
						
						// Determine whether this is the selected option
						var isSelected = (contactPointId == selectedContactPointId);
						var selectedStr = isSelected ? "selected" : "";
						
						// Build the option element
						optionsHtml += 	"<option value='" + contactPointId + "' " 
										+ selectedStr + ">" + addressStr + "</option>";
					}
					
					// Clear current list content.
					$("#xNominatedContactPoint").empty();
					
					// Append all the option elements and enable the option list.
					$("#xNominatedContactPoint").append(optionsHtml).removeAttr("disabled");
				}
				
				if (!foundAddressContact) {
					// Contact Points returned, but no address ones!
					
					// Clear current list content.
					$("#xNominatedContactPoint").empty();
					
					// Add special Not Applicable option
					$("#xNominatedContactPoint").append
					 ("<option value=''>N/A</option>");
					 
					// Display an error message.
					displayFieldErrorMsg("xNominatedContactPoint","Error","Correspondent has no addresses set");
				}
				
			} else {
				// No Contact Points to display!
				
				// Clear current list content.
				$("#xNominatedContactPoint").empty();
					
				// Add special Not Applicable option
				$("#xNominatedContactPoint").append
				 ("<option value=''>N/A</option>");
			}
		}
	
		//Function that colors the process date field depending on the flag in the json
		function colorProcessDateField(jsonData){
		
			if (!jsonData.LocalData.processDateComparision){
				return false;
			}
		
			//If there wasn't a user entered process date, populate field with system calculated process date and mark green
			//Otherwise check if the date entered was before/same or after the system calculated process date
			var processOutcome = jsonData.LocalData.processDateComparision;

			$('#doc_fields  [name=xProcessDate]').removeClass("validation_error_field").removeClass("validation_warning_field").removeClass("validated_field");

			if(processOutcome==0){
				$('#doc_fields [name=xProcessDate]').addClass("validation_error_field");
			} else if (processOutcome ==1){
				$('#doc_fields [name=xProcessDate]').addClass("validated_field");
			} else if (processOutcome == 2){
				$('#doc_fields [name=xProcessDate]').addClass("validation_warning_field");
			}
		}
	
	
		var colorBankFields = function(jsonData){
	
			$('[name=xBankAccountNumber]')
										.removeClass("validation_error_field")
										.removeClass("validation_warning_field")
										.removeClass("validated_field");
										
			$('[name=xSortCode]')
										.removeClass("validation_error_field")
										.removeClass("validation_warning_field")
										.removeClass("validated_field");
		
			if (jsonData.LocalData.ENOUGH_DETAILS_FOR_CHECK){
		
				if (jsonData.LocalData.NON_EXISTENT_BANK_ACCOUNT == 1 
					|| jsonData.LocalData.NON_RELATED_BANK_ACCOUNT == 1){
					$('[name=xBankAccountNumber]').addClass("validation_error_field");
					$('[name=xSortCode]').addClass("validation_error_field");
				}
		
				if (jsonData.LocalData.IS_NOMINATED_BANK_ACCOUNT == 1){
					$('[name=xBankAccountNumber]').addClass("validated_field");
					$('[name=xSortCode]').addClass("validated_field");
				}

				if (jsonData.LocalData.IS_RELATED_BANK_ACCOUNT == 1){
					$('[name=xBankAccountNumber]').addClass("validation_warning_field");
					$('[name=xSortCode]').addClass("validation_warning_field");
				}	
			} 
		}

</script>
<@end@>

<!-- 	Overriden from iriscore_resource. Appends any search
		filter parameters from the DOC_LISTING screen, these
		can then be preserved on a redirect back to the listing
		page.
		
		Searches for presence of additional url parameters
		in the Binder. If any exist, they are appended to
		a string called urlparams.
			-->
<@dynamichtml iris_get_url_params@>

	<$include super.iris_get_url_params$>
	
	<$include ccla_get_sf_url_params$>
	<$urlparams = #local.urlparams & #local.sfparamstring$>
	
<@end@>

<!--	Builds a list of URL attributes which captures the state of
		the DOC_LISTING page -->
<@dynamichtml ccla_get_sf_url_params@>

	<$exec rsMakeFromString("sfParams",CCLA_SF_params,"param")$>
	<$sfparamstring = ""$>
	
	<$loop sfParams$>
		<$thisValue = getValue("#local",#active.param)$>
		
		<$if thisValue$>
			<$sfparamstring = sfparamstring & "&" & #active.param & "=" & thisValue$>
		<$endif$>
	<$endloop$>

<@end@>

<@dynamichtml doc_approval_resolve_js_vars@>

	<$include super.doc_approval_resolve_js_vars$>
		
	<script type="text/javascript">
		<$if bundleRef$>
			approveService = "CCLA_WF_APPROVE";
		<$endif$>
	</script>

<@end@>

<!-- Panel display on doc approval screen. Overriden from core resource
	   to display item lock panel -->
<@dynamichtml iris_doc_panel_display@>

	<$if not thumbnailMode$>
		<$include iris_item_lock_panel$>
		
		<!-- Container for replaceable content -->
		<div id="doc_meta_panel_container">
			<!-- Editable fields for this content item -->
			<$include doc_approval_fields$>
		</div> 

		<!-- Display workflow info panel -->
		<$include doc_approval_wf$>
	<$else$>

		<$if batchEditMode like 'parent'$>
			
			<!-- Container for replaceable content -->
			<div id="doc_meta_panel_container">
				<$include doc_approval_fields$>
			</div>
	
			<$if not isInfo$>
				<!-- Used to dispatch work notifications -->
				<$include doc_notification_panel$>
	
				<$if dWfStepName like 'Assigned'$>
					<!-- Used to generate documents -->
					<$include doc_generation_panel$>
				<$endif$>
			<$endif$>
	
			<!-- Display routing panel -->
			<$include doc_approval_routing$>

		<$else$>
		
			<!-- rename DOC_INFO so the bundle item info isn't displayed. -->
			<$if batchEditMode like 'document'$>
				<$exec rsRename("DOC_INFO","BUNDLE_DOC_INFO")$>
			<$endif$>
			
			<!-- Use dynamic content panel to display
			     batch item data -->
			<$include bundle_item_details_panel$>

			<!-- restore DOC_INFO bundle item data -->
			<$if batchEditMode like 'document'$>
				<$exec rsRename("BUNDLE_DOC_INFO","DOC_INFO")$>
			<$endif$>
			
			<!-- Display workflow info panel -->
			<$include doc_approval_wf$>
			
			<!-- Info about signature approval panel -->
			<$if (#env.CCLA_SC_ShowSignaturePanels == 1)$>
				<div id="applet"></div>
				<$include ccla_sc_sig_init_applet$>
				<$include ccla_sc_sig_approval_panel$>
			<$endif$>
			
			<!-- Info about the parent bundle item -->
			<$include bundle_details_panel$>
			
			
		<$endif$>

	<$endif$>

<@end@>

[[%Use greyPanel_top for a slimmer newer look%]]
<@dynamichtml greyPanel_top_old@>

	<table cellpadding=0 cellspacing=0 border=0 width='100%' name="greyPanel" style="width: 100%">

		<tr height='11'>
			<td width='11' style="background: url(<$HttpWebRoot$>images/iris/greypanel-tlc.gif); width: 11px; height: 11px;">
			</td>
			<td bgcolor="#DDDADA" style="height: 3px;">
			</td>
			<td width='12' style="background: url(<$HttpWebRoot$>images/iris/greypanel-trc.gif); width: 12px; height: 11px;">
			</td>
		</tr>

		<tr>

			<td style="background: url(<$HttpWebRoot$>images/iris/greypanel-ls.gif) repeat-y; width: 11px;">
			</td>

			<td bgcolor="#DDDADA">

<@end@>

<@dynamichtml greyPanel_top@>

	<table cellpadding=0 cellspacing=0 border=0 width='100%' name="greyPanel" style="width: 100%">

		<tr height='6'>
			<td width='6' style="background: url(<$HttpWebRoot$>images/iris/greypanel-tlc_small.gif) no-repeat; width: 6px; height: 6px;">
			</td>
			<td bgcolor="#DDDADA" style="height: 3px;">
			</td>
			<td width='7' style="background: url(<$HttpWebRoot$>images/iris/greypanel-trc_small.gif) no-repeat; width: 7px; height: 6px;">
			</td>
		</tr>

		<tr>

			<td style="background: url(<$HttpWebRoot$>images/iris/greypanel-ls.gif) repeat-y; width: 6px;">
			</td>

			<td bgcolor="#DDDADA">

<@end@>

[[%Now with improved width/height corners!%]]
<@dynamichtml greyPanel_bottom@>

		</td>
			<td style="background: url(<$HttpWebRoot$>images/iris/greypanel-rs.gif) repeat-y; width: 7px;">
			</td>
		</tr>

		<tr height='5'>
			<td width='6' style="background: url(<$HttpWebRoot$>images/iris/greypanel-blc.gif); width: 6px; height: 5px;">
			</td>
			<td style="background: url(<$HttpWebRoot$>images/iris/greypanel-bs.gif) repeat-x; height: 5px;">
			</td>
			<td width='7' style="background: url(<$HttpWebRoot$>images/iris/greypanel-brc.gif); width: 7px; height: 5px;">
			</td>
		</tr>

	</table>
	<div class="inter_panel_spacer"></div>
<@end@>


<!-- Panel display on doc approval screen. Overriden from core resource
	   to display item lock panel -->
<@dynamichtml iris_doc_panel_display_OLD@>

	<$if not thumbnailMode$>
		<$include iris_item_lock_panel$>
		
		<!-- Container for replaceable content -->
		<div id="doc_meta_panel_container">
			<!-- Editable fields for this content item -->
			<$include doc_approval_fields$>
		</div> 

		<!-- Display workflow info panel -->
		<$include doc_approval_wf$>
	<$else$>

		<$if batchEditMode like 'parent'$>
			
			<!-- Container for replaceable content -->
			<div id="doc_meta_panel_container">
				<$include doc_approval_fields$>
			</div>
	
			<$if not isInfo$>
				<!-- Used to dispatch work notifications -->
				<$include doc_notification_panel$>
	
				<$if dWfStepName like 'Assigned'$>
					<!-- Used to generate documents -->
					<$include doc_generation_panel$>
				<$endif$>
			<$endif$>
	
			<!-- Display routing panel -->
			<$include doc_approval_routing$>

		<$else$>
		
			<$include bundle_autofetch_panel$>
			
			<!-- Info about the parent bundle item -->
			<$include bundle_details_panel$>
			
			<!-- rename DOC_INFO so the bundle item info isn't displayed. -->
			<$if batchEditMode like 'document'$>
				<$exec rsRename("DOC_INFO","BUNDLE_DOC_INFO")$>
			<$endif$>
			
			<!-- Use dynamic content panel to display
			     batch item data -->
			<$include bundle_item_details_panel$>

			<!-- restore DOC_INFO bundle item data -->
			<$if batchEditMode like 'document'$>
				<$exec rsRename("BUNDLE_DOC_INFO","DOC_INFO")$>
			<$endif$>
			
			<!-- Display workflow info panel -->
			<$include doc_approval_wf$>
			
		<$endif$>

	<$endif$>

<@end@>


<!-- Sets the sort images used for S&F column headers -->
<@dynamichtml iris_sf_sort_images@>

	<$customSortImage_up=""$>
	<$customSortImage_down=""$>	
	<$customSortImage_off=""$>
		
	<$customSortImage_up 		= HttpImagesRoot & "ccla/asc.gif"$>
	<$customSortImage_down	= HttpImagesRoot & "ccla/desc.gif"$>
	<$customSortImage_off		= HttpImagesRoot & "ccla/asc_dis.gif"$>
		
<@end@>

<!-- Document listing configuration. Overrides default include. -->
<@dynamichtml iris_doc_listing_pre@>
		
	<$if #env.Iris_enableBatchLocking$>
		<$executeService("IRIS_GET_ITEM_LOCKS")$>
	<$endif$>
	
	<$include iris_sf_sort_images$>
	
	<$tp="Bundle"$>
			
  	<$calendarSelectFields="DATE,DATE_ADV"$>
	<$include epoch_calendar_header$>

	<$overrideResultsLink_DEFAULT="<$HttpCgiPath & '?IdcService=DOC_APPROVAL' & inc('add_idc_token_to_url') & '&dDocName=' & dDocName$>"$>
	<$suppressSortLinks = "CHECKBOX,ACTIONS"$>

	<$advSearchFieldList="REF,SENDER,CCLA_BUNDLE_STATUS,DATE_ADV"$>
	<$moreAdvSearchFieldList=""$>

  	<$nodeSearchQuery = "(dDocType <matches> `Bundle`)"$>
  	<$nodeFilterFieldWidth="1,1,35,20,16,16,16"$>
	  <$nodeFilterFieldNames="CHECKBOX,REF,CCLA_BUNDLE_DATE,SENDER,CCLA_BUNDLE_STATUS,PRIORITY"$>

	 	<$CHECKBOX_CustomIncludeScript="CHECKBOX_CustomIncludeScript"$>

		<$SF_REF_caption="Envelope ID"$>
	 	<$REF_CustomIncludeScript="REF_CustomIncludeScript"$>
	 	<$SF_REF_idcname=#env.Iris_batchIdField$>
	 	<$SF_REF_search="matches"$>
	 	
	 	<$SF_MAILTYPE_type="custom"$>
	 	<$SF_MAILTYPE_idcname="dDocType"$>
	 	<$MAILTYPE_CustomIncludeScript="MAILTYPE_CCLA_CustomInclude"$>
	 	<$MAILTYPE_CustomFilterScript="MAILTYPE_CCLA_CustomFilterScript"$>
		<$SF_SENDER_caption="Scanned by"$>
		<$SENDER_CustomIncludeScript="SENDER_CCLA_CustomInclude"$>
		<$SF_SENDER_idcname="xScanUser"$>
		<$SF_SENDER_search="matches"$>
		
		<$SF_DATE_caption="Date added"$>
		<$SF_DATE_ADV_caption="Date added"$>
	
		<$SF_PRIORITY_type="input"$>
		<$SF_PRIORITY_search="matches"$>
		<$PRIORITY_CustomIncludeScript="PRIORITY_CustomIncludeScript"$>
			
		<!-- Determine now whether or not current user can adjust priority level. -->
		<$if userHasRole("WF_COO") or userHasRole("WF_Scanning Manager") or userHasRole("admin")$>
			<$userCanUpdatePriorites=1$>
		<$endif$>
			
		<$CCLA_BUNDLE_DATE_CustomIncludeScript="CCLA_DATE_CustomIncludeScript"$>

	 	<!-- Bundle status config -->
	  <$CCLA_BUNDLE_STATUS_CustomIncludeScript="CCLA_STATUS_CustomIncludeScript"$>
	  <$CCLA_BUNDLE_STATUS_CustomFilterScript="CCLA_BUNDLE_STATUS_CustomFilterScript"$>

	  <$SF_APPROVER_caption="Assigned to"$>
	  <$SF_APPROVER_type="custom"$>
	  <$APPROVER_CustomIncludeScript="APPROVER_batch_CustomIncludeScript"$>
	  <$APPROVER_CustomFilterScript="APPROVER_batch_CustomFilterScript"$>

	  <$ACTIONS_CustomIncludeScript="DocActions_CustomIncludeScript"$>

		<$hideInfoLink="N"$>
	  <$displaySearchButton="N"$>

		<$displayPagingOptions="N"$>
		<$displayPaginator="Y"$>
		<$SF_CustomPaginator="iris_sf_paginator"$>

	  <$inlineHeaderInclude = "ccla_doc_listing_inline_header"$>
	  <$customIncludeResultsHeader = "group_action_controls"$>

	  <$advSearchBackgroundColour="#FFFFFF"$>
	  <$advSearchDisplay_pre='orangeContainer_top'$>
	  <$advSearchDisplay_after='orangeContainer_bottom'$>

	  <!-- Misc search customizations -->
	  <$PARAMETERSLIST=PARAMETERSLIST & ",showCompleted,showDeleted"$>
	  <$QueryFieldList="REF,QUICKDATE,CCLA_BUNDLE_DATE,SENDER,DATE_ADV,DUEDATE_ADV,AUTHOR,IRIS_STATUS,APPROVER,TITLE,DOCTYPE,PRIORITY"$>

	  <$DISPLAYTHUMBNAILS=1$>
	  <$THUMBNAILWIDTH=30$>
	  <$THUMBNAILHEIGHT=30$>

	  <$nodeSortField="dInDate"$>
  	<$nodeSortOrder="DESC"$>

	  <!-- Verity search -->

	<$if #local.st like 'Completed'$>
		<$showCompleted=1$>
	<$endif$>
	
	<$if #local.st like 'Deleted'$>
		<$showDeleted=1$>
	<$endif$>

	  <$if not #active.showCompleted$>
	  	<$nodeSearchQuery = nodeSearchQuery & " <and> <not> (xStatus <matches> `Completed`) "$>
	  <$endif$>
	  
	  <$if not #active.showDeleted$>
		<$nodeSearchQuery = nodeSearchQuery & " <and> <not> (xStatus <matches> `Deleted`) "$>
	  <$endif$>
	
	<script type="text/javascript">
		
		// Attach onblur event to every single priority value input field, 
		// if applicable.
		$(document).ready( function() {
			$(".priority-input").bind("blur", function() {
				updatePriority(this);
			});
			
		});
		
		function updatePriority(input) {
			// Fetch the ID and value.
			var fieldId 	= input.id;
			var newValue	= input.value;
			
			var oldValue 	= $("#" + fieldId + "_current").val();
			
			if (newValue != oldValue) {
				// User updated this priority value - update via
				// AJAX.
				
				var bundleDocName = fieldId.substring(9);
				
				$.getJSON("?IdcService=CCLA_UPDATE_BUNDLE_PRIORITY<$include add_idc_token_to_url$>",
					{
						"dDocName":		bundleDocName,
						"newPriority": 	newValue
					},
					function(jsonData) {
						var jsonErrorMsg = checkJsonErrorMsg(jsonData);
						alert(jsonErrorMsg);
					}
				);
				
			}
		}
		
	</script>
	
<@end@>

<@dynamichtml ccla_bundle_listing_header@>
	
	
	
<@end@>

<!-- Company signature listing configuration. -->
<@dynamichtml ccla_signature_listing_pre@>

		<$include iris_sf_sort_images$>

  	<$calendarSelectFields="DATE,DATE_ADV"$>
	  <$include epoch_calendar_header$>

	  <$overrideResultsLink_DEFAULT="<$URL$>"$>
	  <$suppressSortLinks = "ACTIONS"$>

	 	<$advSearchFieldList="REF,CCLA_CLIENT_NUM,CCLA_ACC_NUM,TITLE,DATE_ADV"$>
		<$moreAdvSearchFieldList=""$>

  	<$nodeSearchQuery = "(dDocType <matches> `Signature`)"$>
  	<$nodeFilterFieldWidth="1,10,15,15,40,23,1"$>
	  <$nodeFilterFieldNames="REF,CCLA_CLIENT_NUM,CCLA_ACC_NUM,SIG_IMAGE,DATE,ACTIONS"$>

	 	<$CHECKBOX_CustomIncludeScript="CHECKBOX_CustomIncludeScript"$>
		
		<$SF_DATE_caption="Date Added"$>
		
		<$SF_REF_caption="Signature ID"$>
	 	<$REF_CustomIncludeScript="SIG_REF_CustomIncludeScript"$>
	 	<$SF_REF_idcname="dDocName"$>
	 	<$SF_REF_search="substring"$>
	 	
		<$SF_SCANDATE_idcname="dReleaseDate"$>
		<$SF_SCANDATE_ADV_idcname="dReleaseDate"$>
		<$DATE_CustomIncludeScript="CCLA_DATE_CustomIncludeScript"$>
		
	  <$SIG_IMAGE_CustomIncludeScript="SIG_IMAGE_CustomIncludeScript"$>
			
	  <$ACTIONS_CustomIncludeScript="CCLA_DocActions_CustomIncludeScript"$>

		<$hideInfoLink="N"$>
	  <$displaySearchButton="N"$>

		<$displayPagingOptions="N"$>
		<$displayPaginator="Y"$>
		<$SF_CustomPaginator="iris_sf_paginator"$>

	  <$inlineHeaderInclude = "ccla_signature_listing_inline_header"$>

	  <$advSearchBackgroundColour="#FFFFFF"$>
	  <$advSearchDisplay_pre='orangeContainer_top'$>
	  <$advSearchDisplay_after='orangeContainer_bottom'$>

	  <!-- Misc search customizations -->
	  <$PARAMETERSLIST=PARAMETERSLIST & ",showCompleted"$>
	  <$QueryFieldList="REF,CCLA_COMPANY,SIG_IMAGE,DATE"$>

	  <$DISPLAYTHUMBNAILS=1$>
	  <$THUMBNAILWIDTH=30$>
	  <$THUMBNAILHEIGHT=30$>

	  <$nodeSortField="dInDate"$>
  	<$nodeSortOrder="DESC"$>

	  <!-- Verity search -->
	  <$if #active.amt$>
	  	<$trueAmt = amt * 100$>
	  	<$nodeSearchQuery = nodeSearchQuery & " <and> ((xTotalAmount <= " & trueAmt & ") <and> (xTotalAmount >= " & trueAmt & ")) "$>
	  <$endif$>

	  <$if not #active.showCompleted$>
	  	<$nodeSearchQuery = nodeSearchQuery & " <and> <not> (xStatus <matches> `Completed`) "$>
	  <$endif$>

<@end@>

<!-- Overriden from iriscore_resource.
		 Adds a select element to the doc listing screen
		 to control the types of documents being displayed -->
<@dynamichtml ccla_signature_listing_inline_header@>

	<div style="margin-top: 10px">
		<input type="submit" class="submitLink" value="Search" style="margin-left: 10px"/>
	</div>

<@end@>

<!-- Displays the xPriority value for Bundle items.
	 If the user has the required access, they can adjust the value by typing
	 a new value in the box. -->
<@dynamichtml PRIORITY_CustomIncludeScript@>
	
	<$if userCanUpdatePriorites$>
		<input 	type="text" 
				style="width: 4em; margin-left: 3px;" 
				class="priority-input"
				
				value="<$#active.xPriority$>" 
				id="priority_<$#active.dDocName$>" 
				tabindex="<$getValue("SearchResults","#row") + 50$>" />
				
		<input 	type="hidden"
				id="priority_<$#active.dDocName$>_current"
				value="<$#active.xPriority$>" />
	<$else$>
		<$#active.xPriority$>&nbsp;
	<$endif$>
	
<@end@>

<!-- Displays document status -->
<@dynamichtml CCLA_STATUS_CustomIncludeScript@>

	<$if #active.xStatus like 'Completed'$>
		<span style="color: #A9A9A9; font-size: 1em;">Completed</span>
	<$elseif #active.xStatus like 'Indexed'$>
		<span style="color: #2E8B57; font-size: 1em;">Indexed</span>
	<$elseif #active.xStatus like 'Deleted|Flagged'$>
		<span style="color: #DC143C; font-size: 1em;"><$xStatus$></span>
	<$else$>
		<$#active.xStatus$>
	<$endif$>

<@end@>

<@dynamichtml SIG_IMAGE_CustomIncludeScript@>
	
	<div style="border: 1px solid #BBB; padding: 2px; float: left; overflow: auto">
  	<img src="<$URL$>" />
	</div>
<@end@>

<@dynamichtml SIG_REF_CustomIncludeScript@> 
	
<a href="javascript:openPopup('?IdcService=CCLA_ADD_SIGNATURE<$include add_idc_token_to_url$>&docName=<$dDocName$>',500);"><$dDocName$></a>
	
<@end@>

<!-- Staging and configuration for the Filing Cabinet S&F display. 
			
		 Overriden from iris_batchdocuments_resource.
			-->
<@dynamichtml iris_filing_cabinet_listing_pre@> 
	
	<$include float_menu_header$>
	<$include ecs_popup_div_header$>
	
	<$include iris_sf_sort_images$>

	<!-- Display/result list behaviour -->
 	<$hideLineBreak="1"$>
  
  <$SF_enableFullTextSearch=""$>
  <$SF_showResultCountSelector=1$>
  
  <$custTableAttrs="class='IssueBlock' cellpadding='4' cellspacing='0' width='100%' border='0' bgcolor='#F6F6F4'"$>
  <$custRowAttrs="class='resultrow' onmouseover='setRowHighlight(this);' onmouseout='remRowHighlight(this);' onclick='toggleRow(this);'"$>
  <$custRowEval="<$'id=\"' & dDocName & '_row\"'$>"$>
  <$custColumnHeaderEval="<$if columnCounter==0$> class='sfHeader_start' <$elseif columnCounter >= (totalColumns-1)$> class='sfHeader_end' <$else$> class='sfHeader_mid' <$endif$> height=40 cellpadding=1"$>

	<$onLoadStr="clearChecks();"$>	

	<$calendarSelectFields="DATE_ADV,WF_DATE_ADV"$>
  <$include epoch_calendar_header$>
  
  <$suppressSortLinks = "CHECKBOX,ACTIONS"$>
	
	<$WF_DATE_CustomIncludeScript="WF_DATE_CustomIncludeScript"$>
	<$CCLA_ACC_NUM_CustomIncludeScript="CCLA_ACC_NUM_CustomIncludeScript"$>
  
	<$QUICKSEARCHMETADATA = "dDocName,dDocTitle,dDocAuthor,xBundleRef,xBatchNumber,xClientNumber,xCompany,xDocumentClass,xComments"$>
  	
  <$nodeFilterFieldWidth="1,1,18,8,8,8,8,8,18,10,10"$>
  <$nodeFilterFieldNames="CHECKBOX,DOC_CLASS,CCLA_DOCNAME,CCLA_STATUS,CCLA_DOCTYPE,REF,CCLA_WF_ID,CCLA_CLIENT_NUM,CCLA_ACC_NUM,QUICKDATE,WF_DATE"$>
  <$advSearchFieldList="EVERYTHING,FORM_ID,CCLA_DOCNAME,CCLA_SOURCE,TITLE,DOC_CLASS,CCLA_DOCTYPE,REF,CCLA_WF_ID,GAP,CCLA_CLIENT_NUM_ADV,CCLA_COMPANY,CCLA_ORG_ACCOUNT_CODE,CCLA_DEST_ORG_ACCOUNT_CODE,CCLA_ACC_NUM,CCLA_FUND,CCLA_AMOUNT,CCLA_UNITS,CCLA_STATUS,CCLA_PAYMENT_REF,DATE_ADV,GAP,WF_DATE_ADV"$>
  <$moreAdvSearchFieldList=""$>
  
  <$SF_REF_caption="Envelope ID"$>
  <$SF_REF_idcname=#env.Iris_batchIdField$>
  <$SF_REF_search="matches"$>
  <$SF_EVERYTHING_caption="Full text"$>
 	<$SF_EVERYTHING_idcname=""$>
 	<$SF_QUICKDATE_caption="Date added"$>
 	<$SF_DATE_ADV_caption="Date added"$>
	
	<$SF_TITLE_caption="Title"$>
	
 	<$CHECKBOX_CustomIncludeScript="CHECKBOX_CustomIncludeScript"$>
	<$DOC_CLASS_CustomIncludeScript="DOC_CLASS_CustomIncludeScript"$>
	<$DOC_CLASS_CustomFilterScript="ccla_document_class_option_list_sf"$>
	
 	<$CCLA_DOCNAME_CustomIncludeScript="CCLA_DOCNAME_CustomIncludeScript"$>
 	<$QUICKDATE_CustomIncludeScript="QUICKDATE_long_CustomIncludeScript"$>
 	<$REF_CustomIncludeScript="ENVELOPE_ID_CustomIncludeScript"$>
 	<$CCLA_WF_ID_CustomIncludeScript="CCLA_WF_ID_CustomIncludeScript"$>
	<$CCLA_CLIENT_NUM_CustomIncludeScript="CCLA_CLIENT_NUM_CustomIncludeScript"$>
  <$IRIS_STATUS_CustomIncludeScript="IRIS_STATUS_CustomIncludeScript"$>
  <$DEPARTMENT_CustomIncludeScript="DEPARTMENT_CustomIncludeScript"$>
  <$SUBDEPT_CustomIncludeScript="SUBDEPT_CustomIncludeScript"$>
  <$ACTIONS_CustomIncludeScript="DocActions_CustomIncludeScript"$>
	
	<$CCLA_CLIENT_NUM_ADV_CustomFilterScript="CCLA_CLIENT_NUM_ADV_CustomFilterScript"$>
	<$CCLA_FUND_CustomFilterScript="CCLA_FUND_CustomFilterScript"$>
	
	<$hideInfoLink="N"$>
  <$displaySearchButton="N"$>
  	
	<$displayPagingOptions="N"$>
	<$displayPaginator="Y"$>
	<$SF_CustomPaginator="iris_sf_paginator"$>

  <$customIncludeResultsHeader = "group_action_controls"$>
  <$inlineHeaderInclude = "ccla_filing_cabinet_inline_header"$>
  
  <$advSearchBackgroundColour="#FFFFFF"$>
  <$advSearchDisplay_pre='orangeContainer_top'$>
  <$advSearchDisplay_after='orangeContainer_bottom'$>
  
  <!-- Search customizations -->
  <$PARAMETERSLIST=PARAMETERSLIST & ",showUnclassified,selectMode,callbackParams,ssResultCount,SF_CCLA_CLIENT_NUM_ADV_search"$>
  <$QueryFieldList="EVERYTHING,FORM_ID,TITLE,REF,CCLA_WF_ID,DOC_CLASS,CCLA_DOCTYPE,CCLA_DOCNAME,CCLA_SOURCE,QUICKDATE,DATE_ADV,WF_DATE,WF_DATE_ADV,CCLA_CLIENT_NUM,CCLA_CLIENT_NUM_ADV,CCLA_COMPANY,CCLA_ORG_ACCOUNT_CODE,CCLA_DEST_ORG_ACCOUNT_CODE,CCLA_ACC_NUM,CCLA_FUND,CCLA_AMOUNT,CCLA_UNITS,CCLA_PAYMENT_REF,CCLA_STATUS"$>
  	
  <$DISPLAYTHUMBNAILS=1$>
  <$THUMBNAILWIDTH=30$>
  <$THUMBNAILHEIGHT=30$>	
	 
	<$if not #local.sf$>
		<$sf="dInDate"$>
		<$so="DESC"$>
	<$endif$>

	<!-- Special checks on client number filter to enforce
		 customizable matching clause used in Advanced Search panel -->
	<$if #local.clientno and #local.adv$>
		<$clientnoadv = clientno$>
		<$clientno = ""$>
		<$SF_CCLA_CLIENT_NUM_ADV_search="matches"$>
	<$elseif #local.clientnoadv and not #local.adv$>
		<$clientno = clientnoadv$>
		<$clientnoadv = ""$>
	<$endif$>
	
  <!-- Verity search -->  
  <$nodeSearchQuery = "((dDocType <matches> `Document`) <or> (dDocType <matches> `ChildDocument`))"$>
  
	<$if false$>
		<$if showUnclassified$>
			
		<$else$>
			<$nodeSearchQuery = nodeSearchQuery & " <and> (xBatchNumber >= `1`)"$>
		<$endif$>
	<$endif$>

	<$if selDocs$>
		<$exec rsMakeFromString("rsSelDocs",selDocs,"docName")$>
		
		<$loop rsSelDocs$>
			<$if appendQuery$>
				<$appendQuery = appendQuery & " <or> "$>
			<$endif$>
			
			<$appendQuery = #local.appendQuery & "(dDocName <matches> `" & docName & "`)"$>
		<$endloop$>
		
		<$nodeSearchQuery  = nodeSearchQuery & " <and> (" & appendQuery & ")"$>
	<$endif$>

<@end@>

<@dynamichtml group_action_controls@>
	
	<$include super.group_action_controls$>
		
	<input type="hidden" name="selectMode" value="<$#local.selectMode$>" />
	<input type="hidden" name="callbackParams" value="<$#local.callbackParams$>" />
	
	<$if #local.selectMode$>
		<br/>
		
		<div class="message_panel info_icon">
			You are currently in document select mode. Click a Select button to choose a document.
		</div>
	
		<br/>
	<$endif$>
	
<@end@>

<@dynamichtml WF_DATE_CustomIncludeScript@>
	<$#active.xWorkflowDate$>&nbsp;
<@end@>

<@dynamichtml CCLA_ACC_NUM_CustomIncludeScript@>
	<$#active.xAccountNumber$>&nbsp;
<@end@>

<!-- Overriden from iris_batchdocuments_resource to configure columns for CCLA. -->
<@dynamichtml iris_batch_docs_listing_pre@> 

	<$include iris_sf_sort_images$>
	
  <$isDocSearchAndFilter = 1$>

	<$custTableAttrs="class='IssueBlock' cellpadding='4' cellspacing='1' border='0' bgcolor='#F6F6F4'"$>
  <$custRowAttrs="class='resultrow_linked'"$>
  <$custRowEval="<$'id=\"' & dDocName & '_row\"'$>"$>
  <$custColumnHeaderEval="<$if columnCounter==0$> class='sfHeader_start' <$elseif columnCounter >= (totalColumns-1)$> class='sfHeader_end' <$else$> class='sfHeader_mid' <$endif$> height=40 cellpadding=1"$>

  <$hideLineBreak="1"$>
  <$displayColumnHeaderSortOptions="Y"$>
  <$suppressSortLinks="CHECKBOX,DOCACTIONS"$>

  <$nodeFilterFieldWidth="1,40,20,20,20,1"$>
  <$nodeFilterFieldNames="CHECKBOX,FILE,DOC_CLASS,DATE,AUTHOR,DOCACTIONS"$>
	<$QueryFieldList="FILE,DOC_CLASS,DATE,AUTHOR"$>
	
	<$displayPagingOptions="N"$>
	<$displayPaginator="Y"$>
	<$SF_CustomPaginator="iris_sf_paginator"$>
	
	<$SF_DATE_caption="Date Added"$>
	<$SF_AUTHOR_caption="Contributor"$>
	
	<$PARAMETERSLIST="dDocName,bundleRef,isAssignee"$>
	
  <$overrideFirstColumn="Y"$>
  <$overrideResultsLink_DEFAULT="mailto:<$getValueForSpecifiedUser(dDocAuthor,'dEmail')$>"$>

	<$if not sf$>
		<$sf = "dDocName"$>
	<$endif$>
	
	<$if not so$>
		<$so = "ASC"$>
	<$endif$>

  <$include iris_build_batch_item_query$>	
	<$nodeSearchQuery = batchItemQuery$>
	  	
  <$c="SL:set sort order to match thumbnail display. earliest first."$>
  <$ssSortOrder="Asc"$>
  <$ssSortField="dInDate"$>

  <$c="SL: used to temporarily stop the deleted doc re-appearing in the S&F list when the page is refreshed"$>
  <$if #active.deleted_dDocName$>
  	<$nodeSearchQuery = nodeSearchQuery & " <and> <NOT> (dDocName <matches> `" & #active.deleted_dDocName & "`)"$>
  <$endif$>

  <$SF_DISPLAYADVSEARCHLINK=""$>

  <$displayCountSummary="Y"$>
  <$displayPagingOptions="N"$>
  <$displaySearchButton="N"$>
  <$displayFilterOptions="N"$>
  <$useAdvancedSearch="N"$>
  <$advSearchFieldList=""$>
	<$allowContentTypeLinkOverride="Y"$>
	<$hideInfoLink="Y"$>

	<$CHECKBOX_CustomIncludeScript="CHECKBOX_CustomIncludeScript"$>
  <$FILE_CustomIncludeScript="FILE_batchitem_CustomIncludeScript"$>
  <$AUTHOR_CustomIncludeScript="AUTHOR_CustomIncludeScript"$>
  <$DOCACTIONS_CustomIncludeScript="BATCHDOCACTIONS_CustomIncludeScript"$>
  
  <$customIncludeResultsHeader = "batch_item_controls"$>

  <$linkedDocType = "LinkedDoc"$>
  <$customSearchScript = "performLinkedItemSearch"$>

<@end@>

<@dynamichtml batch_doc_actions_listing_pre@>
  	<$calendarSelectFields="SCANDATE"$>
	  <$include epoch_calendar_header$>

	  <$overrideResultsLink_DEFAULT="<$HttpCgiPath & '?IdcService=DOC_APPROVAL' & inc('add_idc_token_to_url') & '&dDocName=' & dDocName$>"$>

	  <$suppressSortLinks = "CHECKBOX,ACTIONS"$>

		<$nodeSearchQuery = "(dDocType <matches> `Bundle`)"$>
		<$nodeFilterFieldWidth="1,25,20,20,15"$>
		<$nodeFilterFieldNames="CHECKBOX,BUNDLEREF,CCLA_BUNDLE_DATE,SENDER,CCLA_BUNDLE_STATUS"$>

		<$if not tp$>
			<$tp="bundle"$>
		<$endif$>

	  <$CHECKBOX_CustomIncludeScript="BATCHDOC_ACTIONS_RADIO_CustomIncludeScript"$>
	  <$CCLA_BUNDLE_DATE_CustomIncludeScript="CCLA_DATE_CustomIncludeScript"$>

	  <$isActionListing=1$>
	  <$REF_CustomIncludeScript="REF_CustomIncludeScript"$>
	  <$BUNDLEREF_CustomIncludeScript="REF_CustomIncludeScript"$>
	  <$CCLA_BUNDLE_STATUS_CustomIncludeScript="CCLA_STATUS_CustomIncludeScript"$>
	  <$CCLA_BUNDLE_STATUS_CustomFilterScript="CCLA_BUNDLE_STATUS_CustomFilterScript"$>
	  <$TOTALAMOUNT_CustomIncludeScript="TOTALAMOUNT_CustomIncludeScript"$>

		<$hideInfoLink="N"$>
	  <$displaySearchButton="N"$>

		<$displayPagingOptions="N"$>
		<$displayPaginator="Y"$>
		<$SF_CustomPaginator="iris_sf_paginator"$>

	  <$c="removing below from page"$>
	  <$inlineHeaderInclude = "iris_doc_listing_inline_header"$>
	  <$customIncludeResultsHeader = "group_action_controlsX"$>

	  <!-- Search customizations -->
	  <$PARAMETERSLIST="tp,mDN,thisBundle,itemName,mdID,mRL,mSG,mDA,bDN,showCompleted"$>
	  <$PARAMETERSLIST="tp,mDN,showCompleted"$>
	  <$QueryFieldList="REF,BUNDLEREF,QUICKDATE,CCLA_BUNDLE_DATE,DUEDATE,AUTHOR,IRIS_STATUS,APPROVER,TITLE,VENDORNAME,CURRENCY,DOCTYPE,DATE_ADV,MAILTYPE"$>

	  <$DISPLAYTHUMBNAILS=''$>
	  <$THUMBNAILWIDTH=30$>
	  <$THUMBNAILHEIGHT=30$>
	  <$ssResultCount=5$>
	  <$SF_DISPLAYADVSEARCHLINK=N$>
				
		<$paginationParamString= "&mDN=" & #active.mDN & "&showCompleted=" & #active.showCompleted$>

	  <$pn_link_prefix= HttpCgiPath & "?IdcService=GET_DOC_PAGE" & inc('add_idc_token_to_url') & "&Action=GetTemplatePage&Page=IRIS_BATCH_ACTIONS" & paginationParamString & "&SR="$>

	  <$nodeSortField="dInDate"$>
  	<$nodeSortOrder="DESC"$>

	  <!-- Verity search -->

	  <$if #active.amt$>
	  	<$trueAmt = amt * 100$>
	  	<$nodeSearchQuery = nodeSearchQuery & " <and> ((xTotalAmount <= " & trueAmt & ") <and> (xTotalAmount >= " & trueAmt & ")) "$>
	  <$endif$>

		<$if #local.st like 'Completed'$>
			<$showCompleted=1$>
		<$endif$>

	  <$if not #active.showCompleted$>
	  	<$nodeSearchQuery = nodeSearchQuery & " <and> <not> (xStatus <matches> `Completed`) "$>
	  <$endif$>

	  <$customIncludeFieldScript = "actions_SandF_formextras"$>

<@end@>

<!-- Overriden from iriscore_resource.
		 Adds a select element to the doc listing screen
		 to control the types of documents being displayed -->
<@dynamichtml ccla_doc_listing_inline_header@>
	
	  <div style="margin-top: 10px">
		
		<table>
			<tr>
				<td valign="top">
					<select name="view" id="view" onchange="document.forms['SEARCHFILTER'].submit();">
						<option value="Bundle" <$if view like "Bundle"$>selected<$endif$>>Mail Bundles</option>
						<option value="Response" <$if view like "Response"$>selected<$endif$>>Response Slips</option>
					</select>
				</td>
				<td>
			
					<input type=checkbox name="showCompleted" <$if showCompleted$>checked=true<$endif$> onclick="document.forms['SEARCHFILTER'].submit();">Show completed
					<br style="line-height: 0px; height: 0px"/>
					<input type=checkbox name="showDeleted" <$if showDeleted$>checked=true<$endif$> onclick="document.forms['SEARCHFILTER'].submit();">Show deleted
				
				</td>
				<td valign="top">
					<input type="submit" class="submitLink" value="Search" style="margin-left: 10px"/>
				</td>
			</tr>
		</table>
		
	</div>

<@end@>

<!-- Overriden from iriscore_resource.
		 Adds a select element to the doc listing screen
		 to control the types of documents being displayed -->
<@dynamichtml ccla_filing_cabinet_inline_header@>

  <div style="margin-top: 10px">
		&nbsp;
		<$if false$>
		<input type=checkbox name="showUnclassified" <$if showUnclassified$>checked=true<$endif$> onclick="toggleShowUnclassified(this)">Show pending documents
		<$endif$>
		<input type="submit" class="submitLink" value="Search" style="margin-left: 10px"/>
		<input type="submit" class="submitLink" value="Clear filters" name="submit_clear"/>
		
			<script type="text/javascript">

				// Show/hide documents with 'Released' status
				function toggleShowUnclassified(chk)
				{
					document.forms['SEARCHFILTER'].submit();
				}
		
			</script>
		
	</div>

<@end@>

<!-- Displays content item dDocName, with link to DOC_APPROVAL page. -->
<@dynamichtml CCLA_DOCNAME_CustomIncludeScript@>
	<a href="<$HttpCgiPath$>?IdcService=DOC_APPROVAL<$include add_idc_token_to_url$>&dDocName=<$dDocName$>" title="View item <$dDocName$>"><$dDocName$></a>
	
	<$if #active.xFormId$>
		<a href="#" onclick="openPopup('?IdcService=CCLA_CS_FORM_INFO_POPUP<$include add_idc_token_to_url$>&formId=<$#active.xFormId$>&updateFlags=1&ts=' + new Date());return false;"><span class="sub-text form-id"><$#active.xFormId$></span></a>
	<$endif$>
<@end@>

<!-- Displays content item xDocumentClass value, with link to DOC_APPROVAL page.

	 The document title is displayed underneath in grey.
	 -->
<@dynamichtml DOC_CLASS_CustomIncludeScript@>
	
	<$if #local.selectMode$>
		
		<table cellpadding=1 width=100%>
			<tr>
				<td width=30>
					<input 	type="button" value="Select" 
							onclick='window.opener.doDocSelectCallback(<$#active.dID$>,"<$#active.dDocName$>","<$#active.dRevisionID$>","<$js(#local.callbackParams)$>");window.close();' />
				</td>
				<td>
					<$include DOC_CLASS_listed_display$>
				</td>
			</tr>
		</table>
		
	<$else$>
		<$include DOC_CLASS_listed_display$>		
	<$endif$>
	
<@end@>

<@dynamichtml DOC_CLASS_listed_display@>
	
	<a href="<$HttpCgiPath$>?IdcService=DOC_APPROVAL<$include add_idc_token_to_url$>&dDocName=<$dDocName$>" title="View item <$dDocName$>"><$if #active.xDocumentClass$><$xDocumentClass$><$else$>-<$endif$></a>
		
	<br/>
	<span class="sub-text">
		<$if #active.xDependantDocName$>
			[<a href="<$HttpCgiPath$>?IdcService=DOC_APPROVAL<$include add_idc_token_to_url$>&dDocName=<$xDependantDocName$>" title="View this items dependant document <$xDependantDocName$>">Ins</a>]
		<$endif$>
		
		<$if strLength(#active.dDocTitle) > 25$>
			<$strSubstring(#active.dDocTitle, 0, 25)$>...
		<$else$>
			<$#active.dDocTitle$>
		<$endif$>
	</span>
	
	<$if 	(#active.xDocumentClass like "INV") 
			or 
			(#active.xDocumentClass like "INVHIST") 
			or 
			(#active.xDocumentClass like "MULTIINV")$>
		<br/>
		
		<span class="sub-text">Inv No: <$#active.xUnits$>, Gross Amount: <$#active.xAmount$></span>
		
	<$elseif #active.xAmount$> 
		<br/>
		<span class="sub-text">Amount:</span> <span style="color:#5555BB; font-size:0.8em"><$#active.xAmount$></span>
		
	<$elseif #active.xUnits$>
		<br/>
		<span class="sub-text">Units:</span> <span style="color:#5555BB; font-size:0.8em"><$#active.xUnits$></span></span>
		
	<$endif$>
	
	<$if #active.xPaymentRef$>
		<br/>
		<span class="sub-text">Pay Ref:</span> <span style="color:#5555BB; font-size:0.8em"><$#active.xPaymentRef$></span>
	<$endif$>
	
<@end@>

<!-- 	Displays item workflow IDs. The field is numeric, so a zero
			value is equivalent to a null value. -->
<@dynamichtml CCLA_WF_ID_CustomIncludeScript@>

	<$if xBatchNumber like "0"$>
		-
	<$else$>
		<a href="<$HttpCgiPath$>?IdcService=IRIS_CLASSIFIED_ITEMS<$include add_idc_token_to_url$>&wfid=<$xBatchNumber$>"><$xBatchNumber$></a>
	<$endif$>

<@end@>

<!-- 	Displays item workflow IDs. 
		-->
<@dynamichtml CCLA_CLIENT_NUM_CustomIncludeScript@>

	<$if not xClientNumber$>
		-
	<$else$>
		<$if false$>
			<a href="<$HttpCgiPath$>?IdcService=IRIS_CLASSIFIED_ITEMS<$include add_idc_token_to_url$>&clientno=<$xClientNumber$>"><$xClientNumber$></a>
		<$endif$>
		
		<$if #active.xCompany$>
			<a 	title="View client info"
				href="?IdcService=CCLA_CS_ENTITY_INFO<$include add_idc_token_to_url$>&COMPANY=<$#active.xCompany$>&CLIENT_NUMBER=<$xClientNumber$>"><$xClientNumber$></a>
		<$else$>
			<a 	title="Search for matching clients"
				href="?IdcService=CCLA_CS_SEARCH_CLIENT<$include add_idc_token_to_url$>&clientId=<$xClientNumber$>"><$xClientNumber$></a>	
		<$endif$>
	<$endif$>

<@end@>

<!-- 	Used to display the action menu for each item on the
			Document Listing template -->
<@dynamichtml CCLA_DocActions_CustomIncludeScript@>

	<$menu_style_prefix="top"$>
	<$actionMenu_CustomInclude="ccla_iris_doc_actions_menu"$>

	<$include action_menu$>

<@end@>

<@dynamichtml ccla_iris_doc_actions_menu@>

	<tr>
  	<td class="<$menu_style_prefix$>PopupLink" nowrap onMouseOver="glowPopupRow(this,'<$menu_style_prefix$>PopupLink_over','<$menu_style_prefix$>PopupLink')"	onMouseOut="fadePopupRow(this,'<$menu_style_prefix$>PopupLink')">
  		<a href="<$HttpCgiPath & '?IdcService=DOC_INFO' & inc('add_idc_token_to_url') & '&dID=' & dID$>">Standard info</a>
		</td>
	</tr>
	
	<$if dDocType like 'Signature'$>
		
		<tr>
	  	<td class="<$menu_style_prefix$>PopupLink" nowrap onMouseOver="glowPopupRow(this,'<$menu_style_prefix$>PopupLink_over','<$menu_style_prefix$>PopupLink')"	onMouseOut="fadePopupRow(this,'<$menu_style_prefix$>PopupLink')">
	  		<a href="javascript:openPopup('?IdcService=CCLA_ADD_SIGNATURE<$include add_idc_token_to_url$>&docName=<$dDocName$>',500);">Update</a>
			</td>
		</tr>
		
		<tr>
	  	<td class="<$menu_style_prefix$>PopupLink" nowrap onMouseOver="glowPopupRow(this,'<$menu_style_prefix$>PopupLink_over','<$menu_style_prefix$>PopupLink')"	onMouseOut="fadePopupRow(this,'<$menu_style_prefix$>PopupLink')">
	  		<a href="javascript:expireSig('<$dDocName$>');">Delete</a>
			</td>
		</tr>
	<$endif$>

<@end@>

<!-- Custom select list of batch statuses -->
<@dynamichtml CCLA_BUNDLE_STATUS_CustomFilterScript@>

	<$bundleStatusList = #env.CCLA_bundleStatuses$>
	<$exec rsMakeFromString("rsStatus",bundleStatusList,"status")$>

	<select name="st" id="st" class="sfSelect" <$if autoSearch$>onChange="document.forms['SEARCHFILTER'].submit();"<$endif$>>
		<option value=""></option>

		<$loop rsStatus$>
			<option value="<$rsStatus.status$>" <$if #local.st like rsStatus.status$>selected="selected"<$endif$>>
				<$rsStatus.status$>
			</option>
		<$endloop$>
	</select>
<@end@>

<@dynamichtml MAILTYPE_CCLA_CustomFilterScript@> 

	<$bundleTypeList = "Bundle,Mail Bundle"$>
	<$exec rsMakeFromString("rsBundleTypes",bundleTypeList,"type")$>

	<select name="mailtype" id="mailtype" class="sfSelect" <$if autoSearch$>onChange="document.forms['SEARCHFILTER'].submit();"<$endif$>>
		<option value=""></option>

		<$loop rsBundleTypes$>
			<option value="<$rsBundleTypes.type$>" <$if #local.mailtype like rsBundleTypes.type$>selected="selected"<$endif$>>
				<$exec rsNext("rsBundleTypes")$>
				<$rsBundleTypes.type$>
			</option>
		<$endloop$>
	</select>

<@end@>

<!-- Special S&F filter field used in Advanced Search panel.

	 Allows the user to specify their own match type for the xClientNumber field. -->
<@dynamichtml CCLA_CLIENT_NUM_ADV_CustomFilterScript@>
	
	<select name="SF_CCLA_CLIENT_NUM_ADV_search">
	
		<option value="matches" <$if #local.SF_CCLA_CLIENT_NUM_ADV_search like "matches"$>selected<$endif$>>Exact match</option>
		<option value="substring" <$if #local.SF_CCLA_CLIENT_NUM_ADV_search like "substring"$>selected<$endif$>>Substring match</option>
		<option value="starts" <$if #local.SF_CCLA_CLIENT_NUM_ADV_search like "starts"$>selected<$endif$>>Starts with</option>
		<option value="ends" <$if #local.SF_CCLA_CLIENT_NUM_ADV_search like "ends"$>selected<$endif$>>Ends with</option>
	</select>

	<input type="text" style="width: 9em" value="<$#local.clientnoadv$>" id="clientnoadv" name="clientnoadv" title="Client no filter"/>
	
<@end@>

<!-- Displays the Fund code field as a smaller than usual field. -->
<@dynamichtml CCLA_FUND_CustomFilterScript@>
	
	<input type="text" style="width: 9em" value="<$#local.fundcode$>" id="fundcode" name="fundcode" title="Fund filter"/>

<@end@>

<@dynamichtml ENVELOPE_ID_CustomIncludeScript@> 
	
	<$if xBundleRef$>
		<a href="<$HttpCgiPath$>?IdcService=DOC_APPROVAL<$include add_idc_token_to_url$>&bundleRef=<$xBundleRef$>"><$xBundleRef$></a>
	
		<span name="<$xBundleRef$>_item_count" class="bundle-item-count"></span>
	<$endif$>
	
<@end@>

<@dynamichtml MAILTYPE_CCLA_CustomInclude@>
	
	Mail Bundle
	
<@end@>

<@dynamichtml SENDER_CCLA_CustomInclude@>
	<$#active.xScanUser$>&nbsp;
<@end@>

<@dynamichtml CCLA_DATE_CustomIncludeScript@>
	
	<$formatDateWithPattern(#active.dInDate,"dd MMM yy HH:mm")$>

<@end@>

<@dynamichtml iris_get_profile_data@>
	
	<!-- Resolve CCLA Iris Profile for this user -->

	<$profileName = "CCLA"$>
	<$batchItemDocType = "MailItem"$>
	
	<$executeService("IRIS_GET_PROFILE_INFO")$>
	
<@end@>

<!-- Doc metadata validation hook. Add any required validation
 		 logic for CCLA documents here. -->
<@dynamichtml iris_doc_validation_extra_js@> 
	
	// Company/client no. checks. Only executed if both xCompany/xClientNumber
	// values are specified.
	var companyField 	= document.doc_fields['xCompany'];
	var clientNumField	= document.doc_fields['xClientNumber'];
	
	if (companyField && clientNumField) {
		var company		= companyField.value;
		var clientNum 	= clientNumField.value;
		
		/*
		
		Don't bother validating the Client Number lengths any more - they get
		fixed at the back end.
		
		var result = validateCompanyAndClientNumber(company, clientNum);
			
		if (result == "CBF_invalid_length") {
			displayFieldErrorMsg("xClientNumber","Invalid CBF client","Must be 6 or 7 digits long");
			hasErrors = true;
		
		} else if (result == "COIF_invalid_length") {
			displayFieldErrorMsg("xClientNumber","Invalid COIF client","Must be 5 digits long");
			hasErrors = true;
		}
		*/
	}
	
	// Check amount field is a valid number, pad .00 if no decimal specified
	var amountField = document.doc_fields['xAmount'];
	if (amountField) {
		
		var currClassField = document.doc_fields['xDocumentClass'];
		var allowNegativeAmountDocClassList = "<$#env.CCLA_allowNegativeAmountDocClasses$>";
		var isValid = false;

		if (allowNegativeAmountDocClassList && currClassField && allowNegativeAmountDocClassList.indexOf(currClassField.value)>=0) {
			isValid = validateCurrencyValueIncNegative(amountField.value);
		} else {
			isValid = validateCurrencyValue(amountField.value);
		}	
		
		if (!isValid) {
			displayFieldErrorMsg("xAmount","Invalid number","Must be in the format 0.00");
			hasErrors = true;
		} else {
			
			if (amountField.value.length > 0 && amountField.value.indexOf(".") == -1) {
				// No decimal place specified in amount field - add one now.
				amountField.value = amountField.value + ".00";
			}
		}
	}
	
	// Check scan date is a valid date value
	var scanDateField = document.doc_fields['xScanDate'];
	if (scanDateField && !scanDateField.value == "") {
		var isValid = validateDateValue(scanDateField.value);
		
		if (!isValid) {
			displayFieldErrorMsg("xScanDate","Invalid date","Must be in the format dd/mm/yyyy");
			hasErrors = true;
		}
	}
	
	// Check document date is a valid date value
	var docDateField = document.doc_fields['xDocumentDate'];
	if (docDateField && !docDateField.value == "") {
		var isValid = validateDateValue(docDateField.value);
		
		if (!isValid) {
			displayFieldErrorMsg("xDocumentDate","Invalid date","Must be in the format dd/mm/yyyy");
			hasErrors = true;
		} else {
			// Check document date is in valid range
			var rangeCheck = validateDateRange(docDateField.value, '01/01/1970', '01/01/2100');
			
			if (rangeCheck != 0) {
				displayFieldErrorMsg("xDocumentDate","Invalid date","The date falls outside the valid range");
				hasErrors = true;
			}
		}
	}
	
	// Special check: ensure that user has selected a valid multi-doc 
	// class, if they have chosen to add multi-docs.
	var multiDocField = document.doc_fields['xMultiDoc'];
	var docClassField = document.doc_fields['xDocumentClass'];
	
	if (multiDocField && (multiDocField.value == "Yes")) {
			
		// List of valid multi-doc classes taken from IDOC env. var
		var multiDocClassList = "<$#env.CCLA_multiDocClasses$>";
	
		// User has flagged this item as having multi-docs. Ensure doc class
		// is valid.
		if (docClassField && multiDocClassList.indexOf(docClassField.value) < 0) {
			
			// Pad the list with spaces so it can be printed nicely
			multiDocClassList =
			 multiDocClassList.replace(new RegExp(",", 'g'), ", ");
		
			displayFieldErrorMsg("xDocumentClass","Invalid class",
			"You must select a valid class to use the multi-docs feature: " +
			multiDocClassList);
			hasErrors = true;
		}
	}
	

<@end@>

<!-- Generic JavaScript functions required for CCLA field validation -->
<@dynamichtml ccla_field_validation_js@>
	
	<script type="text/javascript">
		
		// Company/client no. checks. Only executed if both company/client no.
		// values are non-null.
		//
		// Returns true if both values validate. A variety of error strings are
		// returned if the validation fails.
		function validateCompanyAndClientNumber(company, clientNum) {
		
			if (company.length == 0 || clientNum.length == 0)
				return true;
			
			// CBF check: client number must be 6 or 7 digits.
			if (company == "CBF") {
				
				if (clientNum.length < 6 || clientNum.length > 7) {
					return "CBF_invalid_length";
				}
			
			// COIF check: client number must be 5 digits.
			} else if (company == "COIF") {
				
				if (clientNum.length != 5) {
					return "COIF_invalid_length";
				}
			}
			
			return true;
		}
		
		function validateCurrencyValueIncNegative(val) {
			var numPattern = new RegExp("^(([-]?)[0-9])*[\.]?[0-9]*$");
		return numPattern.test(val);
	}
	</script>
	
<@end@>

<@dynamichtml iris_update_form_header@>

<$if not isBatchDoc$>
	<$if isInfo$>
		
		<form name="doc_fields" id="doc_fields" action="<$HttpCgiPath$>" method="POST" style="margin: 0px; padding: 0px">
	
			<input type=hidden name=isIris					value="1">
	
			<input type=hidden name=IdcService 			value="IRIS_UPDATE_DOCINFO">
			<$include add_idc_token_to_form$>
			<input type=hidden name=dID							value="<$dID$>">
			<input type=hidden name=dSecurityGroup	value="<$dSecurityGroup$>">
			<input type=hidden name=dRevLabel				value="<$dRevLabel$>">
			<input type=hidden name=dDocName				value="<$dDocName$>">
			<input type=hidden name=dInDate					value="<$dInDate$>">
			
			<input type=hidden name=RedirectUrl			value="<$HttpCgiPath & '?IdcService=DOC_APPROVAL' & inc('add_idc_token_to_url') & '&dDocName=' & dDocName & #local.urlparams$>">
			
			<$include iris_document_extra_hidden_fields$>
			
			<input type="hidden" name="dDocType" value="<$dDocType$>" />
	
			<$numMissingFields = 0$>
	
			<!-- 	Table containing metadata fields.
						Header customized for CCLA documents.
						 -->
			<table width="100%" cellpadding=0 cellspacing=2>
				
				<tr>
					<td valign=center class="field_caption_info">Envelope ID:</td>
					<td valign=center class="field_value_info"><a href="<$HttpCgiPath$>?IdcService=DOC_APPROVAL<$include add_idc_token_to_url$>&bundleRef=<$xBundleRef$>"><$xBundleRef$></a></td>
				</tr>
				
				<tr>
					<td valign=center class="field_caption_info">Added:</td>
					<td valign=center class="field_value_info"><$dReleaseDate$></a></td>
				</tr>
				
				<tr>
					<td valign=center class="field_caption_info">Workflow date:</td>
					<td valign=center class="field_value_info"><$#active.xWorkflowDate$></a></td>
				</tr>
				
				<tr><td colspan=2><br><td></tr>
				
				<tr>
					<td valign=center class="field_caption_info">Scanned by:</td>
					<td valign=center class="field_value_info"><$#active.xScanUser$></a></td>
				</tr>
				
				<tr>
					<td valign=center class="field_caption_info">Indexed by:</td>
					<td valign=center class="field_value_info"><$#active.xIndexer$></a></td>
				</tr>
				
				<tr>
					<td valign=center class="field_caption_info">Title:</td>
					<td valign=center class="field_value_info"><$dDocTitle$></a></td>
				</tr>
				
				<tr><td colspan=2><br><td></tr>
		
	<$else$>
		
		<$include super.iris_update_form_header$>
			
		<tr>
			<td valign=center class="field_caption">Envelope ID:</td>
			<td valign=center class="field_value">
				<a 	href="<$HttpCgiPath$>?IdcService=DOC_APPROVAL<$include add_idc_token_to_url$>&bundleRef=<$#active.xBundleRef$>"
						title="View this envelope"><$#active.xBundleRef$></a>
			
			</td>
		</tr>
		
		<tr>
			<td>
				<$include ccla_update_form_audit_fields$>
				<br/>
			</td>
		</tr>
		
		<tr>
			<td valign=center class="field_caption">Workflow ID:</td>
			<td valign=center class="field_value">
				<a 	href="<$HttpCgiPath$>?IdcService=IRIS_CLASSIFIED_ITEMS<$include add_idc_token_to_url$>&wfid=<$#active.xBatchNumber$>"
						title="Search for all items with this workflow ID"><$#active.xBatchNumber$></a>
			</td>
		</tr>
		
		<tr>
			<td valign=center class="field_caption">Workflow date:</td>
			<td valign=center class="field_value"><$formatDateWithPattern(#active.xWorkflowDate,#env.Iris_longDatePattern)$></td>
		</tr>
		
		<tr><td><br/></td></tr>
		
	<$endif$>
		
<$else$>
	
	<form name="doc_fields" id="doc_fields" action="<$HttpCgiPath$>" method="POST" style="margin: 0px; padding: 0px">

		<input type=hidden name=isIris					value="1">

		<input type=hidden name=IdcService 			value="IRIS_UPDATE_DOCINFO">
		<$include add_idc_token_to_form$>
		<input type=hidden name=dID							value="<$dID$>">
		<input type=hidden name=dSecurityGroup	value="<$dSecurityGroup$>">
		<input type=hidden name=dRevLabel				value="<$dRevLabel$>">
		<input type=hidden name=dDocName				value="<$dDocName$>">
		<input type=hidden name=dInDate					value="<$dInDate$>">
		
		<input type=hidden name=RedirectUrl			value="<$HttpCgiPath & '?IdcService=DOC_APPROVAL' & inc('add_idc_token_to_url') & '&dDocName=' & dDocName & #local.urlparams$>">
		
		<$include iris_document_extra_hidden_fields$>
		
		<input type="hidden" name="dDocType" value="<$dDocType$>" />
		
		<$include ccla_update_form_audit_fields$>
		
		<input type="hidden" name="xIndexer" value="<$dUser$>" />

		<$numMissingFields = 0$>

		<!-- table containing metadata fields -->
		<table width="100%" cellpadding=0 cellspacing=2>
			
			<$if isInfo$>
				<tr>
					<td class="field_caption_info">
						Last indexer:
					</td>
					<td class="field_value_info">
						<$#active.xIndexer$>
					</td>
				</tr>
			<$else$>
				<tr>
					<td class="field_caption">
						Last indexer:
					</td>
					<td class="field_value">
						<$#active.xIndexer$>
					</td>
				</tr>
			<$endif$>
			
<$endif$>

<@end@>

<!-- 	Inserts hidden form fields which will force an audit entry every
			time a document is updated via the Iris interface. -->
<@dynamichtml ccla_update_form_audit_fields@>

	<input type="hidden" name="doAudit" value="1" />
	<input type="hidden" name="lApp" value="IRIS" />
	<input type="hidden" name="lUser" value="<$dUser$>" />
	
	<input type="hidden" name="lAction" value="UPDATE-DOC" />
	<input type="hidden" name="lRef" value="<$dDocName$>" />
	<input type="hidden" name="lTitle" value="<$dDocTitle$>" />
	
	<input type="hidden" name="lMessage" value="Document updated" />

<@end@>

<!-- Displays the document contributors.

			Overriden from iriscore_resource, displays the
			xScanUser and xIndexer fields as read-only. -->
<@dynamichtml iris_document_author_field@>

	<$if isInfo$>

		<tr>
			<td valign=center class="field_caption_info">Scanned by:</td>
			<td valign=center class="field_value_info"><$#active.xScanUser$></td>
		</tr>
		<tr>
			<td valign=center class="field_caption_info">Indexed by:</td>
			<td valign=center class="field_value_info"><$#active.xIndexer$></td>
		</tr>
	
	<$else$>
		
		</tr>
			<td valign=center class="field_caption">Scanned by:</td>
			<td valign=center class="field_value"><$#active.xScanUser$></td>
		</tr>
		<tr>
			<td valign=center class="field_caption">Indexed by:</td>
			<td valign=center class="field_value">
				<$#active.xIndexer$>
				<input type="hidden" name="xIndexer" value="<$dUser$>" />
			</td>
		</tr>
		
	<$endif$>
		
	<tr><td><br/></td></tr>

<@end@>

<!-- Displays the document type (dDocType) field.

			Overriden from iriscore_resource, always shows
			the dDocType as label-only. An extra link to the
			parent document is displayed if this is a 
			ChildDocument. -->
<@dynamichtml iris_document_type_field@>

	<tr>
		<$if isInfo$>

			<td valign=center class="field_caption_info">Type:</td>
			<td valign=center class="field_value_info"><$dDocType$></td>

		<$else$>

			<td valign=center class="field_caption">Type:</td>
			<td valign=center class="field_value">
				<$dDocType$>
			</td>
		<$endif$>
			
		<input type="hidden" name="dDocType" value="<$dDocType$>">
		<input type="hidden" name="dDocType_old" value="<$dDocType$>">	
	</tr>
	
	<$if dDocType like 'ChildDocument'$>
		<tr>		
			<$if isInfo$>

				<td valign=center class="field_caption_info">Parent item:</td>
				<td valign=center class="field_value_info">
					<a href="<$HttpCgiPath$>?IdcService=DOC_APPROVAL<$include add_idc_token_to_url$>&dDocName=<$#active.xParentDocName$>"><$#active.xParentDocName$></a>
				</td>
	
			<$else$>
	
				<td valign=center class="field_caption">Parent item:</td>
				<td valign=center class="field_value">
					<a href="<$HttpCgiPath$>?IdcService=DOC_APPROVAL<$include add_idc_token_to_url$>&dDocName=<$#active.xParentDocName$>"><$#active.xParentDocName$></a>
				</td>
			<$endif$>	
				
		</tr>	
	<$endif$>	
	

	<$tabIndex = tabIndex+1$>

<@end@>

<@dynamichtml ccla_org_account_code_field@>

	<input 	type="text" 
					name="xOrgAccountCode" id="xOrgAccountCode" 
					value="<$#active.xOrgAccountCode$>" 
					class="input_text_field" style="width: 8em;"
					tabindex="<$include iris_get_next_tabindex$>" />
	
	
	<!-- OrgAccountCode lookup button -->
	<a 		name="orgAccountCodeLookupButton" id="orgAccountCodeLookupButton" 
			class="iris_button ccla_search_button ccla_search" style="margin-left: 5px;" 
			title="Lookup org account code" href="#" onclick="lookupClientData();this.focus();return false;" tabindex="<$include iris_get_next_tabindex$>"></a>
		
	<div 		class="ccla_ajax_loader" style="display:none" id="orgAccountCodeLookupLoadIndicator">
	</div>


<@end@>

<!-- Custom field display for xFormId field. Shows an adjacent lookup button,
	 which can be used to fetch form data based on the value of this field. -->
<@dynamichtml ccla_form_id_field@>

	<input 	type="text" name="xFormId" id="xFormId" value="<$#active.xFormId$>"
			tabindex="<$include iris_get_next_tabindex$>" 
			style="width: 8em" class="input_text_field" />
	
	<!-- Form data lookup button -->
	<a 	name="formDataLookupButton" id="formDataLookupButton" 
			class="iris_button ccla_search_button ccla_search iris_button_rest" style="margin-left: 5px;" 
			title="Lookup form data"
			href="#"
			onclick="lookupFormData();return false;" 
			tabindex="<$include iris_get_next_tabindex$>">
	</a>
	
	<!-- Dynamic container for Form ID-related links, info etc. -->
	<div id="formIdPanel" style="float: left; clear: left; padding: 0px; margin: 0px; width: 100%;">
		<a id="editSubscriptionLink" href="?" style="display:none" target="_BLANK">View subscription details</a>
		
		<!-- Special anchor/link for displaying a custom link associated with the form. -->
		<a id="customFormLink" href="?" style="display:none" target="_BLANK">?</a>
		
		<div id="formValidityCheckboxPanel" style="display:none">
			<div style="clear:both"></div>
			
			<input 	type="checkbox" 
					id="formValidityCheckbox" 
					name="formInvalid" 
					onclick="updateFormValidityState()" /> Form invalid
		</div>
		
	</div>
	
	<!-- Script to support form data lookup. -->
	<script type="text/javascript">
		
		// Stores valid Form IDs following a server side lookup.
		var returnedFormId = "";
		
		var isLookingUpFormData = false;
		
		// Triggered after clicking search button adjacent to Form ID field.
		lookupFormData = function() {
			if (isLookingUpFormData)
				return;
		
			isLookingUpFormData = true;
		
			// remove any existing lookup error message and styling
			$("#docFieldError_xFormId").remove();
			$("#xFormId")
			 .removeClass("validation_error_field")
			 .removeClass("validation_warning_field")
			 .removeClass("validation_verified_field");
		
			var getFormDataUrl = "?IdcService=CCLA_CS_GET_DOCMETA_BY_FORM_ID<$include add_idc_token_to_url$>";
			var formId = $("#xFormId").val();

			var docId 	= document.forms['doc_fields'].dID.value;
			var docName = document.forms['doc_fields'].dDocName.value;
			
			if (formId == "") {
				alert("You must enter a form ID to perform a data lookup.");
				isLookingUpFormData = false;
				return;
			}
			
			// Change button graphic to show loading animation
			$("#formDataLookupButton").removeClass("ccla_search").addClass("ccla_searching");
			$("#formDataLookupButton").css("visibility","hidden");
			$("#formDataLookupButton").css("visibility","visible");
			
			// Hide any form ID-specific links/controls.
			hideEditSubscriptionLink();
			hideCustomFormLink();
			hideFormValidityCheckbox();
			
			// Reset the cached Form ID.
			returnedFormId = "";
			
			// Fetch form data via AJAX
			$.getJSON(getFormDataUrl, 
				{ 	docName: 	docName,
					docId:		docId,
					formId: 	formId,
					IsJson: 	1,
					ts: 		new Date().getTime()
				}, function(jsonData) {lookupFormDataCompleted(jsonData)} 
			);
		};
		
		// Callback function after a form data lookup request
		lookupFormDataCompleted = function(jsonData) {
			isLookingUpFormData = false;
			
			// Reset button graphic
			$("#formDataLookupButton").removeClass("ccla_searching").addClass("ccla_search");
			
			if (jsonData == "") {
				displayFieldErrorMsg("xFormId","Form data not found",
				"No data found for this form ID.");
			} else {
				var jsonErrorMsg  = getJsonErrorMsg(jsonData);
				
				if (jsonErrorMsg) {
					// something went wrong during web service call. Display
					// an error message.
					displayFieldErrorMsg("xFormId","Error", jsonErrorMsg);
					setDocPanelEnabled(true);
					
				} else {
					// Fetch the rsForm ResultSet. This contains the matched row from
					// the FORM table.
					var rsForm = jsonData.ResultSets.rsForm;
					var formId = jsonData.LocalData.formId;
				
					if (formId)
						returnedFormId = formId;
				
					// Fetch the rsFormMeta ResultSet. This contains name-value
					// pairs for document metadata fields
					var rsFormMeta = jsonData.ResultSets.rsFormMeta;
					var numRows = getJsonResultSetNumRows(rsFormMeta);
					
					for (var i=0; i<numRows; i++) {
						var fieldName 	= getJsonResultSetValue(rsFormMeta, "NAME", i);
						var value		= getJsonResultSetValue(rsFormMeta, "VALUE", i);
						
						if (document.doc_fields[fieldName])
							document.doc_fields[fieldName].value = value;
						
						// Special case for SUBSCRIPTION_ID, if its present. Display a link
						// below the FormId field with a link to the appropriate Edit
						// Subscription page.
						if (fieldName == "SUBSCRIPTION_ID") {
							displayEditSubscriptionLink(value);
						}
						
						if (fieldName == "IS_SINGLETON" && value == "1") {
							displayFormValidityCheckbox(getJsonResultSetValue(rsForm, "IS_VALID", 0));
						}
					}
					
					// Check for custom Info/Warn/Error messages and display them.
					var rsFormMessages = jsonData.ResultSets.rsFormMessages;
					
					for (var i=0; i<getJsonResultSetNumRows(rsFormMessages); i++) {
						var msgType 	= getJsonResultSetValue(rsFormMessages, "MSG_TYPE", i);
						var msgHeader	= getJsonResultSetValue(rsFormMessages, "MSG_HEADER", i);
						var msgBody		= getJsonResultSetValue(rsFormMessages, "MSG_BODY", i);
					
						displayFieldMsg(
							msgType.toLowerCase(),
							"xFormId",
							msgHeader, 
							msgBody
						);
					}
					
					var formValidityLevel = jsonData.LocalData.FORM_VALIDITY_LEVEL;
					
					if (formValidityLevel) {
						if (formValidityLevel == "VALID") {
							// Form ID was validated without error or warning. Apply 'validated' style
							$("#xFormId").addClass("validation_verified_field"); 
						} else if (formValidityLevel == "WARNING") {
							$("#xFormId").addClass("validation_warning_field"); 
						} else if (formValidityLevel == "ERROR") {
							$("#xFormId").addClass("validation_error_field"); 
						}
					}
					
					// Check for Custom Form Link paramers in the local data. If they are present,
					// build and display the custom link.
					var customLinkUrl = jsonData.LocalData.CUSTOM_FORM_LINK_URL;
					var customLinkLabel = jsonData.LocalData.CUSTOM_FORM_LINK_LABEL;
					
					if (customLinkUrl) {
						// Custom Link was passed back from server. Modify the existing link element
						// to match the passed parameters and display it.
						displayCustomFormLink(customLinkUrl,customLinkLabel);
					}
				}
			}
		};
		
		// Sets/unsets the IS_VALID flag for the current Form.
		updateFormValidityState = function() {
			// Update form validity status immediately
			
			if (!returnedFormId) {
				alert("No form ID detected from server. " +
				 "Try clicking the magnifying glass button next to the Form ID field and try again.");
				return false;
			}
			
			$.post("?",
				{
					"IdcService":	"CCLA_CS_UPDATE_FORM_VALIDITY_STATE",
					"FORM_ID":		returnedFormId,
					"formInvalid":	$("#formValidityCheckbox").is(":checked") ? 1 : 0,
					"IsJson":		1,
					"ts":			new Date().getTime()
				}, function(data) {
					// Update doc class to CONDINS, if the form was marked invalid.
					if ($("#formValidityCheckbox").is(":checked"))
						$("#xDocumentClass").val("CONDINS");
				}
			);
		};
		
		// Replaces the href content of the View Subscription Details link with a link
		// to the passed Subscription ID.
		displayEditSubscriptionLink = function(subscriptionId) {
			$("#editSubscriptionLink").attr("href", 
			 "?IdcService=CCLA_CS_SUBSCRIPTION_EDIT<$include add_idc_token_to_url$>&SUBSCRIPTION_ID=" 
			 + subscriptionId+"&xFormId="+returnedFormId);
			$("#editSubscriptionLink").css("display","block");
		};
		
		// Hides the Edit Subscription link from view.
		hideEditSubscriptionLink = function() {
			$("#editSubscriptionLink").css("display","none");
		};
		
		// Modifies and displays the custom form link, with the given URL and label.
		displayCustomFormLink = function(url, label) {
			$("#customFormLink").attr("href", url);
			$("#customFormLink").html(label);
			
			$("#customFormLink").css("display", "block");
		}
		
		// Resets and hides the custom form link from view.
		hideCustomFormLink = function(url, label) {
			$("#customFormLink").css("display", "none");
			
			$("#customFormLink").attr("href", "?");
			$("#customFormLink").html("?");
		}
		
		displayFormValidityCheckbox = function(isValid) {
			$("#formValidityCheckboxPanel").css("display","");
			
			if (isValid === "0") {
				$("#formValidityCheckbox").attr("checked","checked");
			} else {
				$("#formValidityCheckbox").removeAttr("checked","checked");
			}
		};
		
		hideFormValidityCheckbox = function() {
			$("#formValidityCheckboxPanel").css("display","none");
		};
		
	</script>
	
	
	
<@end@>

<!-- Custom field display for xWithInstruction field. Shows a button adjacent to the
     Yes/No drop-down list, which launches the multi-doc config page in a new window.
     -->
<@dynamichtml ccla_with_instruction_field@> 
	
	<$if isTrue(isWorkflowItem)$>
	
		<$docName = #active.dDocName$>
		<$parentDocName = #active.dDocName$>
		<$executeService("SPP_INT_Q_GET_WITHINSTRUCTION_ROWS")$>
	
		<$if rsWithInstructionDocs$>
			<$numChildDocs = rsWithInstructionDocs.#numRows$>
		<$endif$>

		<select name="xWithInstruction" id="xWithInstruction"
						class="input_option_field"
						onchange="withInstructionChanged(this);" 
						tabindex="<$include iris_get_next_tabindex$>" >
			<option value="No"  <$if #active.xWithInstruction like 'No'$>selected="selected"<$endif$> >No</option>
			<option value="Yes" <$if #active.xWithInstruction like 'Yes'$>selected="selected"<$endif$> >Yes</option>
		</select>
	
		<!-- Instruction doc button. Opens Child Docs popup window. -->
		<a 	name="instructionDocsButton" id="instructionDocsButton" 
				class="iris_button ccla_child_docs_button" style="margin-left: 5px;" 
				title="Add instruction documents"
				href="#"
				onclick="openChildDocPopup();return false;" 
				tabindex="<$include iris_get_next_tabindex$>">
					
			<$if #active.xWithInstruction like "Yes"$>
				<$numChildDocs$>
			<$endif$>
		</a>
		
		<!-- Instruction doc advanced options button. Displays a panel underneath the With Instruction field,
			 allowing users to link items to a particular MAND/APP in the current envelope, or any other envelope. -->
		<a 	name="instructionDocsAdvButton" id="instructionDocsAdvButton" 
				class="iris_button ccla_instr_docs_adv_button" style="margin-left: 5px;" 
				title="Display instruction document options"
				href="#"
				onclick="loadInstructionSelect('<$xBundleRef$>','<$dDocName$>','<$xDependantDocName$>');return false;" 
				tabindex="<$include iris_get_next_tabindex$>">
					
			...
		</a>
		
		<!-- Contains advanced with-instruction options (HTML content added via JavaScript) -->
		<div id="with_instruction_dropdown_container" style="margin-top: 22px"></div>
	
	<$else$>
		
		<$#active.xWithInstruction$>
	
	<$endif$>
	
<@end@>

<!-- Custom field display for xPaymentRef field. Shows an adjacent lookup button,
	 which can be used to fetch indexing data if this matches against a pending payment. -->
<@dynamichtml ccla_payment_ref_field@>

	<input 	type="text" name="xPaymentRef" id="xPaymentRef" value="<$#active.xPaymentRef$>"
			tabindex="<$include iris_get_next_tabindex$>" 
			style="width: 11em" class="input_text_field" />
	
	<!-- Payment Ref data lookup button -->
	<a 	name="paymentRefLookupButton" id="paymentRefLookupButton" 
			class="iris_button ccla_search_button ccla_search iris_button_rest" style="margin-left: 5px;" 
			title="Lookup Payment Ref data"
			href="#"
			onclick="lookupPaymentRefData();return false;" 
			tabindex="<$include iris_get_next_tabindex$>">
	</a>
	
	<!-- Dynamic container for Payment Ref-related links, info etc. -->
	<div id="paymentRefDataPanel" style="float: left; clear: left; padding: 0px; margin: 0px; width: 100%;">
		<a id="editPaymentSubscriptionLink" href="?" style="visibility:hidden" target="_BLANK">View subscription details</a>
		
		<style type="text/css">
			
			#subscriptionPaymentSummaryTable {
				margin: 5px 0px 0px 0px;
				width: 100%;
			}
			
			#subscriptionPaymentSummaryTable th {
				text-align: left;
				border: 1px solid #BBB;
				background-color: #FFF0DB;
			}
			
			#subscriptionPaymentSummaryTable td {
				text-align: left;
				border: 1px solid #BBB;
			}
			
		</style>
		
		<table id="subscriptionPaymentSummaryTable" style="display:none;" cellspacing=0 cellpadding=2>
			<tr>
				<th>Prev Payments</th>
				<td id="subscriptionPayment_Previous">
				
				</td>
			</tr>
			<tr>
				<th>Expected</td>
				<td id="subscriptionPayment_Expected">
				
				</td>
			</tr>
			<tr>
				<th>Diff</th>
				<td id="subscriptionPayment_Difference">
					
				</td>
			</tr>
		</table>
	</div>
	
	<!-- Script to support form data lookup. -->
	<script type="text/javascript">
		
		var isLookingUpPaymentRef = false;
		
		lookupPaymentRefData = function() {
			if (isLookingUpPaymentRef)
				return;
		
			isLookingUpPaymentRef = true;

			// remove any existing lookup error message and styling
			$("#docFieldError_xPaymentRef").remove();			
			
			$("#xPaymentRef")
			 .removeClass("validation_error_field")
			 .removeClass("validated_field")
			 .removeClass("validation_warning_field");
		
			var getPaymentRefDataUrl = "?IdcService=CCLA_CS_GET_DOCMETA_BY_PAYMENT_REF" +
			 "<$include add_idc_token_to_url$>";
			
			var paymentRef = $("#xPaymentRef").val();
			var docClass 	= document.forms['doc_fields'].xDocumentClass.value;
			var amount 		= document.forms['doc_fields'].xAmount.value;
			
			var formId		= "";
			
			if (document.forms['doc_fields'].xFormId)
				formId = document.forms['doc_fields'].xFormId.value;
			
			var docId = 	document.forms['doc_fields'].dID.value;
			
			if (paymentRef == "") {
				alert("You must enter a Payment Ref to perform a data lookup.");
				return;
			}
			
			// Hide any Payment Ref-specific links.
			hidePaymentEditSubscriptionLink();
			
			// Hide the Payment summary table
			$("#subscriptionPaymentSummaryTable").css("display","none");
			
			// Change button graphic to show loading animation
			$("#paymentRefLookupButton")
			 .removeClass("ccla_search")
			 .addClass("ccla_searching")
			 .css("visibility","hidden")
			 .css("visibility","visible");
			
			// Disable form field
			$("#xPaymentRef").attr("disabled","disabled");
			
			// Fetch form data via AJAX
			$.getJSON(getPaymentRefDataUrl, 
				{ 	
					"paymentRef": 	paymentRef,
					"formId":		formId,
					"docClass":		docClass,
					"amount": 		amount,
					"dID":			docId,
					IsJson: 		1,
					ts: 			new Date().getTime()
				}, function(jsonData) {
					// Successful call.
					lookupPaymentRefDataCompleted(jsonData)
				}, function(data) {
					// Error
					lookupPaymentRefDataCompleted(jsonData)
				}
			);
		};
		
		lookupPaymentRefDataCompleted = function(jsonData) {
			
			isLookingUpPaymentRef = false;
			
			// Change button graphic to show default image
			$("#paymentRefLookupButton").removeClass("ccla_searching").addClass("ccla_search");
				
			// Re-enable form field
			$("#xPaymentRef").removeAttr("disabled");
			
			if (jsonData == "" || !jsonData.LocalData) {
				displayFieldErrorMsg("xPaymentRef","Error",
				"No data found for this Payment Ref");
			} else {
				var jsonErrorMsg  = getJsonErrorMsg(jsonData);
				
				if (jsonErrorMsg) {
					// something went wrong during web service call. Display
					// an error message.
					displayFieldErrorMsg("xPaymentRef","Error", jsonErrorMsg);
					
					setDocPanelEnabled(true);
				} else {
					var paymentStatus = jsonData.LocalData.SubscriptionPaymentStatus;
				
					if (paymentStatus == "RED")
						$("#xPaymentRef").addClass("validation_error_field");
					else if (paymentStatus == "AMBER")
						$("#xPaymentRef").addClass("validation_warning_field");
					else
						$("#xPaymentRef").addClass("validated_field");
					
					// Display detailed status message about the Subscription.
					var msg = jsonData.LocalData.SubscriptionPaymentStatusMessage;
					
					if (jsonData.ResultSets.rsPaymentRefMeta) {
						// Auto-indexing metadata was returned - this must be a deposit.
						// Append something to the message indicating the doc will be
						// auto-indexed (see below).
						msg = "<b>Item auto-indexed from Subscription data</b><br/><br/>" + msg;
					}
					
					// Display error/warning message.
					if (paymentStatus == "RED" || paymentStatus == "AMBER") {
						displayFieldErrorMsg("xPaymentRef","", msg);
						if (paymentStatus == "AMBER") {
							$("#xPaymentRef").removeClass("validation_error_field");
						}
					}
					
					if (jsonData.LocalData.SubscriptionAmount) {
						var expectedPayment = jsonData.LocalData.SubscriptionAmount;
						var previousPayments = jsonData.LocalData.TotalPaymentAmount;
						var difference = jsonData.LocalData.PaymentDifference;
					
						// Populate and display the payment summary table - appears beneath the
						// Payment Ref field.
						$("#subscriptionPayment_Previous").html(previousPayments);
						$("#subscriptionPayment_Expected").html(expectedPayment);
						$("#subscriptionPayment_Difference").html(difference);
						
						$("#subscriptionPaymentSummaryTable").css("display","");
					}
					
					if (jsonData.LocalData.SUBSCRIPTION_ID && jsonData.LocalData.SUBSCRIPTION_ID != "")
						displayPaymentEditSubscriptionLink(jsonData.LocalData.SUBSCRIPTION_ID);
					
					// Fetch the rsPaymentRefMeta ResultSet, if present. This contains name-value
					// pairs for associated payment metadata fields.
					// Currently will be empty/missing if a Form ID was present on the document, or
					// this item is not assumed to be a Deposit.
					var rsPaymentRefMeta = jsonData.ResultSets.rsPaymentRefMeta;
					
					if (rsPaymentRefMeta) {
						var numRows = getJsonResultSetNumRows(rsPaymentRefMeta);
						
						for (var i=0; i<numRows; i++) {
							var fieldName 	= getJsonResultSetValue(rsPaymentRefMeta, "NAME", i);
							var value		= getJsonResultSetValue(rsPaymentRefMeta, "VALUE", i);
							
							if (document.doc_fields[fieldName])
								document.doc_fields[fieldName].value = value;
								
							if (fieldName == "SUBSCRIPTION_ID" && value != "")
								displayPaymentEditSubscriptionLink(value);
						}
					}
				}
			}
		}
		
		// Replaces the href content of the View Subscription Details link with a link
		// to the passed Subscription ID.
		displayPaymentEditSubscriptionLink = function(subscriptionId) {
			$("#editPaymentSubscriptionLink").attr("href", 
			 "?IdcService=CCLA_CS_SUBSCRIPTION_EDIT<$include add_idc_token_to_url$>&SUBSCRIPTION_ID=" + subscriptionId);
			$("#editPaymentSubscriptionLink").css("visibility","visible");
		}
		
		// Hides the Edit Subscription link from view.
		hidePaymentEditSubscriptionLink = function() {
			$("#editPaymentSubscriptionLink").css("visibility","hidden");
		}
		
	</script>
	
<@end@>

<!-- Custom field display for xNominatedContactPoint field. 

	 Shows an option list that displays all available addresses for the current account's
	 nominated Correspondent record.
	 
     -->
<@dynamichtml ccla_nominated_contact_point_field@> 
	
	[[% Store the saved value in a hidden field. When rebuilding the option list below, this
		value is referred to when deciding which value to select in the rebuilt list. %]]
	<input 	type="hidden" 
			name="selectedContactPointId" 
			id="selectedContactPointId" 
			value="<$#active.xNominatedContactPoint$>" />
	
	<select name="xNominatedContactPoint" id="xNominatedContactPoint"
					style="width: 95%"
					class="input_option_field"
					disabled="disabled"
					tabindex="<$include iris_get_next_tabindex$>" >
		
		<option value="">N/A</option>
		
	</select>
	
	[[% Displays the name of the nominated correspondent, with a link to their Edit Person page. %]]
	<div style="padding-top: 2px; clear: both;">
		<a 		id="nominatedCorrespondentLink"
				style="display:none;"
				href="" target="_BLANK"></a>
	</div>
	
	<script type="text/javascript">
		
		// Bind change function to the option list which updates the hidden input value.
		$(document).ready( function() {
			$("#xNominatedContactPoint").bind("change", function() {
				$("#selectedContactPointId").val($(this).val());
			});
		});
		
	</script>

<@end@>

<@dynamichtml ccla_get_with_instruction_parent_docs@>
	<$include iris_build_batch_item_query$>
	<$QueryText = batchItemQuery$>
	
	<$QueryText = QueryText & " <and> (xDocumentClass <matches> `MAND` <or> xDocumentClass <matches> `AUTOMAND` <or> xDocumentClass <matches> `MANDSHORT` <or> xDocumentClass <matches> `APP` <or> xDocumentClass <matches> `APPSHORT`)"$>
	
	<$if strLength(#active.thisDocName) > 0$>
		<$QueryText = QueryText & " <and> <not> (dDocName <matches> `" & thisDocName & "`)"$>
	<$endif$>
	
	<$executeService("GET_SEARCH_RESULTS")$>
	<$temp = rsRename("SearchResults", "rsInstructionBatchItems")$>
<@end@>

<@dynamichtml ccla_get_with_instruction_dependancies_dropdown@>
	
	<$include ccla_get_with_instruction_parent_docs$>
	
	<$parentIsInEnvelope=0$>
	
	<$if isTrue(#active.isManualLookup) or strLength(#active.selectedDocName) == 0$>
		<$parentIsInEnvelope=1$>
	<$else$>
		<$loop rsInstructionBatchItems$>
			<$if strEquals(rsInstructionBatchItems.dDocName,#active.selectedDocName)$>
				<$parentIsInEnvelope=1$>
			<$endif$>		
		<$endloop$>
	<$endif$>
	
	<$if not isTrue(parentIsInEnvelope)$>
		<$c="The parent must be contained in a different bundle. Get the bundle of the parent doc and get the dropdown based on that"$>
		
		<$dDocName=#active.selectedDocName$>
		<$executeService("DOC_INFO_BY_NAME")$>
		
		<$temp = rsRename("rsInstructionBatchItems", "rsInstructionBatchItems_OLDER1")$>
		<$temp = rsRename("SearchResults", "SearchResults_OLDER1")$>
		
		<$bundleRef=DOC_INFO.xBundleRef$>
		<$include ccla_get_with_instruction_parent_docs$>
	<$endif$>
		
		<br style="line-height: 5px" />
		<div style="padding: 4px; margin-bottom: 5px; border: 1px solid #AAA; background-color: #CCC;">
		
			<!--Allow users to choose which document it is a With Instruciton of-->
			<input type="text" value="<$bundleRef$>" 
			onKeyPress="{if (event.keyCode==13){loadInstructionSelect(this.value, '<$#active.thisDocName$>', '<$#active.selectedDocName$>');return false;}}" 
			size="11"/>
			
			<select 
				name="xDependantDocName" 
				id="xDependantDocName" 
				style="width:170px;">
				
				<option value="">Auto</option>
				
				<$loop rsInstructionBatchItems$>
					<option value="<$rsInstructionBatchItems.dDocName$>" 
						<$if strEquals(rsInstructionBatchItems.dDocName,#active.selectedDocName)$>selected<$endif$>>
							
							<$rsInstructionBatchItems.dDocName$> (<$rsInstructionBatchItems.xDocumentClass$>)
					
					</option>
				<$endloop$>
			</select>
		
		</div>
	

<@end@>

<!--	Custom field display for Multi Doc flag field, as used against Invoice (INV)
		documents. -->
<@dynamichtml ccla_invoice_line_items_field@> 

	<select name="xMultiDoc" id="xMultiDoc" 
					class="input_option_field"
					onchange="multiDocChanged(this);" 
					tabindex="<$include iris_get_next_tabindex$>" >
		<option value="No"  <$if #active.xMultiDoc like 'No'$>selected="selected"<$endif$> >No</option>
		<option value="Yes" <$if #active.xMultiDoc like 'Yes'$>selected="selected"<$endif$> >Yes</option>
	</select>

	<!-- Multi docs button. Opens Invoice Line Items popup window. -->
	<a 	name="multiDocsButton" id="multiDocsButton" 
			class="iris_button ccla_child_docs_button" style="margin-left: 5px;" 
			title="Add multi docs" 
			href="#"
			onclick="openInvoiceLineItemsPopup();return false;" 
			tabindex="<$include iris_get_next_tabindex$>">
						
		<$if #active.xMultiDoc like "Yes"$>
			<$#local.numChildDocs$>
		<$endif$>
	</a>
	
	<script type="text/javascript">
		
		var requiredParentInvoiceFields 
		 = "<$#env.CCLA_CommProc_Invoices_RequiredParentFields$>";
		var requiredParentInvoiceFieldsCaptionList 
		 = "<$#env.CCLA_CommProc_Invoices_RequiredParentFieldCaptions$>";
		
		var missingParentInvoiceFields = false;
		
		$(document).ready( function() {
			var reqParentInvoiceFields = requiredParentInvoiceFields.split(",");
			
			for (var i=0; i<reqParentInvoiceFields.length; i++) {
				var reqParentInvoiceField = reqParentInvoiceFields[i];
			
				var field = document.forms["doc_fields"][reqParentInvoiceField];
				
				if (!(field && field.value)) {
					// At least one missing field. Prevent user from opening the
					// Add Items pop-up.
					//alert(reqParentInvoiceField + " missing");
					missingParentInvoiceFields = true;
				}
			}
		});
		
		// Set the enabled state of the Line Items button based on the value
		// of the Multi-Doc field.
		setInvoiceLineItemsButtonState = function(updated) {
			var multiDocVal = $("#xMultiDoc").val();
			
			if (multiDocVal == "No")
				setButtonEnabled("multiDocsButton",false);
			else {
				setButtonEnabled("multiDocsButton",true);
					
				// Open the pop-up.
				if (updated && !missingParentInvoiceFields)
					openInvoiceLineItemsPopup();
			}
		};
		
		openInvoiceLineItemsPopup = function() {
			// remove any existing lookup error message
			$("#xMultiDoc").removeClass("validation_error_field");
			$("#docFieldError_xMultiDoc").remove();
			
			var multiDocVal = $("#xMultiDoc").val();
			if (multiDocVal == "No")
				return;
			
			if (missingParentInvoiceFields) {
				// Can't open the pop-up yet - missing fields.
				displayFieldErrorMsg("xMultiDoc","Data missing",
				 "Ensure ALL the following fields are set and saved first: " 
				 + requiredParentInvoiceFieldsCaptionList);
				return;
			}
			
			var popupUrl = 	'?IdcService=CCLA_INVOICE_LINE_ITEMS<$include add_idc_token_to_url$>' +	
							'&bundleRef=<$#active.xBundleRef$>&parentDocName=<$#active.dDocName$>' +
							'&targetGrossAmount=<$#active.xAmount$>';

			window.open(
				popupUrl, 
				'invoiceLineItems_<$#active.dDocName$>', 
				'resizable=1,width=1010,height=580'
			);
		};
		
		multiDocChanged = function() {
			// Automatically change the Doc Class to match the multi-line item state.
			if ($("#xMultiDoc").val() == "Yes")
				$("#xDocumentClass").val("MULTIINV");
			else
				$("#xDocumentClass").val("INV");
			
			// Save changes before continuing. This will display the appropriate fields
			// for the document class.
			saveDocInfo();
			
			//setInvoiceLineItemsButtonState(true);
		};
		
		$(document).ready( function() {
			setInvoiceLineItemsButtonState(false);
		});
		
	</script>
	
	
<@end@>

<!--	Custom field display for Multi Doc flag field. Adds an event handler to the
			form element. -->
<@dynamichtml ccla_multi_doc_field@> 

	<$if isTrue(isWorkflowItem)$>

		<select name="xMultiDoc" id="xMultiDoc" 
						class="input_option_field"
						onchange="multiDocChanged(this);" 
						tabindex="<$include iris_get_next_tabindex$>" >
			<option value="No"  <$if #active.xMultiDoc like 'No'$>selected="selected"<$endif$> >No</option>
			<option value="Yes" <$if #active.xMultiDoc like 'Yes'$>selected="selected"<$endif$> >Yes</option>
		</select>
	
		<!-- Multi docs button. Opens Child Docs popup window. -->
		<a name="multiDocsButton" id="multiDocsButton" 
						class="iris_button ccla_child_docs_button" style="margin-left: 5px;" 
						title="Add multi docs" 
						href="#"
						onclick="openChildDocPopup();return false;" 
						tabindex="<$include iris_get_next_tabindex$>">
							
			<$if #active.xMultiDoc like "Yes"$>
				<$numChildDocs$>
			<$endif$>
		</a>
	
	<$else$>
		
		<$#active.xMultiDoc$>
	
	<$endif$>

	<!-- Script to support instruction/multi doc fields. -->
	<script type="text/javascript">
		
		// stores the number of child docs. value gets replaced by later IDOC
		var numChildDocs = <$if numChildDocs$><$numChildDocs$><$else$>0<$endif$>;
		
		// List of available multi-doc classes
		var multiDocClassList = "<$#env.CCLA_multiDocClasses$>";

		// disable the instruction docs pop-up button and adv. options button
		if (document.doc_fields.xWithInstruction &&
				document.doc_fields.xWithInstruction.value == "No") {
			setButtonEnabled("instructionDocsButton",false);
			
			setButtonEnabled("instructionDocsAdvButton",false);
		}
		
		// disable the multi docs pop-up button
		if (document.doc_fields.xMultiDoc &&
				document.doc_fields.xMultiDoc.value == "No") {
			setButtonEnabled("multiDocsButton",false);
		}
		
		// Opens the child doc popup window.
		openChildDocPopup = function() {
			var multiDocFlag = "";
			
			if ($("#xMultiDoc").val() == "Yes")
				multiDocFlag = "&isMultiDoc=1";
			
			var docClass = document.doc_fields.xDocumentClass.value;
			
			if (multiDocFlag != "") {
				// User has flagged this item as having multi-docs. Ensure doc class
				// is valid.
				if (docClass && multiDocClassList.indexOf(docClass) < 0) {
					
					// Pad the list with spaces so it can be printed nicely
					multiDocClassList =
					 multiDocClassList.replace(new RegExp(",", 'g'), ", ");

					alert("You may only append multi-instruction docs to the following document classes: " +
					multiDocClassList + ".\n\n" +
					"Change the document class if you wish to append multi-instruction docs.");
					return;
				}
			} else {

				if (!getDocumentClass(docClass).isMandate) {
					alert("You may only append with-instruction docs to Mandate/Application items. \n\n" +
					"Change the document class to one of these types if you wish to append with-instruction docs.");
					return;
				}
			}
			
			var childDocUrl = 	'?IdcService=GET_DOC_PAGE<$include add_idc_token_to_url$>&Action=GetTemplatePage&Page=CCLA_WITHINSTRUCTION_POPUP' +	
								'&bundleRef=<$#active.xBundleRef$>&docName=<$#active.dDocName$>';
			
			var company, clientNum;
			
			var companyField = $("select[name='xCompany']");
			
			if ($(companyField).size() > 0 && !$(companyField).val()) {
				alert("Please select a Company value before opening the popup.");
				return;
			}
			
			clientNum = $("input[name='xClientNumber']").val();
			
			childDocUrl += multiDocFlag + "&company=" + company + "&clientNumber=" + clientNum;
			window.open(childDocUrl, 'docInstructions_<$#active.dDocName$>', 'resizable=1,width=1000,height=670');
		}
			
		updateSigsButton = function() {
			var frm = document.doc_fields;
			
			var clientNum = frm.elements['xClientNumber'];
			var clientAccNum = frm.elements['xAccountNumber'];
			
			if (clientNum) {
				if (clientNum.value.length > 0) {
						$("#viewSigsButton").removeAttr("disabled");
				} else {
						$("#viewSigsButton").attr("disabled","disabled");
				}
			}
		}
			
		// Triggered after 'View Signatures' button is pressed. Opens a pop-up
		// window displaying any signatures which correspond to the current
		// company value.
		viewSigs = function() {
			var frm = document.doc_fields;
			
			var clientNum = frm.elements['xClientNumber'];
			var clientAccNum = frm.elements['xAccountNumber'];
			
			if (clientNum && clientNum.value.length > 0) {
				var sigSearchAttribs = "&clientNum=" + clientNum.value;
				
				if (clientAccNum && clientAccNum.value.length > 0)
					sigSearchAttribs += "&clientAccNum=" + clientAccNum.value;
			
				// Open the View Signatures template with the given search params
				window.open("<$HttpCgiPath$>?IdcService=CCLA_VIEW_SIGNATURES<$include add_idc_token_to_url$>" + sigSearchAttribs, "sig_window",
										"menubar=0,resizable=0,status=0,width=550,height=500");
			} else {
				alert("No client number specified.");
			}
		}
		
		// Triggered after xWithInstruction select value updated.
		// Enables/disables the 'Edit child docs' button.
		withInstructionChanged = function(sel) {
		
			if (!isWorkflowItem)
				return; // no child doc edited allowed after doc has left workflow
			
			if (sel.value == "Yes") {
				$("#xMultiDoc").val("No");
				
				$("#instructionDocsButton").html(numChildDocs);
				$("#multiDocsButton").html("");
				
				setButtonEnabled("multiDocsButton",false);
				setButtonEnabled("instructionDocsButton",true);
				setButtonEnabled("instructionDocsAdvButton",true);
				
				allowUsersToSpecifyParent(true);
				
				saveDocInfo();
			} else {
				$("#instructionDocsButton").html("");
				
				setButtonEnabled("instructionDocsButton",false);
				setButtonEnabled("instructionDocsAdvButton",false);
				
				allowUsersToSpecifyParent(false);
			}
			
		}
		
		allowUsersToSpecifyParent = function(withInstruction){
			try{			
				var objDependantDocName = document.getElementById('xDependantDocName');
				var objWithInstructionButton = document.getElementById('withInstructionButton');
		
				if(!withInstruction){
					$("#with_instruction_dropdown_container").hide();
					objDependantDocName.value = "";
					
				}
			}catch(err){}
			
			if(!withInstruction) 
					$("#instructionDocsButton").html("<input type='hidden' name='xDependantDocName' value=''/>");
		}
				
		multiDocChanged = function(sel) {
			if (!isWorkflowItem)
				return; // no multi doc editing allowed after doc has left workflow
				
			if (sel.value == "Yes") {
				$("#xWithInstruction").val("No");
				
				$("#multiDocsButton").html(numChildDocs);
				$("#instructionDocsButton").html("");
				
				setButtonEnabled("multiDocsButton",true);
				setButtonEnabled("instructionDocsButton",false);
				saveDocInfo();
			} else {
				$("#multiDocsButton").html("");
				
				setButtonEnabled("multiDocsButton",false);
			}
			
			
		}
		
		// Updates the total number of instruction docs displayed on the button label.
		// Called from the Instruction Docs popup window.
		updateInstructionDocCount = function(totalDocs) {
			numChildDocs = totalDocs;
			
			if (totalDocs && totalDocs > 0) {
				
				if ($("#xWithInstruction").val() == "Yes") {
					$("#instructionDocsButton").html(totalDocs);
					$("#multiDocsButton").html("");
					
				} else {
					$("#multiDocsButton").html(totalDocs);
					$("#instructionDocsButton").html("");
				}
			} else {
				$("#multiDocsButton").html("");
				$("#instructionDocsButton").html("");
			}
		}

		//Ajax call to fetch dropdown with allowable parents fors an instruction document
		loadInstructionSelect = function(bundleRef, thisDocName, selectedDocName) {
			var withInstruction = document.getElementById('xWithInstruction');
			
			if(withInstruction.value == "Yes"){
				var url = "?IdcService=CCLA_GET_INCLUDE<$include add_idc_token_to_url$>&incName=ccla_get_with_instruction_dependancies_dropdown&bundleRef=" + bundleRef
					+ "&thisDocName=" + thisDocName + "&selectedDocName=" + selectedDocName + "&isManualLookup=1";
				
				var d = new Date();
				
				$.get(url + '&rt=' + d.getTime(),
					null, 
					function(data){
						$("#with_instruction_dropdown_container").html(data);
					}
				);
			}
		}
		
	</script>

<@end@>

<!--	Custom field display for Process Date field. Forces the field to be
		read-only unless you have privileged access. -->
<@dynamichtml ccla_process_date_field@>
	
	<!--Hidden value used to trigger the updateFilter code-->
	<input type="hidden" name="IRIS_DOC_PANEL_SAVE_REQUEST" value="1" />

	<input type="text" name="xProcessDate" value="<$formatDateOnly(#active.xProcessDate)$>"
			tabindex="<$include iris_get_next_tabindex$>" />

<@end@>


<!-- 	Custom field display for Account no. field. Provides a signature lookup
		button, this opens a pop-up window displaying a list of signatures
		which map to the given Client/Acc numbers.
			
		This field also has a Client Data lookup button - this uses an Aurora
		web service to fetch associated client data for a given company/client no.
     -->
<@dynamichtml ccla_account_num_field@> 

	<input 	type="text" 
					name="xAccountNumber" id="xAccountNumber" 
					value="<$#active.xAccountNumber$>" 
					onkeyup="updateSigsButton()"
					onblur="updateFundField()"
					class="input_text_field" style="width: 8em;"
					tabindex="<$include iris_get_next_tabindex$>" />
	
	<!-- Account info view button -->
	<a 		name="clientViewButton" id="accountViewButton" 
			class="iris_button ccla_search_button ccla_client_data" style="margin-left: 5px;" 
			title="View account data" href="#" onclick="openAccountData();this.focus();return false;" tabindex="<$include iris_get_next_tabindex$>"></a>
	
	<!-- Client info lookup button -->
	<a 		name="clientLookupButton" id="clientLookupButton" 
			class="iris_button ccla_search_button ccla_search" style="margin-left: 5px;" 
			title="Lookup client data" href="#" onclick="lookupClientData();this.focus();return false;" tabindex="<$include iris_get_next_tabindex$>"></a>
		
	<div 		class="ccla_ajax_loader" style="display:none" id="clientLookupLoadIndicator">
	</div>
	
	<!-- Initially-hidden bank account selector. -->
	
	<!-- Reserve 10 tab indexes for the list of bank accounts. -->
	<input 	type="hidden" 
			name="bankAccountTabIndex" 
			id="bankAccountTabIndex"
			value="<$include iris_get_next_tabindex$>" />	
	<$tabIndex = tabIndex+10$>
	
	<div style="clear:both"></div>
	
	<div name="bankAccountSelector" 
			id="bankAccountSelector"
			class="bank_account_list"
			style="display:none">

	</div>
	
<@end@>

<!-- Custom field display for xOrgAccountCode, that shows a list of Organisations
	 marked as Suppliers in the database.
	 
	 A text input field is displayed above the select list - this will display
	 the selected Org Account Code, and allow the user to enter their own.xt
	 *Removed text field for now.
	 
	 -->
<@dynamichtml ccla_org_account_code_supplier_field@>
	
	[[%
	<input type="text"
		   name="xOrgAccountCode" 
		   id="xOrgAccountCode"
		   class="input_option_field"
		   tabindex="<$include iris_get_next_tabindex$>"

		   value="<$#active.xOrgAccountCode$>" />
	%]]
		   
	<!-- We know we are indexing an Invoice item now, so load in ref data sets
		 for payment code option lists displayed further down. -->
	<$executeService("CCLA_CP_GET_INVOICE_REF_DATA")$>
	
	<select name="xOrgAccountCode" 
			id="xOrgAccountCode"
			class="input_option_field"
			style="width: 80%"
			tabindex="<$include iris_get_next_tabindex$>" >

		<option value=""></option>
		
		<$ELEMENT_ATTRIBUTE_ID = #env.CCLA_CS_OrgElementAttributeId_Supplier$>
		<$ATTRIBUTE_STATUS = 1$>
		<$executeService("CCLA_CS_GET_ORGS_WITH_ATTRIBUTE_STATUS")$>
		
		<$loop rsOrgsWithAttributeStatus$>
			<option value="<$#active.ORG_ACCOUNT_CODE$>" 
					<$if #active.xOrgAccountCode like #active.ORG_ACCOUNT_CODE$>selected<$endif$>
					><$#active.ORGANISATION_NAME$></option>
		<$endloop$>
		
	</select>
	
	<!-- Client info view button -->
	<a 	name="clientViewButton" id="clientViewButton" 
		class="iris_button ccla_search_button ccla_client_data" style="margin-left: 5px;" 
		title="View supplier organisation data" href="#" onclick="openOrgInfoFromCode('xOrgAccountCode');this.focus();return false;" tabindex="<$include iris_get_next_tabindex$>"></a>
	
	
	<script type="text/javascript">
		
		/*
		
		Disabled for now.
		
		$(document).ready( function() {
			// Bind change event to xOrgAccountCode selector. This will populate the xOrgAccountCode
			// text input with the selected code.
			$("#xOrgAccountCode_selector").bind("change", function() {
				if ($(this).val() != $("#xOrgAccountCode").val())
					$("#xOrgAccountCode").val($(this).val());
			});
			
			// Bind change event to xOrgAccountCode text input. This will change the selected
			// value of the xOrgAccountCode selector to match the code, if applicable.
			$("#xOrgAccountCode").bind("change", function() {
				
				if ($(this).val() != $("#xOrgAccountCode_selector").val())
					$("#xOrgAccountCode_selector").val($(this).val());
			});
		});
		
		*/

		// Opens an Organisation record, using the ORG_ACCOUNT_CODE value from
		// the form field with the passed name/ID.
		openOrgInfoFromCode = function(fieldName) {
			// remove any existing lookup error message
			$("#" + fieldName).removeClass("validation_error_field");
			$("#docFieldError_" + fieldName).remove();
			
			var orgAccCode = $("#" + fieldName).val();
			
			if (orgAccCode == "") {
				displayFieldErrorMsg(fieldName,"Data missing",
				 "Enter/select an organisation first");
				return;
			}
			
			var w = window.open("?IdcService=CCLA_CS_ENTITY_INFO<$include add_idc_token_to_url$>" + 
			 "&ORG_ACCOUNT_CODE=" + orgAccCode); 
		}
	
	</script>
	
<@end@>

<!-- Custom field display for xDestinationOrgAccountCode, that shows a list of Organisations
	 marked as 'Liable for Invoice Payment' in the database.
	 
	 A text input field is displayed above the select list - this will display
	 the selected Org Account Code, and allow the user to enter their own. 
	  *Removed text field for now.
-->
<@dynamichtml ccla_liability_field@>
	
	
	[[%
	<input type="text"
		   name="xDestinationOrgAccountCode" 
		   id="xDestinationOrgAccountCode"
		   class="input_option_field"
		   tabindex="<$include iris_get_next_tabindex$>"

		   value="<$#active.xDestinationOrgAccountCode$>" />
	%]]
		   
	<select name="xDestinationOrgAccountCode" 
			id="xDestinationOrgAccountCode"
			class="input_option_field"
			style="width: 80%"
			tabindex="<$include iris_get_next_tabindex$>" >

		<option value=""></option>
		
		<$ELEMENT_ATTRIBUTE_ID = #env.CCLA_CS_OrgElementAttributeId_Liable$>
		<$ATTRIBUTE_STATUS = 1$>
		<$executeService("CCLA_CS_GET_ORGS_WITH_ATTRIBUTE_STATUS")$>
		
		<$loop rsOrgsWithAttributeStatus$>
			<option value="<$#active.ORG_ACCOUNT_CODE$>" 
					<$if #active.xDestinationOrgAccountCode like #active.ORG_ACCOUNT_CODE$>selected<$endif$>
					><$#active.ORGANISATION_NAME$></option>
		<$endloop$>
		
	</select>
	
	<!-- Client info view button -->
	<a 	name="clientViewButton" id="clientViewButton" 
		class="iris_button ccla_search_button ccla_client_data" style="margin-left: 5px;" 
		title="View liabile organisation data" href="#" onclick="openOrgInfoFromCode('xDestinationOrgAccountCode');this.focus();return false;" tabindex="<$include iris_get_next_tabindex$>"></a>
	
	<div style="clear: both"></div>
	
	<!-- Provide link for adding new Suppliers/Orgs -->
	<a href="?IdcService=CCLA_CS_CONTACT_LOOKUP<$include add_idc_token_to_url$>&searchScope=organisation" 
	   target="_BLANK">Add new supplier/liable org...</a>

	<script type="text/javascript">
	
		$(document).ready( function() {
			/*
			
			Disabled for now.
			
			// Bind change event to xDestinationOrgAccountCode selector. This will populate the 
			// xDestinationOrgAccountCode text input with the selected code.
			$("#xDestinationOrgAccountCode_selector").bind("change", function() {
				if ($(this).val() != $("#xDestinationOrgAccountCode").val())
					$("#xDestinationOrgAccountCode").val($(this).val());
			});
			
			// Bind change event to xDestinationOrgAccountCode text input. This will change the selected
			// value of the xDestinationOrgAccountCode selector to match the code, if applicable.
			$("#xDestinationOrgAccountCode").bind("change", function() {
				
				if ($(this).val() != $("#xDestinationOrgAccountCode_selector").val())
					$("#xDestinationOrgAccountCode_selector").val($(this).val());
			});
			
			*/
		});

	</script>
	
<@end@>

<!-- Custom field display for Invoice Cost Centre field (xClientName) -->
<@dynamichtml ccla_cost_centre_field@>
	
	<select name="xClientName" 
			id="xClientName"
			class="input_option_field"
			style="width: 90%"
			tabindex="<$include iris_get_next_tabindex$>" >

		<option value=""></option>
		
		<$loop rsCostCentres$>
			<option value="<$#active.COST_CENTRE_CODE$>" 
					<$if #active.xClientName like #active.COST_CENTRE_CODE$>selected<$endif$>
					><$#active.COST_CENTRE_CODE$></option>
		<$endloop$>
		
	</select>

<@end@>

<!-- Custom field display for Invoice Dept/Pro Code field (xFund) -->
<@dynamichtml ccla_dept_pro_code_field@>
	
	<select name="xFund" 
			id="xFund"
			class="input_option_field"
			style="width: 90%"
			tabindex="<$include iris_get_next_tabindex$>" >

		<option value=""></option>
		
		<$loop rsDeptProjectCodes$>
			<option value="<$#active.DEP_PROJECT_CODE$>" 
					<$if #active.xFund like #active.DEP_PROJECT_CODE$>selected<$endif$>
					><$#active.DEP_PROJECT_CODE$></option>
		<$endloop$>
		
	</select>

<@end@>

<!-- Custom field display for Invoice Nominal/GL Code field (xClientServicesRef) -->
<@dynamichtml ccla_nominal_gl_code_field@>
	
	<select name="xClientServicesRef" 
			id="xClientServicesRef"
			class="input_option_field"
			style="width: 90%"
			tabindex="<$include iris_get_next_tabindex$>" >

		<option value=""></option>
		
		<$loop rsGeneralLedgers$>
			<option value="<$#active.GL_CODE$>" 
					<$if #active.xClientServicesRef like #active.GL_CODE$>selected<$endif$>
					><$#active.GL_CODE$></option>
		<$endloop$>
		
	</select>

<@end@>

<!-- Updated script used for client/account data lookup. Uses central database. -->
<@dynamichtml ccla_mailhandling_account_field_db_js@>
			
	<script type="text/javascript">
		
		var isFetchingAccountData = false;
		// Caches returned bank accounts from AJAX call
		var rsBankAccounts;
		
		// Caches nominated bank account ID from AJAX call
		var nominatedBankAccountId;

		$(document).ready( function() {
			// Execute on-load checks
			performPanelValidationExtra();
		
			// Force bank account fields to be read-only
			$("#doc_fields input[name='xBankAccountNumber']").attr("readonly","true");
			$("#doc_fields input[name='xSortCode']").attr("readonly","true");
		});

		// Open a new window showing Account info, providing the user has entered
		// Client Number and Account Number
		openAccountData = function() {
			
			// Remove existing error messages and error styling
			$("#err_xAccountNumber, #err_xClientNumber").remove();
			$("#xAccountNumber, #xClientNumber").removeClass("validation_error_field");
			
			var clientNum		= $("#xClientNumber").val();
			var clientAccNum 	= $("#xAccountNumber").val();
			var fundCode		= document.forms['doc_fields'].xFund.value;
			
			if (clientNum == "") {
				displayFieldErrorMsg("xClientNumber","Data missing",
				 "Enter a client no. to view the account info.");
				return;
			} else if (clientAccNum == "") {
				displayFieldErrorMsg("xAccountNumber","Data missing",
				 "Enter an account no. to view the account info.");
				return;
			}
			
			var w = window.open("?IdcService=CCLA_CS_ACCOUNT_INFO<$include add_idc_token_to_url$>&CLIENT_NUMBER=" + 
			 clientNum + "&ACCOUNT_NUMBER=" + clientAccNum + "&FUND_CODE=" + fundCode); 
		};
		
		// force account number to uppercase and capture the last few characters of the account number
		updateFundField = function() {
			var clientAccNum = $("#xAccountNumber").val();
			
			clientAccNum = clientAccNum.toUpperCase();
			$("#xAccountNumber").val(clientAccNum);
			
			// auto-insert Fund value
			if (clientAccNum.length > 0) {
				var currentFund  = $("input[name='xFund']").val();
				
				if (currentFund == "")
					try{
						var suffixLast = "";
						var suffixSecondLast = "";
						var suffixThirdLast = "";
						
						if(clientAccNum.length >= 3)
							suffixThirdLast = clientAccNum.substring(clientAccNum.length - 3, clientAccNum.length - 2);
						
						if(clientAccNum.length >= 2)
							suffixSecondLast = clientAccNum.substring(clientAccNum.length - 2, clientAccNum.length - 1);
							
						if(clientAccNum.length >= 1)
							suffixLast = clientAccNum.substring(clientAccNum.length - 1, clientAccNum.length);
						
						var fundValue = "";
						
						if(suffixThirdLast.match("[A-Z]") && suffixSecondLast.match("[A-Z]") && suffixLast.match("[A-Z]")){
							fundValue = suffixThirdLast + suffixSecondLast + suffixLast;
						}else if(suffixSecondLast.match("[A-Z]") && suffixLast.match("[A-Z]")){
							fundValue = suffixSecondLast + suffixLast;
						}else if(suffixLast.match("[A-Z]")){
							fundValue = suffixLast;
						}
						
						$("input[name='xFund']").val(fundValue);
					}catch(err){
						$("input[name='xFund']").val(clientAccNum.substr(clientAccNum.length - 1, clientAccNum.length));
					}
			}
		};
		
		// fetches org/client (and optionally bank account) data.
		lookupClientData = function() {
			
			if (isFetchingAccountData) {
				// Still pending a service call. Do nothing
				return;
			}
			
			// Remove any existing client lookup error message
			$("#doc_fields input[name='xAccountNumber']").removeClass("validation_error_field");
			$("#docFieldError_xAccountNumber").remove();
			$("#docFieldError_xClientNumber").remove();
			
			$("#err_Aurora_WS").remove();
			$("#err_xAccountNumber").remove();
			$("#err_xClientNumber").remove();
		
			var frm = document.doc_fields;
			
			// Central DB Org Account Code
			var orgAccountCode	= "";
			
			if ($("#doc_fields #xOrgAccountCode").size() > 0)
				orgAccountCode = $("#doc_fields #xOrgAccountCode").val();
			
			// Aurora Client data fields.
			var clientNum = "", company = "", clientAccNum = "", docClass = "", fundCode = "";

			if ($("#doc_fields input[name='xClientNumber']").size() > 0)
				clientNum = $("#doc_fields input[name='xClientNumber']").val();
			if ($("#doc_fields select[name='xCompany']").size() > 0)
				company = $("#doc_fields select[name='xCompany']").val();
			
			if ($("#doc_fields input[name='xAccountNumber']").size() > 0)
				clientAccNum = $("#doc_fields input[name='xAccountNumber']").val();
			
			if ($("#doc_fields input[name='xFund']").size() > 0)
				fundCode = $("#doc_fields input[name='xFund']").val();
			
			// Doc class field.
			if ($("#doc_fields select[name='xDocumentClass']").size() > 0)
				docClass = $("#doc_fields select[name='xDocumentClass']").val();
			
			if (orgAccountCode) { 
				// Org Account Code present - use this instead of Client Number/Company.
			
			} else if (clientNum == "" || (company == "" && fundCode == "")) {			
				if ($("#doc_fields input[name='xAccountNumber']").size() > 0) {
					displayFieldErrorMsg("xAccountNumber","Data missing",
					 "Enter an Org Code, or Client no and Company/Acc. No., to perform a lookup.");
					return;
				} else {
					displayFieldErrorMsg("xClientNumber","Data missing",
					 "Enter an Org Code, or Client no and Company/Acc. No., to perform a lookup.");
					return;
				}
			}
			
			isFetchingAccountData = true;
	
			// Change button graphic to show loading animation
			$("#clientLookupButton").removeClass("ccla_search").addClass("ccla_searching");
			$("#clientLookupButton").css("visibility","hidden");
			$("#clientLookupButton").css("visibility","visible");
			
			// Disable associated form fields
			setClientDataFieldsEnabled (false);
			
			// Set nomianted Contact Point option list to 'Loading' state
			setNominatedContactPointOptionListLoading();
			
			// Special fix to ensure Org Account Code is NOT passed if Client Number/Company is present.
			// No need for this now - backend logic updated to use Client Number/Company to run lookup
			// in preference of Org Account Code.
			
			$.getJSON("?IdcService=CCLA_CS_GET_ENTITY_DATA_FOR_INSTRUCTION<$include add_idc_token_to_url$>", 
				{ 	
					"ORG_ACCOUNT_CODE":		orgAccountCode,
					"COMPANY": 				company,
					"CLIENT_NUMBER": 		clientNum,
					"ACCOUNT_NUMBER":		clientAccNum,
					"FUND_CODE":			fundCode,
					"DOC_CLASS":			docClass,
					"ts":					new Date().getTime(),
					"IsJson": 1
				}, function(jsonData) {
					lookupClientDataCompleted(jsonData, company, clientNum, clientAccNum)
				} 
			);
		};
		
		// Enables/disables form fields associated with client data lookup function
		setClientDataFieldsEnabled = function(enable) {
			var fields = "input[name='xOrgAccountCode'], select[name='xCompany'], input[name='xClientNumber'], input[name='xAccountNumber'], " +
			 "input[name='xBankAccountNumber'], input[name='xSortCode'], " +
			 "textarea[name='xClientName']";
			
			if (enable) {
				$(fields).removeAttr("disabled");
			} else {
				$(fields).attr("disabled","disabled");
			}
		};

		// Callback function used after client data request completes. Displays
		// the bank acc no, sort code and client name if the lookup succeeded
		lookupClientDataCompleted = function(jsonData, company, clientNum, clientAccNum) {
			
			var completed = false;
			
			if (jsonData == "") {	
				displayFieldErrorMsg("xAccountNumber","Invalid data",
				"No client data found.");
				
				completed = true;
			} else {	
				var jsonErrorMsg  = getJsonErrorMsg(jsonData);
		
				if (jsonErrorMsg) {
					// something went wrong during web service call. Display
					// an error message in the message cell.
					
					displayFieldErrorMsg("xAccountNumber","Data lookup failed", jsonErrorMsg);
					
					/*
					var errorMsg = createErrorMsg("Aurora_WS","Error looking up client data", jsonErrorMsg);		
					document.getElementById("statusText").appendChild(errorMsg);
					*/
					
					completed = true;
				} else {
					var rsEntity 	= jsonData.ResultSets.rsEntity;
					var entityName 	= getJsonResultSetValue(rsEntity, "ORGANISATION_NAME");
					
					var orgAccountCode 	= getJsonResultSetValue(rsEntity, "ORG_ACCOUNT_CODE");
					if (orgAccountCode){
						$("#xOrgAccountCode").val(orgAccountCode);
					}
					
					// Insert Entity name into form field
					document.doc_fields['xClientName'].value = entityName;
					
					// Details for nominated bank account, if applicable.
					nominatedBankAccountId = jsonData.LocalData.bankAccountId;

					var bankAccountNumber = jsonData.LocalData.bankAccountNumber;
					var bankSortCode = jsonData.LocalData.bankSortCode;
					
					// Returned list of related bank accounts
					rsBankAccounts = jsonData.ResultSets.rsBankAccounts;
					
					if (nominatedBankAccountId 
						|| 
						(rsBankAccounts && rsBankAccounts.rows.length == 0)) {
						// Add nominated/zero account details by default, if bank account
						// fields are currently empty.
						if (!isBankAccountDetailsPresent()) {
							document.doc_fields['xBankAccountNumber'].value = bankAccountNumber;
							document.doc_fields['xSortCode'].value = bankSortCode;
							
							colorBankFields(jsonData);
						}
					}

					// Display selectable list of bank accounts, below Account Number
					// field.
					displayBankAccountList();
					
					if(jsonData.LocalData.CLIENT_NUMBER || jsonData.LocalData.CLIENT_NUMBER === "")
						$("#xClientNumber").val(jsonData.LocalData.CLIENT_NUMBER);
					if(jsonData.LocalData.ACCOUNT_NUMBER)
						$("#xAccountNumber").val(jsonData.LocalData.ACCOUNT_NUMBER);
					if(jsonData.LocalData.COMPANY_CODE  || jsonData.LocalData.COMPANY_CODE === "")
						$("[name='xCompany']").val(jsonData.LocalData.COMPANY_CODE);
					if(jsonData.LocalData.FUND_CODE || jsonData.LocalData.FUND_CODE === "")
						$("[name='xFund']").val(jsonData.LocalData.FUND_CODE);
						
					//A caught silent error has occurred, display it.
					if (jsonData.LocalData.EXTRA_ERROR_MSG)
						displayFieldErrorMsg("xAccountNumber","Data lookup failed", jsonData.LocalData.EXTRA_ERROR_MSG);

					completed = true;
				}
			}
			
			if (completed) {
				isFetchingAccountData = false;
				
				// Change button graphic to show default image
				$("#clientLookupButton").removeClass("ccla_searching").addClass("ccla_search");
				
				// Re-enable form fields
				setClientDataFieldsEnabled(true);
				
				// Display select list of addresses, if available
				populateNominatedContactPointOptionList(jsonData);
			}
		};
		
		// Displays a list of selectable bank account links below the account number
		// field.
		displayBankAccountList = function() {
			var bankAccountSel = $("#bankAccountSelector");
			
			// clear current list.
			bankAccountSel.html("");
			
			if (!rsBankAccounts)
				return;
			
			// Fetch starting tab index to use for the bank account links.
			var bankAccountTabIndex = $("#bankAccountTabIndex").val();
	
			if (rsBankAccounts.rows.length == 0) {
				// Display single entry in list, informing the user there are no
				// linked bank accounts
				var thisBankAccountOpt = document.createElement("div");

				$(thisBankAccountOpt)	.addClass("bank_account_list_item")
										.addClass("bank_account_no_data");
				$(thisBankAccountOpt).html("(No linked bank accounts)");
				
				$(bankAccountSel).append(thisBankAccountOpt);
				
			} else {
				// Generate an anchor element for each bank account
				for (var i=0; i<rsBankAccounts.rows.length; i++) {
					var thisBankAccountOpt = document.createElement("a");
					
					var thisId = getJsonResultSetValue
					 (rsBankAccounts, "BANK_ACCOUNT_ID", i);
					
					$(thisBankAccountOpt).attr("tabindex",++bankAccountTabIndex);
					$(thisBankAccountOpt).addClass("bank_account_list_item")
										 .addClass("bank_account_selectable");
					
					// Attach href attribute which triggers select method
					$(thisBankAccountOpt).attr("href", "#");
					$(thisBankAccountOpt).bind("click", function() { 
						bankAccountSelected(this); 
					});

					var thisAccountNumber = getJsonResultSetValue
					 (rsBankAccounts, "ACCOUNT_NO", i);
					var thisSortCode = getJsonResultSetValue
					 (rsBankAccounts, "SORT_CODE", i); 
					 
					var thisAccountName = getJsonResultSetValue
					 (rsBankAccounts, "ACCOUNT_NAME", i); 
					 
					var thisBuildingSocietyNumber = getJsonResultSetValue
					 (rsBankAccounts, "BUILDING_SOCIETY_ROLL_NUMBER", i); 
					
					// Apply styles
					if (nominatedBankAccountId && (thisId == nominatedBankAccountId)) {
						// This is the nominated account.
						$(thisBankAccountOpt).addClass("validated_field");
					} else {
						$(thisBankAccountOpt).addClass("validation_warning_field");
					}
					
					$(thisBankAccountOpt).attr("id", "bankAccount_" + thisId);
					
					// Create span which contains the Account No. and Sort Code
					var bankAccNumberSpan = document.createElement("span");
					$(bankAccNumberSpan).addClass("bank_account_number");
					
					$(bankAccNumberSpan).html(thisAccountNumber + " - " + thisSortCode);

					// This bank account matches the current doc metadata.
					if (isCurrentBankAccountDetails(thisAccountNumber, thisSortCode)) {
						$(thisBankAccountOpt).addClass("selected_bank_account_list_item");
					}
					
					// Create span which contains the Account Name
					var bankAccNameSpan = document.createElement("span");
					$(bankAccNameSpan).html(thisAccountName);
					$(bankAccNameSpan).addClass("bank_account_name");
					
					// Build Bank Account anchor content
					$(thisBankAccountOpt).append(bankAccNumberSpan)
										 .append("<br/>")
										 .append(bankAccNameSpan);
					
					$(bankAccountSel).append(thisBankAccountOpt);
				}
			}
			
			// Add extra 'Clear details' link at the end of the list, if there
			// are currently bank details present.
			if (isBankAccountDetailsPresent()) {
				var clearBankAccountOpt = document.createElement("a");
				$(clearBankAccountOpt).attr("href","#");
				
				$(clearBankAccountOpt).bind("click", function() {
					clearBankDetails(); 
				});
				
				$(clearBankAccountOpt).html("Clear selected bank details");
				$(clearBankAccountOpt)	.addClass("bank_account_list_item")
										.addClass("validation_warning_field")
										.addClass("bank_account_selectable");
								
				$(clearBankAccountOpt).attr("tabindex",++bankAccountTabIndex);

				$(bankAccountSel).append(clearBankAccountOpt);
			}
			
			// Display the bank account list
			$(bankAccountSel).slideDown("fast");
		};
		
		// Returns true if both Bank Account Number and Sort Code fields
		// are non-null.
		isBankAccountDetailsPresent = function() {
			return (document.doc_fields['xBankAccountNumber'].value != ""
					&&
					document.doc_fields['xSortCode'].value != "");
		};
		
		// Returns true if the passed Bank Account Number and Sort Code values
		// match the corresponding metadata values.
		isCurrentBankAccountDetails = function(bankAccountNumber, sortCode) {
			return (document.doc_fields['xBankAccountNumber'].value == bankAccountNumber
					&&
					document.doc_fields['xSortCode'].value == sortCode);
		};
		
		// Clears the current contents of the Bank Account Number and Sort Code fields.
		clearBankDetails = function() {
			document.doc_fields['xBankAccountNumber'].value = "";
			document.doc_fields['xSortCode'].value 			= "";
			
			// Prepare a fake JSON data object to pass to the color bank fields function
			var colorData = new Object();
			colorData.LocalData = new Object();
				
			colorBankFields(colorData);
			
			doCloseBankAccountList();

			// Prevent further propagation of href action
			return false;
		};
		
		// Method triggered after a fetched bank account is selected. Copies the selected
		// bank account data into the bank account/sort code fields and colours the fields
		// accordingly.
		bankAccountSelected = function(bankAccountOpt) {
			var selBankAccountId = $(bankAccountOpt).attr("id").substring("bankAccount_".length); 
			
			var isNominatedAccountSelected = 
			 (nominatedBankAccountId && (selBankAccountId == nominatedBankAccountId));
			
			for (var i=0; i<rsBankAccounts.rows.length; i++) {
				var thisId = getJsonResultSetValue
				 (rsBankAccounts, "BANK_ACCOUNT_ID", i);
				 
				if (thisId == selBankAccountId) {
					document.forms["doc_fields"].xBankAccountNumber.value = 
					 getJsonResultSetValue(rsBankAccounts, "ACCOUNT_NO", i);
					 
					document.forms["doc_fields"].xSortCode.value = 
					 getJsonResultSetValue(rsBankAccounts, "SORT_CODE", i); 
					 
					break;
				}
			}
			
			// Prepare a fake JSON data object to pass to the color bank fields function
			var colorData = new Object();
			colorData.LocalData = new Object();
			
			colorData.LocalData.ENOUGH_DETAILS_FOR_CHECK = 1;
			
			if (isNominatedAccountSelected)
				colorData.LocalData.IS_NOMINATED_BANK_ACCOUNT = 1;
			else
				colorData.LocalData.IS_RELATED_BANK_ACCOUNT = 1;
				
			colorBankFields(colorData);
	
			doCloseBankAccountList();
			
			// Prevent further propagation of href action
			return false;
		};
		
		// Actions to perform after the user selects a bank account or
		// other action from the list of bank accounts.
		doCloseBankAccountList = function() {
			// hide current bank account list.
			$("#bankAccountSelector").css("display","none");
			
			// Focus on the next field after Bank Account fields (currently 
			// the xAmount field)
			$("#doc_fields input[name='xAmount']").focus();
		};
		
	</script>
	
	
<@end@>

<!-- 	Custom field display for Client no. field. Provides a static data lookup
		button, this opens a new window to the Client Services static data interface
		for the given client ID/company values.
     -->
<@dynamichtml ccla_client_num_field@> 

	<input 	type="text" 
					name="xClientNumber" id="xClientNumber" 
					value="<$#active.xClientNumber$>" 
					class="input_text_field" style="width: 8em;"
					tabindex="<$include iris_get_next_tabindex$>" />
		
	<!-- Client info view button -->
	<a 		name="clientViewButton" id="clientViewButton" 
			class="iris_button ccla_search_button ccla_client_data" style="margin-left: 5px;" 
			title="View client data" href="#" onclick="openClientData();this.focus();return false;" tabindex="<$include iris_get_next_tabindex$>"></a>
	

	<script type="text/javascript">

		openClientData = function() {
			// remove any existing client lookup error message
			$("#doc_fields input[name='xClientNumber']").removeClass("validation_error_field");
			$("#docFieldError_xClientNumber").remove();
			
			var frm = document.forms['doc_fields'];
			
			var clientNum 	= frm.elements['xClientNumber'].value;
			var company		= frm.elements['xCompany'].value;
			
			var clientName	= frm.elements['xClientName'].value;
			
			if (clientNum == "" || company == "") {
				displayFieldErrorMsg("xClientNumber","Data missing",
				 "Enter a company and client no. to view the client info.");
				return;
			}
			
			var w = window.open("?IdcService=CCLA_CS_ENTITY_INFO<$include add_idc_token_to_url$>&COMPANY=" + 
			 company + "&CLIENT_NUMBER=" + clientNum + "&CLIENT_NAME=" + clientName); 
		}

		//Function to check
		shouldPerformPendingCheck = function(docClass) {
			
			// TM: Users no longer require this check taking place. So we'll hardcode
			// the return to this function as false!
			return false;
			
			//1. Check for transactions or mandates
			/*
			if (!documentClassArr || documentClassArr.length==0) {
				alert("Not loaded any documentClasses");
				return false;
			} else {
				for (var i=0; i<documentClassArr.length; i++) {
					if (documentClassArr[i].name==docClass && (documentClassArr[i].isTransaction || documentClassArr[i].isMandate)) {
						return true;
					} 
				}
				return false;
			}
			*/
		}
		
		//Check for any pending APP,MAND,AUTOMAND documents that are pending for the current clientNumber and company
		//Cheated a bit by added this code here. Should really be in the xDocumentClass field
		checkForPendingDocs = function() {
			/*
			1. check if the xDocument class	to see if it is APP. MAND or AUTOMAND.
			2. if so, send an ajax JSON to get the data.
			3. check JSON localdata.hasPending=1. 
			4. if true, display the popup window.	
			*/
			var frm 			= document.forms['doc_fields'];
			var documentClass 	= frm.elements['xDocumentClass'].value;
			var clientNum 		= frm.elements['xClientNumber'].value;
			var company			= frm.elements['xCompany'].value;
			
			if (!(documentClass && clientNum && company)) {
				// Not enough data to run check.
				return;
			}
			
			// Determines whether the pending check panel will be displayed
			var hidePendingCheckPanel = 0;
			
			<$if #env.CCLA_HIDE_PENDING_CHECK_PANEL == 1 & userHasRole("admin")$>
				hidePendingCheckPanel = <$#env.CCLA_HIDE_PENDING_CHECK_PANEL$>
			<$endif$>

			// Always returns false now.
			var shouldCheck = shouldPerformPendingCheck(documentClass);
			
			if (shouldCheck && hidePendingCheckPanel == 0) {
				$.getJSON("?<$include add_idc_token_to_url$>",
					{ 
						"IdcService": "CCLA_GET_PENDING_DOCS_FOR_CLIENT",
						"bundleRef": "<$#active.xBundleRef$>",
						"clientNum": clientNum,
						"company": company,
						"IsJson": 1,
						"ts": new Date().getTime()
					}, 
					function(jsonData) {handlePendingCompleted(jsonData);}
				);
			}
		}
		
		// AJAX response handler after checking for pending client documents.
		// Displays a pop-up if a flag is present in the response data.
		handlePendingCompleted = function(jsonData) {
			
			if (jsonData=="") {
				alert("Error whilst checking for pending mandates: no data"); 
			} else {
				var jsonErrorMsg  = getJsonErrorMsg(jsonData);
		
				if (jsonErrorMsg) {
					alert("Error whilst checking for pending mandates: \n"+jsonErrorMsg);
				} else {
					var hasPendingDocs = jsonData.LocalData.hasPending;
					
					if (hasPendingDocs && hasPendingDocs == "1") {
						//show popup with number of with data
						openPopup("?IdcService=GET_DOC_PAGE<$include add_idc_token_to_url$>&Action=GetTemplatePage" +
						 "&Page=CCLA_PENDING_CHECKS&bundleRef=<$#active.xBundleRef$>&ts=" + new Date().getTime());
						 
						return;
					} 
				}
			}			
		}
		
		$(document).ready(function() {	
			checkForPendingDocs();	
			
			// Bind change event to xDocumentClass field
			$('[name=xDocumentClass]').change(function() {
				checkForPendingDocs();
			});
		});
	</script>
	
	<$include ccla_mailhandling_account_field_db_js$>
	
	<!-- 	Hidden field for storing old document class value. 
			Used to trigger updates on changes to doc class field. -->
	<input 	type="hidden" name="xDocumentClass_OLD" 
			value="<$if #active.xDocumentClass$><$#active.xDocumentClass$><$else$>[NONE]<$endif$>" />
	
<@end@>


<!-- 	Custom field display for bank account no. field.
			Displays a read-only span tag instead of an editable
			text element.
     -->
<@dynamichtml ccla_bank_account_num_field@> 
	
	<span id="bankAccountNumValue" style="display: block; margin-top: 5px"></span>
	
<@end@>

<!-- Panel used to automatically fetch and display the next pending bundle.
	 -->
<@dynamichtml bundle_autofetch_panel@>
	
	<div class="message_panel error_icon" style="width:185px;">
		<a href="?IdcService=CCLA_GET_NEXT_BUNDLE<$include add_idc_token_to_url$>">Open next pending bundle</a>
	</div>

<@end@>





<!-- Panel used when in bundle item edit mode, shows read-only data
     relating to the current bundle --> 
<@dynamichtml bundle_details_panel@>

	<$include greyPanel_top$>

		<div class='panelheader'>
			
			<form name="bundle_fields" id="bundle_fields">
				<input type="hidden" name="bundleDocName" value="<$dDocName$>" />
				<input type="hidden" name="bundleRef" value="<$#local.bundleRef$>" />
				<input type="hidden" name="bundleLockUser" value="<$#local.Iris_itemLockUser$>" />
				<input type="hidden" name="bundleStatus" value="<$xStatus$>" />
			</form>
			
			<table width='100%' cellspacing=0 cellpadding=0>
				<tr height=20>
					<td>
						<a name="bundledetails" id="bundledetails"></a>
						<span class='panelheading'>Bundle Details - <span class="docname"><$#local.bundleRef$></span></span>
					</td>
					<td width=22>
						<div onclick="togglePanelGoToLink(this, 'bundledetails')" id="toggle_bundle_details_panel" class="toggle_img_expand"></div>
					</td>
				</tr>
			</table>
		</div>

		<!-- This div has an ID so the display setting can be toggled between block/none -->
		<div id='bundle_details_panel' class='panelbody' style="overflow: hidden;display:none;">
			
			<table width="100%" cellspacing="2" cellpadding="0">
				<tbody>
					<tr>
						<td class="field_caption" valign="center">Status:</td>
						<td class="field_value_info" valign="center"><$#active.xStatus$> <$if xStatus like "Flagged"$>(<$#active.xDocumentAuthor$>)<$endif$> <span style="color: #BBB">[<$#active.xPriority$>]</span></td>
					</tr>
					<tr>
						<td class="field_caption" valign="center">Scanned by:</td>
						<td class="field_value_info" valign="center"><$#active.xScanUser$></td>
					</tr>
					<tr>
						<td class="field_caption" valign="center">Created:</td>
						<td class="field_value_info" valign="center"><$dInDate$></td>
					</tr>
					
					<$if xStatus like 'Completed'$>
						<tr>
							<td><br/></td>
						</tr>
						<tr>
							<td class="field_caption" valign="center">Workflow ID:</td>
							<td class="field_value_info" valign="center">
								<a 	href="<$HttpCgiPath$>?IdcService=IRIS_CLASSIFIED_ITEMS<$include add_idc_token_to_url$>&wfid=<$#active.xBatchNumber$>"
										title="Search for all items with this workflow ID"><$#active.xBatchNumber$></a>
							</td>
						</tr>
						<tr>
							<td class="field_caption" valign="center">Workflow date:</td>
							<td class="field_value_info" valign="center"><$#active.xWorkflowDate$></td>
						</tr>
						<$if userHasRole("admin") or userHasRole("sysman") or userHasRole("WF_Scanning Manager") or userHasRole("WF_COO")$>
							<tr>
								<td colspan=2>
									<br/>
									<a href="#" onClick="window.open('?IdcService=GET_DOC_PAGE<$include add_idc_token_to_url$>&Action=GetTemplatePage&Page=CCLA_DEP_DOCS_MANAGER&bundleRef=<$xBundleRef$>&potentialOldBundle=1', 'dep_docs_mgr', 'status=0,toolbar=0,width=850,height=550,resizable=1,scrollbars=1');return false;">Manage Supporting Docs</a>
								</td>
							</tr>
						<$endif$>
						
						<$if userHasRole("admin") or userHasRole("sysman") or userHasRole("WF_Scanning Manager") or userHasRole("WF_COO")$>
							[[% Special link to force-add a Completed bundle to the Instruction Register. 
								
								Should only be used if the bundle fails to make it into the Instruction Register post-validation, for whatever
								reason. Remember it will only create new instructions against docs that don't yet have a companion instruction,
								so this link won't have any affect on a bundle that was successfully submitted/converted by the Instruction Register.
							%]]
							
							<tr>
								<td colspan=2>
									<form name="forceAddBundleToInstructionRegisterForm">
										<input type="hidden" name="IdcService" value="CCLA_CP_ADD_DOC_BUNDLE" />
										<input type="hidden" name="bundleRef" value="<$#local.bundleRef$>" />
										<input type="hidden" name="persist" value="1" />
										
										<input type="hidden" name="RedirectUrl" value="?IdcService=DOC_APPROVAL&bundleRef=<$#local.bundleRef$>" />
									</form>
								
									<br/>
									<a href="#" onClick="document.forms['forceAddBundleToInstructionRegisterForm'].submit()">Force-add to Instruction Register</a>
								</td>
							</tr>
						<$endif$>
						
						<tr>
							<td colspan=2>
								<br/>
								<span class="docname">
									This bundle has been submitted to Workflow 
										<$if CCLA_CommProc_EnableDocBundleConversion$>
											or the Instruction Register (see log messages)
										<$endif$>
								</span>
							</td>
						</tr>
					
					<$elseif xStatus like 'Deleted'$>
						
						<tr>
							<td colspan=2>
								<br/>
								<span class="docname">
									This bundle has been deleted
								</span>
							</td>
						</tr>
						
					<$else$>
						<tr>
							<td class="field_caption" valign="top">Actions:</td>
							<td class="field_value_info" colspan=2>
								<!-- List bundle actions available to this user -->
								
								<a href="#" onClick="window.location.reload();" title="Refresh the page">Refresh</a>
								
								<$if not (xStatus like "Completed")$>
									<form name="update_bundle_status" id="update_bundle_status" method="POST">
										<input type="hidden" name="IdcService" value="CCLA_UPDATE_ITEM_STATUS" />
										<$include add_idc_token_to_form$>
										<input type="hidden" name="docName" value="<$#active.dDocName$>" />
										<input type="hidden" name="newStatus" value="Indexed" />
										<input type="hidden" name="RedirectUrl" 
												value="<$HttpCgiPath$>?IdcService=DOC_APPROVAL<$include add_idc_token_to_url$>&dDocName=<$#active.dDocName$>&bundleRef=<$#local.bundleRef$><$if autoFetch$>&autoFetch=1<$endif$>" />
									</form>
									
									<form name="unflag_bundle" id="unflag_bundle" method="POST">
										<input type="hidden" name="IdcService" value="CCLA_UNFLAG_BUNDLE_SUBMIT" />
										<$include add_idc_token_to_form$>
										<input type="hidden" name="bundleDocName" value="<$#active.dDocName$>" />
										<input type="hidden" name="RedirectUrl" 
												value="<$HttpCgiPath$>?IdcService=DOC_APPROVAL<$include add_idc_token_to_url$>&dDocName=<$#active.dDocName$>&bundleRef=<$#local.bundleRef$><$if autoFetch$>&autoFetch=1<$endif$>" />
									</form>
									
									<form name="reset_dual_indexing" id="reset_dual_indexing">
										<input type="hidden" name="IdcService" 	value="CCLA_RESET_BUNDLE_DUAL_INDEXING" />
										<$include add_idc_token_to_form$>
										<input type="hidden" name="bundleRef" 	value="<$#local.bundleRef$>" />
										<input type="hidden" name="dDocName" 	value="<$#active.dDocName$>" />
										
										<input type="hidden" name="RedirectUrl" value="<$HttpCgiPath$>?IdcService=DOC_APPROVAL<$include add_idc_token_to_url$>&dDocName=<$#active.dDocName$>&bundleRef=<$#local.bundleRef$>" />
										
									</form>
									
									<$if (xStatus like "Flagged")$>
										<!-- Bundle status is currently flagged - 
											 determine what the status was before it was flagged! -->
										
										<$previousBundleStatus="Completed"$>
										
										<$if DOC_WF_INFO.dWfStepName$>
											<$previousBundleStatus = DOC_WF_INFO.dWfStepName$>
										<$endif$>
										
										<a  href="javascript:unflagBundle()" 
											title="Remove flag from bundle">Unflag</a>
										
										<$if false$>
											<a  href="javascript:updateBundleStatus('<$previousBundleStatus$>')" 
												title="Remove flag from bundle">Unflag</a>
										<$endif$>
										
										<br/>
										
									<$endif$>
									
									<$if not (xStatus like "Flagged")$>
										<a  href="javascript:flagBundle();" 
											title="Flag bundle for attention">Flag</a>
										<br/>
									<$endif$>
									
									<$if DOC_WF_INFO.dWfStepName like "Validation"$>
									
										<$if userHasRole("admin") or userHasRole("WF_COO") or userHasRole("WF_Scanning")$>
											<a  href="javascript:resetDualIndexing();" 
												title="Resets Dual Indexing data for this bundle">Reset Dual Indexing</a>
											<br/>
										<$endif$>
									
									<$endif$>
									
									<script type="text/javascript">
										
										// Updates the bundle status by submitting a hidden form on the page.
										var updateBundleStatus = function(status) {
											changes = checkForChanges();

											// ensure there are no unsaved changes
											if (changes) {
												conf = confirm("You have unsaved changes to this item. Continue without saving?");
												if (!conf)
													return;
											}
										
											var frm = document.forms['update_bundle_status'];
											
											if (status == "Flagged") {
												if (!confirm("You are about to flag this bundle. Click OK if you have added " +
															 "a bundle note explaining your reasons for flagging the bundle."))
													return;
											}
											
											frm.elements['newStatus'].value = status;
											frm.submit();
										};
										
										// Un-flags the current bundle by submitting a hidden form on the page.
										var unflagBundle = function() {
											changes = checkForChanges();

											// ensure there are no unsaved changes
											if (changes) {
												conf = confirm("You have unsaved changes to this item. Continue without saving?");
												if (!conf)
													return;
											}
										
											var frm = document.forms['unflag_bundle'];
											frm.submit();
										};
										
										// Opens the 'Flag Bundle' popup, appending the currently-selected bundle
										// document to the URL.
										var flagBundle = function() {
											changes = checkForChanges();

											// ensure there are no unsaved changes
											if (changes) {
												conf = confirm("You have unsaved changes to this item. Continue without saving?");
												if (!conf)
													return;
											}
										
											var flagBundleUrl = "?IdcService=CCLA_FLAG_BUNDLE<$include add_idc_token_to_url$>" +
											 "&dDocName=<$#active.dDocName$>&bundleRef=<$#active.xBundleRef$>"; 
											
											if (window.frames.thumbsFrame) {
												var selDocName = window.frames.thumbsFrame.getSelThumbDocName();
												flagBundleUrl += "&selDocName=" + selDocName;
											}
											
											openPopup(flagBundleUrl);
										}
										
										// Resets Dual Indexing data for the bundle. Won't work if the bundle has
										// outstanding Dual Indexing items, or the status isn't 'Validation'
										var resetDualIndexing = function() {
											var c = confirm("This will reset the Dual Indexing process for all " +
											 "newly-added items, or items that failed a previous Dual Index check.\n\n" +
											 "Are you sure?");
															
											if (c)
												document.forms["reset_dual_indexing"].submit();
										}
										
									</script>
								<$endif$>
								<$if userHasRole("admin") or userHasRole("WF_COO") or userHasRole("WF_Scanning Manager")$>
									<form name="reset_duplicate" id="reset_duplicate">
										<input type="hidden" name="IdcService" value="CCLA_RESET_DUPLICATE_BUNDLE" />
										<$include add_idc_token_to_form$>
										<input type="hidden" name="bundleRef" value="<$#local.bundleRef$>" />
										<input type="hidden" name="dDocName" value="<$#active.dDocName$>" />

										<input type="hidden" name="RedirectUrl" value="<$HttpCgiPath$>?IdcService=DOC_APPROVAL<$include add_idc_token_to_url$>&dDocName=<$#active.dDocName$>&bundleRef=<$#local.bundleRef$>" />
									</form>
									
									<br/>
									
									<a href="javascript:if(confirm('Are you sure you want to reset duplicates for this bundle?'))document.forms['reset_duplicate'].submit();" title="result duplicates">Reset Duplicates</a>
									
								<$endif$>	
								<$if userHasRole("admin") or userHasRole("WF_COO") or userHasRole("WF_Scanning Manager")$>
										
									<form name="delete_bundle" id="delete_bundle">
										<input type="hidden" name="IdcService" value="CCLA_DELETE_BUNDLE" />
										<$include add_idc_token_to_form$>
										<input type="hidden" name="bundleRef" value="<$#local.bundleRef$>" />
										
										<input type="hidden" name="RedirectUrl" value="<$HttpCgiPath$>?IdcService=DOC_APPROVAL<$include add_idc_token_to_url$>&dDocName=<$#active.dDocName$>&bundleRef=<$#local.bundleRef$>" />
									</form>
									
									<br/>
									
									<a href="javascript:if(confirm('Are you sure you want to delete this bundle?'))document.forms['delete_bundle'].submit();" title="Delete this bundle">Delete</a>
								<$endif$>
														
							</td>
						</tr>
					<$endif$>
					
					<$include iris_batch_lock_display$>
					
				</tbody>
			</table>
			
		</div>
	<$include greyPanel_bottom$>
<@end@>

<!-- Overriden from iris_batchdocuments_resource.
		
	Allows certain roles to unlock any item/bundle.
 	-->
<@dynamichtml doc_approval_resolve_item_locking@>
		
	<$if #env.Iris_enableBatchLocking and #env.Iris_enableAutoBatchLocking$>
		<$executeService("IRIS_GET_ITEM_LOCK_INFO")$>
		<$trace("resolved batch lock user as: " & #local.Iris_itemLockUser)$>
		
		<$if Iris_itemLockUser and not (#local.Iris_itemLockUser like dUser)$>
			<!-- Bundle already locked by someone else - carry on. -->
					
		<$else$>
			<!-- 	Bundle currently unlocked, or locked by current user. -->
			
			<$if userCanWrite$>	
				<$if (not isWorkflowItem) or (isWorkflowItem and allowWorkflowActions)$>
					<$lockBatchToUser = 1$>
				<$endif$>
					
				<$if lockBatchToUser$>
					<$trace("locking batch to current user")$>
					<$dDocName = DOC_INFO.dDocName$>
					<$executeService("IRIS_ACQUIRE_ITEM_LOCK")$>
						
					<$if itemLockAcquired$>
						<!-- 	Success flag found in binder.
									Update Iris_itemLockUser to reflect new lock user -->
						<$Iris_itemLockUser = dUser$>
						<$userCanUnlock=1$>
							
					<$endif$>
						
				<$else$>
					<$userCanLock=""$>
				<$endif$>
			
			<$endif$>
		<$endif$>
			
		<$if not Iris_itemLockUser or (not (#local.Iris_itemLockUser like dUser))$>
			<$isInfo="1"$>
		<$endif$>
		
	<$endif$>
		
	<$if (#local.Iris_itemLockUser like dUser) or userHasRole("admin")$>
		<$userCanUnlock=1$>
	<$endif$>
	
	<$if userHasRole("WF_COO") or userHasRole("WF_Scanning Manager")$>
		<$userCanUnlock=1$>
	<$endif$>
	
<@end@>

<!-- Panel used when locking single items. --> 
<@dynamichtml iris_item_lock_panel@>
	
		<$include greyPanel_top$>
	
			<div class='panelheader'>
		
				<form name="item_lock_form" id="item_lock_form">
					<input type="hidden" name="itemDocName" value="<$dDocName$>" />
					<input type="hidden" name="itemLockUser" value="<$#local.Iris_itemLockUser$>" />
				</form>
		
				<table width='100%' cellspacing=0 cellpadding=0>
					<tr height=20>
						<td>
							<span class='panelheading'>Item Lock</span>
						</td>
						<td width=22>
							<div onclick="togglePanel(this)" id="toggle_item_lock_panel" class="toggle_img_collapse"></div>
						</td>
					</tr>
				</table>
			</div>
	
			<!-- This div has an ID so the display setting can be toggled between block/none -->
			<div id='item_lock_panel' class='panelbody' style="overflow: hidden;display:block">
				
				<table width="100%" cellspacing="2" cellpadding="0">
					<tbody>
						
						<$include iris_item_lock_display$>
						
					</tbody>
				</table>
				
			</div>
	
		<$include greyPanel_bottom$>
	
	</div>

<@end@>

<!-- Displays the approve and reject buttons on the workflow panel. -->
<@dynamichtml iris_wf_panel_buttons@> 
	<!-- Collect custom approve/reject button text for this workflow step.
			 If custom text isn't found, use 'Approve' and 'Reject' instead -->
	<$if false$>
		<$approveText = getValue("#active",DOC_WF_INFO.dWfName & "_" & DOC_WF_INFO.dWfStepName & "_approveText")$>
	<$endif$>

	<$approveText = getValue("rsProfileData","approveText")$>

	<$if not approveText$>
		<$approveText = "Approve"$>
	<$endif$>

	<$hideReject = 	getValue("rsProfileData","hideReject")$>

	<$if not strEqualsIgnoreCase(hideReject,'true')$>

		<$rejectText = getValue("rsProfileData","rejectText")$>
		<$if not rejectText$>
			<$rejectText = "Reject"$>
		<$endif$>

	<$else$>
		<$suppressReject = 1$>
	<$endif$>

	<td colspan=2 align="left">

		<div class="sidepanel_button_holder">

			<input 	type=button
							name="approve_btn"
							value="<$#active.approveText$>"
							style="margin: 0px; <$if suppressApprove$>display: none;<$endif$>"
							onClick="wfAction('Approve');"
							<$if #active.numMissingFields > 0 or (not allowWorkflowActions) or (not enableWorkflowForm)$>disabled=true<$endif$>
							tabindex="<$tabIndex=50$><$tabIndex$>">

			<input 	type=button
							name="reject_btn"
							value="<$#active.rejectText$>"
							style="margin: 0px; <$if suppressReject$>display: none;<$endif$>"
							<$if (not allowWorkflowActions) or (not enableWorkflowForm)$>disabled=true<$endif$>
							onClick="wfAction('Reject');"
							tabindex="<$include iris_get_next_tabindex$>">

		</div>

	</td>

<@end@>

<!-- Displays lock status for the currently-loaded item.
 	 Intended for placement in the item lock panel. -->
<@dynamichtml iris_item_lock_display@> 
	
	<$if #env.Iris_enableBatchLocking$>		
		<tr>	
			<td colspan=2 id="iris_batch_lock_text">
				<div class="lock_display_box">
				
					<$if Iris_itemLockUser$>
						<p id="iris_batch_lock_panel" class="item_locked">
						
							<span id="iris_batch_lock_info">
								<$if Iris_itemLockUser like dUser$>
									You have the lock on this item.
								<$else$>
									<$enableWorkflowForm=""$>
									Locked for editing by <strong><$Iris_itemLockUser$></strong> 
									<br/><$formatDateWithPattern(Iris_itemLockTime,"dd MMM HH:mm")$>
								<$endif$>
							</span>
							
							<$if userCanUnlock$>
								<br/>
								<a id="iris_batch_lock_link" href="javascript:removeItemLock('<$dDocName$>')">Remove lock</a>
							<$endif$>
								
					<$else$>
						<p id="iris_batch_lock_panel" class="item_unlocked">
							
							<$enableWorkflowForm=""$>
							
							<$if userCanLock$>
							
								<span id="iris_batch_lock_info">
									You must have the lock before you can edit.
								</span>
							
								<br/>
								<a id="iris_batch_lock_link" href="javascript:getItemLock('<$dDocName$>')">Acquire lock</a>
							
							<$else$>		
									
								<span id="iris_batch_lock_info">
									You don't have sufficient rights to lock this item for editing.
								</span>
									
							<$endif$>
								
					<$endif$>
						
					</p>
				</div>
			</td>
		</tr> 
		
	<$endif$>

<@end@>

<!-- 	Customized for CCLA: Ensures that ChildDocument item
		content will automatically link to their parent items.

		Retrieves and displays batch doc thumbnails. -->
<@dynamichtml iris_batchdocuments_thumbcontainer@>

	<$Iris_thumbWidth=60$>
	<$Iris_thumbHeight=60$>
	
	<$useBundleRef="Y"$>

	<$if #env.Iris_useBatchItemSearchResults$>
		<$ResultCount=100$>

		<$SortField = "dDocName"$>
		<$SortOrder = "ASC"$>
	
		<$include iris_build_batch_item_query$>
		<$QueryText		= batchItemQuery$>
		
		<$executeService("GET_SEARCH_RESULTS")$>
	<$else$>

		<$releasedBundleItemsOnly=1$>
		<$getDualIndexStatus=1$>
		<$executeService("IRIS_BATCH_GET_ITEMS")$>
		
		<$exec rsRename("rsBatchItems","SearchResults")$>
	<$endif$>	
	<!-- Cache document URLs -->
	<$loop SearchResults$>
		<$if #active.dDocType like "Document"$>
			<$include ccla_get_doc_url$>
			
			<$if #local.cclaDocUrl$>
				<$exec setValue("#local", "contentUrl_" & #active.dDocName, cclaDocUrl)$>
			<$endif$>
		<$endif$>
	<$endloop$>
	
	<div style="<$if verticalThumbs$>float: left; width:100% <$else$>margin: 5px 0px; <$endif$>">

		<$if SearchResults$>
			<!-- Determine currently-selected item from bundle. -->

			<$if not selDoc$>
				<$c="If not document was selected, select the first one by default."$>
				<$exec rsFirst("SearchResults")$>
				<$selDoc = SearchResults.dDocName$>
				<$selIndex = 0$>
				<!--loadContentUrl = SearchResults.URL-->
			<$endif$>
			
			<$if #env.Iris_enableSelectedBatchItemPanel$>
			
				<$loop SearchResults$>
					<$if selDoc like dDocName$>
						<$selIndex = SearchResults.#row$>
						
						<$selDocName = selDoc$>
						<$selDocTitle = dDocTitle$>
						<$selRevLabel = dRevLabel$>
						<$selSecurityGroup = dSecurityGroup$>
						<$selDocAccount = #active.dDocAccount$>
						<$selID = dID$>
						<$selExtension = dExtension$>
						<$selURL = URL$>
						<$loadContentUrl = URL$>
					<$endif$>
				<$endloop$>
				<$include iris_sel_batch_item_panel$>
				
			<$endif$>

		<$endif$>
		<div class="iris_scroll<$if enableThumbScroll$> iris_scroll_enabled<$else$> iris_scroll_disabled<$endif$><$if verticalThumbs$> iris_scroll_vertical<$else$> iris_scroll_horizontal<$endif$> scroll_left_inactive" id="scroll_left" onmousedown="<$if verticalThumbs$>scrollThumbsUp()<$else$>scrollThumbsLeft()<$endif$>" onmouseout="stopScroll()" onmouseup="stopScroll()" >
		</div>

		<div class="iris_thumbset_scroller<$if enableThumbScroll$> iris_thumbset_scroller_enabled<$else$> iris_thumbset_scroller_disabled<$endif$><$if verticalThumbs$> iris_thumbset_scroller_vertical<$else$> iris_thumbset_scroller_horizontal<$endif$>" id="iris_scroller">
			<div class="iris_thumbset_container<$if verticalThumbs$> iris_thumbset_container_vertical<$else$> iris_thumbset_container_horizontal<$endif$>" id="iris_thumbset_container" style="<$include iris_thumbset_container_extra_style$>" >
				<$include iris_batchdocuments_paginationsimple$>
			</div>
		</div>

		<div class="iris_scroll<$if enableThumbScroll$> iris_scroll_enabled<$else$> iris_scroll_disabled<$endif$><$if verticalThumbs$> iris_scroll_vertical<$else$> iris_scroll_horizontal<$endif$> scroll_right_inactive" id="scroll_right" onmousedown="<$if verticalThumbs$>scrollThumbsDown()<$else$>scrollThumbsRight()<$endif$>" onmouseout="stopScroll()" onmouseup="stopScroll()" >
		</div>
			
		<script type="text/javascript">
			 // Code used for collecting all batch items into an array.	
			  var previewUrlPrefix = "<$HttpCgiPath$>?IdcService=IRIS_BATCH_DOCS_PREVIEW<$include add_idc_token_to_url$>" +
				 "&parentDocName=<$#local.parentDocName$>&bundleRef=<$#local.bundleRef$>";
						
				var selIndex = <$if selIndex$><$selIndex$><$else$>0<$endif$>;
						
				var count = 0;
				
			  function batchItem(docName, contentUrl) {
				this.docName = docName;
				this.contentUrl = contentUrl;
			  }
		
			// Auto-loading function:
			// - Builds array of batch items. This is used to expose the items
			//   to various JavaScript functions, such as prev/next item.
			// - Selects the currently-selected item thumbnail and load its associated 
			//   content in the preview frame.
			$(document).ready( function() {
			
				<$loop SearchResults$>			
					<$include ccla_get_doc_url$>
					batchItems[count] = new batchItem('<$dDocName$>','<$cclaDocUrl$>');count++;
				<$endloop$>
			
				<$if selDoc$>
					selectThumbByDocName('<$selDoc$>');
				<$else$>
					// If the IDOC selDoc parameter is null, this indicates that no
					// items were found in the batch. Load the preview frame without
					// any parameters set.
					var contentFrame = window.parent.document.getElementById("contextFrame");
					contentFrame.src = previewUrlPrefix;
				<$endif$>
				
				// Update the Thumbnails tab caption
				window.parent.setThumbnailDisplayCount(batchItems.length);
			});
		
		</script>
			
	</div>
<@end@>

<!-- Used to compute the content URL for any content item. This include should only
	 be called while looping a docmeta ResultSet, e.g:
	 DOC_INFO, SearchResults, rsBatchItems
	 
	 It will resolve correctly even in the case of ChildDocuments, by using the content
	 URL of their parent content.
	 
	 Items with a dDocType of "Document" will first look for an active URL value. This
	 will only be present in SearchResults ResultSets. If this isn't present, it attempts
	 to lookup a cached version of the URL in the form: "contentUrl_<dDocName>".
	 If this isn't present, the item URL must be fetched using a computeDocUrl() call.
	 -->
<@dynamichtml ccla_get_doc_url@>
	
	<$if debugDocUrlGeneration$>
		<$trace("Determining Doc Url for " & #active.dDocName, "#log")$>
	<$endif$>
	
	<$if #active.dDocType like "ChildDocument"$>
		<$if #active.xPdfDocName$>
			<$contentDocName = #active.xPdfDocName$>
		<$else$>
			<$contentDocName = #active.xParentDocName$>
		<$endif$>
	<$else$>
		<$contentDocName = #active.dDocName$>
	<$endif$>
	
	<$cclaDocUrl = getValue("#local", "contentUrl_" & contentDocName)$>
		
	<$if not cclaDocUrl$>
		<$if debugDocUrlGeneration$>
			<$trace("Unable to find cached Doc URL for " & contentDocName, "#log")$>
		<$endif$>
	
		<$if #active.dDocType like "ChildDocument" and contentDocName$>
			
			<$if debugDocUrlGeneration$>
				<$trace("ChildDocument0....contentDocName:" & contentDocName, "#log")$>
			<$endif$>
			
			<$backupDocName = getValue("#local","dDocName")$>
	
			
			<$if debugDocUrlGeneration$>
				<$trace("ChildDocument1....backupDocName:" & backupDocName, "#log")$>
			<$endif$>


			<$exec setValue("#local","dDocName",contentDocName)$>
			<$exec setValue("#local","docNameToQuery",contentDocName)$>
			
			
			<$if debugDocUrlGeneration$>
				<$trace("ChildDocument2....#local.dDocName:" & #local.dDocName, "#log")$>
				<$trace("ChildDocument2....#active.dDocName:" & #active.dDocName, "#log")$>
			<$endif$>
			
			<$executeService("CCLA_GETLATESTDOCINFO_BY_NAME")$>
			
			<$if false$>
				<$executeService("DOC_INFO_LATESTRELEASE")$>
			<$endif$>
			
			<$loop DOC_INFO$>
			
				<$if debugDocUrlGeneration$>
					<$trace("ChildDocument2.5....dDocName:" & #active.dDocName, "#log")$>
					<$trace("ChildDocument2.5....dRevLabel:" & #active.dRevLabel, "#log")$>
					<$trace("ChildDocument2.5....dDocType:" & #active.dDocType, "#log")$>
					<$trace("ChildDocument2.5....dSecurityGroup:" & #active.dSecurityGroup, "#log")$>
					<$trace("ChildDocument2.5....dWebExtension:" & #active.dWebExtension, "#log")$>
					<$trace("ChildDocument2.5....dProcessingState:" & #active.dProcessingState, "#log")$>
					<$trace("ChildDocument2.5....dDocAccount:" & #active.dDocAccount, "#log")$>		
				<$endif$>
			
			
				<$cclaDocUrl = computeDocUrl(false)$>
				
				<$if debugDocUrlGeneration$>
					<$trace("ChildDocument3....cclaDocUrl:" & cclaDocUrl, "#log")$>
				<$endif$>

				
				
				<$exec setValue("#local", "contentUrl_" & contentDocName, cclaDocUrl)$>
			<$endloop$>
			
			
			
			<$exec setValue("#local","dDocName",backupDocName)$>
			<$dDocName = #local.backupDocName$>
			
			
			
			<$if debugDocUrlGeneration$>
				<$trace("ChildDocument4....#local.dDocName" & #local.dDocName, "#log")$>
			<$endif$>

			
		<$elseif #active.dDocType like "Document"$>
		
			<$if #active.URL$>
				<$if debugDocUrlGeneration$>
					<$trace("Document0....cclaDocUrl" & #active.URL, "#log")$>
				<$endif$>
		
				<$cclaDocUrl = #active.URL$>
			<$else$> 

			
				<$cclaDocUrl = computeDocUrl()$>
				
				<$if debugDocUrlGeneration$>
					<$trace("Document1....cclaDocUrl" & cclaDocUrl, "#log")$>
				<$endif$>

				
				<$if debugDocUrlGeneration$>
					<$trace("Cached Doc URL for " & contentDocName & ": " & cclaDocUrl, "#log")$>
				<$endif$>
				
				<$exec setValue("#local", "contentUrl_" & #active.dDocName, cclaDocUrl)$>
				
			<$endif$>
		
		<$else$>
			<$if debugDocUrlGeneration$>
				<$trace("Else0....cclaDocUrl" & cclaDocUrl, "#log")$>
			<$endif$>

		
			<$cclaDocUrl = #active.URL$>
		<$endif$>
	
	<$endif$>
	
	<$if debugDocUrlGeneration$>
		<$trace("Finished determining Doc Url for " & #active.dDocName & ":  " & cclaDocUrl, "#log")$>
	<$endif$>
	
<@end@>

<@dynamichtml ccla_get_doc_thumbnail_url@>
	
	<$if cclaDocUrl$>
		<$cclaDocThumbnailUrl = computeRenditionUrl(cclaDocUrl,1,"T")$>
		
		<$if debugDocUrlGeneration$>
			<$trace("ccla_get_doc_thumbnail_url cclaDocUrl:" & cclaDocUrl, "#log")$>
			<$trace("ccla_get_doc_thumbnail_url cclaDocThumbnailUrl:" & cclaDocThumbnailUrl, "#log")$>
		<$endif$>
	

	<$endif$>
	
<@end@>

<!-- Customized for CCLA: 
	 -Shows document class under each thumbnail, unless the bundle is at Validation phase.
	 -ChildDocuments have a special overlay image.
-->
<@dynamichtml iris_thumbnail_batch@>
  <$useThumbnails="1"$>

  <$ImageWidth=Iris_thumbWidth$>
  <$ImageHeight=Iris_thumbHeight$>

  <$if strEqualsIgnoreCase(SearchResults.dDocName,#local.selDoc)$>
  	<$selIndex = SearchResults.#row$>
  <$endif$>

	<div 	class="iris_thumb_container<$if verticalThumbs$> iris_thumb_container_vertical<$else$> iris_thumb_container_horizontal<$endif$>" 
			id="thumb_<$dDocName$>">
		
		<$diStatus = ""$>
		
		[[% Determine dual-index status for this item %]]
		
		<$loop rsDualIndexItems$>
			<$if #active.DOCNAME like SearchResults.dDocName$>
				<$if #active.OUTCOME like 1$>
					<$diStatus = "Passed"$>
				<$elseif #active.OUTCOME like 0$>
					<$diStatus = "Failed"$>
				<$else$>
					<$diStatus = "Unknown"$>
				<$endif$>
			<$endif$>
		<$endloop$>
	
		<$if #local.diStatus like "Unknown"$>
			<$picTitle = "?"$>
		<$elseif SearchResults.xDocumentClass$>
			<$picTitle=SearchResults.xDocumentClass$>
		<$else$>
			<$picTitle="Unclassified"$>
		<$endif$>
		
		<$if #active.dDocType like 'ChildDocument'$>
			<img src="<$HttpImagesRoot$>ccla/link.gif" style="left: 60px; position: absolute;" title="Child document" />
		<$endif$>
		
		<$if diStatus$>
			<$diIcon = ""$>
			
			<$if diStatus like "Unknown"$>
				<$diIcon = "index.png"$>
				<$diTitle = "Dual-indexing required"$>
			<$elseif diStatus like "Passed"$>
				<$diIcon = "index-green.png"$>
				<$diIcon = "tick-green.gif"$>
				<$diTitle = "Dual-indexing passed"$>
			<$elseif diStatus like "Failed"$>
				<$diIcon = "index-red.png"$>
				<$diIcon = "cross.png"$>
				<$diTitle = "Dual-indexing failed"$>
			<$endif$>
			
			<$if #active.dDocType like 'ChildDocument'$>
				<$topOffset = "22px"$>
			<$else$>
				<$topOffset = "0px"$>
			<$endif$>
			
			<$if diIcon$>
				<img src="<$HttpImagesRoot$>ccla/<$diIcon$>" style="left: 60px; top: <$topOffset$>; position: absolute;" 
					 title="<$diTitle$>" />
			<$endif$>
			
		<$endif$>
		
	<a 	href="javascript:void(0);" 
			onclick="selectThumbByDocName('<$dDocName$>');" 
			target="contextFrame"
			title="<$dDocTitle$>"><$include searchapi_result_table_content_begin_img$></a>

			<div class="iris_thumb_details<$if verticalThumbs$> iris_thumb_details_vertical<$else$> iris_thumb_details_horizontal<$endif$>">

				<a 		href="javascript:void(0);" 
						onclick="selectThumbByDocName('<$dDocName$>');" 
						target="contextFrame" 
						title="<$dDocTitle$>" 
						id="thumbTitle_<$SearchResults.dDocName$>" ><$picTitle$></a>
			</div>
		
	
		<div class="openDocInNewTab_forIpad"><a target="_blank"  href="?IdcService=GET_FILE&RevisionSelectionMethod=Latest&dDocName=<$SearchResults.dDocName$>">Open</a> <img src="<$HttpImagesRoot$>iris/icon_new_window.gif""/></div>

		</div>
	
<@end@>

<!-- Called on entry event to the EnterDetails step of the
		 MailHandling workflow. -->
<@dynamichtml ccla_mailhandling_enterdetails_entry@>

	<$wfSet("wfJumpEntryNotifyOff", "1")$>
	
	<$wfReleaseDocument()$>
	
	<$wfUpdateMetaData("xStatus","EnterDetails")$>
	<$wfUpdateMetaData("xDocumentAuthor","")$>
	
<@end@>

<!-- Called on entry event to the Validation step of the
		 MailHandling workflow. -->
<@dynamichtml ccla_mailhandling_validation_entry@>
	
	<$wfSet("wfJumpEntryNotifyOff", "1")$>
	
	<$wfUpdateMetaData("xDocumentAuthor","")$>
	
<@end@>

<@dynamichtml iris_ccla_doc_class_field@>
	
	<$dOptionListKey=dOptionListKey$>
	<$executeService("ECS_GETOPTIONLISTVALUES")$>

	<select class="input_option_field" name="<$dName$>" tabindex="<$include iris_get_next_tabindex$>" >

		<option value=""></option>

		<$loop SchemaData$>
			<$key = getValue('SchemaData','dOption')$>

			<$trace("[" & dName & "] - checking '" & fieldValue & "' against '" & key & "'.. " & (fieldValue like key))$>

			<option value="<$key$>" <$if fieldValue like key$>SELECTED="selected"<$endif$>><$key$></option>

		<$endloop$>

	</select>
	
	<input type="button" value="Multi doc" />

<@end@>

<@dynamichtml iris_ccla_doc_date_field@>
	
	<$if not (#active.xDocumentClass like "INV|MULTIINV") and #active.xDocumentDate$>
		<$formatDateOnly(#active.xDocumentDate)$>
		<input type="hidden" name="xDocumentDate" value="<$formatDateOnly(#active.xDocumentDate)$>">
	<$else$>
	
		<script type="text/javascript">
			
			var keyUpArrow  	= 38;
			var keyDownArrow 	= 40;
			
			$(document).ready( function() {
				
				// bind onfocus event to xDocumentDate field
				/*
				$("#xDocumentDate").bind("focus",
					
					// Auto-completes the xDocumentDate field value with the current date
					// when the field is focused (providing it doesn't already have a value)
					function(e) {
						if ($("#xDocumentDate").val() == "") {
							var now = new Date();
							$("#xDocumentDate").val(formatDateWithShortPattern(now));
							$("#xDocumentDate")[0].select();
						}
					}
				);
				*/
				
				// bind onkeyup event to xDocumentDate field
				$("#xDocumentDate").bind("keyup", 
				
					function(e) {
						// First check for up/down arrow key presses
						if (!(e.keyCode == keyUpArrow|e.keyCode == keyDownArrow))
							return true;
						
						// Check for non-empty date value
						var curDateValue = $("#xDocumentDate").val();
						if (curDateValue == "")
							return true;
						
						var splitDate = curDateValue.split("/");
						if (splitDate.length < 3)
							return true;
						
						var fullYear = splitDate[2];

						if (fullYear.length == 2)
							fullYear = "20" + fullYear;
						
						// Parse the date string into a Date object
						var curDate = new Date();
						curDate.setFullYear(fullYear);
						curDate.setMonth(splitDate[1]-1);
						curDate.setDate(splitDate[0]);
						
						var dateInMillis 	= curDate.getTime();
						var dayInMillis		= 86400000;
						
						if (e.keyCode == keyUpArrow) 
							dateInMillis = dateInMillis + dayInMillis;
						else if (e.keyCode == keyDownArrow)
							dateInMillis = dateInMillis - dayInMillis;
						
						var alteredDate = new Date();
						alteredDate.setTime(dateInMillis);
						
						$("#xDocumentDate").val(formatDateWithShortPattern(alteredDate));
						$("#xDocumentDate")[0].select();
					}
				);
				
			});
			
		</script>

		<$if #active.xDocumentDate$>
			<$fieldValue = formatDateWithPattern(#active.xDocumentDate,Iris_shortDatePattern)$>
		<$else$>
			<$fieldValue = ""$>
		<$endif$>
		
		<input 	name="xDocumentDate" id="xDocumentDate" class="input_short_date_field" 
				type="text" value="<$#local.fieldValue$>" 
				tabindex="<$include iris_get_next_tabindex$>" />
		
		<img id="xDocumentDate_picker" class="calbutton" name="xDocumentDate_picker" style="margin-left: 5px;" src="epoch/images/epoch_calendar.gif"/>
	
	<$endif$>
	
<@end@>

<!-- Invoice Payment Date field display.
	 
	 If this field contains a (valid) date value, the various payment code 
	 fields (e.g. Cost Centre) will be enabled, otherwise they are disabled
	 on page load.
	 -->
<@dynamichtml iris_ccla_invoice_payment_date_field@>
	
	<$if #active.xPaymentDate$>
		<$fieldValue = formatDateWithPattern(#active.xPaymentDate,Iris_shortDatePattern)$>
	<$else$>
		<$fieldValue = ""$>
	<$endif$>
	
	<input 	name="xPaymentDate" id="xPaymentDate" class="input_short_date_field" 
			type="text" value="<$#local.fieldValue$>" 
			tabindex="<$include iris_get_next_tabindex$>" />
	
	<img id="xPaymentDate_picker" class="calbutton" name="xPaymentDate_picker" style="margin-left: 5px;" src="epoch/images/epoch_calendar.gif"/>
	
	<script type="text/javascript">
		
		// List of Payment field IDs for use in JQuery selectors
		var paymentFieldsSelector = "#xClientName, #xClientServicesRef, #xFund";
		
		/*
		updatePaymentFieldsState = function() {
			var paymentDate = $("#xPaymentDate").val();
			
			// TODO: validate date.
	
			if (paymentDate) {
				$(paymentFieldsSelector).removeAttr("disabled");
			} else {
				$(paymentFieldsSelector).attr("disabled","disabled");
			}
		};

		$(document).ready(function() {
			updatePaymentFieldsState();
			
			$("#xPaymentDate").bind("change", function() {
				updatePaymentFieldsState();
			});
		});
		*/
		
	</script>
	
<@end@>	

<@dynamichtml iris_ccla_client_name_field@>

	<textarea 	name="xClientName" id="xClientName" 
				class="input_small_memo_field" tabindex="<$include iris_get_next_tabindex$>"><$#active.xClientName$></textarea>

<@end@>

<!-- Standard new item checkin panel.

		 Overriden from iriscore_resource -->
<@dynamichtml iris_new_item_panel@>

	<$include orangeContainer_top$>

	<div class='panelheader' style="padding: 3px; border-bottom: 1px solid; margin-right: 3px">
		<b>Add new item<b>
	</div>

	<div>

	<br/>

	<$if not dSecurityGroup$>
		<$dSecurityGroup = "Public"$>
	<$endif$>

	<$if not (userCanWrite)$>
	<!--if not (userHasGroupPrivilege(dSecurityGroup,"W") or userHasGroupPrivilege(dSecurityGroup,"D") or userHasGroupPrivilege(dSecurityGroup,"A"))-->
		<!-- 	Ensure user has read access on Public security group
					before displaying 'new item' form -->

		Sorry, you do not have sufficient access rights to add new documents.
		<br/>
		<br/>

	<$else$>

		<!-- Form used for content item checkin -->
		<form name="newdocform" id="newdocform" enctype="multipart/form-data" action="<$HttpCgiPath$>" method="POST">
			
			<$if added$>
				<div class="message_panel info_icon">
					New item added.
				</div>
				
				<br/>
			<$endif$>
			
			<input type=hidden name="IdcService" value="CCLA_CHECKIN_NEW">
			<$include add_idc_token_to_form$>
			<input type=hidden name="dDocAuthor" value="<$dUser$>">
			<input type=hidden name="dSecurityGroup" value="Public">
			<!--<input type=hidden name="xStorageRule" value="testStorageRule">-->
			<input type=hidden name="RedirectUrl" value="<$HttpCgiPath & '?IdcService=IRIS_NEW_ITEM' & inc('add_idc_token_to_url') & '&added=1'$>">
			
			<input type=hidden name="lApp" value="IRIS" />
			<input type=hidden name="lAction" value="ADD-DOC" />
			<input type=hidden name="lRef" value="" /> <!-- Bundle dDocName, added via js -->
			<input type=hidden name="lTitle" value="" /> <!-- Bundle ref, added via js -->
			<input type=hidden name="lUser" value="<$dUser$>" />
			
			<!-- Audit parameters are: (must be added after checkin via Java):
					1. dDocName of new item 
					2. title of new item 
					-->
			<input type=hidden name="lParam1" value="" />
			<input type=hidden name="lParam2" value="" />

	
			<table width="100%" cellpadding=0 cellspacing=2>
				<$include iris_doctype_list$>

				<$allowsFileUpload="1"$>
				<$isEditMode="1"$>

				<tr>
					<td><span class=infoLabel>File*:</span></td>
					<td><input name="primaryFile" size="30" maxlength="250" type="file" onChange="addFileName(this.form)"></td>
				</tr>

				<tr><td><br></td></tr>

				<$include iris_checkin_metadata$>

				<tr><td><br></td></tr>

				<tr>
					<td colspan=2 align=center>
						<input type=button value=Submit onClick="addNewItem(this.form)" class="generic_button">
					</td>
				</tr>
			</table>
		
		</form>

	<$endif$>

	</div>

	<$include orangeContainer_bottom$>
		
<@end@>

<!-- Overidden from iris_batchdocs_resource. Adds an
		 extra validation check to ensure the user
		 specified an envelope ID. -->
<@dynamichtml iris_checkin_js@>

	<script type="text/javascript">

	// Called before submitting the Add new item form
	function addNewItem(form)
	{
		var fileVal = form.primaryFile.value;
		var titleVal = form.dDocTitle.value;

		var accountVal = form.dDocAccount.value;

		if (fileVal == '') {
			alert("Please select a file for this item.");
			return false;
		} else if (titleVal == '') {
			alert("Please enter a title for this item.");
			return false;
		} else if (accountVal == '') {

			<$if #active.requireAccount$>
				alert("You must specify an account for this item.");
				return false;
			<$endif$>
		}

		var docType = form.dDocType.value;
		
		/*
		var bundleRef = form.xBundleRef.value;

		if (bundleRef == '') {
			alert("You must specify an Envelope ID for this item.");
			return false;
		}
		*/

		form.submit();
	}
	
	function addBundleRefClicked(chk) {
		
		if (chk.checked) {
			$("#newEnv").css("display","");
			$("#filingCab").css("display","none");
			
			$("#doAudit").val("1");
			
		} else {
			$("#newEnv").css("display","none");
			$("#filingCab").css("display","");
			
			$("#doAudit").val("");
		}
	}

	<$include add_filename_script$>

</script>

<@end@>

<!-- Overrides standard Iris checkin metadata -->
<@dynamichtml iris_checkin_metadata@>

	<$calendarSelectFields="xScanDate,xDocumentDate,xProcessDate"$>
	<$include Iris_prepareEpochCalendars$>

	<script type="text/javascript">

		window.onload=prepareCalendars;

		// triggered via change event to the document type selector
		// does nothing at the moment.
		function changeType(sel) {

			var frm = document.forms['newdocform'];

		}

  </script>

	<input type="hidden" name="dDocAccount" value="">
	
	<tr>
		<td><span class=infoLabel>Source:</span></td>
		<td>
			<select name=xSource id=xSource>
				<option value="Bank">Bank</option>
				<option value="Email">Email</option>
				<option value="Fax">Fax</option>
				<option value="User Upload" selected>User Upload</option>
				
				<$if userHasRole("admin")$>
					<option value="User Upload">Scanned for Iris</option>
				<$endif$>
			</select>
		</td>
	</tr>
	
	<$if userHasRole("admin")$>
		
		<tr>
			<td><span class=infoLabel>Scan User:</span></td>
			<td>
				<input type="text" name="xScanUser" />
			</td>
		</tr>
	<$endif$>
	
	<tr>
		<td><span class=infoLabel>Title*:</span></td>
		<td><input type=text name=dDocTitle style="width: 90%"></td>
	</tr>
	<tr>
		<td><span class=infoLabel>Scan date:</span></td>
		<td>
			<input type=text name=xScanDate id=xScanDate style="width: 30%" tabindex="<$tabindex$>">
			<input type="button" src="epoch/images/epoch_calendar.gif" name="xScanDate_picker" id="xScanDate_picker" value="..."
						 style=" background-image: url(epoch/images/epoch_calendar.gif)" tabindex="<$tabindex$>"/>
		</td>
	</tr>

	<tr><td><br></td></tr>
	
	<tr>
		<td><span class=infoLabel>Company:</span></td>
		<td>
			
			<select name="xCompany">
				<option value=""></option>
				
				<$dOptionListKey="CompanyList"$>
				<$executeService("ECS_GETOPTIONLISTVALUES")$>

				<$loop SchemaData$>
					<$key = getValue('SchemaData','dOption')$>		
					<option value="<$key$>"><$key$></option>
				<$endloop$>
			</select>
		
		</td>
	</tr>
	<tr>
		<td><span class=infoLabel>Client no:</span></td>
		<td><input type=text name=xClientNumber style="width: 50%"></td>
	</tr>
	<tr>
		<td><span class=infoLabel>Client acc. no:</span></td>
		<td><input type=text name=xAccountNumber style="width: 50%"></td>
	</tr>
	<tr>
		<td><span class=infoLabel>Sort Code:</span></td>
		<td><input type=text name=xSortCode style="width: 50%"></td>
	</tr>
	<tr>
		<td><span class=infoLabel>Bank acc. no:</span></td>
		<td><input type=text name=xBankAccountNumber style="width: 50%"></td>
	</tr>
	
	<tr><td><br></td></tr>
	
	<tr>
		<td><span class=infoLabel>Document class:</span></td>
		<td>
			<$include ccla_document_class_option_list$>
		</td>
	</tr>
	
	<tr>
		<td><span class=infoLabel>Document date:</span></td>
		<td>
			<input type=text name=xDocumentDate id=xDocumentDate style="width: 30%">
			<input type="button" src="epoch/images/epoch_calendar.gif" name="xDocumentDate_picker" id="xDocumentDate_picker"
						 style=" background-image: url(epoch/images/epoch_calendar.gif)" value="..."/>
		</td>
	</tr>

	<tr><td><br></td></tr>
	
	<tr>
		<td><span class=infoLabel>Amount:</span></td>
		<td><input type=text name=xAmount style="width: 50%"></td>
	</tr>
	<tr>
		<td><span class=infoLabel>Units:</span></td>
		<td><input type=text name=xUnits style="width: 50%"></td>
	</tr>
	<tr>
		<td><span class=infoLabel>Client name:</span></td>
		<td><input type=text name=xClientName style="width: 90%"></td>
	</tr>
	<tr>
		<td><span class=infoLabel>Fund:</span></td>
		<td><input type=text name=xFund style="width: 50%"></td>
	</tr>

	<tr><td><br></td></tr>

	<tr>
		<td><span class=infoLabel>Process date:</span></td>
		<td>
			<input type=text name=xProcessDate id=xProcessDate style="width: 30%" />
			<input type="button" src="epoch/images/epoch_calendar.gif" name="xProcessDate_picker" id="xProcessDate_picker"
						 style=" background-image: url(epoch/images/epoch_calendar.gif)" value="..."/>
		</td>
	</tr>
	
	<tr><td><br></td></tr>
	
	<$if false$>
		<tr>
			<td><span class=infoLabel>Envelope ID*:</span></td>
			<td>
				(auto-generated)
			
				<$if false$>
					<input type=text name=xBundleRef id=xBundleRef style="width: 50%" />
				<$endif$>
			</td>
		</tr>
	<$endif$>
	
	<tr>
		<td><span class=infoLabel>Create new envelope:</span></td>
		<td><input type=checkbox name=addBundleRef id=addBundleRef checked="checked" onclick="addBundleRefClicked(this)" />
		
			<!-- Audit fields used to record new checkin. Only passed if 'Create new envelope' is ticked -->
			<input type=hidden name="doAudit" id="doAudit" value="1">
		
		</td>
	</tr>
	
	<tr>
		<td><span class=infoLabel>Workflow ID:</span></td>
		<td><input type=text name=xBatchNumber id=xBatchNumber style="width: 50%" /></td>
	</tr>
	
	<tr>
		<td colspan=2>
			<br/>
			<span id="newEnv">
				This item will be added to a new envelope in the Scanned Envelopes view.
				<br/><br/>
				You may also specify an existing workflow ID - this will be used when the 
				item is submitted to Workflow.
			</span>
			<span id="filingCab" style="display:none">
				This item will be added directly to the Filing Cabinet.
				<br/><br/>
				<b>Only use this feature if the item doesn't require a workflow job.</b>
			</span>
			
		</td>
	</tr>

	
	<tr>
		<td>

			<input type="hidden" name="xStatus" value="Pending" />
		</td>
	</tr>
	
<@end@>

<@dynamichtml makeSearchResultsUrl@>

	<$if strEqualsIgnoreCase(dDocType,"bundle")$>
		href="?IdcService=DOC_APPROVAL<$include add_idc_token_to_url$>&dDocName=<$#active.dDocName$>&bundleRef=<$SearchResults.xBundleRef$><$#local.sfparamstring$>"
	<$elseif strEqualsIgnoreCase(dDocType,"mailitem")$>
		href="?IdcService=DOC_APPROVAL<$include add_idc_token_to_url$>&dDocName=<$#active.dDocName$><$#local.sfparamstring$>"
	<$else$>
		<$include super.makeSearchResultsUrl$>
	<$endif$>

<@end@>

<@dynamichtml makeSearchResultsUrl_OLD@>

	<$if strEqualsIgnoreCase(dDocType,"bundle")$>
		onClick="openBundle('<$SearchResults.dDocName$>','<$SearchResults.xBundleRef$>',event);"
	<$elseif strEqualsIgnoreCase(dDocType,"mailitem")$>
		onClick="openDoc('<$SearchResults.dDocName$>',event);"
	<$else$>
		<$include super.makeSearchResultsUrl$>
	<$endif$>

<@end@>

<@dynamichtml iris_doc_approval_title@>
	<$if not bundleRef$>
		Document Approval: <$DOC_INFO.dDocTitle$>
	<$else$>
		Envelope: <$getValue("DOC_INFO",#env.Iris_batchIdField)$>
	<$endif$>
<@end@>

<@dynamichtml iris_styles@>
	<$include super.iris_styles$>
	<link rel="stylesheet" href="<$HttpWebRoot$>resources/ccla/ccla_styles.css" type="text/css">
	
	<link rel="SHORTCUT ICON" href="<$HttpImagesRoot$>ccla/favicon.ico" />
<@end@>

<@dynamichtml orangeContainer_top@>

	<table cellpadding=0 cellspacing=0 border=0 width='100%'>

		<tr height='4'>
			
			<td colspan="4" style="border-top:4px solid #FFF;" colspan="2">
			</td>
		</tr>

		<tr>

			<td width='4' style="border-left:4px solid #FFF;">
			</td>

			<td>
<@end@>


<@dynamichtml orangeContainer_bottom@>

			</td>

			<td width='4' style="border-right:4px solid #FFF;">
			</td>
		</tr>

		<tr height='4'>
			<td colspan="4" style="border-bottom:4px solid #FFF;">
			</td>
		</tr>

	</table>

<@end@>

<!-- Displays the approve and reject buttons on the workflow panel. -->
<@dynamichtml ccla_wf_panel_buttons@> 

	<!-- Collect custom approve/reject button text for this workflow step.
			 If custom text isn't found, use 'Approve' and 'Reject' instead -->
	<$if false$>
		<$approveText = getValue("#active",DOC_WF_INFO.dWfName & "_" & DOC_WF_INFO.dWfStepName & "_approveText")$>
	<$endif$>

	<$approveText = getValue("rsProfileData","approveText")$>

	<$if not approveText$>
		<$approveText = "Approve"$>
	<$endif$>

	<$hideReject = 	getValue("rsProfileData","hideReject")$>

	<$if not strEqualsIgnoreCase(hideReject,'true')$>

		<$rejectText = getValue("rsProfileData","rejectText")$>
		<$if not rejectText$>
			<$rejectText = "Reject"$>
		<$endif$>

	<$else$>
		<$suppressReject = 1$>
	<$endif$>

			<input 	type=button
							name="approve_btn"
							value="<$#active.approveText$>"
							class="submitLink"
							style="<$if suppressApprove$>display: none;<$endif$>"
							onClick="wfAction('Approve');"
							<$if #active.numMissingFields > 0 or (not allowWorkflowActions) or (not enableWorkflowForm)$>disabled=true<$endif$>
							tabindex="<$tabIndex=50$><$tabIndex$>">

			<input 	type=button
							name="reject_btn"
							value="<$#active.rejectText$>"
							class="submitLink"
							style="<$if suppressReject$>display: none;<$endif$>"
							<$if (not allowWorkflowActions) or (not enableWorkflowForm)$>disabled=true<$endif$>
							onClick="wfAction('Reject');"
							tabindex="<$include iris_get_next_tabindex$>">

<@end@>


<!-- Overriden here to prevent account field showing in Iris. -->
<@dynamichtml iris_document_account_field@>

<@end@>

<!-- Override from IrisCore.

		 When in bundle item edit mode, update calls are done
		 via AJAX calls. -->
<@dynamichtml doc_approval_fields_actions@>

	<$if not isInfo$>
		
		<tr>
			<td colspan=3 align="left">
				<div class="sidepanel_button_holder">
					<$if batchEditMode like 'document'$>
						<!-- bind to AJAX functions -->
						<$saveEvent 		= "saveDocInfo()"$>
						<$discardEvent 	= "reloadDocInfo()"$>
						<$disableButtons = ""$>
					<$else$>
						<!-- bind to standard form submission functions -->
						<$saveEvent 		= "saveChanges()"$>
						<$discardEvent 	= "discardChanges()"$>
							
						<$saveEvent 		= "saveDocInfo()"$>
						<$discardEvent 	= "reloadDocInfo()"$>
					<$endif$>
					
					<input type=button name="submitbtn" id="submitbtn" value="Save" 
								 onclick="<$saveEvent$>;" 
								 class="doc_panel_submit_button"
								 <$#local.disableButtons$> 
								 tabindex="<$include iris_get_next_tabindex$>" />
					
					<input type=button name="discardbtn" id="discardbtn" value="Reload" 
								 onclick="<$discardEvent$>;" 
								 class="doc_panel_submit_button"
								 tabindex="<$include iris_get_next_tabindex$>"
								 <$#local.disableButtons$> />
								 	
					<$if isBatchDoc and #env.Iris_enableBatchUpdates$>
						<!-- Display batch update button -->
						<input type="button" name="batchUpdateBtn" id="batchUpdateBtn" value="Batch update"
									 onclick="applyBatchUpdate()"
									 class="doc_panel_submit_button"
									 tabindex="<$include iris_get_next_tabindex$>"
									 disabled />	 
						
					<$endif$>			 	
					
					<$if not isBatchDoc$>
					
						<!-- Added extra button to standard controls to allow SPP workflow submission -->
						<$if userHasRole("admin") or userHasRole("sysman") or userHasRole("WF_Scanning Manager") or userHasRole("WF_COO")$>
							<input 	type=button name="submitToSPPButton" id="submitToSPPButton" 
											value="Submit to Workflow" onclick="submitToSPP();" 
											style="width: 120; margin: 2px;"
											tabindex="<$include iris_get_next_tabindex$>">
						<$endif$>
								
						<script type="text/javascript">
							
							function submitToSPP() {
								<$if #active.xWorkflowDate or (#active.xBatchNumber and (#active.xBatchNumber > 0))$>
									var conf = confirm("This item has a workflow ID or workflow date set, " +
									"indicating it has already been submitted to Workflow.\n\nDo you want to resubmit it?");
								<$else$>
									var conf = confirm("Are you sure you want to submit this item to Workflow?");
								<$endif$>
								
								if (conf) {
									// call single-doc SPP submit service.
									
									var frm = document.forms['sppSubmit'];
									
									if (frm) {
										frm.elements['dDocName'].value = "<$#active.dDocName$>";
										frm.submit();
									} else {
										window.location.assign("idcplg?IdcService=ECS_MANUAL_TRIGGER_SPP_WORKFLOW<$include add_idc_token_to_url$>&dDocName=<$#active.dDocName$>");
									}
								}
							}
							
						</script>	
									
					<$endif$>
					
					<script type="text/javascript">
						// send a list of the displayed fields so their
						// values can be cached.
						collectDocFieldValues('<$fields$>');
						
						<$if isBatchDoc$>
							// callback the batch thumbnail display and update the
							// thumbnail caption.
							updateThumbCaption(
								document.forms.doc_fields['dDocName'].value,
								document.forms.doc_fields['xDocumentClass'].value
							);
						
						<$elseif not isInfo$>
							// Always enable the doc meta panel if this isn't a batch doc.
							setDocPanelEnabled(true);
						<$endif$>
						
					</script>
								 	
				</div>
			</td>
		</tr>

	<$else$>
					
		<tr><td colspan=2 align="right">
			<br/>
			<a href="<$HttpCgiPath$>?IdcService=DOC_INFO<$include add_idc_token_to_url$>&dID=<$dID$>&dDocName=<$dDocName$>">View standard info</a>
		</td></tr>

	<$endif$>

<@end@>

<!-- Panel used for adding new batch documents.  Displayed
     on IRIS_BATCH_DOCS_LISTING template.
     
     Overriden from iris_batchdocuments_resource to support
     CCLA child docs.
      -->
<@dynamichtml iris_add_batch_doc_panel@>

	<$include orangeContainer_top$>
	<div class='panelheader' style="padding: 3px; border-bottom: 1px solid; margin-right: 3px;">

		<table width="90%" cellpadding=0 cellspacing=0>
			<tr>
				<td>
				<b>Add new document<b>
				</td>
			</tr>
		</table>

	</div>

	<div style="padding:2px;">			
		<table width="100%" cellpadding=0 cellspacing=2 style="height:120px">
			
			<form name="newdocform" enctype="multipart/form-data" action="<$HttpCgiPath$>" method="POST" style="height: 0px; margin: 0px;">
				<input type=hidden name="IdcService" value="CHECKIN_NEW">
				<$include add_idc_token_to_form$>
				<input type=hidden name="dDocAuthor" value="<$UserName$>">
				<input type=hidden name="<$#env.Iris_batchIdField$>" value="<$#local.bundleRef$>">
				<input type=hidden name="dSecurityGroup" value="Public">
				<$c="currently, all bundle child docs will be 'Document'"$>
				<input type=hidden name="dDocType" value="Document">
				<input type=hidden name="dDocAccount" value="<$#local.parentDocAccount$>">
				
				<input type=hidden name="xSource" value="User Upload" />
				
				<$c="audit fields used to record new checkin"$>
				<input type=hidden name="doAudit" value="1">

				<input type=hidden name="lApp" value="IRIS" />
				<input type=hidden name="lAction" value="ADD-DOC" />
				<input type=hidden name="lRef" value="<$parentDocName$>" />
				<input type=hidden name="lTitle" value="<$bundleRef$>" />
				<input type=hidden name="lUser" value="<$dUser$>" />

				<!-- Audit parameters are (must be added after checkin via Java):
						1. dDocName of new item
						2. title of new item
						-->
				<input type=hidden name="lParam1" value="" />
				<input type=hidden name="lParam2" value="" />

				<input type=hidden name="RedirectUrl" value="<$HttpCgiPath & "?IdcService=IRIS_BATCH_DOCS_LISTING<$include add_idc_token_to_url$>" & "&parentDocName=" & parentDocName & "&bundleRef=" & #local.bundleRef$>&isAssignee=<$#local.isAssignee$>">

				<$allowsFileUpload="1"$>
				<$isEditMode="1"$>
				<$c="get doc info from parent doc to set on new doc"$>
				<$dDocName=#active.parentDocName$>
				<$executeService("DOC_INFO_LATESTRELEASE")$>
				<$if DOC_INFO$>
					<$parentDocAccount=DOC_INFO.dDocAccount$>
					<$parentSecurityGroup=DOC_INFO.dSecurityGroup$>
				<$endif$>
				<$dDocName=''$>
					
				<tr>
					<td><span class=infoLabel>File:</span></td>
					<td><input name="primaryFile" maxlength="250" type="file" onChange="addFileName(this.form)" ></td>
				</tr>

				<tr>
					<td><span class=infoLabel>Title:</span></td>
					<td><input type=text name=dDocTitle style="width: 234px"></td>
				</tr>
				<tr>
					<td><span class=infoLabel>Class:</span></td>
					<td>
						<$getViewValuesResultSet("vDOCUMENT_CLASSES","","")$>
						<select name="xDocumentClass" id="xDocumentClass" tabindex="<$include iris_get_next_tabindex$>" >
							<option value=""></option>
							<$loop SchemaData$>
								<option value="<$#active.DOC_CLASS$>"><$#active.DOC_CLASS$></option>
							<$endloop$>
						</select>
					</td>
				</tr>

				<tr><td><br></td></tr>

				<tr>
					<td colspan=2 align=right style="padding-right:4px">
						<input type=button value=Submit onClick="addNewItem(this.form)">
					</td>
				</tr>

			</form>

		</table>
	</div>

	<$include orangeContainer_bottom$>
		
<@end@>

<!-- 	Overrides standard Quicksearch form displayed in iris page header.
			
			Points to Filing Cabinet page instead.
			 -->
<@dynamichtml iris_header_quicksearch@>

	<form action="<$HttpCgiPath$>" method="GET">
		<input type=hidden name=IdcService value="IRIS_CLASSIFIED_ITEMS" />
		<$include add_idc_token_to_form$>
		<input type=hidden name="adv" value="true" />
		<input type=text name="qs">
		<input type=submit value='Quick Search' class='generic_button'/>
	</form>
	
	<!-- manual SPP submission form -->
	<form name="sppSubmit" id="sppSubmit" action="<$HttpCgiPath$>" method="GET">
		<input type="hidden" name="IdcService" value="ECS_MANUAL_TRIGGER_SPP_WORKFLOW" />
		<$include add_idc_token_to_form$>
		<input type="hidden" name="dDocName" value="" />
		<input type="hidden" name="noRedirectOnSuccess" value="1" />
		
		<input type="hidden" name="RedirectUrl" value="<$HttpCgiPath$>?IdcService=DOC_APPROVAL<$include add_idc_token_to_url$>&dDocName=<$#active.dDocName$>" />
	</form>
	
	<!-- manual SPP submission form -->
	<form name="checkOutCheckinForm" id="checkOutCheckinForm" action="<$HttpCgiPath$>" method="GET">
		<input type="hidden" name="IdcService" value="SPP_CHECKOUT_CHECKIN" />
		<$include add_idc_token_to_form$>
		<input type="hidden" name="dDocName" value="<$#active.dDocName$>" />
		
		<input type="hidden" name="RedirectUrl" value="<$HttpCgiPath$>?IdcService=DOC_APPROVAL<$include add_idc_token_to_url$>&dDocName=<$#active.dDocName$>" />
	</form>
	
<@end@>

<@dynamichtml ccla_reports_menu_popup@>
<$if userHasRole("admin") or userHasRole("WF_COO") or userHasRole("WF_Scanning Manager")$>
	<tr>
		<td class="<$menu_style_prefix$>PopupLink" nowrap onMouseOver="glowPopupRow(this,'<$menu_style_prefix$>PopupLink_over','<$menu_style_prefix$>PopupLink')"	onMouseOut="fadePopupRow(this,'<$menu_style_prefix$>PopupLink')">
			<a style="text-decoration: none; font-weight: normal; font-size: 8pt" href="<$HttpCgiPath$>?IdcService=GET_DOC_PAGE<$include add_idc_token_to_url$>&Action=GetTemplatePage&Page=CCLA_REPORTS">
				Content Reports
			</a>
		</td>
	</tr>
	
	<tr>
		<td class="<$menu_style_prefix$>PopupLink" nowrap onMouseOver="glowPopupRow(this,'<$menu_style_prefix$>PopupLink_over','<$menu_style_prefix$>PopupLink')"	onMouseOut="fadePopupRow(this,'<$menu_style_prefix$>PopupLink')">
			<a style="text-decoration: none; font-weight: normal; font-size: 8pt" href="<$HttpCgiPath$>?IdcService=GET_DOC_PAGE<$include add_idc_token_to_url$>&Action=GetTemplatePage&Page=CCLA_EXTENDED_REPORT">
				Extended Content Reports
			</a>
		</td>
	</tr>
	
	<tr>
		<td class="<$menu_style_prefix$>PopupLink" nowrap onMouseOver="glowPopupRow(this,'<$menu_style_prefix$>PopupLink_over','<$menu_style_prefix$>PopupLink')"	onMouseOut="fadePopupRow(this,'<$menu_style_prefix$>PopupLink')">
			<a style="text-decoration: none; font-weight: normal; font-size: 8pt" href="<$HttpCgiPath$>?IdcService=GET_DOC_PAGE<$include add_idc_token_to_url$>&Action=GetTemplatePage&Page=CCLA_WORKFLOW_REPORTS">
				Parking Lot Reports
			</a>
		</td>
	</tr>
	
	<tr>
		<td class="<$menu_style_prefix$>PopupLink" nowrap onMouseOver="glowPopupRow(this,'<$menu_style_prefix$>PopupLink_over','<$menu_style_prefix$>PopupLink')"	onMouseOut="fadePopupRow(this,'<$menu_style_prefix$>PopupLink')">
			<a style="text-decoration: none; font-weight: normal; font-size: 8pt" href="<$HttpCgiPath$>?IdcService=CCLA_ODC_REPORTS<$include add_idc_token_to_url$>">
				ODC Reports
			</a>
		</td>
	</tr>
	
	<tr>
		<td class="<$menu_style_prefix$>PopupLink" nowrap onMouseOver="glowPopupRow(this,'<$menu_style_prefix$>PopupLink_over','<$menu_style_prefix$>PopupLink')"	onMouseOut="fadePopupRow(this,'<$menu_style_prefix$>PopupLink')">
			<a style="text-decoration: none; font-weight: normal; font-size: 8pt" href="<$HttpCgiPath$>?IdcService=CCLA_IRIS_REPORTS<$include add_idc_token_to_url$>">
				Iris Reports
			</a>
		</td>
	</tr>
<$endif$>
	<tr>
		<td class="<$menu_style_prefix$>PopupLink" nowrap onMouseOver="glowPopupRow(this,'<$menu_style_prefix$>PopupLink_over','<$menu_style_prefix$>PopupLink')"	onMouseOut="fadePopupRow(this,'<$menu_style_prefix$>PopupLink')">
			<a style="text-decoration: none; font-weight: normal; font-size: 8pt" href="<$HttpCgiPath$>?IdcService=CCLA_CS_FUND_XFER_REPORT<$include add_idc_token_to_url$>">
				Fund Transfers
			</a>
		</td>
	</tr>

<@end@>

<!-- ------------------
Displays a form allowing submission of new batch documents,
classification panel has been removed.
----------------------- -->
<@dynamichtml batch_SandF_add_doc_header@>

	<div style="width: 600px; overflow-x: hidden">
		<div style='width: 290px;float:left;margin:5px;display:inline;'>
			<$include iris_add_batch_doc_panel$>
		</div>
	</div>

	<div style="clear:both"></div>
	<$include batchdocs_display_processing_count$>

<@end@>


<!-- Overriden from iris_batchdocs_resource.

		 When in thumbnailMode, the original include is used, otherwise
		 the third tab is customized for CCLA: 
		 
		 If the current doc has a type of Document, the 'Multi/Instruction docs' 
		 tab is shown. This displays a list of child docs associated with the 
		 current item (not the same as standard Iris 'associated docs'). 
		 
		 If the current doc has any type apart from Document, no third tab is shown. 
		 -->
<@dynamichtml doc_approval_tabs@>

	<$if thumbnailMode$>
		<table cellpadding=0 cellspacing=0 width="100%">
			<tr>
				<td valign="bottom">
					<$include super.doc_approval_tabs$>
				</td>
				<td valign="bottom" align="right">
					<$include bundle_autofetch_panel$>	
				</td>
				
					<$if false$>
						<div style="overflow:auto">		
							<div style="float:left;overflow:auto">
								<$include super.doc_approval_tabs$>
							</div>
							<div style="float:right;overflow:auto">
								<$include bundle_autofetch_panel$>	
							</div>
						</div>		
					<$endif$>
				</td>
			</tr>
		</table>
	<$else$>
		
		<$if #active.dDocType like 'Document'$>
			<table width='522' cellpadding=0 cellspacing=0>
		<$else$>
			<table width='348' cellpadding=0 cellspacing=0>
		<$endif$>
			
			<tr height='25'>
				<td width='172' align='center' class="tabOff" id='tab_image'>
					<a href="javascript:openTab('tab_image')"><span class="tab_text">
						Image
					</span></a>
				</td>
	
				<td width='172' align='center' class="tabOff" id='tab_notes'>
	
					<a href="javascript:openTab('tab_notes')"><span class="tab_text" id="tab_notes_caption">
						Notes/Activity (<$numNotes$>)
					</span></a>
	
				</td>
				
				<$if #active.dDocType like 'Document'$>
					<td width='172' align='center' class="tabOff" id='tab_docs'>
		
						<a href="javascript:openTab('tab_docs')"><span class="tab_text" id="tab_docs_caption">
							<$if (#active.xMultiDoc like "Yes")$>
								Multi Docs (<$numDocs$>)
							<$else$>
								Instruction Docs (<$numDocs$>)
							<$endif$>
						</span></a>
		
					</td>
				<$endif$>
			</tr>
		</table>
		
		<script type="text/javascript">
			// This piecee of script is used to highlight the 
			// currently-selected tab when the page loads.
			
			// Check the # of the current URL
			if (window.location.hash) {
				
				var curHash = window.location.hash;
				curHash = curHash.substring(1,curHash.length);
				
				var hashValues = curHash.split(",");
				
				var newTab = "";
				
				if (hashValues.length > 1) {
					// current tab will be held in the first portion of the
					// # string
					newTab = "tab" + hashValues[0];
					
					// selected dDocName will appear after the first comma
					// in the # string.
					var selDoc = hashValues[1];
				} else {
					newTab = "tab" + curHash;
				}
				
				if (newTab != "") {
					if (newTab == "tab_image" | newTab == "tab_docs" | newTab == "tab_notes")
						curTab = newTab;
				}
			}
			
			var tabElem = document.getElementById(curTab);
			tabElem.className = "tabOn";
			
		</script>
		
	<$endif$>

<@end@>

<!-- Overriden from iriscore_resource. Adds CCLA styling to
     paginator controls -->
<@dynamichtml iris_paginator_styles@>

	<style type="text/css">

		/* Styles for browse icons */

			.pn_large {
				padding: 0.3em 0.1em 0.3em 0.1em;
				margin: 2px 10px 2px 10px;
			}

			.pn_icon_rest {
				height: 15px;
				display: inline;
				border: 1px solid #999999;
				background-color: #F6F6DD;
				margin: 1px;
				text-align: center;
				cursor: pointer;
				color: #C20072;
			}

			.pn_icon_inactive {
				height: 15px;
				border: 1px solid #BBBBBB;
				background-color: #DDDDDD;
				color: #999999;
				margin: 1px;
				text-align: center;
				display: inline;
			}
			
			.pn_icon_inactive a {
				color: #999999;
			}
			
			.pn_icon_hover {
				height: 15px;
				display: inline;
				margin: 1px;
				text-align: center;
				cursor: pointer;
				border: 1px solid #000000;
				background-color: #DADAF0;
			}

			.pn_icon_sel {
				height: 15px;
				display: inline;
				border: 1px solid #000000;
				/* font-weight: bold; */
				color: #FFFFFF;
				background-color: #C20072; /*#9BDF30;  #DADAF0; */
				margin: 1px;
				text-align: center;
			}

			.pn_small {
				padding: 0.3em 0.5em 0.3em 0.5em;
			}

			.browse_ellipsis {
				display: inline;
				border: none;
				margin: 1px 0px 1px 0px;
				text-align: center;
				padding: 0.3em 0.0em 0.1em 0.0em;
			}

			#browse_panel a {
				text-decoration: none;
			}

	</style>

<@end@>

<!-- Popup panel content used for informing user about
     the effects of releasing a mail bundle from workfow.
     
     Clicking OK on this panel will submit the workflow
     form on the parent page.
     -->
<@dynamichtml ccla_confirm_release_panel@>

	<div class="grey_bg">
	<$include orangeContainer_top$>

	
		<div class='panelheader'  style="padding: 3px; border-bottom: 1px solid; margin-right: 3px">
			<b>Confirm release for envelope ID: <span class='docname'><$bundleRef$></span></b>
		</div>
		
		<div id="evelopeReleaseDiv">
			
			<$if false$>
				<div>
					<h3>This shouldn't be here</h3>
					
					<$executeService("CCLA_CP_ADD_DOC_BUNDLE")$>
					
					<$if bundleTranslated$>
						<$rsInstructions.#numRows$> instructions will be generated:
						
						<p>
							<$loop rsInstructions$>
								<$COUNT$> X <$INSTRUCTION_TYPE_NAME$>
								<br/>
							<$endloop$>
						</p>
					
					<$else$>
						<!-- Error during bundle translation -->
						<$FailReason$>
						<br/>
						<$FailMessage$>
						<br/>
						<$FailedDocName$>
					
					<$endif$>
					
				</div>
			<$endif$>
		
			<form name="actionform" id="commentform" method="get" action="<$HttpCgiPath$>">
				
				<br/>

				<table width="100%" cellpadding=0 cellspacing=2>
						
					<tr>
						<td>					
							<$exec rsMakeFromString("rsMultiDocClasses",#env.CCLA_multiDocClasses, "class")$>
						
							<$getViewValuesResultSet("vDOCUMENT_CLASSES","","")$>
							<$exec rsRename("SchemaData","rsDocumentClasses")$>
							
							<!--If rsBatchItems is not already in the binder, fetch it-->
							<$if rsBatchItems and rsBatchItems.#numRows > 0$>
							<$else$>
								<$executeService("IRIS_BATCH_GET_ITEMS")$>
							<$endif$>

							<$exec rsCreateResultSet("SPPJobs","DOCTYPE,TOTAL")$>
							
							<$totalSPPJobs 			= 0$>
							<$totalInstructionDocs 	= 0$>
							<$totalMultiDocs 		= 0$>
							
							<$totalTransDocs 		= 0$>
							<$totalSupportingDocs 	= 0$>
							
							<$totalDuplicates		= 0$>
							
							<!-- First check for MAND/APP items and duplicates. -->
							<$loop rsBatchItems$>
								<$if #active.xDocumentClass like "AUTOMAND|MAND"$>
									<$containsMAND=1$>
								<$endif$>
								
								<$if #active.xDocumentClass like "AUTOMAND|MAND|APP|APPSHORT"$>
									<$containsMANDorAPP=1$>
									<$mandOrAppDocName=#active.dDocName$>
								<$endif$>
								
								<$if #active.xStatus like "Duplicate"$>
									<$totalDuplicates = totalDuplicates + 1$>
								<$endif$>
							
							<$endloop$>
							
							<$loop rsBatchItems$>
								<$if not strEquals(#active.xStatus,"Duplicate")$>
									<$isIntructionDoc = ''$>
									<$isMultiDoc = ''$>
									
									<$if strEquals(#active.xWithInstruction, "Yes")$>
										<$isInstructionDoc=1$>
									<$endif$>
										
									<$if strEquals(#active.xMultiDoc, "Yes")$>
										<$isMultiDoc=1$>
									<$endif$>
									
									<$submitToSpp = ""$>
									
									<$if #active.xDocumentClass like "AUTOMAND|MAND"$>
										<$submitToSpp = "Y"$>
									<$else$>
									
										<$loop rsDocumentClasses$>
											<$if #active.xDocumentClass like #active.DOC_CLASS$>
												
												<$isSupporting = #active.IS_SUPPORTING$>
											
												<$if #env.SPP_SUPPRESS_MAND_SUPPORTING_DOC_SUBMISSION and containsMAND and (isSupporting like "Y")$>
													<!-- Supporting docs in MAND bundles aren't released to SPP. -->
													<$hasSuppressedSupportingDocs=1$>
												<$else$>
													<$submitToSpp = #active.SUBMIT_TO_SPP$>
												<$endif$>
											
											<$endif$>
										<$endloop$>
									
									<$endif$>
									
									<$if #local.submitToSpp like "Y"$>
										<$if rsFindRowPrimary("SPPJobs",#active.xDocumentClass)$>
											<$exec setValue("SPPJobs","TOTAL",SPPJobs.TOTAL + 1)$>
										<$else$>
											<$exec rsAppendRowValues("SPPJobs", #active.xDocumentClass & ",1")$>
										<$endif$>
									<$endif$>
								<$endif$>
							<$endloop$>
								
							<$loop SPPJobs$>
								<$totalSPPJobs = totalSPPJobs + SPPJobs.TOTAL$>
							<$endloop$>
													
							<$if not ignoreMissingChildDocs$>
							
								<!-- Fetch all multi-doc items. -->
								<$exec rsCreateResultSet("MultiDocs","DOCNAME,DOCTYPE")$>

								<$loop rsBatchItems$>
									<$loop rsMultiDocClasses$>
										<$if #active.xDocumentClass like #active.class$>
											<$exec rsAppendRowValues("MultiDocs", #active.dDocName & "," & #active.class)$>
										<$endif$>
									<$endloop$>
									
								<$endloop$>
								
								<!-- Check that each multi-doc item has at least 1 child document. -->
								<$loop MultiDocs$>
									<$hasChildDoc = ""$>
								
									<$loop rsBatchItems$>
										<$if (#active.xParentDocName like #active.DOCNAME)$>
											<$hasChildDoc = 1$>
										<$endif$>
									<$endloop$>
									
									<$if not hasChildDoc$>
										<$missingChildDocs = 1$>
									
										<p>
											<b>WARNING:</b> The <$#active.DOCTYPE$> bundle item 
											<a href="javascript:window.parent.selThumbByDocName('<$#active.DOCNAME$>');cancel();"><$#active.DOCNAME$></a>
											is a multi-doc type, but doesn't appear to have any instructions against it.
										</p>
									<$endif$>
								<$endloop$>
							
							<$endif$>
							
							<$if missingChildDocs$>
								
								<p>
									<input type="checkbox" name="ignoreMissingChildDocs" id="ignoreMissingChildDocs" /> I acknowledge this and wish to continue anyway (not recommended)
								</p>
							
							<$else$>
							
								<p>
									You are about to release all items in the current envelope. 
									
									<$if totalSPPJobs == 0$>
										This won't trigger any workflow jobs.
									<$else$>
										This will trigger the following <$totalSPPJobs$> jobs:
									<$endif$>	
									
								</p>
											
									<table>		
										<$loop SPPJobs$>
											<tr>
												<td>
													<$SPPJobs.TOTAL$> X <$SPPJobs.DOCTYPE$>
												</td>
											</tr>
										<$endloop$>
									</table>
								<$if false$>
								<p>
									The list includes <$totalInstructionDocs$> instruction documents and <$totalMultiDocs$> multi documents.
								</p>
								<$endif$>
																	
								<$if hasSuppressedSupportingDocs$>
									<p>
										The bundle contains a MAND plus at least one supporting document. These supporting documents
										will not be released to Workflow.
									</p>
								<$endif$>
								
								<$if containsMANDorAPP$>
								
									<$if isTrue(#env.SPP_INT_USE_TABLES_FOR_SUPPORTING_DOCS)$>
											
										<$performInit=1$>
										<$bundleRef=bundleRef$>
										<$isSupporting="1"$>
										<$executeService("CCLA_DEP_DOCS_INIT_DEPENDANT_DOCS_FOR_ENVELOPE")$>
										
										<$if isTrue(#active.bundleContainsAmbiguity)$>
											<p>
												This envelope contains multiple APPs/MANDs. It is therefore not possible 
												to automatically tell which supporting documents relate to which APP/MAND. Click 
												<a href="#" onClick="openSupportingDocManager('<$bundleRef$>');return false;">here</a> to resolve 
												this ambiguity. If you choose not to do this, all supporting documents in this envelope will relate to all 
												APPs/MANDs in the envelope. Please ignore this message if you have already resolved this ambiguity.
											</p>
										<$endif$>
									
									<$else$>
										<p>
											One of the main documents has been tagged as a MAND or APP. All other documents in the bundle will be
											tagged as supporting documents.
										</p>
									<$endif$>
									
								<$endif$>
								
								<$if totalDuplicates > 0$>
									<p>
										<$totalDuplicates$> document(s) were marked as duplicates and will be archived.
									</p>
								<$endif$>
								
								
							<$endif$>
							
							<br/>
							
						</td>
					</tr>
					<tr>
						<td align="center">
							<input type=button id="releaseEnvButton" value=Submit style="width: 120; margin: 2px;" onClick="releaseEnvelope();">
							<input type=button value=Cancel id="cancelRelease" style="width: 120; margin: 2px;" onClick="cancel();">
						</td>
					</tr>
				</table>
							
			</form>	
				
		</div>
		
	<$include orangeContainer_bottom$>
</div>
<@end@>

<!-- JavaScript include hook found in iriscore_resource.
		 
		 This hook is triggered just before the workflow form is
		 submitted, i.e. all validation checks have been
		 completed successfully. 
		 
		 For CCLA, we need to place another confirmation pop-up
		 window here while in the CCLA_MailHandling workflow. This
		 pop-up will display the effects of the user's workflow
		 action, i.e. how many documents will be submitted to SPP.
		 -->
<@dynamichtml iris_wf_action_validation_extra_js@> 

	if (document.doc_fields.dDocType.value == "Document" || document.doc_fields.dDocType.value == "ChildDocument") {

		// Open CCLA_CONFIRM_RELEASE template
		openPopup("<$HttpCgiPath$>?IdcService=GET_DOC_PAGE<$include add_idc_token_to_url$>&Action=GetTemplatePage" +
			"&Page=CCLA_CONFIRM_RELEASE&dDocName=<$dDocName$>&bundleRef=<$bundleRef$>&performReleaseChecks=1&action=" 
			+ action + "&ts=" + new Date().getTime(),500);
			
		// The user will trigger the workflow submission from the pop-up
		// window, so terminate the current function before it submits
		// the workflow form.
		return;
	}
	
<@end@>

<!--DJ - 18/11/09
		Duplciate checking for client, amount and date, with custom date check range.
-->
<@dynamichtml ccla_duplicate_resolve_panel@>
	<script type="text/javascript">
		// User opted to cancel duplicate window.
		function cancel()
		{
			window.parent.closePopup();
			window.parent.setWorkflowPanelEnabled(true);
		}
		
		submitDuplicateForm = function(){
			try{
				var docsMarkedAsDuplicate = [];
				var docsMarkedAsDuplicateStr = "";
				
				$('.mark_as_duplicate_radio').each(
					function( intIndex ){
						if($(this)[0].checked){
							var docName = $(this).attr("dDocName");
							docsMarkedAsDuplicate.push(docName);
							docsMarkedAsDuplicateStr += docName + ",";
						}
					}
				);
				
				var decision = true;
				
				if(docsMarkedAsDuplicate.length > 0) {
					decision = confirm("You have chosen to mark " + docsMarkedAsDuplicate.length + " document(s) as Duplicates." +
					" Any document marked as Duplicate will not start a job in SPP. Are you sure you want to continue?");
				}
				
				$("#saveAndProceedBtn").attr("disabled","disabled");
				$("#cancelBtn").attr("disabled","disabled");
				
				if (decision) {
					$.post(
						"?"
						, 
						$('#duplicate_action').serialize()
						,
						function(jsonData){
							var duplicateError 		= jsonData.LocalData.duplicateError;
							var disagreeDocName		= jsonData.LocalData.duplicateDisagreementDocName; 
						
							if (duplicateError && duplicateError == "1") {
								// Service execution error.
								
								alert(	"There was an error setting duplicate status for this bundle.\n\n" +
										"Please contact an administrator.");
										
							} else if (disagreeDocName) {
								// Disagreement between indexers over duplicate status of at least one
								// document. The bundle must be flagged in this case.
								
								alert(	"There was a disagreement about the duplicate status. This bundle " +
										"will be flagged automatically.");
										
								var flagForm = document.forms["flagBundleForm"];
								
								flagForm.elements["FLAG_REASON_ID"].value = 5;
								flagForm.elements["selDocName"].value = disagreeDocName;
								
								flagForm.submit();
								
							} else {
								// Progress to Submit Bundle confirmation 
								
								window.location.href = window.location.href + "&doDuplicateCheck=0&performReleaseChecks=0&docsToExclude="
								 + docsMarkedAsDuplicateStr;
							}
						}
						, 
						"json"
					);
				} else {
					window.location.href = window.location.href + "&doDuplicateCheck=0";
				}
				
			}catch(err){
				alert(err.description);
			}
		}
	</script>
	
	<style type="text/css">
		.label{
			width:90px;
			display:block;
			float:left;
			clear:left;
			font-weight:bold;
			text-align:right;
			margin-right: 2px;
		}
		
		.duplicateList {
			padding-left: 5px;
		}
		
		.duplicateList li{
			list-style:none;
			margin-top:4px;
		}
		
		table.accounts-table ,
		table.ccla-table {
			margin: 0px;
			padding: 0px;
			
			table-layout:fixed;
			word-break: break-word;
			border-style:solid;
			border-width:1px;
			background-color:#F3F3F6;
			border-color:#BBB6C5;
		}
		
		div.cs-pending-container {
			border: 1px inset; 
			margin-top: 1px; 
			height: 150px; 
			overflow-y: scroll;
		}	
	</style>
	
	<$executeService("CCLA_CHECK_BUNDLE_FOR_DUPLICATES")$>
	
	<!--If duplicates found, print them out and ask how to proceed-->
	<$if numDuplicatesFound > 0$>
		
		<$include orangeContainer_top$>
	
		<div class='panelheader' style="padding: 3px; border-bottom: 1px solid; margin-right: 3px">
			<b>Duplicate check: <span class='docname'><$bundleRef$></span></b>
		</div>
		
		<div style="margin: 5px">
		
			<p><$numDuplicatesFound$> of your document(s) has potential duplicate items. Any documents that you mark as Duplicates will not start a job in Workflow.</p>
			<p>The document(s) below are potential duplicates because they have the same Amount, Client Number and Account Number as another recent document.</p>
			
			<form name="duplicate_action" id="duplicate_action" action="<$HttpCgiPath$>" method="POST" style="margin: 0px; padding: 0px">
				<input type="hidden" name="IdcService" 			value="CCLA_UPDATE_DUPLICATES"/>
				<$include add_idc_token_to_form$>
				<input type="hidden" name="envelopeId" 			value="<$bundleRef$>"/>
				<input type="hidden" name="bundleDocName" 		value="<$dDocName$>"/>
				<input type="hidden" name="childDocsCheckedIn" 	value="1" />
				<input type="hidden" name="IsJson"				value="1"/>
				
				<div style="height:340px; overflow:scroll; border: 1px inset; overflow-y: scroll; overflow-x: hidden; padding: 2px;">
				
				<$useThumbnails=1$>
				
				<$loop rsBatchItems$>
					<$if strIndexOf(csvDuplicatedBatchItems, "," & rsBatchItems.dDocName & ",") >= 0$>
						<$temp = rsRename("rsDuplicatedItems", "rsDuplicatedItemsOLD")$>
						
						<$temp = rsRename("rsDuplicates_" & rsBatchItems.dDocName, "rsDuplicatedItems")$>
						<!--The current rsBatchItem row is a potential duplicate of all docs in rsDuplicatedItems-->
						<p style="font-weight: bold">
							<$rsBatchItems.dDocName$> is potentially duplicated with <$rsDuplicatedItems.#numRows$> item(s):
						</p>
						
						<$if #active.xStatus like "Duplicate"$>
							<!-- 	This document was already marked as a duplicate by the previous indexer. 
									Don't show any indication for now. -->
						<$endif$>
						
						<table border="1" width="99%">
							<tr>
								<!--Display the batch item trying to be submitted to SPP-->
								<td style="width:25px;background-color:#DDD;">
									
									<$include ccla_get_doc_url$>
									
									<a href="<$#local.cclaDocUrl$>" target="_blank" title="Click to view document">
										<$include searchapi_result_table_content_begin_img$>
									</a>
									
									
								</td>
								<td style="background-color:#DDD;width:230px;" align="left">
									<ul style="margin-left:0px;" class="duplicateList">
										<li><div class="label">Doc ID:&nbsp;</div><$rsBatchItems.dDocName$></li>
										<li><div class="label">Doc Class:&nbsp;</div><$rsBatchItems.xDocumentClass$></li>
										<li><div class="label">Envelope:&nbsp;</div><a href="?IdcService=DOC_APPROVAL<$include add_idc_token_to_url$>&bundleRef=<$rsBatchItems.xBundleRef$>#_image,<$rsBatchItems.dDocName$>" target="_blank"><$rsBatchItems.xBundleRef$></a></li>
										<li><div class="label">Account:&nbsp;</div><$rsBatchItems.xAccountNumber$></li>
										<li><div class="label">Amount:&nbsp;</div><$rsBatchItems.xAmount$>&nbsp;</li>
										<li><div class="label">Units:&nbsp;</div><$rsBatchItems.xUnits$>&nbsp;</li>
										<li><div class="label">Date In:&nbsp;</div><$rsBatchItems.dInDate$></li>
										<$if rsBatchItems.xBatchNumber > 0$>
											<li><div class="label">Workflow ID:&nbsp;</div><$rsBatchItems.xBatchNumber$></li>
											<li><div class="label">Date:&nbsp;</div><$rsBatchItems.xWorkflowDate$></li>
										<$endif$>
									</ul>
								</td>
								<td style="background-color:#DDD;">
									<input type="radio" name="duplicate_action_<$rsBatchItems.dDocName$>" 
										dDocName="<$rsBatchItems.dDocName$>" class="mark_as_duplicate_radio" value="1"/>Mark as Duplicate
									<br/>
									<input type="radio" name="duplicate_action_<$rsBatchItems.dDocName$>" 
										dDocName="<$rsBatchItems.dDocName$>" checked value="0"/>Proceed
								</td>
							</tr>
							
							<$csvDuplicatesOfList=""$>
							
							<!--Display each duplicate -->
							<$loop rsDuplicatedItems$>
								<$csvDuplicatesOfList=csvDuplicatesOfList & rsDuplicatedItems.dDocName & "," & rsDuplicatedItems.xBundleRef & ","$>
								<tr>
									<td style="width:30px;">
										
										<$include ccla_get_doc_url$>
									
										<a href="<$#local.cclaDocUrl$>" target="_blank" title="Click to view document">
											<$include searchapi_result_table_content_begin_img$>
										</a>
										
									</td>
									<td colspan="2" align="left">
										<ul class="duplicateList">
											<li><div class="label">Doc ID: </div><$rsDuplicatedItems.dDocName$></li>
											<li><div class="label">Doc Class: </div><$rsDuplicatedItems.xDocumentClass$></li>
											<li><div class="label">Envelope: </div><a href="?IdcService=DOC_APPROVAL<$include add_idc_token_to_url$>&bundleRef=<$rsDuplicatedItems.xBundleRef$>#_image,<$rsDuplicatedItems.dDocName$>" target="_blank"><$rsDuplicatedItems.xBundleRef$></a></li>
											<li><div class="label">Account: </div><$rsDuplicatedItems.xAccountNumber$></li>
											<li><div class="label">Amount: </div><$rsDuplicatedItems.xAmount$>&nbsp;</li>
											<li><div class="label">Units: </div><$rsDuplicatedItems.xUnits$>&nbsp;</li>
											<li><div class="label">Date In: </div><$rsDuplicatedItems.dInDate$></li>
											<$if rsDuplicatedItems.xBatchNumber > 0$>
												<li><br/></li>
												<li><div class="label">Workflow ID:&nbsp;</div><$rsDuplicatedItems.xBatchNumber$></li>
												<li><div class="label">Date:&nbsp;</div><$rsDuplicatedItems.xWorkflowDate$></li>
											<$endif$>
										</ul>
									</td>
								</tr>
							<$endloop$>
						</table>
						<input type="hidden" name="csvBundleItemDuplicateOf_<$rsBatchItems.dDocName$>" value="<$strSubstring(csvDuplicatesOfList,0,strLength(csvDuplicatesOfList)-1)$>"/>
					<$endif$>
				<$endloop$>
				
				</div>
				
				<br/>
				
				<input type="hidden" name="csvDuplicatedBundleItems" value="<$csvDuplicatedBatchItems$>"/>
				<input type="button" value="Save and Proceed" onClick="submitDuplicateForm();" id="saveAndProceedBtn" />
				<input type="button" value="Cancel" onClick="cancel()" id="cancelBtn" />
			</form>
					
			<br/>
		
		</div>
		
		<$include orangeContainer_bottom$>
		
	<$else$>
		<$include ccla_final_release_checks$>
	<$endif$>
<@end@>


<!--	Overriden from iriscore_resource.

			If the current item is a ChildDocument, its parent content will
			be loaded in the preview frame. Notice the URL to the parent
			item is built in a restricted way and is only supported if the
			parent content item is a PDF. 
			
			TODO: ensure url link is dynamically generated for child documents
 -->
<@dynamichtml iris_get_content_url_js@>

	<script type="text/javascript">
		
		// Fetches the absolute URL for the current content item.
		function getContentUrl() {
			var contentUrl;
			
			<$if #active.dDocType like 'ChildDocument'$>
				
				contentUrl = "<$getPdfDocUrl()$>";
				
			<$else$>
				contentUrl = '<$DocUrl$>';
			<$endif$>
			
			return contentUrl;
		}
		
	</script>

<@end@>

<!-- 	Thumbnail customization for CCLA.
			
			If the document has a type of 'ChildDocument', it will not
			have any content of its own and therefore no thumbnail.
			
			Instead, we show the thumbnail of the item's parent document.
			
			TODO: Ensure links are dynamically calculated using 
			computeRenditionUrl() function.
			-->
<@dynamichtml searchapi_result_table_content_begin_img@>

	<$if (#active.dDocType like "ChildDocument" and #active.xParentDocName) or (#active.dDocType like "Document")$>
		<$include ccla_get_doc_url$>
		
		<$if cclaDocUrl$>
			<$thumbnailUrl = ""$>
			
			<$if #active.dDocType like "Document"$>
				<$revLabel = #active.dRevLabel$>
				<$rendition = #active.dRendition1$>
			<$else$>
				<$revLabel = "1"$>
				<$rendition = "T"$>
			<$endif$>
			
			<$if useThumbnails and rendition like "t|g|p"$>
				<$thumbnailUrl = computeRenditionUrl(cclaDocUrl, revLabel, rendition)$>
				
				<$if debugDocUrlGeneration$>
					<$trace("Thumnail URL for " & #active.dDocName & ": " & thumbnailUrl & ", derived from doc URL: " & cclaDocUrl, "#log")$>
				<$endif$>
			<$endif$>
			
			<$rendition = ""$>
			
			<$if thumbnailUrl$>
				<!-- rendition1 -->
				<img src="<$thumbnailUrl$>" border="0"
					<$if not maintainAspectRatio$>width="<$ImageWidth$>" 
					 alt="<$stripXml(lc("wwLinkToDocument"))$>" height="<$ImageHeight$>"<$endif$>>
			<$elseif dGif$>
				<img src="<$HttpWebRoot$>images/docgifs/<$dGif$>" border="0" alt="<$stripXml(lc("wwLinkToDocument"))$>"
					width="<$ImageWidth$>" height="<$ImageHeight$>">
			<$else$>
				<$strTrimWs(inc("doc_doctype_default_image"))$>
				
			<$endif$>
				
		<$endif$>		
				
	<$else$>
		<$include super.searchapi_result_table_content_begin_img$>	
	<$endif$>

<@end@>

<!-- Old thumbnail include, used fixed URL links for CCLA content. -->
<@dynamichtml searchapi_result_table_content_begin_img_OLD@>

	<$if #active.dDocType like "ChildDocument" and #active.xParentDocName$>

		<$if #active.xPdfDocName$>
			<$pdfRef = #active.xPdfDocName$>
		<$else$>
			<$pdfRef = xParentDocName$>
		<$endif$>
		
		<$parentThumbnailUrl = HttpWebRoot & "groups/public/documents/document/" & strLower(pdfRef) & "@t~1.jpg"$>
	
			<img src="<$parentThumbnailUrl$>" border="0"
				<$if not maintainAspectRatio$>width="<$ImageWidth$>" 
				alt="<$#active.dDocName$>" height="<$ImageHeight$>"<$endif$>>
		
	<$elseif #active.dDocType like "Document"$>
		
		<$include ccla_get_doc_url$>

		<$thisThumbnailUrl = HttpWebRoot & "groups/public/documents/document/" & strLower(#active.dDocName) & "@t~1.jpg"$>
		
		<img src="<$thisThumbnailUrl$>" border="0"
			<$if not maintainAspectRatio$>width="<$ImageWidth$>" 
			alt="<$#active.dDocName$>" height="<$ImageHeight$>"<$endif$>>
		
	<$else$>
		<$include super.searchapi_result_table_content_begin_img$>
	<$endif$>
	
<@end@>

<!-- Override pop-up menu styles to point at external stylesheet -->
<@dynamichtml float_menu_styles@>

	<link rel="stylesheet" href="<$HttpWebRoot$>resources/ccla/float_menu_styles.css" type="text/css">

<@end@>


<!-- Computes a value for 'auditText', which displays the
		 current audit action as a user-friendly string.

		 Requires auditCode and auditParams to be present in
		 the binder. 
		 
		 Overriden from iriscore_resource to include extra
		 batch audit actions.
		 -->
<@dynamichtml iris_compute_audit_text@>
	<$auditText=''$>
	
	<$if lAction like 'UPDATE-DOC'$>
		Document updated
	
	<$elseif lAction like 'APPROVE' and lParam1 like 'CCLA_MailHandling'$>
		<$if lParam2 like 'Validation'$>
			Bundle items validated
		<$elseif lParam2 like 'EnterDetails'$>
			Bundle items marked as indexed 
		<$else$>
			Document approved: <$lParam2$>
		<$endif$>
	
	<$elseif lAction like 'FLAG-BUNDLE'$>
		<$flagReason	= lParam2$>
		<$hasCustomNote = lParam3$>
		<$selDocName 	= lParam4$>

		Bundle flagged: <$flagReason$><$if selDocName$>.
			<$docClass = lParam5$>
			
			See <$if docClass$><$docClass$><$endif$> item: <$if NOT hideLinks$><a href="<$HttpCgiPath & '?IdcService=DOC_APPROVAL' & inc('add_idc_token_to_url') & '&bundleRef=' & bundleRef$>#_image,<$selDocName$>"><$selDocName$></a><$else$><$selDocName$><$endif$>
		<$endif$>
		
		<$if hasCustomNote$>
			<p class='iris_user_note'><b>User note:</b> <$lMessage$></p>
		<$endif$>
	
	<$elseif lAction like 'AUTO-UNFLAG-BUNDLE'$>
		<$lMessage$>
	
	<$elseif lAction like 'SPP-CLONE-DOC'$>
		Document 	<a href='javascript:displayBundleDoc("<$lParam1$>");'><$lParam1$></a> cloned as 
					<a href='javascript:displayBundleDoc("<$lParam2$>");'><$lParam2$></a> by Workflow web service request
	
	<$elseif lAction like 'SPP-SUBMIT'$>
		<$lParam2$> document(s) submitted to Workflow successfully with workflow ID: <$if NOT hideLinks$><a target="_top" href="<$HttpCgiPath$>?IdcService=IRIS_CLASSIFIED_ITEMS<$include add_idc_token_to_url$>&wfid=<$lParam1$>"><$lParam1$></a><$else$><$1Param1$><$endif$>
	
	<$elseif lAction like 'PL-SUBMIT'$>
		<$lParam2$> document(s) submitted to Parking Lot with workflow ID: <$if NOT hideLinks$><a target="_top" href="<$HttpCgiPath$>?IdcService=IRIS_CLASSIFIED_ITEMS<$include add_idc_token_to_url$>&wfid=<$lParam1$>"><$lParam1$></a><$else$><$1Param1$><$endif$>
	
	<$elseif lAction like 'SPP-BATCH-ALLOC|ADD-BUNDLE-TO-INSTRREG'$>
		<$if lAction like 'ADD-BUNDLE-TO-INSTRREG'$>
			<a href="?IdcService=CCLA_CP_INSTRUCTION_LISTING<$include add_idc_token_to_url$>&ucmBatchRef=<$#local.bundleRef$>"><$lParam3$> items</a> added to Instruction Register
			
			<$if lParam4$>
				with pre-allocated workflow ID <a href="?IdcService=CCLA_CP_INSTRUCTION_LISTING<$include add_idc_token_to_url$>&sppBatchRef=<$lParam4$>"><$lParam4$></a>
			<$endif$>
			
		<$elseif lAction like 'SPP-BATCH-ALLOC'$>
			Instruction Register allocated Workflow batch no: <a href="?IdcService=CCLA_CP_INSTRUCTION_LISTING<$include add_idc_token_to_url$>&sppBatchRef=<$lParam1$>"><$lParam1$></a>
		<$endif$>

	<$elseif lAction like 'SPP-SUBMIT-DOC|SPP-MAN-SUBMIT'$>
		<$lMessage$>
	
	<$elseif lAction like 'RESET-PL-DOC'$>
		<$lMessage$>
	
	<$elseif lAction like 'DUPLICATE-ST-UPD|DUPLICATE-IGNORE'$>
		<$duplicateDocNamesIndex = strIndexOf(lMessage, "of: ") + 4$>
		
		<$csvDuplicateDocNames = strSubstring(lMessage, duplicateDocNamesIndex, strLength(lMessage))$>
		<$rsMakeFromString("rsPotentialDuplicateDocs", csvDuplicateDocNames)$>
		
		<$strSubstring(lMessage, 0, duplicateDocNamesIndex)$>
		
		<$duplicateCounter=0$>
		<$loop rsPotentialDuplicateDocs$>
			<$duplicateCounter=duplicateCounter+2$>
			
			<$itemDocName = rsPotentialDuplicateDocs.row$>
			<$exec rsNext("rsPotentialDuplicateDocs")$>
			<$itemBundleRef = rsPotentialDuplicateDocs.row$>
			
			<$if NOT hideLinks$><a href="<$HttpCgiPath & '?IdcService=DOC_APPROVAL&bundleRef=' & itemBundleRef$>#_image,<$itemDocName$>" target="_blank"><$itemDocName$> (<$itemBundleRef$>)</a><$else$><$itemDocName$> (<$itemBundleRef$>)<$endif$>
			<$if duplicateCounter < rsPotentialDuplicateDocs.#numRows$>,<$endif$>
		<$endloop$>
	
	
	<$elseif lAction like 'DUP-BUNDLE-RESET'$>
		Reset duplicate status of <a href='javascript:displayBundleDoc("<$lParam1$>");'><$lParam1$></a>
	
	<$elseif lAction like 'MAND-RESUBMIT'$>
		<$lMessage$>
	
	<$elseif lAction like 'CHECKIN-BUNDLE-CHILD-DOCS'$>
		<$lParam1$> instruction/multi documents created<$if lParam2$> and <$lParam2$> submitted to Workflow<$endif$>
	
	<$elseif lAction like 'CHECKIN-MULTI-DOCS'$>
		<$lParam1$> multi documents created<$if lParam2$> and <$lParam2$> submitted to Workflow<$endif$>
	
	<$elseif lAction like 'CHECKIN-INSTR-DOCS'$>
		<$lParam1$> instruction documents created<$if lParam2$> and <$lParam2$> submitted to Workflow<$endif$>
	
	<$elseif lAction like 'DEL-BUNDLE'$>
		Bundle deleted, <$lParam2$> documents marked as expired
	<$elseif (lAction like 'UPDATE-ITEM-STATUS') or (lAction like 'FLAG-USER-NOTIFY') or (lAction like 'UNFLAG-BUNDLE')$>	
		<$lMessage$>
	<$elseif (lAction like 'RESET-BUNDLE') or (lAction like 'CHECKOUT-CHECKIN')$>	
		<$lMessage$>
	<$else$>
		<$include super.iris_compute_audit_text$>
	<$endif$>
	
	<$isWFAction=''$>

<@end@>

<@dynamichtml get_result_count@>
	  		        
	<$if TotalRows le 0$>
		<$if not SearchResults$>
			<$resultCountStr = lc("wwNoItemsFound")$>
		<$else$>
			<$resultCountStr = lc("wwItemsOf", 1, SearchResults.#numRows, SearchResults.#numRows)$>
		<$endif$>
	<$else$>
		<$resultCountStr = lc("wwItemsOf", ssFirstHit, ssLastHit, TotalRows)$>
	<$endif$>

<@end@>

<!-- 	Overrides display of Associated Docs page from
			iriscore_resource. -->
<@dynamichtml iris_linked_doc_listing_pre@>

	<$include iris_linked_docs_js$>

	<$include iris_sf_sort_images$>

	<$isDocSearchAndFilter = 1$>

	<$custTableAttrs="class='IssueBlock' cellpadding='4' cellspacing='1' width='100%' border='0' bgcolor='#F6F6F4'"$>
  <$custRowAttrs="class='resultrow_linked'"$>
  <$custColumnHeaderEval="<$if columnCounter==0$> class='sfHeader_start' <$elseif columnCounter >= (totalColumns-1)$> class='sfHeader_end' <$else$> class='sfHeader_mid' <$endif$> height=40 cellpadding=1"$>

  <$hideLineBreak="1"$>
  <$displayColumnHeaderSortOptions="N"$>

  <$nodeFilterFieldWidth="1,15,30,20,15,20,1"$>
  <$nodeFilterFieldNames="SOMETHING,REF,DOC_CLASS,CCLA_ACC_NUM,CCLA_AMOUNT,CCLA_BUNDLE_DATE,DOCACTIONS"$>
	
	<$PARAMETERSLIST=PARAMETERSLIST & ",dDocName"$>
	
  <$overrideFirstColumn="Y"$>
	<$inlineHeaderInclude=""$>

  <$nodeSearchQuery = "(xParentDocName <matches> `" & dDocName & "`) <and> (dDocType <matches> `ChildDocument`)"$>

  <$SF_DISPLAYADVSEARCHLINK=""$>

  <$displayCountSummary="Y"$>
  <$displaySearchButton="N"$>
  <$displayFilterOptions="N"$>
  <$useAdvancedSearch="N"$>
  <$advSearchFieldList=""$>
	<$allowContentTypeLinkOverride="Y"$>
	<$hideInfoLink="Y"$>
		
	<$displayPagingOptions="N"$>
	<$displayPaginator="Y"$>
	<$SF_CustomPaginator="iris_sf_paginator"$>

	<$CCLA_BUNDLE_DATE_CustomIncludeScript="CCLA_DATE_CustomIncludeScript"$>
	<$REF_CustomIncludeScript="CCLA_CHILD_DOC_REF_CustomIncludeScript"$>
  <$DOCACTIONS_CustomIncludeScript="CCLA_DocActions_CustomIncludeScript"$>

  <$linkedDocType = "LinkedDoc"$>
  <$customSearchScript = "performLinkedItemSearch"$>

<@end@>


<@dynamichtml CCLA_CHILD_DOC_REF_CustomIncludeScript@>
	<a href="<$HttpCgiPath$>?IdcService=DOC_APPROVAL<$include add_idc_token_to_url$>&dDocName=<$#active.dDocName$>" target="_top"><$dDocName$></a>
<@end@>

<!-- 	Overriden from iris_batchdocs_resource.
			
			When in bundle/thumbnail mode, the batchdocs include is used
			as normal. For single items, things are a bit different in
			CCLA's case. The Associated Docs tab is replaced by a Child
			Docs tab instead. Child docs are fetched based on the value of
			their xParentDocName field.
 -->
<@dynamichtml doc_approval_count_totals@>
	
	<$if thumbnailMode$>
		<$include super.doc_approval_count_totals$>
	<$else$>
	
		<$numNotes = 0$>
		<$numDocs = 0$>
	
		<$origDocName = dDocName$>
	
		<$hasRecentNotes = ''$>
	
		<!-- find number of child docs -->
		<$parentId=dDocName$>
		<$executeService("CCLA_GET_CHILD_DOC_COUNT")$>
		<$numDocs = getValue("childDocCount","NUMCHILDDOCS")$>
	
		<$trace("fetching audit entry count, dDocName = " & #active.dDocName)$>
		<!-- find number of associated notes -->
		<$executeService("IRIS_GET_AUDIT_ENTRY_COUNT")$>
		
		<$if rsEntryCount.AUDITENTRYCOUNT$>
			<$numNotes = rsEntryCount.AUDITENTRYCOUNT$>
		<$endif$>
	
		<$if numNotes > 0$>
			<$hasRecentNotes = 1$>
		<$else$>
			<$showRecentNotes = ''$>
		<$endif$>
	
		<!-- Restore parent dDocName -->
		<$dDocName = origDocName$>
		
	<$endif$>

<@end@>

<!-- 	Overridden from ECS_SearchAndFilter component. Designed to pick up
		from-to date values in the parameters list. -->
<@dynamichtml buildParameterList@>

  <$if QueryFieldList$>
    <$rsMakeFromString("rsParameters",QueryFieldList,"param")$>

    <$if rsParameters$>

      <$loop rsParameters$>

        <$shortName = getValue("#active","SF_" & param & "_shortname")$>
		<$type = getValue("#active","SF_" & param & "_type")$>
        
		<$if type like "fromto"$>
			<$from_value = getValue("#active",shortName & "_from")$>
			<$to_value = getValue("#active",shortName & "_to")$>
			
			<$if from_value$>
			  <$if parameters$>
				<$parameters= parameters & "&" & shortName & "_from" & "=" & from_value$>
			  <$else$>
				<$parameters= "&" & shortName & "_from" & "=" & from_value$>
			  <$endif$>
			<$endif$>
			
			<$if to_value$>
			  <$if parameters$>
				<$parameters= parameters & "&" & shortName & "_to" & "=" & to_value$>
			  <$else$>
				<$parameters= "&" & shortName & "_to" & "=" & to_value$>
			  <$endif$>
			<$endif$>
			
		<$endif$>
		
		<$value = getValue("#active",shortName)$>

		<$if value$>
		  <$if parameters$>
			<$parameters= parameters & "&" & shortName & "=" & value$>
		  <$else$>
			<$parameters= "&" & shortName & "=" & value$>
		  <$endif$>
		<$endif$>
		
      <$endloop$>

    <$endif$>
  <$endif$>

  <$rsMakeFromString("rsParameterAdditionals",PARAMETERSLIST,"paramAdd")$>
  <$if rsParameterAdditionals$>

    <$loop rsParameterAdditionals$>

      <$paramValue = getValue("#active",paramAdd)$>

      <$if paramValue$>
        <$if parameters$>
          <$parameters= parameters & "&" & paramAdd & "=" & paramValue$>
        <$else$>
          <$parameters= "&" & paramAdd & "=" & paramValue$>
        <$endif$>
      <$endif$>

    <$endloop$>

  <$endif$>

  <$if parameters$>
    <$parameters=strReplace(parameters," ","+")$>
  <$endif$>

<@end@>

<!-- Displays the list of document classes as an option list, taken from the 
	 vDOCUMENT_CLASSES UCM view. -->
<@dynamichtml ccla_document_class_option_list@>
	<$if #env.CCLA_ENABLE_DYNAMIC_DOCCLASS_PROFILE_CONDITION==1$>
	<script type="text/javascript">
	
		var selDocumentClass = "";
		
		$(document).ready(function(){
			selDocumentClass = $("#xDocumentClass").val();
			
			/*
			On change, call the IRIS_GET_CONDITION_FOR_PARAMS method to obtain the condition, 
			if it is different to $conditionName$ save the panel, forcing a refresh of the panel...
			*/
			$("#xDocumentClass").bind("blur",function(){	
				var curDocumentClass = $("#xDocumentClass").val();
			
				// Check that the doc class has changed before continuing
				if (selDocumentClass == curDocumentClass)
					return;
					
				selDocumentClass = curDocumentClass;
				
				$.getJSON("?IdcService=IRIS_GET_CONDITION_FOR_PARAMS<$include add_idc_token_to_url$>", 
					{ 	
						"metaField":		"xDocumentClass",
						"metaValue":		$("#xDocumentClass").val(),
						"profileName": 		"<$profileName$>",
						"ts":				new Date().getTime(),
						"IsJson": 1
					}, 
					function(jsonData) {
						var jsonErrorMsg  = getJsonErrorMsg(jsonData);
						if (jsonErrorMsg)
							alert(jsonErrorMsg);
						
						var currentCondition = "<$conditionName$>";
						if (jsonData.LocalData.latestConditionName != currentCondition){
							// Focus the input element that appears AFTER the xDocumentClass selector.
							// This is currently xSource.
							focusElementId = "xSource";
							saveDocInfo();
						}
					});
			});
		});
		
	</script>
	<$endif$>
	
	<$getViewValuesResultSet("vDOCUMENT_CLASSES","","")$>
	<$currentDocClass = #active.xDocumentClass$>
	<select name="xDocumentClass" id="xDocumentClass" tabindex="<$include iris_get_next_tabindex$>" >
		<option value=""></option>
		
		<$loop SchemaData$>
			<option value="<$#active.DOC_CLASS$>" <$if strEquals(currentDocClass, #active.DOC_CLASS)$>selected<$endif$> ><$#active.DOC_CLASS$></option>
		<$endloop$>
	</select>
	
<@end@>

<!-- Displays the list of document classes as an option list, taken from the 
	 vDOCUMENT_CLASSES UCM view. Used for custom S&F filter include -->
<@dynamichtml ccla_document_class_option_list_sf@>
	
	<$getViewValuesResultSet("vDOCUMENT_CLASSES","","")$>
	
	<select name="doc_class" id="doc_class" class="sfSelect">
		<option value=""></option>
		
		<$loop SchemaData$>
			<option value="<$#active.DOC_CLASS$>" <$if #local.doc_class like #active.DOC_CLASS$>selected<$endif$> ><$#active.DOC_CLASS$></option>
		<$endloop$>
	</select>
	
<@end@>

<!-- Overridden doc listing footer, adds JavaScript code for displaying
     envelope item counts via AJAX call. -->
<@dynamichtml doc_listing_footer@>

	<$include super.doc_listing_footer$>
	
	<$include iris_common_js$>
	
	<$include iris_sf_bundle_item_counts_js$>

<@end@>

<!-- Used by Workflow Token CCLA_Token_Omit_Indexer.
	
	Adds all users from the configured aliases (WF_Scanning/WF_COO, see env var) but excludes the previous 
	indexer (xIndexer value) if we are at the second Validation step, and they are not in the special override
	users list.
	
	The env var CCLA_indexAndValidateUsers contains a comma-separated list of users who will never be excluded
	(thus allowed to index AND validate the same bundles).
	
	The weblogic user is ALWAYS added as an approver regardless. If there is some terrible failure with the
	rest of the evaluation script, this should ensure that weblogic is always a valid step user, preventing
	the item from dropping out of workflow.
 -->
<@dynamichtml ccla_document_wf_approvers_token@>
	<$trace("Token script started for " & dDocName & ", wfAction=" & #local.wfAction,"#console")$>
		
	[[% List of aliases containing users who are eligible as approvers for CCLA_MailHandling workflow %]]
	<$exec rsMakeFromString("rsApproverAliases", #env.CCLA_workflowApproverAliases)$>
	
	[[% List of usernames who are allowed to index AND validate bundles %]]
	<$exec rsMakeFromString("rsIndexAndValidateUsers", #env.CCLA_indexAndValidateUsers)$>
	
	<$lastIndexer = wfGet("lastIndexer")$>

	<$if rsApproverAliases$>
		<$loop rsApproverAliases$>
			<$if #active.rsAliasMembers$>
				<$exec rsRename("rsAliasMembers", "rsAliasMembers_old")$>
			<$endif$>
			
			<$aliasName = rsApproverAliases.row$>		
			<$aliasMembers = irisGetAliasMembers()$>
			
			<$trace("Evaluating approvers for CCLA_MailHandling", "#console")$>
			<$trace("dDocName=" & dDocName & ", lastIndexer=" & #local.lastIndexer, "#console")$>
			<$trace("Fetched aliasMembers: " & aliasMembers & ", aliasName=" & aliasName, "#console")$>

			<$exec rsMakeFromString("rsAliasMembers", aliasMembers, "dUserName")$>

			<$if rsAliasMembers$>
				<$loop rsAliasMembers$>

					<$if strEquals(dWfStepName,"Validation")$>
						<$addThisUser = ""$>
						
						<$if strEquals(rsAliasMembers.dUserName,lastIndexer)$>
							
							<$loop rsIndexAndValidateUsers$>
								<$if strEquals(rsAliasMembers.dUserName,rsIndexAndValidateUsers.row)$>
									[[% Dont exclude the previous indexer, they are allowed to index and validate the same bundles %]]
									<$addThisUser = 1$>
								<$endif$>
							<$endloop$>
						
						<$else$>
							<$addThisUser = 1$>
						<$endif$>
						
						<$if addThisUser$>
							<$wfAddUser(rsAliasMembers.dUserName, "user")$>
						<$endif$>

					<$else$>
						<$wfAddUser(rsAliasMembers.dUserName, "user")$>
					<$endif$>
					
				<$endloop$>
			<$endif$>
			
		<$endloop$>
	<$endif$>
		
	[[% fail safe so at least weblogic can approve docs %]]
	<$wfAddUser("weblogic", "user")$>
	<$trace("Token script completed for " & dDocName,"#console")$>
	
<@end@>

<!-- 	Overriden from iriscore_resource to handle custom CCLA errors.

		Panel displayed via pop-up if workflow action validation fails.
     
			The panel gives a detailed breakdown of why the validation failed.
			-->
<@dynamichtml iris_wf_validation_report_panel@>

	<script type="text/javascript">
		
		// Selects the given batch item.
		function selThumb(docName) {
			window.parent.closePopup();
			window.parent.selThumbByDocName(docName);
		}
		
	</script>

	<div class="grey_bg">
	<$include orangeContainer_top$>

		<div class='panelheader error_icon' style="padding: 3px 3px 3px 20px; border-bottom: 1px solid; margin-right: 3px;">
		
			<$if validationFailed$>
				<b>Errors during validation</b>
			<$else$>
				<b>Validation successful</b>
			<$endif$>
			
		</div>
		
		<div>
			
			<$if validationPassed$>
				
				<!-- Display confirmation of successful validation -->
				<table width="100%" cellpadding=0 cellspacing=2>
				
					<tr>
						<td align="center">
							<br/>
							The document <$dDocName$> was validated successfully.
							<br/>
							<br/>
							<input type=button value=OK style="width: 120; display: block; margin: 2px;" onClick="window.parent.location.reload(true);">
						</td>
					</tr>
					
				</table>
			
			<$else$>
					
					<!-- Display validation errors -->
					<br/>
					
					<table width="100%" cellpadding=0 cellspacing=2>
							
						<tr>
							<td>
								<p>
									You cannot perform the required workflow action at this time. Please fix the errors listed below and try again.
								</p>
								
								<$if validationErrorMessage$>
									An internal error has occured. Please contact an administrator.
									<br/><br/>
									<$validationErrorMessage$>
								<$endif$>
								
								<$if bundleFlagged$>
									<ul>
										<li>
											This bundle has been flagged. Please ensure the reason for flagging has been resolved,
											then click the 'Unflag' action in the Bundle Details panel before trying to process.
										</li>
									</ul>
								<$endif$>
								
								<$if requiredBatchItemFieldsMissing$>
									<b>Required fields</b> were missing on <$rsBatchItemsMissingReqFields.#numRows$> documents:
									
									<ul>
										<$loop rsBatchItemsMissingReqFields$>
											<li>
												<a href="javascript:selThumb('<$rsBatchItemsMissingReqFields.dDocName$>');">
													<$rsBatchItemsMissingReqFields.dDocName$> <$if #active.xDocumentClass$>(<$#active.xDocumentClass$>)<$endif$>
												</a>
											</li>
										<$endloop$>
									</ul>
									
								<$endif$>
								
								<$if requiredBatchItemAccountFieldsMissing$>
									<b>Required account fields</b> were missing on <$rsBatchItemsMissingReqAccountFields.#numRows$> documents:
									
									<ul>
										<$loop rsBatchItemsMissingReqAccountFields$>
											<li>
												<a href="javascript:selThumb('<$rsBatchItemsMissingReqAccountFields.dDocName$>');">
													<$rsBatchItemsMissingReqAccountFields.dDocName$> (<$#active.xDocumentClass$>)
												</a>
											</li>
										<$endloop$>
									</ul>
									
								<$endif$>

								<$if rsBatchItemsMissingReqDestinationFields$>
									<b>Required standing order destination fields</b> were missing on <$rsBatchItemsMissingReqDestinationFields.#numRows$> documents:
									
									<ul>
										<$loop rsBatchItemsMissingReqDestinationFields$>
											<li>
												<a href="javascript:selThumb('<$rsBatchItemsMissingReqDestinationFields.dDocName$>');">
													<$rsBatchItemsMissingReqDestinationFields.dDocName$> (<$#active.xDocumentClass$>)
												</a>
											</li>
										<$endloop$>
									</ul>
									
								<$endif$>

								<$if false$>
									<$if rsBatchItemsMissingDualIndexing$>
										<b>Missing or Failed Dual Index Items </b>found in <$rsBatchItemsMissingDualIndexing.#numRows$> document(s):
											
										<ul>
											<$loop rsBatchItemsMissingDualIndexing$>
												<li>
													<a href="javascript:selThumb('<$rsBatchItemsMissingDualIndexing.dDocName$>');">
														<$rsBatchItemsMissingDualIndexing.dDocName$> (<$#active.xDocumentClass$>) - <$#active.status$>
													</a>
												</li>
											<$endloop$>
										</ul>
										<a title="Resets Dual Indexing data for this bundle" 
											href="javascript:resetDualIndexing();">Click here</a> to reset the dual indexing for these items.
									<$endif$>
								<$endif$>
								
								<$if rsBatchItemsMismatchedContactPoints$>
									<b>Mismatched nominated addresses </b>found in <$rsBatchItemsMismatchedContactPoints.#numRows$> document(s):
									
									<ul>
										<$loop rsBatchItemsMismatchedContactPoints$>
											<li>
												<a href="javascript:selThumb('<$rsBatchItemsMismatchedContactPoints.dDocName$>');">
													<$rsBatchItemsMismatchedContactPoints.dDocName$> (<$#active.xDocumentClass$>)
												</a>
											</li>
										<$endloop$>
									</ul>

									This error will be shown for Mandates, Applications etc. where the account correspondent's default address
									does not match the selected address in the Corr. address field.
									
									<br/><br/>
									Ensure that the correct nominated correspondent address is set against the Person record AND the document.

								<$endif$>
								
								<$if rsBatchItemsMismatchedFormState$>
									<b>Mismatched form states</b> found in <$rsBatchItemsMismatchedFormState.#numRows$> document(s):
									
									<ul>
										<$loop rsBatchItemsMismatchedFormState$>
											<li>
												<a href="javascript:selThumb('<$rsBatchItemsMismatchedFormState.dDocName$>');">
													<$rsBatchItemsMismatchedFormState.dDocName$> (<$#active.xDocumentClass$>)
												</a>
											</li>
										<$endloop$>
									</ul>

									This error will be shown for items with a Form ID set that are in one of the two states below:
									
									<ul>
										<li>
											Form has been explicitly marked as 'Invalid' but isn't set as document class CONDINS
										</li>
										<li>
											Form has NOT been explicitly marked as 'Invalid' but is set as document class CONDINS
										</li>
									</ul>
									
									<br/>
									
									Ensure that the document class is always set to CONDINS if the form is invalid.
									
								<$endif$>
							</td>
						</tr>
						<tr>
							<td align="center">
								<input type=button value="OK" style="width: 120; margin: 2px;" onClick="window.parent.closePopup();">
							</td>
						</tr>
						
					</table>
								
				</form>	
				
			<$endif$>
				
		</div>
		
		
	<$include orangeContainer_bottom$>
	</div>
	
<@end@>

<!-- Overrides default header for doc info/update panel -->
<@dynamichtml iris_doc_panel_header@>

	<$if dDocType like #env.Iris_batchDocType$>
		Bundle Details - <span class='docname'><$getValue("#active",#env.Iris_batchIdField)$></span>
	<$else$>
		Item Details - <span class='docname'><$dDocName$></span>&nbsp;&nbsp;
		<img src="/ucm/images/ccla/refresh.png" onclick="reloadDocInfo();" title="Reload" alt="Reload" style="cursor:pointer">	<$endif$>

<@end@>

<@dynamichtml ccla_pending_mandates_check@>
	<script type="text/javascript">
		openPendingBundleWindow = function (ddocName, bundleRef){
			var url = "?IdcService=DOC_APPROVAL<$include add_idc_token_to_url$>&dDocName="+ddocName+"&bundleRef="+bundleRef+"&view=Bundle";
			var pendingWin = window.open(url, "Pending_Bundle", "status=0,toolbar=0,width=850,height=550,resizable=1,scrollbars=1");
			pendingWin.focus();	
		}
	</script>
	<style type="text/css">		
		div.cs-pending-container {
			border: 1px inset; 
			margin-top: 1px; 
			height: 150px; 
			overflow-y: scroll;
		}	
	</style>	
	<$executeService("CCLA_GET_ALL_PENDING_DOCS_FOR_BUNDLE")$>

	<div class="grey_bg">
		<$include orangeContainer_top$>
		<div class='panelheader' style="padding: 3px; border-bottom: 1px solid; margin-right: 3px">
			<b>Warning:</b> there are other pending MAND/APP documents for this client:
		</div>
		
		
		<$if rsAllPendBundle$>
			<br/>
			<div class="cs-pending-container">
				<table width="98%" cellspacing="5px" cellpadding="0" class="accounts-table">
					<tbody>
						<tr>
							<td width="20%"><b>Doc Class</b></td>
							<td width="30%"><b>Bundle Ref</b></td>
							<td width="20%"><b>Client No.</b></td>
							<td width="30%"><b>Date Added</b></td>

						</tr>	
							
						<$loop rsAllPendBundle$>
						<tr>
							<td><$#active.xDocumentClass$></td>
							<td><a href="#" onclick="openPendingBundleWindow('<$#active.dDocName$>','<$#active.xBundleRef$>');return false;"><$#active.xBundleRef$></a></td>
							<td><$#active.xClientNumber$></td>
							<td><$formatDateWithPattern(#active.dInDate,"dd MMM yy HH:mm")$></td>

						</tr>
						<$endloop$>
					</tbody>
				</table>
			</div>
		<$endif$>		
		<$include orangeContainer_bottom$>
	</div>
<@end@>	

<@dynamichtml ccla_documentClasses_cache@>
<script type="text/javascript">

	//Array of documentClasses
	var documentClassArr = [];

	function DocumentClass(name, description, isSubmitToSPP, isSupporting, isMultiDoc, 
	 isRequireAccountData, isTransaction, isStandingOrder, isSignaturesRequired, isMandate) {
		this.name = name;
		this.description = description;
		this.isSubmitToSPP = isSubmitToSPP;
		this.isSupporting = isSupporting;
		this.isMultiDoc = isMultiDoc;
		this.isRequireAccountData = isRequireAccountData;
		this.isTransaction = isTransaction;
		this.isStandingOrder = isStandingOrder;
		this.isSignaturesRequired = isSignaturesRequired;
		this.isMandate = isMandate
		
		
		this.equals = function (other) {
			return other.name==this.name && other.description==this.description &&
				other.isSubmitToSPP==this.isSubmitToSPP && other.isSupporting==other.isSupporting &&
				other.isSupporting==this.isSupporting && other.isMultiDoc==this.isMultiDoc &&
				other.isRequireAccountData==this.isRequireAccountData && other.isTransaction==this.isTransaction && 
				other.isMandate==this.isMandate && other.isSignaturesRequired==this.isSignaturesRequired;
		};
		
		this.toString = function() {
			return 'name:'+this.name+', desc:'+this.desc+', isSubmitToSPP:'+this.isSubmitToSPP+', isSupporting:'+this.isSupporting
				+', isMutliDoc:'+this.isMultiDoc+', requiresAccData:'+this.isRequireAccountData+', isTransaction:'+this.isTransaction
				+', isStandingOrder:'+this.isStandingOrder+', isSignaturesRequired:'+isSignaturesRequired+', isMandate:'+this.isMandate;
		};
	}
	
	
	// Returns a DocumentClass object for the given Document Class name, if it exists.
	getDocumentClass = function(docClass) {
		for (var i=0; i<documentClassArr.length;i++) {
			if (documentClassArr[i].name == docClass)
				return documentClassArr[i];
		}
		
		return false;
	}
	
	isEnabled = function(variable) {
		if (variable!=null && (variable=='Y' || variable=='1')) {
			return true;
		} else {
			return false;
		}
	}
	
	// Builds the array of document classes
	$(document).ready(function() {
		
		if (!documentClassArr || documentClassArr.length==0) {
			
			<$getViewValuesResultSet("vDOCUMENT_CLASSES","","")$>
			<$loop SchemaData$>				
				documentClassArr.push(new DocumentClass('<$SchemaData.DOC_CLASS$>', '<$SchemaData.DESCRIPTION$>', 
				 isEnabled('<$SchemaData.SUBMIT_TO_SPP$>'), isEnabled('<$SchemaData.IS_SUPPORTING$>'), isEnabled('<$SchemaData.IS_MULTIDOC$>'), isEnabled('<$SchemaData.REQUIRE_ACCOUNT_DATA$>'), 
				 isEnabled('<$SchemaData.IS_TRANSACTION$>'), isEnabled('<$SchemaData.IS_STANDING_ORDER$>'), isEnabled('<$SchemaData.SIGNATURES_REQUIRED$>'), isEnabled('<$SchemaData.IS_MANDATE$>'))
				);
				
			<$endloop$>	
		}		
	});

</script>

<@end@>

<!-- Customized for CCLA: link to batch thumbnails may get an isDualIndex=1 appended
	 to the end. This is used to hide Document Class display in the thumbnail listing
	-->
<@dynamichtml doc_approval_preview@>

<$if not bundleRef$>
	<$include super.doc_approval_preview$>
<$else$>
	<table id="previewtable" width="100%" height="85%" cellpadding="0" cellspacing="0" valign="top">
			
			<$if isTrue(#env.Iris_enableThumbnailScroll)$>
				<tr>
				<td <$if not isTrue(#env.Iris_enableVerticalThumbnails)$>height="100px"<$else$>width="1px"<$endif$> id="thumbsTd">
					<iframe bgcolor='white' 
									style="border: none; overflow-x: hidden;" 
									name='thumbsFrame' id="thumbsFrame" height="100%" width=100%" frameborder="0"></iframe>
					
					<script type="text/javascript">
						try{
							loadThumbsFrame();
						}catch(err){}
						
						function loadThumbsFrame(){
							var iframe = document.getElementById("thumbsFrame");
							var thumbSrc;
						
							if (curTab == 'tab_image') {
								
								var isDualIndex = "";
								
								// Inspect the hidden bundle_fields form to determine the bundle status.
								// If its at Validation status, set the isDualIndex flag when loading the
								// batch doc thumbnail template. This will blank out the document class
								// names and replace them with question marks.
								if (document.forms['bundle_fields']) {
									var bundleStatus = 
									 document.forms['bundle_fields'].elements['bundleStatus'].value;
									 
									if (bundleStatus == "Validation")
										isDualIndex = "1";
								}
								
								
								var thumbSrc = "<$HttpCgiPath$>?IdcService=IRIS_BATCH_DOCS_THUMBS<$include add_idc_token_to_url$>" +
								 "&parentDocName=<$dDocName$>&bundleRef=<$#active.bundleRef$>";
								
								var isiPad = navigator.userAgent.match(/iPad/i) != null;
								if (isiPad){
									thumbSrc = thumbSrc + "&isiPad=1";
								}
								
								if (isDualIndex == "1")
									thumbSrc += "&isDualIndex=" + isDualIndex;
								
								if (selDoc)
									thumbSrc += "&selDoc=" + selDoc;
								
								iframe.src = thumbSrc;
								
								try{
									document.getElementById('thumbsTd').style.width="100px";
								}catch(err){}
							}					
						}
					</script>
				</td>
				<$if not isTrue(#env.Iris_enableVerticalThumbnails)$>
				</tr>
				<tr>
				<$endif$>
			<$endif$>

			<td id="preview_region" name="colored_region" align="center" valign="top" style="border:1px solid white;">

				<iframe bgcolor='white' 
								style="border: none;overflow-x: hidden;" 
								name='contextFrame' id="contextFrame" height="100%" width=100%" frameborder="0"></iframe>
				
				<script type="text/javascript">

					// This piece of script is used to set the source URL of the above iframe
					// when the page is first loaded. This allows the URL to be changed to
					// show a certain tab, based on the # portion of the parent URL.
				
					var iframe = document.getElementById("contextFrame");
					var thumbSrc;
				
					if (curTab == 'tab_image') {							
						var thumbSrc = "<$HttpCgiPath$>?IdcService=IRIS_BATCH_DOCS_PREVIEW<$include add_idc_token_to_url$>&parentDocName=<$dDocName$>&bundleRef=<$#active.bundleRef$>";
						
						if (selDoc)
							thumbSrc += "&selDoc=" + selDoc;
							
						// TM: Preview iframe src is set by the thumbnail strip.
						thumbSrc = "";

					} else if (curTab == 'tab_docs') {
						var thumbSrc = "<$HttpCgiPath$>?IdcService=IRIS_BATCH_DOCS_LISTING<$include add_idc_token_to_url$>&parentDocName=<$dDocName$>" +
						 "&bundleRef=<$bundleRef$><$if allowWorkflowActions$>&allowWorkflowActions=1<$endif$>";
					} else {
						var thumbSrc = 
						 "<$HttpCgiPath & '?IdcService=IRIS_LINKED_AUDIT_ENTRIES' & inc('add_idc_token_to_url') & '&dDocName=' & dDocName$>&ts=" + 
						  new Date().getTime();
					}
					
					if (thumbSrc != "")
						iframe.src = thumbSrc;	
					
				</script>

			</td>
		</tr>
	</table>

<$endif$>
	
<@end@>


<@dynamichtml ccla_confirm_process_dates_js@>
	<script type="text/javascript">
		function prepareProcessDates(){
			var errorFound = false;
			
			var docNameList = $("#docNameList").val();
			// remove last comma
			docNameList = docNameList.substring(0,docNameList.length-1);
			var docNameArray = docNameList.split(',');
			
			$.each(docNameArray, function(key, value) {
			    //alert( "The key is '" + key + "' and the value is '" + value + "'" );
				var outcome = $("input[name='radio_"+value+"']:checked").val();
				if (outcome == null){
					errorFound = true;
				} else {
					$("#"+value+"_Outcome").val(outcome);
				
				}
				
			});
			
			if (errorFound){
				alert("Please choose an option");
				return false;
			} else{
				return true;
			}
		}
	
	</script>

<@end@>


<@dynamichtml ccla_confirm_process_date_html@>

	<$include ccla_confirm_process_dates_js$>
	<div align=center>	
		<div id='ccla_cs_content' style='width: 470px'>
			
			<$include orangeContainer_top$>
			
			<div style="padding: 3px; border-bottom: 1px solid; margin-right: 3px;" class="panelheader">
				<b>Confirm Process Dates for bundle: <span class="docname"><$#active.xBundleRef$></span></b>
			</div>
			
			<$if rsProcessDatesForResetBundles$>
				<p><b>WARNING</b> This bundle contains a CONDINS instruction. Please make sure the process date is correct. 
				If not, press cancel and adjust the date accordingly. </p>
			<$endif$>
			
			
			<$if rsProcessDateMismatch or rsProcessDatesForResetBundles$>
				<$docNameList=""$>
				<div class='ccla_cs_panel_content'>
					<form name="confirmProcessDatesForm" id="confirmProcessDatesForm" method="POST" onSubmit="return prepareProcessDates()">
						<input type="hidden" name="IdcService" value="CCLA_UPDATE_PROCESS_DATE_FOR_BUNDLE" />
						<$include add_idc_token_to_form$>
						<input type="hidden" name="RedirectUrl" value="<$HttpCgiPath$>?IdcService=<$#local.IdcService$><$include add_idc_token_to_url$>&Action=<$#local.Action$>&Page=<$#local.Page$>&doDuplicateCheck=0&processDatesConfirmed=1&bundleRef=<$#active.xBundleRef$>&performReleaseChecks=0&dDocName=<$#local.dDocName$>" />

						<$if rsProcessDatesForResetBundles$>
							<div style="padding: 1px; border: 1px inset; height: 200px; overflow-y: scroll">
					
						
								<table class="ccla-table" width="100%" border=1>
									<tr>
										<th style='width: 52%'>Details</th>
										<th style='width: 14%'>Doc. Class</th>
										<th style='width: 14%'>Worfklow Date</th
										<th style='width: 20%'>Document</th>
									</tr>
									<$loop rsProcessDatesForResetBundles$>
									<$if rsProcessDatesForResetBundles.xWorkflowDate$><$workflowStateClass="hasWorkflowDate"$><$else$><$workflowStateClass=""$><$endif$>
									<tr>
										<td class="<$workflowStateClass$>">
											<$if rsProcessDatesForResetBundles.xFund AND rsProcessDatesForResetBundles.xDocumentClass$>  
											Fund:<b><$rsProcessDatesForResetBundles.xFund$></b>&nbsp;&nbsp;Doc Class: <b><$rsProcessDatesForResetBundles.xDocumentClass$></b><br/>
											<$endif$>
											Current process date: <b><$formatDateOnly(rsProcessDatesForResetBundles.xProcessDate)$></b>
											</td>
										<td class="<$workflowStateClass$>"><$rsProcessDatesForResetBundles.xDocumentClass$></b></br></td>
										<td class="<$workflowStateClass$>"><$rsProcessDatesForResetBundles.xWorkflowDate$></b></br></td>
										<td class="<$workflowStateClass$>"><a class="newWindow" target="_blank" href="?IdcService=DOC_APPROVAL<$include add_idc_token_to_url$>&dDocName=<$rsProcessDatesForResetBundles.dDocName$>"><$rsProcessDatesForResetBundles.dDocName$></a></td>
									</tr>	
									<$endloop$>
								</table>
								
							</div>
							
							</br>
						<$endif$>
					
					
					
					<$if rsProcessDateMismatch$>
						<p>The following documents have a different process date compared to the system calculated process date. 
						Please confirm whether you wish to continue to use the current process date, or whether you wish to change it to the system
						calculated process date</p>
						
						<div style="padding: 1px; border: 1px inset; height: 200px; overflow-y: scroll">
						
							<table width="100%">
								<tr>
									<td width="100%" valign="top">
										
										<table class="ccla-table" width="100%">
											<tr>
												<th style='width: 52%'>Details</th>
												<th style='width: 14%'>Use System Process Date</th>
												<th style='width: 14%'>Use Current Process Date</th>
												<th style='width: 20%'>Document</th>
											</tr>
											<$loop rsProcessDateMismatch$>
											<$mismatchValue = rsProcessDateMismatch.MISMATCHSTATUS$>
											<$include ccla_calc_mismatch_status_class$>
											<tr>
												<td class="<$mismatchClass$>">
												<$if rsProcessDateMismatch.xFund AND rsProcessDateMismatch.xDocumentClass $>
													Fund:<b><$rsProcessDateMismatch.xFund$></b>&nbsp;&nbsp;Doc Class:<b><$rsProcessDateMismatch.xDocumentClass$></b><br/>
												<$endif$>
												
												Curr. process date:<b><$formatDateOnly(rsProcessDateMismatch.xProcessDate)$></b><br/>
												Sys. process date:<b><$formatDateOnly(rsProcessDateMismatch.xOriginalProcessDate)$></b></td>
												<td class="<$mismatchClass$>" align=center><input type="radio" value="1" name="radio_<$rsProcessDateMismatch.dDocName$>"></td>
												<td class="<$mismatchClass$>" align=center><input type="radio" value="0" name="radio_<$rsProcessDateMismatch.dDocName$>"></td>
												<td class="<$mismatchClass$>"><a class="newWindow" target="_blank" href="?IdcService=DOC_APPROVAL<$include add_idc_token_to_url$>&dDocName=<$rsProcessDateMismatch.dDocName$>"><$rsProcessDateMismatch.dDocName$></a></td>
												<!--populated onSubmit using JS-->
												<input type="hidden" name="<$rsProcessDateMismatch.dDocName$>_Outcome" id="<$rsProcessDateMismatch.dDocName$>_Outcome" value="" />
											</tr>	
											<$docNameList = docNameList & rsProcessDateMismatch.dDocName & ","$>
											<$endloop$>
											<input type="hidden" name="docNameList" id="docNameList" value="<$docNameList$>" />
										</table>
										
									</td>
									
								</tr>
							</table>
							
						</div>
							
						</br>
					<$endif$>
						
						<div style="float:left"><input type="submit" class="button" value="Save and Proceed" /> <input type="button" class="button" value="Cancel" onclick="cancel();"/></div>
						<div style="clear:both"></div>
					</form>
				</div>
				<br/>
			<$endif$>
			<$include orangeContainer_bottom$>

		</div>
<@end@>



<@dynamichtml ccla_calc_mismatch_status_class@>
<$misMatchClass=""$>

	<$if mismatchValue == 0$>
		<$mismatchClass="validation_error_field"$>
	<$elseif mismatchValue == 1$>
		<$mismatchClass="validated_field"$>
	<$elseif mismatchValue == 2$>
		<$mismatchClass="validation_warning_field"$>
	<$endif$>

<@end@>


<@dynamichtml ccla_final_release_checks@>
	
	<$if #active.processDatesConfirmed$>
		<$include ccla_confirm_release_panel$>
	<$else$>
		<$xBundleRef = bundleRef$>
		<$executeService("CCLA_GET_MISMATCH_PROCESS_DATE_FOR_BUNDLE")$>	
		<$if rsProcessDateMismatch or rsProcessDatesForResetBundles$>
			<$include ccla_confirm_process_date_html$>
		<$else$>
			<$include ccla_confirm_release_panel$>
		<$endif$>
	<$endif$>

<@end@>

<@dynamichtml ccla_active_bundle_counts_display@>
	
	<$if isAjaxRefresh$>
		<$executeService("CCLA_GET_ACTIVE_BUNDLE_COUNTS")$>
	<$endif$>
	
	<p>
		Last refreshed at <$bundleCountsLastUpdated$>
	</p>
	<p>
		Total bundles completed today: <b><$numBundlesCompleted$></b>
	</p>
	
	<div id="doc_tabs_container">
		<table cellspacing="0" cellpadding="0">
			<tr height="25">
				<td id="tab_source" class="cs-info-tab cs-tabOff" width="100" align="center" onclick="openTab('source');">
					<span id="tab_text_caption" class="tab_text">Source</span>
				</td>
				<td id="tab_scanUser" class="cs-info-tab cs-tabOff" width="100" align="center" onclick="openTab('scanUser');">
					<span id="tab_text_caption" class="tab_text">Scan User</span>
				</td>
				<td id="tab_status" class="cs-info-tab cs-tabOff" width="100" align="center" onclick="openTab('status');">
					<span id="tab_text_caption" class="tab_text">Status</span>
				</td>
				<td id="tab_priority" class="cs-info-tab cs-tabOff" width="100" align="center" onclick="openTab('priority');">
					<span id="tab_text_caption" class="tab_text">Priority</span>
				</td>								
			</tr>
		</table>
	</div>
	
	<!-- Replaceable region for AJAX-loaded content -->
	<div id="info-container" style="border:1px inset; height:180px; margin-top:1px; overflow-y:scroll;">
		
		<div id="bundleTotals_source" class="bundle-total-table hidden">
			
			<$bundleCountTypeName = "BUNDLE_SOURCE"$>
			<$bundleCountTypeLabel = "Source"$>
			
			<$include ccla_display_bundle_count_table_header$>

				<$loop rsBundleCountsBySource$>
					<$include ccla_display_bundle_count_row$>
				<$endloop$>
				
			</table>
		
		</div>
		
		<div id="bundleTotals_scanUser" class="bundle-total-table hidden">
			
			<$bundleCountTypeName = "BUNDLE_SCANUSER"$>
			<$bundleCountTypeLabel = "Scan User"$>
			
			<$include ccla_display_bundle_count_table_header$>

				<$loop rsBundleCountsByScanUser$>
					<$include ccla_display_bundle_count_row$>
				<$endloop$>
				
			</table>
		
		</div>
		
		<div id="bundleTotals_status" class="bundle-total-table hidden">
			
			<$bundleCountTypeName = "BUNDLE_STATUS"$>
			<$bundleCountTypeLabel = "Status"$>
			
			<$include ccla_display_bundle_count_table_header$>

				<$loop rsBundleCountsByStatus$>
					<$include ccla_display_bundle_count_row$>
				<$endloop$>
				
			</table>
		
		</div>
		
		<div id="bundleTotals_priority" class="bundle-total-table hidden">
			
			<$bundleCountTypeName = "BUNDLE_PRIORITY"$>
			<$bundleCountTypeLabel = "Priority"$>
			
			<$include ccla_display_bundle_count_table_header$>

				<$loop rsBundleCountsByPriority$>
					<$include ccla_display_bundle_count_row$>
				<$endloop$>
				
			</table>
		
		</div>
		
	</div>
	
<@end@>

<@dynamichtml ccla_display_bundle_count_table_header@>
	
	<table class="accounts-table" cellspacing="0" cellpadding="0" width="95%">
		<tr>
			<th class="first-col" width="60%">
				<$bundleCountTypeLabel$>
			</th>
			
			<$if includedCompletedCounts$>
				<th>
					Active
				</th>
				<th>
					Completed
				</th>
			
			<$else$>
				<th>
					Count
				</th>
				
			<$endif$>
		</tr>
	
<@end@>

<@dynamichtml ccla_display_bundle_count_row@>
	
	<tr class="account-details-row">
		<td class="first-col">
			<b><$getValue("#active", bundleCountTypeName)$></b>
				
			<$if not getValue("#active", bundleCountTypeName)$>
				<span class="no-info">None</span>
			<$endif$>
		</td>
		
		<$if includedCompletedCounts$>
			<td align="right">
				&nbsp;<$#active.NUM_BUNDLES_ACTIVE$>
			</td>
			
			<td align="right">
				&nbsp;<$#active.NUM_BUNDLES_COMPLETED$>
			</td>
		
		<$else$>
			<td align="right">
				<$#active.NUM_BUNDLES$>
			</td>
		<$endif$>
	</tr>
	
<@end@>

<@dynamichtml ccla_confirm_preadvice_dicondins_html@>
<script type="text/javascript">
	function prepareTransRefChecks() {
		// Clear current contents of list
		$("#pendingValues").val("");

		// Determine which of the displayed tickboxes has been selected.
		var newList = "";
			
		$(".pendingValue").each( function() {
			if ($(this).is(":checked")) {
				if (newList.length > 0)
					newList += ",";
				newList += $(this).val();
			}
			
		});
		$("#pendingValues").val(newList);
		return ($("#pendingValues").val().length > 0);		
	}

	function checkDups(obj) {
	
		var instrId =(obj.id).substring((obj.id).indexOf('|'), (obj.id).length);
		//returns "|[INSTR_ID]"	
		var checked = obj.checked;
	
		// Clear current contents of list
		$("#pendingValues").val("");

		// Determine which of the displayed tickboxes has been selected.
		var newList = "";
			
		$(".pendingValue").each( function() {
			if ((this.id!=obj.id) && ((this.id).indexOf(instrId)!=-1)) {
				if (checked) {
					$(this).attr("disabled", true);
				} else {
					$(this).removeAttr("disabled");
				}
			}			
		});
	}
	
</script>

	<div align=center>	
		<div id='ccla_cs_content' style='width: 570px'>
			
			<$include orangeContainer_top$>
			
			<div style="padding: 3px; border-bottom: 1px solid; margin-right: 3px;" class="panelheader">
					<$if rsDocsWithPossiblePendingTrans$>
						
						<form name="PendingCheck" id="PendingCheck" method="POST" onSubmit="return prepareTransRefChecks()">
						<input type="hidden" name="IdcService" value="CCLA_UPDATE_TRANSACTION_REF" />
						<$include add_idc_token_to_form$>
						<input type="hidden" name="RedirectUrl" value="<$HttpCgiPath$>?IdcService=<$#local.IdcService$><$include add_idc_token_to_url$>&dDocName=<$#local.dDocName$>" />
						<input type="hidden" name="pendingValues" id="pendingValues" value="" />
							<table border="1" >					
						<$loop rsDocsWithPossiblePendingTrans$>

							<tr>
								<td colspan="8"><b>Pending Transactions found for <$#active.dDocName$> (<$#active.xDocumentClass$>)</b></td>
							<tr>
								<th>Instruction ID</th>
								<th>Type</th>
								<th>Company</th>
								<th>Client Number</th>
								<th>Account Number</th>
								<th>FundCode</th>
								<th>Amount</th>
								<th>Select</th>
								
							</tr>							
							<$results = 'rsPendingTransRef_'&#active.dDocName$>
								
							<$loopwhile getValue(results, "#isRowPresent")$>
								<tr>
									<td><$getValue(results, "INSTRUCTION_ID")$>&nbsp;</td>
									<td><$getValue(results, "INSTRUCTION_TYPE_NAME")$>&nbsp;</td>
									<td><$getValue(results, "COMPANY_CODE")$>&nbsp;</td>
									<td><$getValue(results, "CLIENT_NUMBER")$>&nbsp;</td>
									<td><$getValue(results, "ACCOUNTNUMBER")$>&nbsp;</td>
									<td><$getValue(results, "FUND_CODE")$>&nbsp;</td>
									<td><$getValue(results, "CASH")$>&nbsp;</td>
									<td><input type="checkbox" class="pendingValue" 
										name="<$#active.dDocName$>|<$getValue(results, "INSTRUCTION_ID")$>" 
										id="<$#active.dDocName$>|<$getValue(results, "INSTRUCTION_ID")$>" 
										value="<$#active.dDocName$>|<$getValue(results, "DOC_ID")$>|<$getValue(results, "INSTRUCTION_ID")$>"
										onclick="checkDups(this);"/></td>
								</tr>			
								<$exec rsNext(results)$>
							<$endloop$>
						<$endloop$>
								<tr>
									<td colspan="8" align="right">
										<input type="submit" name="submit" id="submit" value="submit"/>
									</td>
								</tr>
							</table>
							<form>

					<$else$>
						No pending transaction found
					<$endif$>
			</div>
			
			<$include orangeContainer_bottom$>
			
		</div>
	</div>
<@end@>
<@dynamichtml iris_ccla_doc_class_with_help@>
	<$include ccla_document_class_option_list$>
	<$include ccla_cs_display_helpbutton_js$>
	
	<a href="#" onclick="displayHelpDocumentIris();" alt="Help"><img src="<$HttpImagesRoot$>ccla/clientservices/helpIcon_sm.gif" border="0" alt="Help"></a>
	
<@end@>
</body></html>