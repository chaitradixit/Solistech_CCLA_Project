-- Table REF_AGREEMENT_TYPE

CREATE TABLE REF_AGREEMENT_TYPE(
  AGREEMENT_TYPE_ID Number(10,0) CONSTRAINT AGREETYPE_ID_NN NOT NULL,
  AGREEMENT_TYPE_NAME Varchar2(50 ) CONSTRAINT AGREETYPE_NAME_NN NOT NULL,
  AGREEMENT_TYPE_CODE Varchar2(10 ) CONSTRAINT AGREETYPE_CODE_NN NOT NULL,
  AGREEMENT_TYPE_DESCRIPTION Varchar2(500 )
)
/

-- Add keys for table REF_AGREEMENT_TYPE

ALTER TABLE REF_AGREEMENT_TYPE ADD CONSTRAINT AGREETYPE_PK PRIMARY KEY (AGREEMENT_TYPE_ID)
/

-- Table and Columns comments section
  
COMMENT ON TABLE REF_AGREEMENT_TYPE IS 'Account Agreement Types e.g. Scheme Particular, Tri-partite, Segregated. Mandatory reference in ACCOUNT table.'
/

-- New column in Account table
ALTER TABLE ACCOUNT ADD (
	AGREEMENT_TYPE_ID Number(10,0)
);

CREATE INDEX AGREETYPE_ACC_IX ON ACCOUNT (AGREEMENT_TYPE_ID) 
/
ALTER TABLE ACCOUNT ADD CONSTRAINT AGREETYPE_ACC_FK FOREIGN KEY (AGREEMENT_TYPE_ID) REFERENCES REF_AGREEMENT_TYPE (AGREEMENT_TYPE_ID)
/

CREATE OR REPLACE PUBLIC SYNONYM REF_AGREEMENT_TYPE FOR CCLA.REF_AGREEMENT_TYPE;
GRANT ALL ON REF_AGREEMENT_TYPE TO UCMADMIN;

REM INSERTING into REF_AGREEMENT_TYPE
Insert into REF_AGREEMENT_TYPE (AGREEMENT_TYPE_ID,AGREEMENT_TYPE_NAME,AGREEMENT_TYPE_CODE,AGREEMENT_TYPE_DESCRIPTION) values (1,'Scheme Particular','SP',null);
Insert into REF_AGREEMENT_TYPE (AGREEMENT_TYPE_ID,AGREEMENT_TYPE_NAME,AGREEMENT_TYPE_CODE,AGREEMENT_TYPE_DESCRIPTION) values (2,'Tri-Partite','TP',null);
Insert into REF_AGREEMENT_TYPE (AGREEMENT_TYPE_ID,AGREEMENT_TYPE_NAME,AGREEMENT_TYPE_CODE,AGREEMENT_TYPE_DESCRIPTION) values (3,'Segregated','SEG',null);

-- Set all Accounts to Scheme Particular
UPDATE ACCOUNT SET AGREEMENT_TYPE_ID = 1;

ALTER TABLE ACCOUNT MODIFY (
	AGREEMENT_TYPE_ID Number(10,0)  CONSTRAINT ACC_AGREETYPE_NN NOT NULL
);

CREATE OR REPLACE FORCE VIEW "UCMADMIN"."ACCOUNT_EXTENDED" ("ACCOUNT_ID", "MANDATED_ACCOUNT_ID", "INCOME_DISTRIBUTION_METHOD", "FUND_CODE", "ACCOUNT_STATUS_ID", "AURORA_ACCOUNT", "ACCOUNTNUMBER", "ACCNUMEXT", "SUBTITLE", "DATE_OPENED", "SHARE_CLASS_ID", "REQ_SIGNATURES", "IS_EXCLUSIVE", "AML_CHECK_OVERRIDE_USER", "LAST_UPDATED", "ACCOUNT_TYPE_ID", "LOAN_TYPE_ID", "LOAN_TERM", "AGREEMENT_TYPE_ID", "ACCOUNT_TYPE_NAME", "ACCOUNT_STATUS_NAME", "SHORT_NAME", "IDM_NAME", "ACC_CASH", "ACC_UNITS", "DATE_LAST_REFRESH")
AS
  SELECT acc."ACCOUNT_ID",
    acc."MANDATED_ACCOUNT_ID",
    acc."INCOME_DISTRIBUTION_METHOD",
    acc."FUND_CODE",
    acc."ACCOUNT_STATUS_ID",
    acc."AURORA_ACCOUNT",
    acc."ACCOUNTNUMBER",
    acc."ACCNUMEXT",
    acc."SUBTITLE",
    ACC."DATE_OPENED",
    acc."SHARE_CLASS_ID",
    acc."REQ_SIGNATURES",
    acc."IS_EXCLUSIVE",
    acc."AML_CHECK_OVERRIDE_USER",
    acc."LAST_UPDATED",
    acc.ACCOUNT_TYPE_ID,
    acc.LOAN_TYPE_ID,
    acc.LOAN_TERM,
    acc.AGREEMENT_TYPE_ID,
    accType.ACCOUNT_TYPE_NAME,
    accStatus.ACCOUNT_STATUS_NAME,
    accStatus.SHORT_NAME,
    incDistMethod.IDM_NAME,
    accValue.ACC_CASH,
    accValue.ACC_UNITS,
    accValue.DATE_LAST_REFRESH
  FROM ACCOUNT acc
  INNER JOIN REF_ACCOUNT_STATUS accStatus
  ON (acc.ACCOUNT_STATUS_ID = accStatus.ACCOUNT_STATUS_ID)
  INNER JOIN REF_INCOME_DIST_METHOD incDistMethod
  ON (acc.INCOME_DISTRIBUTION_METHOD = incDistMethod.IDM_CODE)
  INNER JOIN REF_ACCOUNT_TYPE accType
  ON (acc.ACCOUNT_TYPE_ID = accType.ACCOUNT_TYPE_ID)
  LEFT JOIN ACCOUNT_VALUE accValue
  ON (acc.ACCOUNT_ID = accValue.ACCOUNT_ID);