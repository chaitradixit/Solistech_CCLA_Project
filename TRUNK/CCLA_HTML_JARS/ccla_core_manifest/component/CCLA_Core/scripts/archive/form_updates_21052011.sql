
-- New columns in REF_FORM_TYPE
ALTER TABLE REF_FORM_TYPE ADD (
  FORM_TYPE_SHORTNAME VARCHAR2(50 CHAR),
  IS_SINGLETON NUMBER(1,0)
);

COMMENT ON COLUMN REF_FORM_TYPE.FORM_TYPE_SHORTNAME IS 'Shorthand version of the form type name. All characters must be in caps and not contain spaces or underscores. Use hyphens to split up portions of the name';

COMMENT ON COLUMN REF_FORM_TYPE.IS_SINGLETON IS 'If true(1) the app layer will only allow 1 document to be allocated to instances of this form type.';

UPDATE REF_FORM_TYPE SET FORM_TYPE_SHORTNAME = 'PSDF-APP-NONLA', IS_SINGLETON = 1 WHERE FORM_TYPE_ID = 1;
UPDATE REF_FORM_TYPE SET FORM_TYPE_SHORTNAME = 'PSDF-APP-LA', IS_SINGLETON = 1 WHERE FORM_TYPE_ID = 2;

-- PSDF Subs/Redempt Form
REM INSERTING into REF_FORM_TYPE
Insert into REF_FORM_TYPE (FORM_TYPE_ID,FORM_TYPE_NAME,GEN_INSTRUCTION_TYPE_ID,RET_INSTRUCTION_TYPE_ID,FORM_HANDLER_CLASS,FORM_TYPE_SHORTNAME,IS_SINGLETON) values (3,'PSDF Subscription Form',14,14,'com.ecs.stellent.ccla.clientservices.form.AccountFormHandler','PSDF-SUBS',0);
Insert into REF_FORM_TYPE (FORM_TYPE_ID,FORM_TYPE_NAME,GEN_INSTRUCTION_TYPE_ID,RET_INSTRUCTION_TYPE_ID,FORM_HANDLER_CLASS,FORM_TYPE_SHORTNAME,IS_SINGLETON) values (4,'PSDF Redemption Form',96,96,'com.ecs.stellent.ccla.clientservices.form.AccountFormHandler','PSDF-REDEMPT',0);
Insert into REF_FORM_TYPE (FORM_TYPE_ID,FORM_TYPE_NAME,GEN_INSTRUCTION_TYPE_ID,RET_INSTRUCTION_TYPE_ID,FORM_HANDLER_CLASS,FORM_TYPE_SHORTNAME,IS_SINGLETON) values (5,'PSDF Cancellation Form',96,96,'com.ecs.stellent.ccla.clientservices.form.AccountFormHandler','PSDF-CANC',0);

ALTER TABLE REF_FORM_TYPE MODIFY (
  FORM_TYPE_SHORTNAME VARCHAR2(50 CHAR) CONSTRAINT FORMTYPE_SHORTNAME_NN NOT NULL,
  IS_SINGLETON NUMBER(1,0) CONSTRAINT FORMTYPE_SINGLETON_NN NOT NULL
);


ALTER TABLE FORM ADD (
  ORGANISATION_ID NUMBER(15,0)
);

ALTER TABLE FORM ADD CONSTRAINT FORM_ORG_FK FOREIGN KEY (ORGANISATION_ID) REFERENCES ORGANISATION (ORGANISATION_ID);

COMMENT ON COLUMN FORM.ORGANISATION_ID IS 'Must be specified for forms that aren''t connected to a campaign, i.e. where CAMPAIGN_ENROLMENT_ID is null.';

ALTER TABLE FORM ADD CONSTRAINT FORM_ENROL_ORG_CHK CHECK (NOT (CAMPAIGN_ENROLMENT_ID IS NULL AND ORGANISATION_ID IS NULL));

-- Update all current 'PEND' PC/PI accounts to 'OPEN' so they get picked up by EOD calculator
UPDATE ACCOUNT SET ACCOUNT_STATUS_ID = 1 WHERE ACCOUNT_STATUS_ID = 4 AND FUND_CODE IN ('PC','PI');

-- Import of manually-generated Form IDs.

CREATE TABLE PSDF_FORM_LOADER_TEMP (
  ORG_ACCOUNT_CODE VARCHAR2(12 CHAR),
  FORM_ID NUMBER(15,0),
  FORM_TYPE_ID NUMBER(15,0),
  ACCOUNTNUMBER NUMBER(15,0)
);

REM INSERTING into PSDF_FORM_LOADER_TEMP
Insert into PSDF_FORM_LOADER_TEMP (ORG_ACCOUNT_CODE,FORM_ID,FORM_TYPE_ID,ACCOUNTNUMBER) values ('AURB00777957',250117,3,1);
Insert into PSDF_FORM_LOADER_TEMP (ORG_ACCOUNT_CODE,FORM_ID,FORM_TYPE_ID,ACCOUNTNUMBER) values ('AURB00777957',250118,4,1);
Insert into PSDF_FORM_LOADER_TEMP (ORG_ACCOUNT_CODE,FORM_ID,FORM_TYPE_ID,ACCOUNTNUMBER) values ('RUNN00066003',250119,3,1);
Insert into PSDF_FORM_LOADER_TEMP (ORG_ACCOUNT_CODE,FORM_ID,FORM_TYPE_ID,ACCOUNTNUMBER) values ('RUNN00066003',250120,4,1);
Insert into PSDF_FORM_LOADER_TEMP (ORG_ACCOUNT_CODE,FORM_ID,FORM_TYPE_ID,ACCOUNTNUMBER) values ('LIVE00066004',250121,3,1);
Insert into PSDF_FORM_LOADER_TEMP (ORG_ACCOUNT_CODE,FORM_ID,FORM_TYPE_ID,ACCOUNTNUMBER) values ('LIVE00066004',250122,4,1);
Insert into PSDF_FORM_LOADER_TEMP (ORG_ACCOUNT_CODE,FORM_ID,FORM_TYPE_ID,ACCOUNTNUMBER) values ('SOUT00066020',250123,3,1);
Insert into PSDF_FORM_LOADER_TEMP (ORG_ACCOUNT_CODE,FORM_ID,FORM_TYPE_ID,ACCOUNTNUMBER) values ('SOUT00066020',250124,4,1);
Insert into PSDF_FORM_LOADER_TEMP (ORG_ACCOUNT_CODE,FORM_ID,FORM_TYPE_ID,ACCOUNTNUMBER) values ('CHES00066005',250125,3,1);
Insert into PSDF_FORM_LOADER_TEMP (ORG_ACCOUNT_CODE,FORM_ID,FORM_TYPE_ID,ACCOUNTNUMBER) values ('CHES00066005',250126,4,1);
Insert into PSDF_FORM_LOADER_TEMP (ORG_ACCOUNT_CODE,FORM_ID,FORM_TYPE_ID,ACCOUNTNUMBER) values ('AURL00042626',250127,3,1);
Insert into PSDF_FORM_LOADER_TEMP (ORG_ACCOUNT_CODE,FORM_ID,FORM_TYPE_ID,ACCOUNTNUMBER) values ('AURL00042626',250128,4,1);
Insert into PSDF_FORM_LOADER_TEMP (ORG_ACCOUNT_CODE,FORM_ID,FORM_TYPE_ID,ACCOUNTNUMBER) values ('GOSP00066013',250129,3,1);
Insert into PSDF_FORM_LOADER_TEMP (ORG_ACCOUNT_CODE,FORM_ID,FORM_TYPE_ID,ACCOUNTNUMBER) values ('GOSP00066013',250130,4,1);
Insert into PSDF_FORM_LOADER_TEMP (ORG_ACCOUNT_CODE,FORM_ID,FORM_TYPE_ID,ACCOUNTNUMBER) values ('HERT00066001',250131,3,1);
Insert into PSDF_FORM_LOADER_TEMP (ORG_ACCOUNT_CODE,FORM_ID,FORM_TYPE_ID,ACCOUNTNUMBER) values ('HERT00066001',250132,4,1);
Insert into PSDF_FORM_LOADER_TEMP (ORG_ACCOUNT_CODE,FORM_ID,FORM_TYPE_ID,ACCOUNTNUMBER) values ('DORS00066009',250133,3,1);
Insert into PSDF_FORM_LOADER_TEMP (ORG_ACCOUNT_CODE,FORM_ID,FORM_TYPE_ID,ACCOUNTNUMBER) values ('DORS00066009',250134,4,1);
Insert into PSDF_FORM_LOADER_TEMP (ORG_ACCOUNT_CODE,FORM_ID,FORM_TYPE_ID,ACCOUNTNUMBER) values ('CHAM00066012',250146,3,1);
Insert into PSDF_FORM_LOADER_TEMP (ORG_ACCOUNT_CODE,FORM_ID,FORM_TYPE_ID,ACCOUNTNUMBER) values ('CHAM00066012',250147,4,1);
Insert into PSDF_FORM_LOADER_TEMP (ORG_ACCOUNT_CODE,FORM_ID,FORM_TYPE_ID,ACCOUNTNUMBER) values ('HERT00066001',250142,3,2);
Insert into PSDF_FORM_LOADER_TEMP (ORG_ACCOUNT_CODE,FORM_ID,FORM_TYPE_ID,ACCOUNTNUMBER) values ('HERT00066001',250143,4,2);
Insert into PSDF_FORM_LOADER_TEMP (ORG_ACCOUNT_CODE,FORM_ID,FORM_TYPE_ID,ACCOUNTNUMBER) values ('HERT00066001',250144,3,3);
Insert into PSDF_FORM_LOADER_TEMP (ORG_ACCOUNT_CODE,FORM_ID,FORM_TYPE_ID,ACCOUNTNUMBER) values ('HERT00066001',250145,4,3);
Insert into PSDF_FORM_LOADER_TEMP (ORG_ACCOUNT_CODE,FORM_ID,FORM_TYPE_ID,ACCOUNTNUMBER) values ('TEST00066010',250148,3,1);
Insert into PSDF_FORM_LOADER_TEMP (ORG_ACCOUNT_CODE,FORM_ID,FORM_TYPE_ID,ACCOUNTNUMBER) values ('TEST00066010',250149,4,1);
Insert into PSDF_FORM_LOADER_TEMP (ORG_ACCOUNT_CODE,FORM_ID,FORM_TYPE_ID,ACCOUNTNUMBER) values ('LOCA00066022',250151,3,1);
Insert into PSDF_FORM_LOADER_TEMP (ORG_ACCOUNT_CODE,FORM_ID,FORM_TYPE_ID,ACCOUNTNUMBER) values ('LOCA00066022',250152,4,1);

CREATE OR REPLACE PUBLIC SYNONYM PSDF_FORM_LOADER_TEMP FOR CCLA.PSDF_FORM_LOADER_TEMP;
GRANT ALL ON PSDF_FORM_LOADER_TEMP TO UCMADMIN;

-- Run as UCMADMIN
-- Run the SELECTs in isolation first and check row counts match the no. of entries in the FORM_LOADER table.
INSERT INTO FORM (FORM_ID, FORM_TYPE_ID, FORM_STATUS_ID, CAMPAIGN_ENROLMENT_ID, USER_ID, PERSON_ID, DATE_ADDED, LAST_UPDATED, ORGANISATION_ID)
SELECT fl.FORM_ID, fl.FORM_TYPE_ID, 2, ce.CAMPAIGN_ENROLMENT_ID, 'sysadmin', ce.PERSON_ID, SYSDATE, SYSDATE, o.ORGANISATION_ID FROM PSDF_FORM_LOADER_TEMP fl
INNER JOIN ORGANISATION o ON (fl.ORG_ACCOUNT_CODE = o.ORG_ACCOUNT_CODE)
INNER JOIN CAMPAIGN_ENROLMENT ce ON ((o.ORGANISATION_ID = ce.ORGANISATION_ID) AND ce.CAMPAIGN_ID=10)
INNER JOIN ACCOUNT_EXTENDED_CLIENT acc ON (acc.ORGANISATION_ID = o.ORGANISATION_ID AND acc.FUND_CODE = 'PC' AND acc.ACCOUNTNUMBER = fl.ACCOUNTNUMBER);

INSERT INTO FORM_ELEMENT_APPLIED (FORM_ID, ELEMENT_ID)
SELECT fl.FORM_ID, acc.ACCOUNT_ID FROM PSDF_FORM_LOADER_TEMP fl
INNER JOIN ORGANISATION o ON (fl.ORG_ACCOUNT_CODE = o.ORG_ACCOUNT_CODE)
INNER JOIN CAMPAIGN_ENROLMENT ce ON ((o.ORGANISATION_ID = ce.ORGANISATION_ID) AND ce.CAMPAIGN_ID=10)
INNER JOIN ACCOUNT_EXTENDED_CLIENT acc ON (acc.ORGANISATION_ID = o.ORGANISATION_ID AND acc.FUND_CODE = 'PC' AND acc.ACCOUNTNUMBER = fl.ACCOUNTNUMBER); 

