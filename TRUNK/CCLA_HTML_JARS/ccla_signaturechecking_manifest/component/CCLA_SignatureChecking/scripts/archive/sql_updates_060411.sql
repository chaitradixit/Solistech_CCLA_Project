-- Fixes to COMM_SIGNATURE table

-- Add ID backup column to COMM_SIGNATURE
ALTER TABLE COMM_SIGNATURE ADD (COMM_SIGNATURE_ID_2 NUMBER(15,0));
UPDATE COMM_SIGNATURE SET COMM_SIGNATURE_ID_2 = COMM_SIGNATURE_ID;
COMMIT;

-- Drop PK constraint/column
ALTER TABLE COMM_SIGNATURE DROP CONSTRAINT COMM_SIGNATURE_PK;
ALTER TABLE COMM_SIGNATURE DROP COLUMN COMM_SIGNATURE_ID;

-- Rename backup column and set NN/PK constraint
ALTER TABLE COMM_SIGNATURE RENAME COLUMN COMM_SIGNATURE_ID_2 TO COMM_SIGNATURE_ID;
ALTER TABLE COMM_SIGNATURE MODIFY (COMM_SIGNATURE_ID NUMBER(15,0) CONSTRAINT COMMSIG_ID_NN NOT NULL);
ALTER TABLE COMM_SIGNATURE ADD CONSTRAINT COMM_SIGNATURE_PK PRIMARY KEY (COMM_SIGNATURE_ID);



-- New column DOC_ID, stores document dID values.
ALTER TABLE COMM_SIGNATURE ADD (DOC_ID NUMBER(38,0));

-- Add foreign key constraint to UCM Revisions table
ALTER TABLE COMM_SIGNATURE ADD CONSTRAINT COMMSIG_DOCID_FK FOREIGN KEY (DOC_ID) REFERENCES UCMADMIN.REVISIONS (DID);

-- Fill in new DOC_ID column using corresponding values
UPDATE COMM_SIGNATURE SET DOC_ID = (SELECT MAX(DID) FROM UCMADMIN.Revisions r WHERE r.dDocName = COMM_SIGNATURE.DOCNAME);

-- Remove unmatched document IDs. There shouldn't be any but this is here as a precaution.
DELETE FROM COMM_SIGNATURE WHERE DOC_ID IS NULL;

-- Drop check constraint
ALTER TABLE COMM_SIGNATURE DROP CONSTRAINT COMM_SIGNATURE_SRC_CHK;
ALTER TABLE COMM_SIGNATURE ADD CONSTRAINT COMM_SIGNATURE_SRC_CHK CHECK (NOT (DOC_ID IS NULL AND COMM_ID IS NULL));

-- Create unique constraint
ALTER TABLE COMM_SIGNATURE ADD CONSTRAINT COMM_SIGNATURE_UQ UNIQUE (DOC_ID, COMM_ID, PERSON_ID);

-- Drop deprecated DOCNAME column
ALTER TABLE COMM_SIGNATURE DROP COLUMN DOCNAME;
