<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>
DocApproval htmlIncludeOrString
</title>
</head>
<body>

<!-- 	A set of includes called in the header
			of the DOC_APPROVAL template. Performs
			various staging tasks, such as loading the
			document info, workflow info and profile
			data.

			There are two hook includes:

 			doc_approval_pre
 			doc_approval_extra
 
			These are designed to be implemented by custom components.

-->
<@dynamichtml doc_approval_preamble@>

	<$include iris_jquery_js$>

	<!-- Resolve user's role membership -->
	<$include iris_resolve_user_access$>

	<!-- Not defined by default. Use for custom implementations -->
	<$include doc_approval_pre$>
		
	<$include doc_approval_check_params$>
		
	<$executeService("IRIS_DOC_INFO")$>
		
	<$include doc_approval_resolve_status_field$>

	<$include doc_approval_workflow_data$>
	<$include doc_approval_resolve_action$>
	<$include doc_approval_resolve_item_locking$>
		
	<$include doc_approval_count_totals$>

	<!-- Not defined by default. Use for custom implementations -->
	<$include doc_approval_extra$>

	<$include doc_approval_resolve_js_vars$>
	<$include doc_approval_js$>
	<$include iris_shortcut_keys_js_extra$>
	<$include	iris_doc_validation_js$>
		
	<$include iris_paginator_header$>

	<$include iris_get_url_params$>
		
	<$include iris_prepare_calendar_fields$>

<@end@>

<!-- JQuery script resource. -->
<@dynamichtml iris_jquery_js@>
	<script type="text/javascript" src="<$HttpWebRoot$>resources/jquery/jquery-1.3.2.min.js"></script>
<@end@>
<@dynamichtml iris_common_js@>
	<script type="text/javascript">
		var idcToken = "<$include add_idc_token_to_url$>";
	</script>
	<script type="text/javascript" src="<$HttpWebRoot$>resources/iris/iris_common.js"></script> 
<@end@>


<!-- Default title for the Document Approval page. -->
<@dynamichtml iris_doc_approval_title@>
	Document Approval: <$DOC_INFO.dDocTitle$>
<@end@>

<@dynamichtml iris_body_def_internal@>
		marginwidth="0" marginheight="0" topmargin="0" leftmargin="0"
<@end@>

<!-- Default S&F document listing config. -->
<@dynamichtml iris_doc_listing_pre@>
	<$SF_CustomPaginator="display_paginator_iris"$>

	<$calendarSelectFields="DATE_ADV"$>
  <$include epoch_calendar_header$>

  <$overrideResultsLink_DEFAULT="<$HttpCgiPath & '?IdcService=DOC_APPROVAL&dDocName=' & dDocName$>"& inc("add_idc_token_to_url")$>

  <$suppressSortLinks = "CHECKBOX,ACTIONS"$>

  <$nodeFilterFieldWidth="1,3,7,7,3,18,10,15,15,9"$>
  <$nodeFilterFieldNames="CHECKBOX,REF,QUICKDATE,DOCTYPE,TITLE,IRIS_STATUS,APPROVER,VENDORNAME,TOTALAMOUNT"$>
  <$advSearchFieldList="EVERYTHING,TITLE,AUTHOR,VENDORNAME"$>
 	<$moreAdvSearchFieldList="DATE_ADV"$>

 	<$CHECKBOX_CustomIncludeScript="CHECKBOX_CustomIncludeScript"$>
 	<$REF_CustomIncludeScript="REF_CustomIncludeScript"$>
  <$IRIS_STATUS_CustomIncludeScript="IRIS_STATUS_CustomIncludeScript"$>
  <$TOTALAMOUNT_CustomIncludeScript="TOTALAMOUNT_CustomIncludeScript"$>
  <$ACTIONS_CustomIncludeScript="DocActions_CustomIncludeScript"$>

	<$hideInfoLink="N"$>
  <$displaySearchButton="N"$>

	<$displayPagingOptions="N"$>
	<$displayPaginator="Y"$>
	<$SF_CustomPaginator="iris_sf_paginator"$>

  <$inlineHeaderInclude = "iris_doc_listing_inline_header"$>
  <$customIncludeResultsHeader = "group_action_controls"$>
  <$include iris_sf_sort_images$>

  <$advSearchBackgroundColour="#FFFFFF"$>
  <$advSearchDisplay_pre='orangeContainer_top'$>
  <$advSearchDisplay_after='orangeContainer_bottom'$>

  <!-- Search customizations -->
  <$PARAMETERSLIST="showCompleted"$>
  <$QueryFieldList="REF,QUICKDATE,AUTHOR,IRIS_STATUS,APPROVER,TITLE,VENDORNAME,CURRENCY,DOCTYPE,DATE_ADV"$>

  <$DISPLAYTHUMBNAILS=1$>
  <$THUMBNAILWIDTH=30$>
  <$THUMBNAILHEIGHT=30$>

  <$nodeSortField="dInDate"$>
	<$nodeSortOrder="DESC"$>

  <!-- Verity search -->
  <$nodeSearchQuery = "(dDocType <matches> `Image` or dDocType <matches> `Invoice` or dDocType <matches> `Form` or dDocType <matches> `Expenses` or dDocType <matches> `RA`)"$>

  <$if #active.amt$>
  	<$trueAmt = amt * 100$>
  	<$nodeSearchQuery = nodeSearchQuery & " <and> ((xTotalAmount <= " & trueAmt & ") <and> (xTotalAmount >= " & trueAmt & ")) "$>
  <$endif$>

  <$if not #active.showCompleted$>
  	<$nodeSearchQuery = nodeSearchQuery & " <and> <not> (xStatus <matches> `Completed`) "$>
  <$endif$>

<@end@>

<!-- Title for Document Listing page. -->
<@dynamichtml iris_doc_listing_title@>Document Listing<@end@>

<!-- Custom paginator used for S&F displays. -->
<@dynamichtml display_paginator_iris@>
  <!-- The ECS_Paginator component must be installed to correctly use this include -->
	<$if TotalRows > 0 and ssLastPage > 1$>

		<$pn_width=250$>
		<$pn_size = 5$>
		<$pn_total = ssLastPage$>

		<$pn_current = ssThisPage$>

		<$if not #active.pn_link_prefix$>
			<$pn_link_prefix=locURL & "SR="$>
		<$endif$>

		<$counter = 2$>
		<$str = '1,'$>

		<$loopwhile counter <= ssLastPage$>

			<$str = str & (((counter-1) * ResultCount)+1) & ','$>
			<$counter = counter + 1$>

		<$endloop$>

		<$rsMakeFromString("pn_rs",str,"ID")$>

		<$pn_rs = "pn_rs"$>
		<$pn_rs_row = "ID"$>

		<$pn_use_rs = 1$>

		<$include iris_paginator_compute_window$>

		<$include iris_paginator_display_window$>

	<$endif$>

<@end@>

<!-- Handles opening of multiple documents, preparing
     pagination variables when applicable. -->
<@dynamichtml doc_approval_check_params@>

	<$if thumbnailMode and not sel$>
		<!--sel = dDocName -->
	<$endif$>

	<!--	-------------------------
	Checks for an existing 'sel' parameter. This will contain a
	comma-separated list of content ID numbers, representing a
	selection of items which the user wishes to traverse through.
	This include resolves all variables required to display
	the paginator browse controls.
	------------------------------- -->
	<$if sel$>

		<$trace("Found sel param: " & sel)$>
		<!-- Create a resultset from the 'sel' parameter and add an index column to it -->
		<$exec rsMakeFromString("rsSel", sel, "ID")$>
		<$exec rsAddRowCountColumn("rsSel", "index")$>

		<!-- Store the total number of documents -->
		<$num_sel_docs = getValue("rsSel", "#numRows")$>

		<$if not dDocName$>
			<!-- No given dDocName parameter, use the first one in the resultset. -->

			<$exec rsFirst("rsSel")$>
			<$dDocName = rsSel.ID$>
		<$endif$>

		<!-- This determines how many direct document links appear in the browse panel -->
		<$max_visible_docs = 5$>

		<!-- Search resultset for given ID. Work out the next/previous IDs from this. -->
		<$exec rsFirst("rsSel")$>
		<$first_doc_id = rsSel.ID$>
		<$first_doc_index = rsSel.index+1$>

		<$loop rsSel$>
			<$trace("rsSel.ID = " & rsSel.ID)$>

			<$if (dDocName like rsSel.ID)$>
				<!-- Match found. -->

				<$curIndex = rsSel.index$>
				<$cur_doc_index = (rsSel.index)+1$>

				<$prevIndex = (curIndex-1)$>

				<$if prevIndex ge 0$>
					<$exec rsSetRow("rsSel", prevIndex)$>
					<!-- Store the ID of the previous item in the selection. -->
					<$prev_doc_index = prevIndex+1$>
					<$prev_doc_id = rsSel.ID$>
				<$endif$>

				<$nextIndex = (curIndex+1)$>

				<$if nextIndex lt num_sel_docs$>
					<$exec rsSetRow("rsSel", nextIndex)$>
					<!-- Store the ID of the next item in the selection. -->
					<$next_doc_index = nextIndex+1$>
					<$next_doc_id = rsSel.ID$>
				<$endif$>

				<!-- Now find the last ID in the selection set -->
				<$if rsSetRow("rsSel",num_sel_docs-1)$>
					<$last_doc_id = rsSel.ID$>
					<$last_doc_index = rsSel.index+1$>
				<$endif$>

				<$trace("last_doc_id=" & last_doc_id)$>

				<!-- Jump out the loop -->
				<$break$>

			<$endif$>

		<$endloop$>

		<!-- 	Now that we know	the first/last indicies and the total
					number of selected objects, the 'selection window' can
					be generated. This determines the set of items
					that have direct links displayed to them  -->

		<$trace("num_sel_docs =" & num_sel_docs)$>

		<!-- Assign paginator variables -->
		<$pn_total = num_sel_docs$>
		<$pn_size = 5$>
		<$pn_current = cur_doc_index$>

		<$pn_prev = #active.prev_doc_id$>
		<$pn_next = #active.next_doc_id$>

		<$pn_rs = "rsSel"$>
		<$pn_rs_row = "ID"$>
		<$pn_use_rs = 1$>

		<$pn_debug = 1$>
		<$pn_use_ellipses = 1$>

		<$include iris_paginator_compute_window$>

	<$endif$> <!-- End if sel -->

<@end@>

<!-- Check for error flags, display errors to user -->
<@dynamichtml iris_check_for_errors@>
	
	<noscript>
		<div class="error">
			<p>Error</p>
			JavaScript support is disabled or unavailable. Iris will not work correctly unless JavaScript is enabled.
		</div>
	</noscript>
	
	<$if not DOC_INFO$>

		<div class="error">
			<p>Error</p>
			<$if noParentBundleItem$>
				<$include iris_batch_no_parent_item_error$>		
			<$else$>
		
				<$if not #local.dDocName$>
					Document reference is invalid or missing.
				<$else$>
					No documents found with reference '<$dDocName$>'
				<$endif$>
					
			<$endif$>
		</div>

	<$elseif noProfileName$>

		<div class="error">
			<p>Error</p>
			No profile name specified. Unable to load profile information for this document.
		</div>

	<$elseif not profileDefinitionResolved$>

		<div class="error">
			<p>Error</p>
			Unable to resolve definition in profile: <$profileName$>.
			<br>
			<$if profileNotFound$>
				Couldn't find cached XML profile with Content ID '<$profileName$>'.
			<$elseif not profileConditionResolved$>
				Error resolving document condition:
				<ul>
				<$if irisProfileNull$>
					<li>Iris Profile instance was null!</li>
				<$endif$>
				<$if docInfoNull$>
					<li>DOC_INFO ResultSet was null!</li>
				<$endif$>
				<$if (not irisProfileNull) and (not docInfoNull)$>
					<li>Unknown error.</li>
				<$endif$>
				</ul>
			<$endif$>
		</div>

	<$endif$>

<@end@>

<!-- Check for debug flag. If found, print data to display -->
<@dynamichtml iris_debug_info@>
	
	<$if debug$>
		
		<div class="error">
			<p>Iris - Debug Info</p>
			
			userCanWrite? <$#local.userCanWrite$>
			<br/>
			userCanRead? <$#local.userCanRead$>
			<br/>
			<br/>
			
			Using profile: <$profileName$>
			<br/>
			
			<$if rsProfileData$>
				rsProfileData present.
			<$else$>
				rsProfileData missing.
			<$endif$>
			<br/>
			<br/>
			
			thumbnailMode: <$#local.thumbnailMode$>
			<br/>
			isInfo: <$#local.isInfo$>
			<br/>
			<br/>
			
			<$if DOC_WF_INFO$>
				Workflow data
				<ul>
					<li>Name: <$DOC_WF_INFO.dWfName$></li>
					<li>Step: <$DOC_WF_INFO.dWfStepName$></li>
					<li>User queue: <$wfUserQueue$></li>
				</ul>
			<$else$>
				Item not in workflow
				<br/><br/>
			<$endif$>
			
			Field config
			<ul>
				<li>Visible: <$getValue("rsProfileData","visible")$></li>
				<li>Required: <$getValue("rsProfileData","required")$></li>
				<li>Label: <$getValue("rsProfileData","label")$></li>
			</ul>
			
		</div>
		
	<$endif$>
	
<@end@>

<!-- Used to compute width applied to side panels on
		 approval screen. Also used as the minimum width 
		 for the panels when the user resizes them. 
		 -->
<@dynamichtml iris_compute_panels_width@>

	<!-- use default panel width -->
	<$panelWidth = #env.Iris_defaultPanelWidth$>
 			
<@end@>

<!-- Panel display on doc approval screen. Override this
		 if you wish to add custom panels. -->
<@dynamichtml iris_doc_panel_display@>

	<!-- Container for replaceable content -->
	<div id="doc_meta_panel_container">
			<!-- Editable fields for this content item -->
		<$include doc_approval_fields$>
	</div> 

	<!-- Display workflow info panel -->
	<$include doc_approval_wf$>

<@end@>

<!-- 	Not sure if this stuff is needed any more.
			
			Used to be required for CS 7.5, as slow re-indexing
			times meant that user updates would not take effect
			fast enough. This meant having to pass updated status
			values etc. on page URLs.
 -->
<@dynamichtml doc_approval_resolve_status_field@>

	<$c='Iris_statusField is an optional env variable which points
	to an alternate field which Iris is using to store document
	status as the documents move through workflow.'$>
	<$if #env.Iris_statusField$>
		<$docStatusField=#env.Iris_statusField$>
	<$else$>
		<$docStatusField="xStatus"$>
	<$endif$>

	<$if #env.Iris_passStatusInURL$>
		<$c='Attempt to retrieve previous status value from URL'$>
		<$if #local.prevStatus$>

			<$if not #local.prevAction$>
				<$prevAction = "approve"$>
			<$endif$>

			<$c='Resolve what the new status value should be, based on the
			     previous status and action.'$>
			<$newStatusInfo=getValue("#env","Iris_StatusMapping_" & prevStatus & "_" & prevAction)$>

			<$trace("newStatusInfo: " & newStatusInfo)$>

			<$c='newStatusInfo should be a comma-separated list containing
			     3 values; corresponding to the new status, workflow name
			     and workflow step.'$>

			<$if not newStatusInfo$>
				<$docStatus = prevStatus$>
			<$else$>

				<$exec rsMakeFromString("rsNewStatusInfo",newStatusInfo)$>

				<$if rsNewStatusInfo.#numRows == 1$>
					<$c='document has finished workflow'$>
					<$docStatus = rsNewStatusInfo.row$>
				<$else$>

					<$if prevAction like "approve"$>
						<$docStatus = rsNewStatusInfo.row$>
						<$exec rsNext("rsNewStatusInfo")$>
					<$else$>
						<$docStatus = prevStatus$>
					<$endif$>

					<$docWfName = rsNewStatusInfo.row$>
					<$exec rsNext("rsNewStatusInfo")$>
					<$docWfStepName = rsNewStatusInfo.row$>

				<$endif$>

				<!--trace("loaded new status info from env: " & newStatus & ", " & newWFName & "," & newWfStepName)-->
			<$endif$>

		<$endif$>
	<$endif$>

	<$if not docStatus$>
		<$docStatus=eval("<$" & docStatusField & "$>")$>
	<$endif$>

	<$trace("docStatus was: " & #local.docStatus)$>

<@end@>

<!-- 	Attempt to retrieve workflow info for this item. If
			the item is not within a workflow, the resultset
			DOC_WF_INFO will be null -->
<@dynamichtml doc_approval_workflow_data@>

	<$if dDocName$>

		<$if #env.Iris_passStatusInURL and (prevStatus or curStatus)$>
			<!-- Status was passed in URL, this means docWfName and docWfStepName
					 will already be determined. -->

			<$c= 'Perform workflow information lookup'$>
			<$executeService("IRIS_GET_WF_INFO")$>

			<$if DOC_WF_INFO$>
				<$dWfName=DOC_WF_INFO.dWfName$>
				<$dWfStepName=DOC_WF_INFO.dWfStepName$>
			<$endif$>

		<$else$>

			<$c= 'Perform standard doc workflow lookup'$>
			<$executeService("IRIS_GET_DOC_WF_INFO")$>

			<$if DOC_WF_INFO$>

				<$dWfName=DOC_WF_INFO.dWfName$>
				<$dWfStepName=DOC_WF_INFO.dWfStepName$>

				<!-- Pull information from the document's workflow companion file -->
				<$executeService("IRIS_GET_WF_COMPANION_INFO")$>

			<$endif$>
		<$endif$>

		<$include iris_get_profile_data$>

	<$endif$>

<@end@>

<!-- Resolve Iris Profile for this user -->
<@dynamichtml iris_get_profile_data@>

	<$if false$>
		<!-- Old method for fetching profile - user data field. -->
		<$profileName = getUserValue("uIrisProfile")$>
	<$endif$>

	<$if not profileName$>
		<$profileName = getValue("#env","Iris_defaultProfile")$>
	<$endif$>

	<$if not profileName$>
		<$noProfileName=1$>
	<$else$>
		<$executeService("IRIS_GET_PROFILE_INFO")$>
	<$endif$>

<@end@>

<!-- This include is used to determine whether or not the current
		 user has read/write/approval rights on the current document.
		 It will set a number of flags:

		 isInfo
		 ======
		 If this is non-null, all the fields will appear as labels and there
		 is no option to update the data.

		 allowWorkflowActions
		 =================
		 This flag is set if the document is currently in workflow, and the
		 user is assigned to the current step.

		  -->
<@dynamichtml doc_approval_resolve_action@>

	<$if userCanWrite or userCanRead$>

		<$docAccount=DOC_INFO.dDocAccount$>
		<$if docAccount$>
			<$executeService("IRIS_GET_USER_ACC_PRIVILEGE")$>

			<$if userAccPriv >= 3$>
				<$foundAccount="Y"$>
			<$endif$>

		<$else$>
			<$foundAccount="Y"$>
		<$endif$>

		<$if not #active.foundAccount$>
			<!-- 	Take away user's write priviledges, as they do
						not have write access to this document's account -->
			<$userCanWrite = ""$>
		<$endif$>

	<$endif$>

	<!--	Look for an 'action' parameter in the URL request. The
				value of this parameter determines whether or not the
				user may make changes to item metadata.

				Doesn't really work at the moment. -->
	<$if action$>

		<$if action like 'edit' and userCanWrite$>
			<$isInfo = ""$>
		<$elseif action like 'view'$>
			<$isInfo = 1$>
		<$endif$>

	<$endif$>

	<$if not userCanWrite and userCanRead$>
		<$isInfo = 1$>
	<$endif$>

	<!-- 	The action setting can be potentially overriden by
				security restrictions relating to the current
				workflow step. -->
	<$if #active.dWfStepType$>
		<$isWorkflowItem=1$>
		
		<$if (strIndexOf(dWfStepType,":CE:") >=0 or strIndexOf(dWfStepType,":CN:") >=0)$>
			<!-- Indicates a workflow step which allows data to be edited. -->
			<$isEditStep		="Y"$>
			<$approveService = "IRIS_WF_APPROVE"$>

		<$elseif strIndexOf(dWfStepType,":R:") >= 0$>
			<!-- Indicates a workflow step which does not allow data to be edited. -->
			<$isReviewStep	="Y"$>
			<$approveService = "IRIS_WF_APPROVE"$>
			
		<$endif$>
		
		<$reviewSteps = getValue("#env","IRIS_reviewSteps_" & dWfName)$>
		
		<$if strIndexOf(reviewSteps,dWfStepName) > -1$>
			<$isEditStep	  =""$>
			<$isReviewStep	="Y"$>
		<$endif$>

		<$trace("wfUserQueue = " & wfUserQueue)$>

		<$if (strIndexOf(wfUserQueue,dUser) >= 0)$>

			<$if isEditStep and userCanWrite$>
				<!-- User is registered as a contributor/reviewer for this step -->
				<$isInfo 				= ""$>
			<$else$>
				<!-- User is registered as a reviewer for this step -->
				<$isInfo 				= 1$>
			<$endif$>
			
			<$allowWorkflowActions=1$>
			<$enableWorkflowForm=1$>
			
		<$else$>
			<!-- User does not have rights to the document
					 at this workflow step. -->
			<$isInfo = 1$>
			<$allowWorkflowActions=''$>

		<$endif$>
	<$else$>
		<$if #env.Iris_allowPostWorkflowEdit$>
			
		<$else$>
			<$isInfo = 1$>
		<$endif$>
	<$endif$>

	<$include doc_approval_resolve_action_extra$>

<@end@>

<!-- 	Assign global JavaScript variables using IDOC values.
		
		Most of these are required by iris_common.js.
		
		Override this include if you want to expose further
		IDOC variables through JavaScript.
 			-->
<@dynamichtml doc_approval_resolve_js_vars@>

	<script type="text/javascript">
		
		var userName = "<$js(UserName)$>";
		
		var httpCgiPath = "<$HttpCgiPath$>";
		
		// Name of current Iris profile in use
		var profileName = '<$#local.profileName$>';
		
		// Determines whether the approval screen is loaded in info-only state
		var isInfo = <$if isInfo$>true<$else$>false<$endif$>;
				
		// Determines whether the user may perform workflow actions
		var allowWorkflowActions = <$if allowWorkflowActions$>true<$else$>false<$endif$>;
	
		var thumbnailMode = <$if thumbnailMode$>true<$else$>false<$endif$>;
		var batchEditMode = <$if #env.Iris_batchEditMode$><$#env.Iris_batchEditMode$><$else$>''<$endif$>;
		
		var approvalDocName	  	= "<$if #active.dDocName$><$dDocName$><$endif$>";
		var bundleRef 			= "<$if bundleRef$><$bundleRef$><$else$><$endif$>";
		
		// Whether the document panel is checked for changes on page unload
		var checkChangesOnExit = <$if #env.Iris_checkChangesOnExit$>true<$else$>false<$endif$>;
		
		// Whether the (parent) item is attached to UCM workflow
		var isWorkflowItem = <$if isWorkflowItem$>true<$else$>false<$endif$>;
		
		// Workflow document permissions
		var isEditStep 		= <$if isEditStep$>true<$else$>false<$endif$>;
		var isReviewStep 	= <$if isReviewStep$>true<$else$>false<$endif$>;
		
		// Workflow action validation class
		var validationClass = '<$getValue("rsProfileData","validationClass")$>'
		
		var useAsyncApprovals = <$if #env.Iris_AsyncApprovals$>true<$else$>false<$endif$>;
		
		var approveService = '<$#local.approveService$>';
		
		// Total submitted notes
		var numNotes = <$if #local.numNotes$><$numNotes$><$else$>0<$endif$>;
		// Total submitted docs
		var numDocs = <$if #local.numDocs$><$numDocs$><$else$>0<$endif$>;

		var hasRecentNotes	= <$if hasRecentNotes$>true<$else$>false<$endif$>;
		
		// Fixed preview height, if empty/null this will be calculated dynamically based
		// on the size of the browser window.
		var fixedPreviewHeight = '<$#env.Iris_previewZoneHeight$>';
		
		// validation URL prefix.
		var validationUrl = "?IdcService=IRIS_VALIDATE_DOCUMENT<$include add_idc_token_to_url$>&dDocName=<$dDocName$>" +
	 	 "&dWfName=<$DOC_WF_INFO.dWfName$>&dWfStepName=<$DOC_WF_INFO.dWfStepName$>" +
	 	 "&profileName=<$profileName$>&validationClass=<$rsProfileData.validationClass$>";
		
		// Name of the metadata field used to hold document status.
		var docStatusField = "<$docStatusField$>";
		
		var passStatusInUrl = <$if #env.Iris_passStatusInURL$>true<$else$>false<$endif$>;
		
		// Last method call before actually submitting the workflow
		// form via the submitWfAction() method.
		function prepareSubmitWfAction(action) {
			
			// Use this include hook to add further validation checks.
			<$include iris_wf_action_validation_extra_js$>
			
			// submit workflow form
			submitWfAction(action);
		}
		
	</script>

<@end@>

<!-- 	Resolve the user's access rights by checking their
			membership to the contributor and admin roles. This
			will set the values of up to three flags, which determine
			their access rights -->
<@dynamichtml iris_resolve_user_access@>

	<$if userHasRole("contributor") or userHasRole("admin")$>
		<$userCanDelete="Y"$>
		<$userCanWrite="Y"$>
	<$endif$>

	<$if userHasRole("admin")$>
		<$userCanAdmin="Y"$>
	<$else$>
		<$userCanAdmin=""$>
	<$endif$>

	<$trace("userCanDelete? " & #local.userCanDelete)$>
	<$trace("userCanWrite? " & #local.userCanWrite)$>
	<$trace("userCanAdmin? " & #local.userCanAdmin)$>
	
	<$userAccessResolved=1$>

<@end@>

<!-- 	Searches for presence of additional url parameters
			in the Binder. If any exist, they are appended to
			a string called urlparams.
			-->
<@dynamichtml iris_get_url_params@>
	<$selstring	= ""$>

	<$if bundleRef$>
		<$bundlestring = "&bundleRef=" & bundleRef$>
	<$endif$>

 	<$if sel$>
		<$selstring	= "&sel=" & sel$>
	<$endif$>

	<$actionstring = ""$>

	<$if action$>
		<$actionstring = "&action=" & action$>
	<$endif$>

	<$urlparams = #local.bundlestring & #local.selstring & #local.actionstring$>

<@end@>

<!--	-------------------------
Contains all javascript functions used in the Document Approval page
------------------------------- -->
<@dynamichtml doc_approval_js@>

	<$include iris_common_js$>

	<!-- TODO: Move all script below into the above external file. Need to remove some
			 referenes to IDOC variables first. -->
	<script type="text/javascript">

	

	</script>
	
	<$include iris_get_content_url_js$>

<@end@>

<!-- 	Contains a single JavaScript method, getContentUrl(), used when
			retrieving an absolute URL to display in the preview frame. -->
<@dynamichtml iris_get_content_url_js@>

	<script type="text/javascript">
		
		// Fetches the absolute URL for the current content item.
		function getContentUrl() {
			var contentUrl = '<$DocUrl$>';
			return contentUrl;
		}
		
	</script>

<@end@>

<!-- Copy and override this include to add extra shortcut key handlers. -->
<@dynamichtml iris_shortcut_keys_js_extra@> 
	
	<script type="text/javascript">
		
		function pageKeyPressExtra(e) {
			// nothing
		}
		
	</script>

<@end@>

<!-- Contains a single function, validateDocFields(). This
		 is called prior to submitting a metadata update.
		 
		 It is expected to return a boolean indicating whether
		 the document fields were valid.
		 
		 To implement your own validation, override this include
		 and replace the function body.
		 -->
		 
<@dynamichtml iris_doc_validation_js@>

	<script type="text/javascript">
		
		var requireAccount = <$if getValue("#env","Iris_requireAccount")$>true<$else$>false<$endif$>;
		
		// Validates document metadata.
		//
		// Returns true if all fields are valid, false otherwise.
		function validateDocFields() {
	
			// remove any previously-displayed error messages
			clearFieldErrorMsgs();
	
			var hasErrors = false;
	
			if (requireAccount) {
				var accountField = document.getElementsByName("dDocAccount")[0];
	
				// check for account field
				if (accountField != null && accountField.value == '') {
					alert("Please specify a document account before continuing.");
					accountField.focus();
					
					hasErrors = true;
				}
			}
						
			// Use this include for custom validation checks.
			<$include iris_doc_validation_extra_js$>	
			
			return !hasErrors;
		}
		
		// Displays a validation error message below the given field
		// on the document indexing panel.
		//
		// The field element itself will also be re-styled to show it
		// is in error.
		function displayFieldErrorMsg(fieldName, msgTitle, msgBody) {
			
			// re-style field input element
			var fieldElem = document.doc_fields[fieldName];
			$(fieldElem).addClass("validation_error_field");
		
			// build the error message div
			var errorMsg = createErrorMsg(fieldName, msgTitle, msgBody);
			
			// clicking the error msg div will highlight the offending field.
			errorMsg.onclick = function() {
				var thisField = this.id.substring(4);
				
				document.doc_fields[thisField].focus();
				document.doc_fields[thisField].select();
			}
			
			// create the table cell/row to hold the div and insert
			// it after the document field row.
			var errorMsgCell = document.createElement("td");
			
			errorMsgCell.appendChild(errorMsg);
			
			var errorMsgRow = document.createElement("tr");
			errorMsgRow.id = "docFieldError_" + fieldName;
			errorMsgRow.className = "doc_field_error_row";
			errorMsgRow.appendChild(document.createElement("td"));
			errorMsgRow.appendChild(errorMsgCell);
			
			// find the table row holding the field
			var fieldRow = $("#docFieldEntry_" + fieldName + ":first");
			
			$(errorMsgRow).insertAfter(fieldRow);
		}
		
		// Displays a custom message below the given field on the document 
		// indexing panel.
		// 
		// A new table row with ID of "docFieldError_[fieldName]" is inserted below
		// the table row containing the input field, and used as a container for the
		// error message panel.
		//
		// "msgType" determines the styling used, and can be one of the following:
		// "info"
		// "warning"
		// "error"
		function displayFieldMsg(msgType, fieldName, msgTitle, msgBody) {
		
			// re-style field input element. Only applicable to warning/error message types.
			var fieldElem = document.doc_fields[fieldName];
			
			if (msgType == "warning")
				$(fieldElem).addClass("validation_warning_field");
			else if (msgType == "error")
				$(fieldElem).addClass("validation_error_field");
		
			// Build the error message div
			var errorMsg = createMsgElement(msgType, fieldName, msgTitle, msgBody);
			
			// Clicking the error msg div will highlight the offending field.
			errorMsg.onclick = function() {
				var thisField = this.id.substring(4);
				
				document.doc_fields[thisField].focus();
				document.doc_fields[thisField].select();
			}
			
			// Check for existence of the error message table row first.
			var errorMsgRow = $("#docFieldError_" + fieldName); 
			
			if ($(errorMsgRow).length == 0) {
				errorMsgRow = document.createElement("tr");
				$(errorMsgRow)
				 .attr("id", "docFieldError_" + fieldName)
				 .addClass("doc_field_error_row");
				 			
				// Create 2 empty table cell elements and append to row.
				// The second one will act as the container for this message 
				// and subsequent ones.
				$(errorMsgRow).append(document.createElement("td"));
				var errorMsgCell = document.createElement("td");
				$(errorMsgRow).append(errorMsgCell);
				 
				// find the table row holding the field
				var fieldRow = $("#docFieldEntry_" + fieldName + ":first");
				// append the error message row
				$(errorMsgRow).insertAfter("#docFieldEntry_" + fieldName + ":first");
			}
			
			var errorMsgCell = $(errorMsgRow).children(":last");
			$(errorMsgCell).append(errorMsg);
		}
		
		// Generates and returns a DOM element that displays a message panel.
		function createMsgElement(msgType, msgId, titleText, bodyText) {
			// create the divs which hold the message
			var msgHeader = document.createElement("div");
			$(msgHeader)
			 .addClass("validation_" + msgType + "_title")
			 .html(titleText);
			
			var msgBody;
			
			if (bodyText) {
				msgBody = document.createElement("p");
				$(msgBody).html(bodyText);
			}
			
			var msgDiv = document.createElement("div");
			$(msgDiv)
			 .attr("id", "err_" + msgId)
			 .addClass("validation_error")
			 .addClass(msgType + "_icon");
			
			msgDiv.appendChild(msgHeader);
			
			if (msgBody)
				msgDiv.appendChild(msgBody);
			
			return msgDiv;
		}
		
		// Creates and returns an error message DIV element. It must
		// be inserted into the DOM afterwards.
		//
		// The given msgTitle, msgBody variables determine the content
		// of the error message.
		function createErrorMsg(msgId, msgTitle, msgBody) {
			
			// create the divs which hold the error message
			var errorMsgTitle = document.createElement("div");
			errorMsgTitle.className = "validation_error_title";
			errorMsgTitle.innerHTML = msgTitle;
			
			if (msgBody && msgBody.length > 0) {
				var errorMsgBody = document.createElement("p");
				errorMsgBody.innerHTML = msgBody;
			}
			
			var errorMsgDiv = document.createElement("div");
			errorMsgDiv.id				= "err_" + msgId;
			errorMsgDiv.className = "validation_error error_icon";
			
			errorMsgDiv.appendChild(errorMsgTitle);
			
			if (errorMsgBody)
				errorMsgDiv.appendChild(errorMsgBody);
			
			return errorMsgDiv;
		}
	
		// Deletes any existing field error messages spawned by 
		// function above.
		function clearFieldErrorMsgs() {
			// remove error styling on invalid fields
			$("#doc_fields input, #doc_fields select, #doc_fields textarea").removeClass("validation_error_field");
			
			// delete rows used for displaying validation errors
			$(".doc_field_error_row").remove();
		}
		
	</script>

	<$include iris_doc_validation_utils_js$>

<@end@>

<!-- Contains common utility functions used by JavaScript
     document validation. -->
<@dynamichtml iris_doc_validation_utils_js@> 

<script type="text/javascript">
	
	// checks if a string satisfies a minimum length
	function validateMinLength(val, minLength) {
		var trimVal = jQuery.trim(val);
	
		return (trimVal.length >= minLength);
	}
	
	// checks if a string exceeds a maximum length
	function validateMaxLength(val, maxLength) {
		var trimVal = jQuery.trim(val);
	
		return (trimVal.length <= maxLength);
	}
	
	// Checks if a value is a whole number, i.e. integer
	function validateIntegerValue(val) {
		var intPattern = new RegExp("^[0-9]+$");
		return intPattern.test(val);
	}
	
	// Checks if a value is a valid currency, e.g. 0.00
	function validateCurrencyValue(val) {
		var numPattern = new RegExp("^[0-9]*[\.]?[0-9]*$");
		return numPattern.test(val);
	}
	
	// Checks if a value is a valid date.
	function validateDateValue(val) {
		
		var dateBits = val.split("/");
		
		if (dateBits.length != 3)
			return false;
		else {	
			var thisDate = dateBits[0];
			var thisMonth = dateBits[1];
			var thisYear  = dateBits[2];
		
			// construct a Date object from the given arguments and
			// check to see if its components match the original args.
			var checkDate = new Date(thisYear,thisMonth-1,thisDate);
		
			return (	 (thisDate			==checkDate.getDate()) 
							&& ((thisMonth-1)	==checkDate.getMonth()) 
							&& ((thisYear			==checkDate.getFullYear()) | (thisYear == (checkDate.getFullYear() + "").substring(2)))
							);
		}
	}
	
	// Checks if the passed date falls between the given range
	// rangeStart and rangeEnd are both optional, but must be 
	// passed as strings in the form dd/mm/yy.
	//
	// Returns 3 possible values:
	// -1 (date occurs before range start)
	// 0 (date occurs between range)
	// 1 (date occurs after range end)
	function validateDateRange(val, rangeStart, rangeEnd) {
		var checkDate = getDateFromString(val);

		if (checkDate) {
			var dateMillis = checkDate.getTime();
			
			if (rangeStart && rangeStart != '') {
				var startDate 	= getDateFromString(rangeStart);
				
				if (startDate.getTime() > dateMillis)
					return -1;
			}
			
			if (rangeEnd && rangeEnd != '') {
				var endDate		= getDateFromString(rangeEnd);
				
				if (endDate.getTime() < dateMillis)
					return 1;
			}
		
			// date falls between given range
			return 0;
			
		} else {
			return false;
		}
	}
	
	// Constructs a Date instance from a given string in the form:
	// dd/mm/yy or dd/mm/yyyy
	function getDateFromString(val) {
		
		var dateBits = val.split("/");
		
		if (dateBits.length != 3)
			return false;
		else {	
			var thisDate = dateBits[0];
			var thisMonth = dateBits[1];
			var thisYear  = dateBits[2];
		
			if (thisYear.length <= 2) {
				// 2- or 1-digit year supplied. Attempt to auto-complete it
				
				if (thisYear.length == 2 && parseInt(thisYear) > 75) {
					// assume 20th century
					thisYear = "19" + thisYear;
				} else {
					// assume 21st century
					var today = new Date();
					var curYear = today.getFullYear() + "";
					
					thisYear = curYear.substring(0, 4 - thisYear.length) + thisYear;
				}
			}
		
			// construct a Date object from the substrings
			var dateObj = new Date(thisYear,thisMonth-1,thisDate);
			
			return dateObj;
		}
	}
	
	<$include iris_doc_validation_utils_extra_js$>
	
</script>

<@end@>

<!-- -----------------------
 Counts the total number of notes and documents associated with this item
------------------------- -->
<@dynamichtml doc_approval_count_totals@>

	<$numNotes = 0$>
	<$numDocs = 0$>

	<$origDocName = dDocName$>

	<$hasRecentNotes = ''$>

	<!-- find number of associated docs -->
	<$docType='LinkedDoc'$>
	<$parentId=dDocName$>
	<$executeService("IRIS_GET_LINKED_ITEMS_COUNT")$>
	<$numDocs = getValue("linkedItems","NUMLINKEDITEMS")$>

	<!-- find number of associated notes -->
	<$executeService("IRIS_GET_AUDIT_ENTRY_COUNT")$>
	<$numNotes = getValue("rsEntryCount", "AUDITENTRYCOUNT")$>

	<$if numNotes > 0$>
		<$hasRecentNotes = 1$>
	<$else$>
		<$showRecentNotes = ''$>
	<$endif$>

	<!-- Restore parent dDocName -->
	<$dDocName = origDocName$>

<@end@>

<!-- 	Displayed for 'selections' only, i.e. when the user has chosen to
			approve/inspect a set of records from the main document listing.
			-->
<@dynamichtml doc_approval_browse@>

	<$if false$>

		<div style="text-align: center; margin-top: 10px; width: 100%">
			Browsing <$num_sel_docs$> images
		</div>
	<$endif$>
	<$if sel$>

		<$pn_link_prefix = HttpCgiPath & "?IdcService=DOC_APPROVAL" &inc("add_idc_token_to_url") & urlparams & "&dDocName="$>
		<$pn_div_attributes = "onmouseover='add_browse_hilite(this)' onmouseout='rem_browse_hilite(this)'"$>
		<$pn_header = "Browsing " & pn_total & " items"$>
		<$pn_width = 300$>
		<$pn_rs = "rsSel"$>
		<$pn_rs_row = "ID"$>
		<$pn_use_justified = "Y"$>

		<!-- Display the paginator window -->
		<$include iris_paginator_display_window$>

	<$endif$>

<@end@>

<@dynamichtml iris_doc_panel_header@>

	<!-- Display standard panel header. -->
	Item Details - <span class='docname'><$dDocName$></span>

<@end@>

<!-- Renders the doc metadata panel. -->
<@dynamichtml doc_approval_fields@>

	<$include greyPanel_top$>

		<!-- Title for the field listing: displays the dDocName for this item -->
		<div class='panelheader'>
			<table width="100%" cellpadding=0 cellspacing=0>
				<tr height=20>
					<td>
						<span class='panelheading'>
							<$include iris_doc_panel_header$>
						</span>
					</td>
					<td width=22>
						<div onclick="togglePanel(this)" id="toggle_metadata_panel" class="toggle_img_collapse" id="toggle_metadata_panel"></div>
					</td>
				</tr>
			</table>
		</div>
		
		<!-- This div has an ID so the display setting can be toggled between block/none -->
		<div id='metadata_panel' class='panelbody'>
			
			<$include iris_doc_panel_dualindex_header$>
				
			<$include iris_update_form_header$>

					<$if not fields$>
						<!-- No field list found yet, try and find a field list
								 relating to its content type only -->
						<$if getValue("#active", "Iris_fields_" & DOC_INFO.dDocType)$>
							<$fields = getValue("#active", "Iris_fields_" & DOC_INFO.dDocType)$>
						<$else$>

							<!-- No content type-specific field list was found. Use
									 the default field list instead. -->
							<$fields = getValue("#env", "Iris_fields_default")$>

						<$endif$>
					<$endif$>

					<!-- Collect field spec from profile data	-->
					<$fields = getValue("rsProfileData","visible")$>
					<$requiredFields = getValue("rsProfileData","required")$>
					<$labelFields = getValue("rsProfileData","label")$>

					<$rsMakeFromString("fieldList",fields,"fieldName")$>

					<!-- Collect all short-date fields -->
					<$shortDateFields = getValue("#active","Iris_shortDateFields")$>

					<!-- Now load the DocMeta definition data to handle the custom fields -->
					<$loadDocMetaDefinition()$>

					<!-- Loop over the custom field list -->
					<$loop fieldList$>

						<!-- 	Look out for 'div' entries in the field list. If one
									is found, print an extra row with a line break -->
						<$if fieldName like "div"$>
							<tr style="height:6px"><td colspan=2><td></tr>
						<$else$>

							<$loop DocMetaDefinition$>
								<$c='Search metadata definition for this field'$>
								<$fieldValue_dec=""$>
							<$foundDecimalField=""$>
								<$if dName like fieldName$>

									<$fieldCaption = dCaption$>

									<$trace("fieldCaption = " & DocMetaDefinition.dCaption & ", fieldName = " & DocMetaDefinition.dName & ", fieldType = " & DocMetaDefinition.dType & ", fieldValue = " & eval("<$" & DocMetaDefinition.dName & "$>"))$>

									<$if (dType like 'Date')$>
										<$if false$>
											<$if (strIndexOf(shortDateFields,fieldName) >= 0)$>
												<!-- format this field as a 'short date' -->
												<$fieldValue = formatDateWithPattern(getValue("DOC_INFO",fieldName),#active.Iris_shortDatePattern)$>
											<$else$>
												<!-- format this field as a 'long date' -->
												<$fieldValue = formatDateWithPattern(getValue("DOC_INFO",fieldName),#active.Iris_longDatePattern)$>
											<$endif$>
										<$endif$>
									<$else$>

										<$if not #active.fieldValue$>
											<$fieldValue = getValue("DOC_INFO",fieldName)$>
										<$endif$>

										<$include shift_decimal$>
										<$if foundDecimalField$>
										  <$fieldValue_dec=fieldValue$>
										<$endif$>
									<$endif$>

									<$if not #active.fieldValue$>
										<$include compute_std_field_value$>
									<$endif$>
									
									<$include iris_meta_field_display$>
									
									<$c= 'Store the initial value of each field as a hidden input. These are used'$>
									<$c= 'to check whether there are any unsaved changes when the user attempts to'$>
									<$c= 'navigate away from the page'$>
									<$c= 'HB 04/04/2008 - if the field has been decimalized then use this value.'$>

									<$if dType like 'Memo'$>
										<!-- Values are formatted differently inside textareas.
												 Use a special hidden textarea to record the original value
												 of Memo fields. -->
										<textarea name="<$fieldName$>_old" style="display:none"><$fieldValue$></textarea>
									<$else$>
										<input type="hidden" name="<$fieldName$>_old" value="<$if fieldValue_dec$><$fieldValue_dec$><$else$><$fieldValue$><$endif$>">
									<$endif$>

									<$fieldValue = ""$>
									<$fieldValue_dec = ""$>

								<$endif$>

							<$endloop$>

						<$endif$>

					<$endloop$>

						<script type="text/javascript">
				
							var numMissingFields = <$numMissingFields$>;
							
							// initialize any custom buttons.
							$(document).ready( function() {
								initButtons();	
								
								updateMissingFieldCount(numMissingFields);
							});
							
							var isDocInfo = <$if isInfo$>true<$else$>false<$endif$>;

							// this script collects all the field names and stores them
							// to an array
							var fields = new Array();
							var labelFields = '';
							
							// Collect the names of all metadata fields
							collectFields = function() {

								labelFields = '<$#active.labelFields$>';

								<$if not isInfo$>

									// grab custom field list from IDOC variable
									var fieldList = '<$fields$>';

									// remove 'div' entries
									while (fieldList.indexOf('div,') > -1)
										fieldList = fieldList.replace('div,', '')

									while (fieldList.indexOf('div') > -1)
										fieldList = fieldList.replace('div', '');

									// remove orphan commas
									while (fieldList.indexOf(',,') > -1)
										fieldList = fieldList.replace(',,', ',');

									// split string around comma characters to obtain
									// a string array
									fields = fieldList.split(',');

									// add default fields to array
									fields.push('dDocType');
									fields.push('dDocTitle');

									<$if not getValue("#env","Iris_hideAccount")$>
										fields.push('dDocAccount');
									<$endif$>
									
									var fieldValues = new Object();
									
									for (var f=0; f<fields.length; f++) {
										alert("adding field: " + fields[f] + ", value = " + document.doc_fields[fields[f]].value);
										
										fieldValues[fields[f]] = document.doc_fields[fields[f]].value;
									}

								<$endif$>
							}
							
						</script>


						<tr>
							<td colspan=3 align="center" valign="bottom" id="statusText" class="notification" style="padding-top: 5px">
								<script type="text/javascript">
									var isSaved = <$if #local.saved$>true<$else$>false<$endif$>;
								</script>
								
								<$if #local.saved$>
									Document saved
								<$elseif #local.reloaded and not isInfo$>
									Document reloaded
								<$else$>
									&nbsp;
								<$endif$>
							</td>
						</tr>

					<$include doc_approval_fields_actions$>

			</table>

			</form>

		</div> <!-- End metadata_display div -->

		<$include greyPanel_bottom$>

<@end@>

<!-- Displays dual indexing information when applicable. -->
<@dynamichtml iris_doc_panel_dualindex_header@>
	
	<$if (not #local.diOverrideLock) and (diDocumentPassed like "0|1")$>
		
		<$cacheInclude("iris_prepare_dualindex_override_user_roles","application")$>
		<$cacheInclude("iris_get_is_dualindex_override_user", "session")$>
		
		<$if isDualIndexOverrideUser$>
			<form name="forcePassOutcomeForm" id="forcePassOutcomeForm">
				
				<input type="hidden" name="IdcService" 	value="IRIS_BATCH_DUAL_INDEX_FORCE_PASS" />
				<$include add_idc_token_to_form$>
				<input type="hidden" name="dDocName"	value="<$#local.dDocName$>" />
				<input type="hidden" name="IsJson"		value="1" />
				
			</form>
			
			<script type="text/javascript">
				forcePassOutcome = function() {
					$.post("?",
						$("#forcePassOutcomeForm").serialize(),
						function(data) {
							var errMsg = getJsonErrorMsg(data);
							
							if (errMsg)
								alert("Error!\n\n" + errMsg);
							else
								getDocPanel("<$#local.dDocName$>");
						},
						"json"
					);
				};
			</script>
		<$endif$>
		
		<div class="lock_display_box">
			<p class="item_locked">
				<$if diDocumentPassed like 1$>
					This item has passed dual-indexing validation and cannot be edited. 
					<br/>
					<$if isDualIndexOverrideUser$>
						<a href="javascript:getDocPanel('<$dDocName$>','&diOverrideLock=1')">Click here to override</a>
					<$endif$>
				<$else$>
					This item has failed dual-indexing validation. Check the logs for more details.
					<br/>
					<$if isDualIndexOverrideUser$>
						<a href="javascript:forcePassOutcome()">Click here to mark the item as Passed</a>
					<$endif$>
				<$endif$>
			</p>
		</div>
	
	<$elseif diDocumentPending$>
		
		<div class="lock_display_box">
			<p class="item_index">
				This item requires dual indexing. 
			</p>
		</div>
		
	<$endif$>
	
<@end@>

<!-- Generates a ResultSet of role names who are permitted to force-pass
     failed Dual Index items, and override the lock on passed Dual Index
	 items. -->
<@dynamichtml iris_prepare_dualindex_override_user_roles@>
	
	<$if #env.Iris_dualIndexOverrideRoles$>
		<$exec rsMakeFromString("rsDualIndexOverrideRoles", #env.Iris_dualIndexOverrideRoles, "roleName")$>
	<$endif$>
	
<@end@>

<@dynamichtml iris_get_is_dualindex_override_user@>
	
	<$if rsDualIndexOverrideRoles$>
		<$loop rsDualIndexOverrideRoles$>
			<$if userHasRole(#active.roleName)$>
				<$isDualIndexOverrideUser=1$>
				<$break$>
			<$endif$>
		<$endloop$>
	<$endif$>
	
<@end@>

<!-- Default form header used on the approval page. -->
<@dynamichtml iris_update_form_header@>
<$if IsDebug$>iris_update_form_header<$endif$>
	<form name="doc_fields" id="doc_fields" style="margin: 0px; padding: 0px">

		<input type=hidden name=isIris					value="1">

		<input type=hidden name=IdcService 			value="IRIS_UPDATE_DOCINFO"><$include add_idc_token_to_form$>
		<input type=hidden name=dID							value="<$dID$>">
		<input type=hidden name=dSecurityGroup	value="<$dSecurityGroup$>">
		<input type=hidden name=dRevLabel				value="<$dRevLabel$>">
		<input type=hidden name=dDocName				value="<$dDocName$>">
		<input type=hidden name=dInDate					value="<$dInDate$>">

		<input type=hidden name=RedirectUrl			value="<$HttpCgiPath & '?IdcService=DOC_APPROVAL&dDocName=' & dDocName & #local.urlparams$><$include add_idc_token_to_url$>">
		
		<$include iris_document_extra_hidden_fields$>
		
		<$numMissingFields = 0$>

		<!-- table containing metadata fields -->
		<table width="100%" cellpadding=0 cellspacing=2>

			<!-- Display standard information fields at the top -->

			<!-- Author field (dDocAuthor) -->
			<$include iris_document_author_field$>

			<!-- Document Type field (dDocType) -->
			<$include iris_document_type_field$>

			<!-- Title field (dDocTitle) -->
			<$include iris_document_title_field$>
			
			<!-- Account field (dDocAccount) -->
			<$if UseAccounts$>
				<$include iris_document_account_field$>
			<$endif$>

			<!-- Approver field (xApprover) -->
			<$if false$>
				<$fieldName="xApprover"$>
				<$dName="xApprover",dCaption="Approver",fieldValue = #active.xApprover$>
				<$include iris_meta_field_display$>
				<input type="hidden" name="xApprover_old" value="<$xApprover$>">
			<$endif$>

<@end@>

<!-- Action buttons for doc info/update form, i.e. Submit -->
<@dynamichtml doc_approval_fields_actions@>

	<$if not isInfo$>

		<tr>
			<td colspan=3 align="left">
				<div class="sidepanel_button_holder">
					<input 	type=button 
									name="submitbtn" id="submitbtn"
									value="Save Changes" 
									onclick="saveChanges()" 
									style="width: 120; margin: 5px;" 
									tabindex="<$tabIndex$>">
					<input 	type=button 
									name="discardbtn" id="discardbtn"
									value="Discard Changes" 
									onclick="discardChanges();" 
									tabindex="<$include iris_get_next_tabindex$>" 
									style="width: 120; margin: 5px;">
				</div>
			</td>
		</tr>

	<$else$>
		<tr><td colspan=2><br></td></tr>
	<$endif$>

<@end@>

<!-- Displays the document title (dDocTitle) field -->
<@dynamichtml iris_document_title_field@>

	<tr>
		<$if isInfo$>
			<td valign=center class="field_caption_info">Title:</td>
			<td valign=center class="field_value_info"><$dDocTitle$></td>
		<$else$>
			<td valign=center class="field_caption">Title:</td>
			<td valign=center class="field_value"><input type="text" class="input_text_field" name="dDocTitle" value="<$dDocTitle$>" tabindex=<$tabIndex$>></td>
		<$endif$>
	</tr>
	<input type="hidden" name="dDocTitle_old" value="<$dDocTitle$>">

<@end@>

<!-- Displays the document author (dDocAuthor) field -->
<@dynamichtml iris_document_author_field@>

	<tr>
		<$if isInfo$>
			<td valign=center class="field_caption_info">Author:</td>
			<td valign=center class="field_value_info"><$dDocAuthor$></td>
		<$else$>
			<td valign=center class="field_caption">Author:</td>
			<td valign=center class="field_value"><$dDocAuthor$></td>
		<$endif$>
		
	</tr>
	<input type="hidden" name="dDocAuthor_old" value="<$dDocAuthor$>">

<@end@>

<!-- Displays the document type (dDocType) field -->
<@dynamichtml iris_document_type_field@>

	<tr>
		<$if isInfo$>

			<td valign=center class="field_caption_info">Type:</td>
			<td valign=center class="field_value_info"><$dDocType$></td>

		<$else$>

			<td valign=center class="field_caption">Type:</td>
			<td valign=center class="field_value">
				<select name="dDocType" class="input_option_field" <$if tabIndex$>tabindex=<$tabIndex$><$endif$>>

					<option value=""></option>

					<$exec rsMakeFromString("iris_doctypes",#active.Iris_doctypes,"type")$>

					<$loop iris_doctypes$>
						<option value="<$iris_doctypes.type$>" <$if dDocType like iris_doctypes.type$>SELECTED<$endif$>>
							<$iris_doctypes.type$>
						</option>
					<$endloop$>

				</select>
			</td>

		<$endif$>
	</tr>

	<input type="hidden" name="dDocType_old" value="<$dDocType$>">

	<$tabIndex = tabIndex+1$>

<@end@>

<!-- 	Increments and returns an integer. Used for maintaining tab order
			across form fields. -->
<@dynamichtml iris_get_next_tabindex@><$if #local.tabIndex$><$tabIndex = tabIndex+1$><$else$>tabIndex=1<$endif$><$tabIndex$><@end@>

<!-- Displays the dDocAccount field. -->
<@dynamichtml iris_document_account_field@>

	<tr>
		<$if isInfo$>
			<td class="field_caption_info">Account:&nbsp;</td>
			<td valign=center class="field_value_info"><$dDocAccount$></td>
		<$else$>
			<td class="field_caption">Account:&nbsp;</td>
			<td valign=center class="field_value">
				<$if #env.Iris_customAccountList$>
					<$inc(#env.Iris_customAccountList)$>
				<$else$>
					<$include iris_account_list$>
				<$endif$>
			</td>
		<$endif$>
	</tr>
	<input type="hidden" name="dDocAccount_old" value="<$dDocAccount$>">

	<$tabIndex = tabIndex + 1$>

<@end@>

<!-- Designed to replace std_meta_field_display -->
<@dynamichtml iris_meta_field_display@>
<$if IsDebug$>iris_meta_field_display<$endif$>
<tr id="docFieldEntry_<$dName$>">

	<$c='check for a custom metadata field display include/custom caption.'$>
	<$if rsCustomDisplayFields$>

		<$loop rsCustomDisplayFields$>
			<$if rsCustomDisplayFields.fieldName like dName$>
				<$customFieldDisplay = rsCustomDisplayFields.include$>
				<$customFieldCaption = rsCustomDisplayFields.custCaption$>

				<$trace("fieldDisplay? " & customFieldDisplay & ", fieldCaption? " & customFieldCaption)$>
				<$break$>
			<$endif$>
		<$endloop$>

	<$endif$>

	<$if customFieldCaption$>
		<$fieldCaption = customFieldCaption$>
		<$customFieldCaption=""$>
	<$else$>
		<$fieldCaption = dCaption$>
	<$endif$>
	
	<$isDualIndexField = ""$>
	
	<$if rsDualIndexFields$>
		<$if rsFindRowPrimary("rsDualIndexFields",dName)$>
			<$isDualIndexField = 1$>
		<$endif$>
	<$endif$>
	
	<$trace("fieldName = " & dName & ", fieldCaption = " & fieldCaption)$>

	<$if not customFieldDisplay$>
		<$c='now check for a general include relating to this field'$>
		<$customFieldDisplay = getValue("#active","Iris_fields_" & dName & "_customDisplay")$>
	<$endif$>

	<$if isInfo$>

		<$include iris_meta_field_info_display$>

	<$elseif #active.labelFields and strIndexOf(labelFields,dName) >= 0$>

		<$c='This field has been marked as label-only'$>
		<$include iris_meta_field_info_display$>

	<$else$>

		<$if #active.requiredFields and strIndexOf(requiredFields,dName) >= 0$>
			<$c='this field is required'$>

			<$if not fieldValue or fieldValue like ''$>
				<$numMissingFields = numMissingFields + 1$>
				<td valign=top class="field_caption_req">*<$fieldCaption$>:</td>

			<$else$>
				<td valign=top class="field_caption_req"><$fieldCaption$>:</td>

			<$endif$>

		<$else$>
			<td valign=top class="field_caption"><$fieldCaption$>:</td>
		<$endif$>
		
		<$extraCellClasses = ""$>
		
		<$if isDualIndexField$>
			<$extraCellClasses = " dual_index_cell"$>
		<$endif$>
		
		<td valign=top class="field_value<$extraCellClasses$>">
		
			<$if customFieldDisplay$>
				<$inc(customFieldDisplay)$>
				<$customFieldDisplay=""$>
			<$else$>

				<$if dIsOptionList like '1'$>
					<!-- Build the option list for this field -->
					<$valueField = ""$>
					<$displayField = ""$>
					
					<$viewName = ""$>
					
					<$if strIndexOf(dOptionListKey,"view://") == 0$>
						<!-- Option list is based off a view. -->
						<$viewName = strSubstring(dOptionListKey, 7)$>
						<$getViewValuesResultSet(viewName,"","")$>
						
						<$exec loadSchemaData("SchemaViewConfig", viewName)$>
						
						<$valueField = schInternalColumn$>
						<$displayField = schLabelColumn$>
						
					<$else$>
						<!-- Option list is a subset of values from the OPTIONLIST table. -->
						<$executeService("ECS_GETOPTIONLISTVALUES")$>
						
						<$valueField = "dOption"$>
						<$displayField = "dOption"$>
					
					<$endif$>

					<select class="input_option_field" name="<$dName$>" id="<$dName$>" tabindex="<$include iris_get_next_tabindex$>">

						<option value=""></option>

						<$loop SchemaData$>
							<$keyValue 		= getValue('SchemaData',valueField)$>
							<$displayValue 	= getValue('SchemaData',displayField)$>

							<option value="<$keyValue$>" <$if fieldValue like keyValue$>SELECTED="selected"<$endif$>><$displayValue$></option>

						<$endloop$>

					</select>
					
					<$if viewName$>
						<$exec clearSchemaData("SchemaViewConfig", viewName)$>
					<$endif$>
					
				<$else$>

					<$if dType like 'Date'$>
						<!-- Date field display -->
						<$include compute_std_field_value$>

						<$log4j("Computed value of " & dName & " to be: " & fieldValue)$>

						<$if strIndexOf(#active.Iris_shortDateFields,fieldName) > -1$>
							<$dateStyle="input_short_date_field"$>
						<$else$>
							<$dateStyle="input_date_field"$>
						<$endif$>

						<input type="text" class="<$dateStyle$>" name="<$dName$>" id="<$dName$>" value="<$fieldValue$>" tabindex="<$include iris_get_next_tabindex$>">

						<$if strIndexOf(#active.calendarSelectFields,dName) > -1$>

							<img src="epoch/images/epoch_calendar.gif" class="calbutton" style="margin-left: 5px" name="<$dName$>_picker" id="<$dName$>_picker"/>

						<$elseif dateStyle like "input_short_date_field" and false$>
							dd/mm/yy
						<$endif$>

					<$elseif dType like 'Memo'$>
						<!-- Memo field display -->
						<textarea class="input_memo_field" name="<$dName$>" id="<$dName$>" tabindex="<$include iris_get_next_tabindex$>"><$fieldValue$></textarea>
					<$else$>
						<!-- Standard text field display -->
						<input type="text" class="input_text_field" name="<$dName$>" id="<$dName$>" value="<$fieldValue$>" tabindex="<$include iris_get_next_tabindex$>">
					<$endif$>

				<$endif$>

			<$endif$>

		</td>
		
		<$include iris_meta_fields_extra_columns$>
		
	<$endif$>
</tr>

<$fieldValue=""$>

<$tabIndex = tabIndex+1$>

<@end@>

<@dynamichtml iris_meta_field_info_display@>

	<td valign=center class="field_caption_info"><$fieldCaption$>:&nbsp;</td>
	<td valign=center class="field_value_info">
		<$if dType like 'Memo'$>
			<$fieldValue$>
		<$elseif dName like #local.docStatusField$>
			<$docStatus$>
		<$else$>
			<$fieldValue$>
		<$endif$>
	</td>

<@end@>

<!--  Used to define which (date) fields will be displayed with
			a calendar selector in the metadata display. -->
<@dynamichtml iris_prepare_calendar_fields@>
	
	<$calendarSelectFields=#env.Iris_calendarSelectFields$>
	<$include Iris_prepareEpochCalendars$>

<@end@>

<!--  Used in the header for pages that require pop-up calendar functionality.
			Before calling the include, a variable 'calendarSelectFields' must be
			defined, as a comma-separated list of element names.

			For each name specified in the list, there should be a text input element
			with a matching id attribute, and a button element with the same id
			suffixed with '_picker'
			-->
<@dynamichtml Iris_prepareEpochCalendars@>

	<link rel="stylesheet" type="text/css" href="<$HttpWebRoot$>epoch/epoch_styles.css" />
	<script type="text/javascript" src="<$HttpWebRoot$>epoch/epoch_classes.js"></script>

	<script type="text/javascript">

	<$isCalendar=1$>

		<$exec rsMakeFromString("rsCalendarFields",calendarSelectFields)$>
		
		var calendarFields = new Array();
		var calendarWidgets = new Array(); // stores Epoch Calendar instances
		
		// Build array of calendar fields from IDOCScript env. var
		<$if rsCalendarFields$>
			<$loop rsCalendarFields$>calendarFields[<$rsCalendarFields.#row$>]="<$rsCalendarFields.row$>";<$endloop$>
		<$endif$>
					
		function prepareCalendars() {
			calendarWidgets.length = 0;
			
			var widgetCount = 0;
			
			for (var i=0; i<calendarFields.length; i++) {
				var calField = calendarFields[i];
				
				var elem 	= document.getElementById(calField);
				var btn 	= document.getElementById(calField + "_picker");
				
        if (elem != null && btn != null) {
        	//alert("generating widget for " + calField);
          calendarWidgets[widgetCount]  = new Epoch(calField + '_cal','popup',elem,btn,false);
          widgetCount++;
        } else {
        	// silent error
          //alert("Couldn't locate field/button for calendar field '" + calField 
          //			+ "', elem = " + elem + ", btn = " + btn); 
				}
			}
    }

  </script>
<@end@>


<!-- 	Displays workflow-related information, plus
			approve/reject buttons. Nothing is displayed
			if the document is not within a workflow
			-->
<@dynamichtml doc_approval_wf@>

	<$if DOC_WF_INFO$>

		<$include greyPanel_top$>

			<div class='panelheader'>
				<table width='100%' cellspacing=0 cellpadding=0>
					<tr height=20>
						<td>
							<span class='panelheading'>Workflow Details</span>
						</td>
						<td width=22>
							<div onclick="togglePanel(this)" id="toggle_wf_panel" class="toggle_img_collapse"></div>
						</td>
					</tr>
				</table>
			</div>

			<!-- This div has an ID so the display setting can be toggled between block/none -->
			<div id='wf_panel' class='panelbody' style="overflow: hidden">

				<$if isInfo$>
					<$classStr = "_info"$>
				<$else$>
					<$classStr = ""$>
				<$endif$>

				<form id="approve_reject_form" action="<$HttpCgiPath$>" method="GET" style="padding:0px; margin:0px">
					<!-- These form fields have their values inserted through javascript -->
					<input type=hidden name=IdcService>
					<$include add_idc_token_to_form$>
					<input type=hidden name=wfRejectMessage>
					<input type=hidden name=wfApproveMessage>

					<input type=hidden name=dID value="<$dID$>">

					<$if getValue("#env","Iris_passStatusInURL")$>
						<$statusInfo = "&prevStatus=" & docStatus$>
					<$endif$>
					
					<$if false$>
						<input type=hidden name=RedirectUrl value="<$HttpCgiPath & '?IdcService=DOC_APPROVAL<$include add_idc_token_to_url$>&dDocName=' & dDocName & #local.urlparams & #local.statusInfo$>">
					<$else$>
						<input type=hidden name=RedirectUrl value="<$eval(#env.Iris_workflowRedirectUrl)$><$include add_idc_token_to_url$>">
					<$endif$>
					
					<!-- ECS_AuditLog fields -->
					<input type="hidden" name="doAudit" value="1" />
					<input type="hidden" name="lApp" value="IRIS" />
					<input type="hidden" name="lRef" value="<$dDocName$>" />
					<input type="hidden" name="lTitle" value="<$dDocTitle$>" />
					<input type="hidden" name="lAction" /> <!-- Added before submit using javascript -->
					<input type="hidden" name="lUser" value="<$dUser$>" />

					<input type="hidden" name="lMessage" /> <!-- Any workflow comment is copied here -->
					
					<!-- Audit parameters are:
						1. current workflow name 
						2. current step name
						-->
					<input type="hidden" name="lParam1" value="<$DOC_WF_INFO.dWfName$>" />
					<input type="hidden" name="lParam2" value="<$DOC_WF_INFO.dWfStepName$>" />
				

				<!-- This table holds the workflow information -->
				<table width="100%" cellpadding=0 cellspacing=2>
					<tr>
						<td class="field_caption<$#active.classStr$>">Name:</td>
						<td class="field_value<$#active.classStr$>">
							<$if DOC_WF_INFO$>
								<$DOC_WF_INFO.dWfName$>
							<$else$>
								<$docWfName$> ??
							<$endif$>
						</td>
					</tr>

					<tr>
						<td class="field_caption<$#active.classStr$>">Step:</td>
						<td class="field_value<$#active.classStr$>">
							<$if DOC_WF_INFO$>
								<$DOC_WF_INFO.dWfStepName$>
							<$else$>
								<$docWfStepName$> ??
							<$endif$>

						</td>
					</tr>

					<tr>
						<td colspan=2>
							<br>
							<$DOC_WF_INFO.dWfStepDescription$>
						</td>
					</tr>

					<tr><td colspan=2><br></td></tr>

					<tr>
						<td colspan=2 valign=center>
							<!-- Text area for approve/reject comments -->
							<textarea id="wfComments" 
												wrap="virtual" 
												tabindex="<$tabIndex$>"
												<$if (#active.numMissingFields > 0) or (not allowWorkflowActions) or (not enableWorkflowForm)$>disabled="disabled"<$endif$>></textarea>
							<$tabIndex = tabIndex + 1$>
						</td>
					</tr>

					<!-- Display approve/reject buttons -->
					
					<tr>
						<td colspan=2 style="color: #DC143C" id="missing_field_count">
							<$if #active.numMissingFields > 0$>
								<$numMissingFields$> required field value(s) are missing.
							<$endif$>
						</td>
					</tr>
					
					
					<$if allowWorkflowActions$>
						<tr>
							<!-- Workflow notification messages -->
							<td colspan=2 align="center" id="wfStatusText" class="notification">
								&nbsp;
							</td>
						</tr>
					<$endif$>
						
					<tr>

						<$if not allowWorkflowActions$>
							<!-- User is not a valid contributor/reviewer,
									 hide the approve/reject buttons -->

							<td colspan=2 align="left" class="nofication">
								<$if isEditStep$>
									<$roleName = "contributor"$>
								<$else$>
									<$roleName = "reviewer"$>
								<$endif$>

								You are not a valid <$roleName$> for this step.<br/><br/>
								<a href="javascript:toggleApprovers()"><span id="toggleApproverLink">Show <$roleName$>s &gt;&gt;</span></a>

								<div id="approverList" style="display: none">

									<$exec rsMakeFromString("rsUserQueue",wfUserQueue,"user")$>

									<ul>
									<$loop rsUserQueue$>
										<$userEmail = getValueForSpecifiedUser(rsUserQueue.user,"dEmail")$>

										<$if userEmail$>
											<li><a href='mailto:<$userEmail$>?subject=Approval of item [<$dDocName$>]'><$rsUserQueue.user$></a></li>
										<$else$>
											<li><$rsUserQueue.user$></li>
										<$endif$>

									<$endloop$>
									</ul>

								</div>

								<script type="text/javascript">

									function toggleApprovers() {

										var approverList = document.getElementById("approverList");
										var approverLink = document.getElementById("toggleApproverLink");

										if (approverList.style.display == '') {
											approverList.style.display = 'none';
											approverLink.innerHTML = 'Show <$roleName$>s &gt;&gt;';
										} else {
											approverList.style.display = '';
											approverLink.innerHTML = 'Hide <$roleName$>s &lt;&lt;';
										}
									}

								</script>

							</td>

						<$else$>
							
							<$include iris_wf_panel_buttons$>
							
						<$endif$>

					</tr>

					</table>

				</form>

			</div>

		<$include greyPanel_bottom$>

		<br/>

	<$endif$>

<@end@>

<!-- Displays the approve and reject buttons on the workflow panel. -->
<@dynamichtml iris_wf_panel_buttons@> 

	<!-- Collect custom approve/reject button text for this workflow step.
			 If custom text isn't found, use 'Approve' and 'Reject' instead -->
	<$if false$>
		<$approveText = getValue("#active",DOC_WF_INFO.dWfName & "_" & DOC_WF_INFO.dWfStepName & "_approveText")$>
	<$endif$>

	<$approveText = getValue("rsProfileData","approveText")$>

	<$if not approveText$>
		<$approveText = "Approve"$>
	<$endif$>

	<$hideReject = 	getValue("rsProfileData","hideReject")$>

	<$if not strEqualsIgnoreCase(hideReject,'true')$>

		<$rejectText = getValue("rsProfileData","rejectText")$>
		<$if not rejectText$>
			<$rejectText = "Reject"$>
		<$endif$>

	<$else$>
		<$suppressReject = 1$>
	<$endif$>

	<td colspan=2 align="left">

		<div class="sidepanel_button_holder">

			<input 	type=button
							name="approve_btn"
							value="<$#active.approveText$>"
							style="margin: 5px; <$if suppressApprove$>display: none;<$endif$>"
							onClick="wfAction('Approve');"
							<$if #active.numMissingFields > 0 or (not allowWorkflowActions) or (not enableWorkflowForm)$>disabled=true<$endif$>
							tabindex="<$tabIndex=50$><$tabIndex$>">

			<input 	type=button
							name="reject_btn"
							value="<$#active.rejectText$>"
							style="margin: 5px; <$if suppressReject$>display: none;<$endif$>"
							<$if (not allowWorkflowActions) or (not enableWorkflowForm)$>disabled=true<$endif$>
							onClick="wfAction('Reject');"
							tabindex="<$include iris_get_next_tabindex$>">

		</div>

	</td>

<@end@>

<@dynamichtml doc_approval_tabs@>

	<table width='522' cellpadding=0 cellspacing=0>
		<tr height='25'>
			<td width='172' align='center' class="tabOff" id='tab_image'>
				<a href="javascript:openTab('tab_image')"><span class="tab_text">
					Image
				</span></a>
			</td>

			<td width='172' align='center' class="tabOff" id='tab_notes'>

				<a href="javascript:openTab('tab_notes')"><span class="tab_text" id="tab_notes_caption">
					Notes/Activity (<$numNotes$>)
				</span></a>

			</td>

			<td width='172' align='center' class="tabOff" id='tab_docs'>

				<a href="javascript:openTab('tab_docs')"><span class="tab_text" id="tab_docs_caption">
					Associated Docs (<$numDocs$>)
				</span></a>

			</td>
		</tr>
	</table>
	
	<script type="text/javascript">
		// This piecee of script is used to highlight the 
		// currently-selected tab when the page loads.
		
		// Check the # of the current URL
		if (window.location.hash) {
			
			var curHash = window.location.hash;
			curHash = curHash.substring(1,curHash.length);
			
			var hashValues = curHash.split(",");
			
			var newTab = "";
			
			if (hashValues.length > 1) {
				// current tab will be held in the first portion of the
				// # string
				newTab = "tab" + hashValues[0];
				
				// selected dDocName will appear after the first comma
				// in the # string.
				var selDoc = hashValues[1];
			} else {
				newTab = "tab" + curHash;
			}
			
			if (newTab != "") {
				if (newTab == "tab_image" | newTab == "tab_docs" | newTab == "tab_notes")
					curTab = newTab;
			}
		}
		
		var tabElem = document.getElementById(curTab);
		tabElem.className = "tabOn";
		
	</script>

<@end@>

<@dynamichtml orangeContainer_top@>

	<table cellpadding=0 cellspacing=0 border=0 width='100%'>

		<tr height='7'>
			<td width='6' style="background: url(<$HttpWebRoot$>images/iris/orange-container-tlc.gif); width: 6px; height: 7px;">
			</td>
			<td style="background: url(<$HttpWebRoot$>images/iris/orange-container-ts.gif) repeat-x; height: 7px;">
			</td>
			<td width='6' style="background: url(<$HttpWebRoot$>images/iris/orange-container-trc.gif); width: 6px; height: 7px;">
			</td>
		</tr>

		<tr>

			<td style="background: url(<$HttpWebRoot$>images/iris/orange-container-ls.gif) repeat-y;">
			</td>

			<td>

<@end@>


<@dynamichtml orangeContainer_bottom@>

			</td>

			<td style="background: url(<$HttpWebRoot$>images/iris/orange-container-rs.gif) repeat-y;">
			</td>
		</tr>

		<tr height='7'>
			<td width='6' style="background: url(<$HttpWebRoot$>images/iris/orange-container-blc.gif); width: 6px; height: 7px;">
			</td>
			<td style="background: url(<$HttpWebRoot$>images/iris/orange-container-bs.gif) repeat-x; height: 7px;">
			</td>
			<td width='6' style="background: url(<$HttpWebRoot$>images/iris/orange-container-brc.gif); width: 6px; height: 7px;">
			</td>
		</tr>

	</table>

<@end@>

<@dynamichtml greyPanel_top@>

	<table cellpadding=0 cellspacing=0 border=0 width='100%' name="greyPanel" style="width: 100%">

		<tr height='11'>
			<td width='11' style="background: url(<$HttpWebRoot$>images/iris/greypanel-tlc.gif); width: 11px; height: 11px;">
			</td>
			<td bgcolor="#DDDADA" style="height: 11px;">
			</td>
			<td width='12' style="background: url(<$HttpWebRoot$>images/iris/greypanel-trc.gif); width: 12px; height: 11px;">
			</td>
		</tr>

		<tr>

			<td style="background: url(<$HttpWebRoot$>images/iris/greypanel-ls.gif) repeat-y; width: 11px;">
			</td>

			<td bgcolor="#DDDADA">

<@end@>

<@dynamichtml greyPanel_bottom@>

			</td>

			<td style="background: url(<$HttpWebRoot$>images/iris/greypanel-rs.gif) repeat-y; width: 12px;">
			</td>
		</tr>

		<tr height='5'>
			<td width='11' style="background: url(<$HttpWebRoot$>images/iris/greypanel-blc.gif); width: 11px; height: 5px;">
			</td>
			<td style="background: url(<$HttpWebRoot$>images/iris/greypanel-bs.gif) repeat-x; height: 5px;">
			</td>
			<td width='12' style="background: url(<$HttpWebRoot$>images/iris/greypanel-brc.gif); width: 12px; height: 5px;">
			</td>
		</tr>

	</table>

<@end@>


<@dynamichtml doc_approval_preview@>

	<table id="previewtable" width="100%" height="85%" cellpadding=0 cellspacing=0 valign=top>

		<tr>
			<td id="preview_region" name="colored_region" align="center" valign="top">

				<$if thumbnailMode$>
					<iframe bgcolor='white' style="margin-top: 5px" name='contextFrame' id="contextFrame" height="98%" width=98%" src="<$HttpCgiPath$>?IdcService=IRIS_DOC_THUMBS<$include add_idc_token_to_url$>&sel=<$sel$>">
					</iframe>
				<$else$>
					<iframe bgcolor='white' style="margin-top: 5px" name='contextFrame' id="contextFrame" height="98%" width=98%" src="" onload="setTimeout(highlightFirstField,300)">
					</iframe>
				<$endif$>

				<script type="text/javascript">
					// This piece of script is used to set the source URL of the above iframe
					// when the page is first loaded. This allows the URL to be changed to
					// show a certain tab, based on the # portion of the parent URL.
				
					var iframe = document.getElementById("contextFrame");
					var thumbSrc;
				
					if (curTab == 'tab_image') {							
						var thumbSrc = getContentUrl();
					} else if (curTab == 'tab_docs') {
						var thumbSrc = "<$HttpCgiPath$>?IdcService=IRIS_LINKED_DOCS<$include add_idc_token_to_url$>&dDocName=<$dDocName$><$if allowWorkflowActions$>&allowWorkflowActions=1<$endif$>";
					} else {
						var thumbSrc = "<$HttpCgiPath & '?IdcService=IRIS_LINKED_AUDIT_ENTRIES<$include add_idc_token_to_url$>&dDocName=' & dDocName$>&ts=" + new Date().getTime();
					}
					
					iframe.src = thumbSrc;	
			
				</script>

			</td>
		</tr>

	</table>
<@end@>

<!-- Displays the 3 most recent notes/activities, plus some useful links -->
<@dynamichtml doc_approval_recent_notes@>

	<table id="recentnotes_region" style="width: 100%; height: 15%;" border=0>

		<$auditRef = dDocName$>
		<$auditApp = "IRIS"$>
		<$executeService("ECS_GET_AUDIT_ENTRIES_BY_REF")$>

		<tr>
			<td valign="top">
	
			<!-- Link strings -->
			<$moreNotes = 'javascript:openTab("tab_notes")'$>
			<$getFileUrl = HttpCgiPath & "?IdcService=GET_FILE&dID=" & dID&inc("add_idc_token_to_url")$>
			<$newNoteLink = "?IdcService=IRIS_NEW_NOTE"&inc("add_idc_token_to_url")&"&dDocName=" & dDocName$>

			<div class="subheader">

				<span id="recentnotes_span">
					Recent notes/activity<$if numNotes gt 3$> (<a href='<$moreNotes$>'>more..</a>) <$endif$> |
				</span>

				<span style="font-size: 1em" id="recentnotes_links">
					<$if userCanWrite$>
						<a href="<$HttpCgiPath & newNoteLink$>" target="_blank" onclick='openPopup("<$newNoteLink$>&viaPopUp=1",470,170);return false;'>Add new note</a> |
					<$endif$>
						<a href='<$getFileUrl$>'>Download item</a>
				</span>

			</div>
				
		<!-- This div element acts like an iframe, containing a table of recent notes -->
		<div id="recentnotes" name='recentnotes' >
			<table width="99%" cellpadding=2 cellspacing=1>
				<$num = 0$>

				<$if not rsAuditEntries$>
					<tr><td>There are no recent notes/activities for this item.</td></tr>
				<$endif$>

				<$loop rsAuditEntries$>
					<$num = num+1$>

					<$auditText = "(Unknown action)"$>

					<tr style="background-color: #FFF0DB" cellspacing=2 cellpadding=3>
						<td width="23%" name="recentnotes_cell" id='recentnotes_cell' valign=top>
							<span><$lDate$></span>
						</td>

						<td width="60%" style="background-color: #FBE3C2" valign=top>
							<$include iris_compute_audit_text$>
							<$auditText$>
						</td>

						<td width="17%" valign=top>
							<$#active.lUser$>



						</td>
					</tr>

					<$if num ge 3$>
						<$break$>
					<$endif$>

				<$endloop$>

			</table>
		</div>
	</td></tr>
</table>

<@end@>

<!-- Computes a value for 'auditText', which displays the
		 current audit action as a user-friendly string.

		 Requires auditCode and auditParams to be present in
		 the binder. -->
<@dynamichtml iris_compute_audit_text@>

	<$if lAction like 'USER-NOTE'$>

		<$auditText = "<p class='iris_user_note'><b>User note:</b> " & lMessage & "</p>"$>

	<$elseif lAction like 'ADD-LINKED-DOC'$>
	
		<$itemDocName = lParam1$>
		<$itemTitle = lParam2$>
		
		<$linkedDocUrl = "<a href='" & HttpCgiPath & "?IdcService=DOC_APPROVAL&dDocName=" & itemDocName &inc("add_idc_token_to_url")& "' target='_blank'>"$>
		
		<$auditText = "Document '" & linkedDocUrl & #local.itemTitle & "</a>' associated with item"$>

	<$elseif lAction like 'DEL-LINKED-DOC'$>
		<$itemDocName = lParam1$>
		<$itemTitle = lParam2$>
		
		<$auditText = "Document '" & #local.itemTitle & "' removed from item"$>
		
	<$elseif lAction like 'ASSIGN'$>
		<$isWFAction=1$>
		<$thisAssignee = lParam1$>

		<$auditText = "Assigned to "$>

		<$if strIndexOf(thisAssignee,"a:") == 0$>
			<$assignee = strSubstring(thisAssignee,2)$>
			<$auditText = auditText & "group " & assignee$>
		<$else$>
			<$assignee = getValueForSpecifiedUser(thisAssignee,"dFullName")$>
			<$auditText = auditText & assignee$>
		<$endif$>

	<$elseif lAction like 'APPROVE'$>
		<$isWFAction=1$>
		<$thisWfStep = lParam2$>
		
		<$auditText = "Document approved: " & thisWfStep$>
	
	<$elseif lAction like 'REJECT'$>
		<$isWFAction=1$>
		<$thisWfStep = lParam2$>
	
		<$auditText = "Document rejected: " & thisWfStep$>

	<$elseif lAction like 'FIELD-UPDATE'$>
		<$fieldName = lParam1$>
		<$newValue = lParam2$>

		<$if not newValue$>
			<$auditText = fieldName & " removed"$>
		<$else$>
			<$auditText = fieldName & " set to " & newValue$>
		<$endif$>

	<$elseif lAction like 'ADD-DOC'$>
		<$if not lParam1$>
			<$auditText = "Document added"$>
		<$else$>
			<$itemDocName = lParam1$>
			<$itemTitle = lParam2$>
		
			<$docNameQuoted = '"' & itemDocName & '"'$>
			<$jsUrl = "<a href='javascript:displayBundleDoc(" & docNameQuoted & ");'>"$>
		
			<$auditText = "Document '" & jsUrl & #local.itemTitle & "</a>' added to bundle"$>
		<$endif$>

	<$elseif lAction like 'DEL-DOC'$>
		<$itemDocName = lParam1$>
		<$itemDocTitle = lParam2$>

		<$auditText = "Document '" & lParam2 & "' (" & itemDocName & ") removed from bundle"$>

	<$elseif lAction like 'COMPLETE'$>
		<$isWFAction=1$>
		<$auditText = "Marked as completed"$>
	<$endif$>
	
	<$c="Use this include hook to display other audit actions."$>
	<$include iris_compute_audit_text_extra$>

	<$if isWFAction and #active.LMESSAGE and not (#active.LACTION like 'USER-NOTE')$>
		<$if lAction like 'REJECT'$>
			<$noteClass = 'iris_reject_note'$>
		<$elseif lAction like 'APPROVE'$>
			<$noteClass = 'iris_approve_note'$>
		<$else$>
			<$noteClass = 'iris_user_note'$>
		<$endif$>
		
		<$auditText = auditText & "<br/><p class='" & noteClass & "'><b>User note:</b> " & #active.LMESSAGE & "</p>"$>
	<$endif$>

	<$isWFAction=''$>

<@end@>

<!-- 	Displays the Action metafield with appropriate formatting
			depending on its value -->
<@dynamichtml display_action_field@>

	<$if action$>
		<$if action like "Approve"$>
			<$actionStyle = "font-size: 1em; font-weight: bold; color: Green;"$>
		<$elseif action like "Reject"$>
			<$actionStyle = "font-size: 1em; font-weight: bold; color: Red;"$>
		<$endif$>

		<span style="<$actionStyle$>"><$action$></span>

	<$else$>
		-
	<$endif$>

<@end@>

<!-- ------------------
Custom include, replacing the default used for displaying entries
in the FILE column of SearchAndFilter. This one displays the
document title (i.e. dDocTitle), with a direct link to the associated
content item
----------------------- -->
<@dynamichtml FILE_CustomIncludeScript@>

	<$itemDeleted=''$>

	<div style="float: left; margin: 2px">
		<img src = '<$HttpImagesRoot & "/docgifs/" & dGif$>'>
	</div>

	<div style="float: left; margin: 2px">
		<$if delDocNames$>
			<$if strIndexOf(delDocNames,dDocName) > -1$>
				<$itemDeleted=1$>
			<$endif$>
		<$endif$>	

		<$if itemDeleted$>
			[DELETED] <$dDocTitle$>
			<br>
			<$(WebFileSize / 1000)$>kb
		<$else$>
		
			<$fileUrl = HttpCgiPath & "?IdcService=GET_FILE&dID=" & dID&inc("add_idc_token_to_url")$>
			<a href="<$URL$>" target="_blank"><$dDocTitle$></a>
			<br>
			<$(WebFileSize / 1000)$>kb
			
		<$endif$>	
		
	</div>

<@end@>

<@dynamichtml ACTION_CustomIncludeScript@>
	<$action = eval('<$' & auditActionField & '$>')$>
	<$include display_action_field$>

<@end@>

<@dynamichtml LONGDATE_CustomIncludeScript@>

	<$dInDate$>

<@end@>

<@dynamichtml TOTALAMOUNT_CustomIncludeScript@>

	<$fieldValue = #active.xTotalAmount$>
	<$result = setValue("#local", "fieldName", "xTotalAmount")$>

	<$trace("fieldValue was " & fieldValue & ", fieldName was " & fieldName & ", valueset? " & result)$>

	<$if #active.fieldValue$>
		<$include shift_decimal$>
		<$fieldValue$>
	<$endif$>

<@end@>

<!-- 	Displays the document author, with a link to
			their email address -->
<@dynamichtml AUTHOR_CustomIncludeScript@>

	<$authorName = getValueForSpecifiedUser(dDocAuthor,'dFullName')$>
	<$if not authorName$>
		<$authorName = dDocAuthor$>
	<$endif$>
	<$addr = getValueForSpecifiedUser(dDocAuthor,'dEmail')$>

	<$trace("addr = " & addr & ".")$>

	<$if strIndexOf(addr, '@') gt -1$>
		<a href="mailto:<$addr$>"><$authorName$></a>
	<$else$>
		<$authorName$>
	<$endif$>

<@end@>

<!-- Popup action menu used for each row in the Linked Notes view -->
<@dynamichtml NOTEACTIONS_CustomIncludeScript@>

	<$actionMenu_CustomInclude = "NOTEACTIONS_menu"$>
	<$menu_style_prefix="iris"$>
	<center><$include action_menu$></center>

<@end@>

<@dynamichtml NOTEACTIONS_menu@>

	<tr>
  	<td class="<$menu_style_prefix$>PopupLink" nowrap onClick="execGroupAction('open')" onMouseOver="glowPopupRow(this,'<$menu_style_prefix$>PopupLink_over','<$menu_style_prefix$>PopupLink')"	onMouseOut="fadePopupRow(this,'<$menu_style_prefix$>PopupLink')">
  		<a href="javascript:delNote(<$dID$>);">Delete</a>
		</td>
	</tr>

<@end@>

<!-- Popup action menu used for each row in the Linked Notes view -->
<@dynamichtml DOCACTIONS_CustomIncludeScript@>
	
	<$if not itemDeleted$>
		<$actionMenu_CustomInclude = "DOCACTIONS_menu"$>
		<$menu_style_prefix="iris"$>
		<center><$include action_menu$></center>
	<$endif$>

<@end@>

<@dynamichtml DOCACTIONS_menu@>

	<$if userCanDelete$>
		<tr>
	  	<td class="<$menu_style_prefix$>PopupLink" nowrap onMouseOver="glowPopupRow(this,'<$menu_style_prefix$>PopupLink_over','<$menu_style_prefix$>PopupLink')"	onMouseOut="fadePopupRow(this,'<$menu_style_prefix$>PopupLink')">
	  		<a href='javascript:delDoc("<$dDocName$>","<$dDocTitle$>");'>Delete</a>
			</td>
		</tr>
	<$endif$>

	<tr>
  	<td class="<$menu_style_prefix$>PopupLink" nowrap onClick="execGroupAction('open')" onMouseOver="glowPopupRow(this,'<$menu_style_prefix$>PopupLink_over','<$menu_style_prefix$>PopupLink')"	onMouseOut="fadePopupRow(this,'<$menu_style_prefix$>PopupLink')">
  		<$fileUrl = HttpCgiPath & "?IdcService=GET_FILE&dID=" & dID&inc("add_idc_token_to_url")$>
  		<a href="<$fileUrl$>">Download</a>
		</td>
	</tr>

<@end@>

<!-- 	Display the item's dDocName field, with a link to the item's Document Approval screen
			and a 'danger' graphic if this item has been flagged as High priority.
			-->
<@dynamichtml REF_CustomIncludeScript@>

	<a onClick="openDoc('<$dDocName$>',event)"><$dDocName$></a>

	<$if false$>
		<$if strEquals(xPriority,"High")$>
			&nbsp;<img src="<$HttpWebRoot$>images/stellent/AlertIcon.gif" alt="High Priority">
		<$endif$>
	<$endif$>

<@end@>

<!-- Checkbox column used for selecting multiple records -->
<@dynamichtml CHECKBOX_CustomIncludeScript@>

	<input type="checkbox" name="selCheckBox" id="<$dDocName$>" onclick="clickCheck(this)">

<@end@>

<!-- Displays document status -->
<@dynamichtml IRIS_STATUS_CustomIncludeScript@>

	<$if xStatus like 'Completed'$>
		<span style="color: #A9A9A9; font-size: 1em;">Completed</span>
	<$else$>
		<$xStatus$>
	<$endif$>

<@end@>

<!-- 	Custom search script used by the linked item S&F customizations.
			This includes the default search script, followed by a merge-
			delete operation on the search results to remove all deleted
			records.
-->
<@dynamichtml performLinkedItemSearch@>

	<$include performSearch$>

	<$docType = linkedDocType$>
	<$parentId = dDocName$>

	<$trace("Using parentId=" & parentId)$>

	<$if false$>
		TM: Disabled this for now. 
		
		<$executeService("IRIS_GET_LINKED_ITEMS_DELETED")$>
	
		<$if LinkedSearchResults$>
			<$loop LinkedSearchResults$>
				<$trace("found a deleted item")$>
			<$endloop$>
		<$endif$>
	
		<$rsMergeDelete("SearchResults", "LinkedSearchResults", "dID")$>
	<$endif$>
	
<@end@>

<!-- Contains a HTML form used for expiring linked documents. The
		 delDoc() javascript function is used to submit the form -->
<@dynamichtml linkeddoc_delete_form@>

	<form action="<$HttpCgiPath$>" method="POST" name="deldoc">
		<input type=hidden name=IdcService value="IRIS_EXPIRE_DOC" />
		<input type=hidden name=dDocName />
		<$include add_idc_token_to_form$>
		<input type=hidden name=RedirectUrl value="<$HttpCgiPath & '?IdcService=IRIS_LINKED_DOCS&dDocName=' & dDocName$><$include add_idc_token_to_url$>">
	
		<input type=hidden name="doAudit" value="1" />
		<input type=hidden name="lApp" value="IRIS" />	
		<input type=hidden name="lAction" value="DEL-LINKED-DOC" />
		<input type=hidden name="lRef" value="<$dDocName$>" />
		<$loop DOC_INFO$>
			<input type=hidden name="lTitle" value="<$dDocTitle$>" />
		<$endloop$>
		<input type=hidden name="lUser" value="<$dUser$>" />
		
		<input type=hidden name="lMessage" />
		
		<!-- Audit parameters are: (must be added via js):
				1. dDocName of expired item 
				2. title of expired item 
				-->
		<input type=hidden name="lParam1" value="" />
		<input type=hidden name="lParam2" value="" />

		
		
	</form>

<@end@>

<!-- Contains a HTML form used for deleting linked notes. The
		 delNotes() javascript function is used to submit the form.
		 
		 Needs updating to deal with new table-based audit notes.
		  -->
<@dynamichtml linkednote_delete_form@>

	<form action="<$HttpCgiPath$>" method="POST" name="delnote">
		<input type=hidden name=IdcService value="DELETE_DOC"><$include add_idc_token_to_form$>
		<input type=hidden name=dID>
		<input type=hidden name=RedirectUrl value="<$HttpCgiPath & '?IdcService=IRIS_LINKED_AUDIT_ENTRIES&dDocName=' & dDocName$><$include add_idc_token_to_url$>">
	</form>

<@end@>

<!--  Used to inform the user of how many documents are still being processed
			(i.e. not available through standard searches) -->
<@dynamichtml iris_display_doc_processing_count@>
	<$docType = "LinkedDoc"$>
	<$docName = dDocName$>

	<$executeService("IRIS_GET_LINKED_WIP_ITEMS")$>

	<$if NewItems$>
		<div class="iris_user_note" style="margin: 5px">
			<$getValue("NewItems","#numRows")$> item(s) in process queue:
			
			<ul style="list-style-type:square; margin: 5px 0px 15px 0px; padding-left:30px;" >
				<$loop NewItems$>
					<li><$NewItems.dDocTitle$></li>
				<$endloop$>
			</ul>
			
			<a href="javascript:window.location.reload(true)">Click here</a> to refresh the list.
		</div>
	<$endif$>

<@end@>

<!-- Standard new item checkin panel. -->
<@dynamichtml iris_new_item_panel@>

	<$include orangeContainer_top$>

	<div class='panelheader' style="padding: 3px; border-bottom: 1px solid; margin-right: 3px">
		<b>Add new item<b>
	</div>

	<div>

	<br/>

	<$if not dSecurityGroup$>
		<$dSecurityGroup = "Public"$>
	<$endif$>

	<$if not (userCanWrite)$>
	<!--if not (userHasGroupPrivilege(dSecurityGroup,"W") or userHasGroupPrivilege(dSecurityGroup,"D") or userHasGroupPrivilege(dSecurityGroup,"A"))-->
		<!-- 	Ensure user has read access on Public security group
					before displaying 'new item' form -->

		Sorry, you do not have sufficient access rights to add new documents.
		<br/>
		<br/>

	<$else$>

		<table width="100%" cellpadding=0 cellspacing=2>
			<!-- Form used for content item checkin -->
			<form name="newdocform" enctype="multipart/form-data" action="<$HttpCgiPath$>" method="POST">
				
				<$if Iris_customCheckinFormHeader$>
					<$inc(Iris_customCheckinFormHeader)$>
				<$else$>
						
					<input type=hidden name="IdcService" value="CHECKIN_NEW"><$include add_idc_token_to_form$>
					<input type=hidden name="dDocAuthor" value="<$UserName$>">
					<input type=hidden name="dSecurityGroup" value="Public">

					<input type=hidden name="RedirectUrl" value="<$HttpCgiPath & "?IdcService=DOC_LISTING"$><$include add_idc_token_to_url$>">
				
				<$endif$>

				<$c="audit fields used to record new checkin"$>
				<input type=hidden name="doAudit" value="1">
				
				<input type=hidden name="lApp" value="IRIS" />
				<input type=hidden name="lAction" value="ADD-DOC" />
				<input type=hidden name="lRef" value="" /> <!-- Bundle dDocName, added via js -->
				<input type=hidden name="lTitle" value="" /> <!-- Bundle ref, added via js -->
				<input type=hidden name="lUser" value="<$dUser$>" />
				
				<!-- Audit parameters are: (must be added after checkin via Java):
						1. dDocName of new item 
						2. title of new item 
						-->
				<input type=hidden name="lParam1" value="" />
				<input type=hidden name="lParam2" value="" />

				<$include iris_doctype_list$>


			<$allowsFileUpload="1"$>
			<$isEditMode="1"$>

			<tr>
				<td><span class=infoLabel>File:</span></td>
				<td><input name="primaryFile" size="30" maxlength="250" type="file" onChange="addFileName(this.form)"></td>
			</tr>

			<tr><td><br></td></tr>

			<$include iris_checkin_metadata$>

			<tr><td><br></td></tr>

			<tr>
				<td colspan=2 align=center>
					<input type=button value=Submit onClick="addNewItem(this.form)">
				</td>
			</tr>

			</form>
		</table>

		<$endif$>

	</div>

	<$include orangeContainer_bottom$>
		
<@end@>

<!-- ------------------
Custom header for the SearchAndFilter component. Used to display a
form allowing submission of associated documents. The div containing
all form elements is invisible by default - a link in the header
must be clicked to display the form.
----------------------- -->
<@dynamichtml iris_add_linked_doc_header@>

	<div style='width: 400px'>
		<!-- Title for the user profile: displays the dDocName for this item -->

		<$include greyPanel_top$>

		<div class='panelheader' style="padding: 3px">

			<table width="100%" cellpadding=0 cellspacing=0>
				<tr height=20>
					<td>
						<span class='panelheading'>Add new document</span>
					</td>
					<td width=22>
						<div onclick="togglePanel(this)" id="toggle_newdoc_panel" class="toggle_img_collapse"></div>
					</td>
				</tr>

			</table>
		</div>

		<div class='panelbody' id="newdoc_panel" style="display: block; width: 99%">

			<br>

			<table width="100%" cellpadding=0 cellspacing=2>
				<$allowsFileUpload="1"$>
				<$isEditMode="1"$>

				<form name="newdocform" enctype="multipart/form-data" action="<$HttpCgiPath$>" method="POST">
					<input type=hidden name="IdcService" value="IRIS_CHECKIN_LINKED_ITEM"><$include add_idc_token_to_form$>
					<input type=hidden name="dDocAuthor" value="<$UserName$>">
					<input type=hidden name="xParentId" value="<$dDocName$>">
					<input type=hidden name="dSecurityGroup" value="Public">
					<input type=hidden name="dDocType" value="LinkedDoc">
					<input type=hidden name="dDocAccount" value="<$#active.dDocAccount$>">

					<input type=hidden name="RedirectUrl" value="<$HttpCgiPath & "?IdcService=IRIS_LINKED_DOCS" & "&dDocName=" & dDocName$>"<$include add_idc_token_to_url$>>
					
					<$c="audit fields used to record new checkin"$>
					<input type=hidden name="doAudit" value="1">
					
					<input type=hidden name="lApp" value="IRIS" />
					<input type=hidden name="lAction" value="ADD-LINKED-DOC" />
					<input type=hidden name="lRef" value="<$dDocName$>" />
					<$executeService("DOC_INFO_LATESTRELEASE")$>
					<$loop DOC_INFO$>
						<input type=hidden name="lTitle" value="<$dDocTitle$>" />
					<$endloop$>
					
					<input type=hidden name="lUser" value="<$dUser$>" />
					
					<!-- Audit parameters are: (must be added after checkin via Java):
							1. dDocName of new item 
							2. title of new item 
							-->
					<input type=hidden name="lParam1" value="" />
					<input type=hidden name="lParam2" value="" />

				<tr>
					<td><span class=infoLabel>File:</span></td>
					<td><input name="primaryFile" size="30" maxlength="250" type="file" onChange="addFileName(this.form)"></td>
				</tr>

				<tr>
					<td><span class=infoLabel>Title:</span></td>
					<td><input type=text name=dDocTitle style="width: 100%"></td>
				</tr>

				<tr><td><br></td></tr>

				<tr>
					<td colspan=2 align=right>
						<input type=button value=Submit onClick="addNewItem(this.form)">
					</td>
				</tr>

				</form>
			</table>

		</div>

		<$include greyPanel_bottom$>

	</div>

	<br>

	<$include iris_display_doc_processing_count$>

<@end@>

<@dynamichtml iris_checkin_js@>

	<script type="text/javascript">

	// Called before submitting the Add new item form
	function addNewItem(form)
	{
		fileVal = form.primaryFile.value;
		titleVal = form.dDocTitle.value;

		accountVal = form.dDocAccount.value;

		if (fileVal == '') {
			alert("Please select a file for this item.");
			return false;
		} else if (titleVal == '') {
			alert("Please enter a title for this item.");
			return false;
		} else if (accountVal == '') {

			<$if #active.requireAccount$>
				alert("You must specify an account for this item.");
				return false;
			<$endif$>
		}

		form.submit();
	}

	<$include add_filename_script$>

</script>

<@end@>

<!--	-------------------------
Contains all javascript functions used in the Doc_SearchAndFilter page
------------------------------- -->
<@dynamichtml iris_linked_docs_js@>

<script type="text/javascript">

	var showNewDoc = false;

	// Show or hide the div containing the new document form
	function toggleNewDoc(img)
	{
		panel = document.getElementById('docbox');

		if (showNewDoc == true) {

			showNewDoc = false;
			img.src = '<$HttpWebRoot$>images/stellent/tree_top_only_collection_closed.gif'
			panel.style.display = 'none';

		} else {

			showNewDoc = true;
			img.src = '<$HttpWebRoot$>images/stellent/tree_top_only_collection_open.gif'
			panel.style.display = 'block';
		}
	}

	// Called after clicking the Submit Document button. This function
	// checks for presence of data in the two input fields.
	function addNewItem(form)
	{

		fileText = form.primaryFile.value;
		titleText = form.dDocTitle.value;

		if (fileText == '') {
			alert('You must specify the file you wish to submit. Click the Browse button to select one.');
		}
		else {

			submitform=true;

			if (titleText == '')
			{
				submitform=false;
				alert('You must specify a title for your document.');
			}

			if (submitform == true) {
				try {
					// Call back the parent window to update the displayed total no. of docs
					window.parent.adjustNumDocs(1);
				} catch (err) {}

				// Submit the form.
				form.submit();
			}
		}
	}

	<$include add_filename_script$>

	// Used for expiring linked document entries
	function delDoc(docName,docTitle)
	{
		var conf = confirm("Are you sure you wish to delete the linked document '" + docTitle + "'?");
		if (!conf)
			return;
		
		var delForm = document.forms['deldoc'];
		delForm.elements['dDocName'].value = docName;
		
		// complete audit params
		delForm.elements['lParam1'].value = docName;
		delForm.elements['lParam2'].value = docTitle;
		delForm.elements['lMessage'].value = "Document '" + docTitle + "' deleted";
		
		try {
			window.parent.adjustNumDocs(-1);
		} catch (err) {}

		delForm.submit();
	}


</script>

<@end@>


<!-- 	A single function, designed for used on new checkin forms. Requires two
			fields to be present on the supplied form: primaryFile and dDocTitle.
			This include must be placed within <script> tags to function. The
			function 'addFileName(this)' should be placed in the onChange() event
			of the primaryFile field. -->
<@dynamichtml add_filename_script@>

	// Called after a change event to the file input field. This automatically
	// changes the title field to match the chosen file name.
	function addFileName(form)
	{
		fileText = form.primaryFile;
		titleText = form.dDocTitle;

		fileName = fileText.value;

		fileNameStart = fileName.lastIndexOf('/');

		if (fileNameStart == -1) {
			fileNameStart = fileName.lastIndexOf('\\');
		}
		
		if (fileNameStart != -1) {

			clippedName = fileName.substr(fileNameStart+1,fileName.length);
			titleText.value = clippedName;
		} else {
			if (fileName)
				titleText.value = fileName;	
		}

		titleText.focus();
		titleText.select();
	}

<@end@>

<!-- -------------
Used to display controls below the Search And Filter include on the
main document listing template.
------------------ -->
<@dynamichtml doc_listing_footer@>

<div class="listingfooter">

	<table width='100%'>
		<tr>
			<td width='30%'>
				<$include group_action_controls$>
			</td>
			<td width='40%'>
				<$include sf_paging$>
			</td>
			<td width='30%'>
				&nbsp;
			</td>
		</tr>
	</table>

</div>

<@end@>

<!-- Used to display the controls required to perform operations on
		 a selected group of content items -->
<@dynamichtml group_action_controls@>

	<$if not control_num$>
		<$control_num = 0$>
	<$endif$>

	<div style="margin-top: 5px">

	<input type="button" class="searchbtn_small" value="Sel. all" onClick="checkAll()">
	<input type=button class="searchbtn_small" value="Clear sel." onClick="clearChecks()">

	<$menu_id="action_menu_" & control_num$>
	<$menu_button_text="Open selected &gt;&gt;"$>
	<$menu_use_html_button="Y"$>
	<$menu_button_attr=" class='searchbtn' "$>
	<$menu_style_prefix="top"$>

	<$actionMenu_CustomInclude="group_actions_menu"$>

	<$include action_open$>

	<$if false$>
		<input type=button class="searchbtn" id="action_button_<$control_num$>" value="Open selected >>" disabled=true onclick="toggleActionList(this)">
		<$include doc_listing_action_list$>
		<$control_num = control_num + 1$>
	<$endif$>

	<$control_num = control_num + 1$>

	</div>

<@end@>

<!-- This include hook is designed for use with the SF_CustomPaginator
		 variable used in the SearchAndFilter component.
		 
		 Allows S&F pagination using the ECS_Paginator_Iris component. -->
<@dynamichtml iris_sf_paginator@> 

	 <!-- The ECS_Paginator component must be installed to correctly use this include -->
	<$if TotalRows > 0 and ssLastPage > 1$>

		<$pn_width=250$>
		<$pn_size = 5$>
		<$pn_total = ssLastPage$>
		
		<$pn_current = ssThisPage$>
		
		<$if not #active.pn_link_prefix$>
			<$pn_link_prefix=locURL & "&amp;SR="$>
		<$endif$>
	
		<$counter = 2$>
		<$str = '1,'$>
	
		<$loopwhile counter <= ssLastPage$>
			
			<$str = str & (((counter-1) * ResultCount)+1) & ','$>
			<$counter = counter + 1$>
		
		<$endloop$>
		
		<$rsMakeFromString("pn_rs",str,"ID")$>
	
		<$pn_rs = "pn_rs"$>
		<$pn_rs_row = "ID"$>
		
		<$pn_use_rs = 1$>
	
		<$include iris_paginator_compute_window$>
		<$include iris_paginator_display_window$>
		
	<$endif$>

<@end@>

<!-- 	Used to display the action menu for each item on the
			Document Listing template -->
<@dynamichtml DocActions_CustomIncludeScript@>

	<$menu_style_prefix="top"$>
	<$actionMenu_CustomInclude="doc_actions_menu"$>

	<$include action_menu$>

<@end@>

<@dynamichtml doc_actions_menu@>

	<tr>
  	<td class="<$menu_style_prefix$>PopupLink" nowrap onMouseOver="glowPopupRow(this,'<$menu_style_prefix$>PopupLink_over','<$menu_style_prefix$>PopupLink')"	onMouseOut="fadePopupRow(this,'<$menu_style_prefix$>PopupLink')">
  		<a href="<$HttpCgiPath & '?IdcService=DOC_INFO<$include add_idc_token_to_url$>&dID=' & dID$>">Standard info</a>
		</td>
	</tr>

<@end@>

<@dynamichtml action_open@>
	<input type=button id="actIcon_action_menu_<$control_num$>" class="searchbtn_small" style="margin-left: 10px" value="Open sel." onClick="execGroupAction('open')">
<@end@>

<@dynamichtml group_actions_menu@>

	<tr>
  	<td class="<$menu_style_prefix$>PopupLink" nowrap onClick="execGroupAction('open')" onMouseOver="glowPopupRow(this,'<$menu_style_prefix$>PopupLink_over','<$menu_style_prefix$>PopupLink')"	onMouseOut="fadePopupRow(this,'<$menu_style_prefix$>PopupLink')">
  		<a href="javascript:execGroupAction('open')">Open</a>
		</td>
	</tr>

	<!-- Mark as expired function, disabled -->
	<!--
	<tr>
  	<td class="<$menu_style_prefix$>PopupLink" nowrap onClick="execGroupAction('open')" onMouseOver="glowPopupRow(this,'<$menu_style_prefix$>PopupLink_over','<$menu_style_prefix$>PopupLink')"	onMouseOut="fadePopupRow(this,'<$menu_style_prefix$>PopupLink')">
  		<a href="javascript:execGroupAction('open')">Mark as expired</a>
		</td>
	</tr>
	-->


<@end@>

<!-- Contains all javascript functions required to perform
		 group operations on documents. -->
<@dynamichtml group_actions_js@>

<script>

	function execGroupAction(act)
	{
		if (act=='open') {
			openSelected();
		}
	}

	// Captures all selected records and places their IDs
	// on the URL. The DOC_APPROVAL service is then called
	function openSelected() {

		var selected=getSelectedRows();

		if (selected != '') {

				selform = document.forms['group_actions_form'];
				selform.elements['selected'].value = selected;
				//selform.elements['action'].value = 'view';

				selform.submit();
		}
	}

	function getSelectedRows() {
		// get array of checkboxes
		boxes = document.getElementsByName("selCheckBox");

		var selected='';

		for (i=0; i<boxes.length; i++)
		{
			if (boxes[i].checked) {
				// Collect id's for all ticked checkboxes
				selected = selected + boxes[i].id + ','
			}
		}

		if (selected != '') {
			selected = selected.substr(0,selected.length-1);
		}

		return selected;
	}

	function getNumSelectedRows() {
		boxes = document.getElementsByName("selCheckBox");

		num = 0;

		for (i=0; i<boxes.length; i++)
		{
			if (boxes[i].checked) {
				num = num + 1;
			}
		}

		return num;
	}

</script>

<@end@>

<@dynamichtml doc_listing_js@>
	<script type="text/javascript">

		// Opens a single document in the approval template
		function openDoc(dDocName,event) {

			window.location.assign('<$HttpCgiPath & "?IdcService=DOC_APPROVAL<$include add_idc_token_to_url$>&dDocName="$>' + dDocName);
			event.cancelBubble=true;
		}

		// Show/hide documents with 'Released' status
		function toggleShowCompleted(chk)
		{
			if (chk.checked) {
				window.location.replace('<$HttpCgiPath & "?IdcService=DOC_LISTING<$include add_idc_token_to_url$>&showCompleted=true"$>')
			} else {
				window.location.replace('<$HttpCgiPath & "?IdcService=DOC_LISTING<$include add_idc_token_to_url$>"$>')
			}

		}

		// Invoked through clicking on a result row
		function toggleRow(row)
		{
			chkbox = getCheckBoxFromRow(row);

			if (chkbox.checked) {
				chkbox.checked = false;
				row.className = "resultrow_hilite";
			} else {
				chkbox.checked = true;
				row.className = "resultrow_sel";
			}

			checkActionButton();
		}

		// Finds the number of selected rows. If there is
		// 1 or more, enable the action buttons, otherwise
		// disable them
		function checkActionButton()
		{
			actionBtnTop = document.getElementById('actIcon_action_menu_0');
			actionBtnBtm = document.getElementById('actIcon_action_menu_1');

			if (getNumSelectedRows() > 0) {
				actionBtnTop.disabled = false;
				actionBtnBtm.disabled = false;
			} else {
				actionBtnTop.disabled = true;
				actionBtnBtm.disabled = true;
			}

		}

		function getCheckBoxFromRow(row)
		{
			suffixBegin = row.id.indexOf('_row');
			rowid = row.id.substr(0,suffixBegin);

			chkbox = document.getElementById(rowid);

			return chkbox;
		}

		// Invoked through mouseover event on a result row
		function setRowHighlight(row)
		{
			chkbox = getCheckBoxFromRow(row);

			if (!chkbox.checked) {
				row.className = "resultrow_hilite";
			}
		}

		// Invoked through mouseout event on a result row
		function remRowHighlight(row)
		{
			chkbox = getCheckBoxFromRow(row);

			if (!chkbox.checked) {
				row.className = "resultrow";
			}
		}

		// Clicking on a checkbox
		function clickCheck(chkbox) {
			//chkbox.checked = !chkbox.checked;
			row = document.getElementById(chkbox.id + "_row");
			toggleRow(row);
		}

		// Clear all selected rows
		function clearChecks() {
			inputs = document.getElementsByTagName('input');

			for (i=0; i<inputs.length; i++) {
				if (inputs[i].type == 'checkbox') {
					if (inputs[i].checked & inputs[i].id != '') {

						inputs[i].checked = false;

						try {

							row = document.getElementById(inputs[i].id + "_row");
							row.className = "resultRow";

						} catch (err) {} // catch block req. to catch dodgy input elements
					}
				}
			}

			checkActionButton()
		}

		// checks all checkboxes for search results
		function checkAll() {
			var inputs = document.getElementsByTagName('input');

			for (var k=0; k<inputs.length; k++) {

				try {

					if (typeof(inputs[k]) != undefined) {
						if (inputs[k].type == 'checkbox' && inputs[k].id != '' && !inputs[k].checked) {
							row = document.getElementById(inputs[k].id + "_row");
							toggleRow(row);
						}
					}
				} catch (err) {} // catch block req. to catch dodgy input elements
			}
		}


	</script>

<@end@>


<@dynamichtml notes_searchandfilter_js@>
	<script type="text/javascript">

		// Used for deleting search result entries
		function delNote(docID)
		{
			var delForm = document.forms['delnote'];
			delForm.elements['dID'].value = docID;

			try {
				window.parent.adjustNumNotes(-1);
			} catch (err) {}

			delForm.submit();
		}

	</script>

<@end@>


<@dynamichtml doc_listing_styles@>

		<style type="text/css">

			/* Row styles for search results */
			tr.resultrow {
				background-color: #FFF0DB; /* #DCDCDC; */
				cursor: pointer;
			}

			tr.resultrow_hilite {
				background-color: #FFCC79;
				color: #FFFFFF;
				cursor: pointer;
			}

			tr.resultrow_sel {
				background-color: #FF9933;
				color: #FFFFFF;
				cursor: pointer;
			}

			/* Row style for linked items */
			tr.resultrow_linked {
				background-color: #DCDCDC;
			}

			/* Row styles for action menu */
			tr.actionrow {
				background-color: #DCDCDC;
				color: #FFFFFF;
				cursor: pointer;
			}

			tr.actionrow_hilite {
				background-color: #FFFFFF;
				color: #000000;
				cursor: pointer;
				border: thin solid;
			}

			/* Div containing action menu */
			div.actionlist {
				vertical-align: top;
				position: absolute;
				display: inline;
				z-index: 99;
				border: thin solid;
				border-color: #000000;
				background-color: #DCDCDC;
				color: #FFFFFF;
				width: 10em;
			}

			div.invis {
				display: none;
			}

			input.searchbtn {
				width: 10em;
				margin-bottom: 5px;
			}


			input.searchbtn_small {
				width: 6em;
				margin-bottom: 5px;
			}

			div.listingfooter {
				width: 100%
			}

			img.sfSortImage {
				border: none;
			}

		</style>

<@end@>

<!-- Sets the sort images used for S&F column headers -->
<@dynamichtml iris_sf_sort_images@>

	<$customSortImage_up=""$>
	<$customSortImage_down=""$>	
	<$customSortImage_off=""$>

<@end@>

<@dynamichtml iris_menubar@>

	<script type="text/javascript">

		function glowMenuItem(entry) {
			entry.className="glowMenuItem"
		}

		function fadeMenuItem(entry) {
			entry.className="menuItem"
		}

	</script>


	<$menu_events = "class='menuItem' onmouseover='glowMenuItem(this)' onmouseout='fadeMenuItem(this)' "$>

	<div class="menuBar">

		<$homeLink = HttpCgiPath & "?IdcService=GET_DOC_PAGE&Action=GetTemplatePage&Page=IRIS_HOME_PAGE"&inc("add_idc_token_to_url")$>
		<$docListingLink = HttpCgiPath & "?IdcService=DOC_LISTING"&inc("add_idc_token_to_url")$>
		<$userProfileLink = HttpCgiPath & "?IdcService=IRIS_USER_PROFILE"&inc("add_idc_token_to_url")$>
		<$addNewItemLink = HttpCgiPath & "?IdcService=IRIS_NEW_ITEM"&inc("add_idc_token_to_url")$>
		<$stellentHomeLink = HttpCgiPath & "?IdcService=GET_DOC_PAGE&Action=GetTemplatePage&Page=HOME_PAGE&Auth=Internet"&inc("add_idc_token_to_url")$>
		<$irisProfilesLink = HttpCgiPath & "?IdcService=IRIS_PROFILE_LISTING"&inc("add_idc_token_to_url")$>
		<$adminServerLink  = CgiFileName & "/cs-admin/pxs?IdcService=GET_ROOT_IDC_ADMIN_PAGE"&inc("add_idc_token_to_url")$>

		<ul class="menuItems">

		<$if IsLoggedIn$>
			<li <$menu_events$>>
				<a class="menuLink" href="<$homeLink$>">Home</a>
			</li>

			<li <$menu_events$>>
				<a class="menuLink" href="<$docListingLink$>"><$include iris_doc_listing_title$></a>
			</li>

			<li <$menu_events$>>
				<a class="menuLink" href="<$userProfileLink$>">User Profile</a>
			</li>

		<$else$>
			<li <$menu_events$>>
				<a class="menuLink" href="<$homeLink$>">Home</a>
			</li>
		<$endif$>

			<$if not dSecurityGroup$>
				<$dSecurityGroup = "Public"$>
			<$endif$>

			<$if userCanWrite$>
				<!-- 	Ensure user has read access on Public security group
							before displaying 'new item' link -->
				<li <$menu_events$>>

					<$if false$><$include new_item_menu$><$endif$>

					<a class="menuLink" href="<$addNewItemLink$>">Add new item</a>
				</li>

				<$if UserIsAdmin$>

					<li <$menu_events$>>
						<a class="menuLink" href="<$irisProfilesLink$>">Configuration</a>
					</li>
					<li <$menu_events$>>
						<a class="menuLink" href="<$adminServerLink$>">Admin Server</a>
					</li>

				<$endif$>

			<$endif$>

			<$if IsLoggedIn$>
				<li <$menu_events$>>
					<a class="menuLink" href="<$HttpWebRoot$><$#env.Iris_helpFilePath$>">Help</a>
				</li>
			<$endif$>

		</ul>
	</div>

<@end@>


<!-- Appears in the header of Search&Filter template -->
<@dynamichtml iris_doc_listing_inline_header@>
	<div style="float: right; text-align: left; padding: 2px; margin-top: 3px; padding-right: 5px">
		<table cellpadding=0 cellspacing=0>
			<tr>

				<td valign=center>
					<input type=checkbox name="showCompleted" <$if showCompleted$>checked=true<$endif$> onclick="toggleShowCompleted(this)">
				</td>
				<td>
			 		Show completed
				</td>
				<td>
					<input type="submit" class="submitLink" value="Search" style="margin-left: 10px"/>
				</td>
			</tr>
		</table>
	</div>
<@end@>

<!--
		 DEPRECATED


		 Searches for an environment variable of the form 'x_y_z_required', where
		 x - workflow name
		 y - step name
		 z - doc type

		 If such a variable exists, it will consist of a comma-separated string
		 of field names which must be marked as 'required' in their given context.
		 This is saved to a var called requiredFields.

		 If no such variable exists, it will search for one in the form
		 'x_y_required' instead. If this is not found, requiredFields is left as null.
		 -->
<@dynamichtml iris_get_required_fields@>

	<$numMissingFields = 0$>

	<$if #active.dWfName and #active.dWfStepName$>

		<$trace("searching for " & dWfName & "_" & dWfStepName & "_" & dDocType & "_required")$>

		<$requiredFields = ""$>
		<$requiredFields = getValue("#active", dWfName & "_" & dWfStepName & "_" & dDocType & "_required")$>

		<$if not requiredFields$>
			<$requiredFields = getValue("#active", dWfName & "_" & dWfStepName & "_required")$>
		<$endif$>

	<$endif$>

<@end@>

<!-- Overriden from std_page.htm, this include is used to correctly display date fields.
			
		Any date fields marked as Iris short-date fields will be displayed used the short
		date pattern format.
 -->
<@dynamichtml compute_std_field_value@>

	<$include super.compute_std_field_value$>

	<$c='If a field name is listed in the variable Iris_shortDateFields,'$>
	<$c='its date value is displayed without hours/minutes.'$>
	
	<$if dType like 'Date'$>
		<$if strIndexOf(#active.Iris_shortDateFields,fieldName) > -1$>
			<$fieldValue = formatDateWithPattern(fieldValue,Iris_shortDatePattern)$>
		<$else$>
			<$fieldValue = formatDateWithPattern(fieldValue,Iris_longDatePattern)$>
		<$endif$>
	<$endif$>

<@end@>

<!-- 	Javascript functions used on the doc_approval template. Allows
			the user to adjust the relative size of the meta-data region
			and preview region.
			-->
<@dynamichtml resize_table_js@>

<script type="text/javascript">

	var resizing = false;
	var startX, diff, leftCellWidth;

	var containerTable = document.getElementById("container_table");
	var leftCell			 = document.getElementById("container_table_left_cell");
	var divs 					 = document.getElementsByTagName("div");

	$(document).ready( function() { initResize();});

	/* occurs on page load */
	function initResize() {
		// make sure the resize bar takes up the entire height of the table
		resizeBar = document.getElementById("resize_bar");
		resizeBar.style.height = containerTable.clientHeight + "px";
	}

	/* occurs after the user holds down the mouse button
	 * over the resize area */
	function startResize(e) {
		// store current mouse x-position
		startX = e.clientX;

		// hide the preview iframe so it does not constantly
 		// resize as the user drags the mouse
 		var contextFrame = document.getElementById("previewtable");
 		contextFrame.style.visibility = "hidden";

		resizing = true;

		containerTable.style.cursor = "w-resize";
		leftCellWidth = leftCell.clientWidth;

		for (i=0; i<divs.length; i++) {
			// find all panelbody divs, make them invisible and remove
			// their width setting so they can be freely resized
			if (divs[i].className == 'panelbody') {
				divs[i].style.visibility = "hidden"; divs[i].style.width = "";
			}
		}

		if (e.preventDefault != null) {
	 		e.preventDefault();
	 	}
		e.returnValue = false;

	}

	/* occurs after the user releases the mouse button */
	function stopResize(e) {

		if (resizing) {
	 		resizing = false;

			var contextFrame = document.getElementById("previewtable");
			contextFrame.style.visibility="";

			containerTable.style.cursor = "";

			for (i=0; i<divs.length; i++) {
		 		// find all panelbody divs, make them visible again and
		 		// adjust their width to match the client's chosen width
		 		if (divs[i].className == 'panelbody') {
					divs[i].style.width = (leftCell.clientWidth - 25) + "px";
					divs[i].style.visibility = "visible";
				}
			}

			diff=0;
			//window.status = "stopped!";
		}
	}

	/* occurs every time the mouse moves
 	*/
 	function resizeTable(e) {
 		// check if the mouse is moving during a resize operation
 		if (resizing) {
			//window.status = "resizing...";

			if (startX != e.clientX) {
				diff = startX - e.clientX;

				var newWidth = (leftCellWidth - diff);
		 		if (newWidth < <$panelWidth$>)
		 			newWidth = <$panelWidth$>; // minimum left-column width
		 		else if (newWidth > containerTable.clientWidth - 522 - 10)
		 			newWidth = containerTable.clientWidth - 522 - 10;

				leftCell.style.width = (newWidth) + "px";
			}

			if (e.preventDefault != null) {
				e.preventDefault();
			}
			e.returnValue = false;
		}
	}

</script>

<@end@>

<!-- ===============================
			WORKFLOW-RELATED includes
     =============================== -->

<@dynamichtml redirect_to_docapproval@>

	<$wfSet("wfJumpName", "GoToDocApproval")$>
	<$wfSet("wfJumpTargetStep","Level1@DocApproval")$>

<@end@>

<@dynamichtml redirect_to_process_payments@>

	<$wfSet("wfJumpName", "GoToProcessPayments")$>
	<$wfSet("wfJumpTargetStep","ProcessPayments@AccountsPayable")$>

<@end@>

<!-- This include will turn off default email notification and set the email subject -->
<@dynamichtml iris_email_subject@>

	<$wfSet("wfJumpEntryNotifyOff","1")$>

	<$wfMailSubject = dDocType & " '" & dDocName & "' requires your attention at workflow step '" & dWfStepName & "'"$>

<@end@>

<!-- 	This include is placed in the 'entry' event for any
			workflow steps which may get revisited following
			a document rejection.
			If the document arrived at the step due to a rejection,
			a custom notification email is sent rather than the
			default REJECT_MAIL template
			-->
<@dynamichtml iris_check_for_reject@>

	<$wfSet("wfJumpEntryNotifyOff","1")$>

	<$if wfAction like 'REJECT'$>

		<$wfMailSubject = dDocType & " '" & dDocName & "' has been rejected."$>
		<$wfNotify('gordanam','user','IRIS_MAIL')$>

	<$endif$>


<@end@>

<@dynamichtml iris_check_for_reject2@>

	<$wfSet("wfJumpEntryNotifyOff","1")$>

	<$if wfAction like 'REJECT'$>

		<$wfMailSubject = dDocType & " '" & dDocName & "' has been rejected."$>
		<$wfNotify('gordanam','user','IRIS_MAIL')$>

	<$endif$>


<@end@>

<@dynamichtml iris_styles@>

	<link rel="stylesheet" href="<$HttpWebRoot$>resources/iris/iris_styles.css" type="text/css">
<@end@>

<@dynamichtml iris_header@>

	<$isIris=1$>

	<$if not userAccessResolved$>
		<$include iris_resolve_user_access$>
	<$endif$>

	<!-- Script and CSS required to support pop-up menus -->
	<$include float_menu_header$>
	
        <script>
                function irisLogin() {
					var frm = document.forms['irisLogin'];
					<$if #active.IdcService$>
							frm.submit();
					<$else$>
							window.location.href=window.location.href+"idcplg?IdcService=LOGIN";
					<$endif$>
                }
        </script>

	<!-- Container div for all Iris header elements -->
	<div id="irisheader" class="header">

		<table cellpadding=0 cellspacing=0 border=0 width='100%'>

			<tr height='70'>
				<td width='259'>

					<!-- Left-floated div displaying logo graphic -->
					<div class="logo"></div>
					
				</td>
				<td>

					<!-- This div contains a Search button and input field, plus a 'logged-in' message -->

					<div style="position: absolute; right: 210px; height: 30px; top: 5px">

						<table width='300' align=left cellpadding=2>
							<tr>
								<td align=right>
										<$if IsLoggedIn$>
												<span style="font-size: 1em; z-index: 90">Logged in as <b><$UserName$></b>&nbsp;<$if #active.idcToken$><a target="_top" href="/ucm/logout.htm">[Logout]</a><$endif$></span>
										<$else$>

												<form name='irisLogin' method="post">
														<input type="hidden" name="IdcService" value="LOGIN">
														<$include add_idc_token_to_form$>
														<input type="hidden" name="RedirectUrl">

														You are not logged in.&nbsp;
																<a class=pneHeader href="javascript:irisLogin()">Login</a>
												</form>

										<$endif$>
								</td>
							</tr>

							<$if IsLoggedIn$>
								<tr>
									<td align=right>
										<$include iris_header_quicksearch$>
									</td>
								</tr>
							<$endif$>

						</table>

					</div>


						<$if Iris_companyLogo$>
							<$inc(Iris_companyLogo)$>
						<$else$>
							<!-- Display default ECS logo -->

							<!--[if lte IE 6]>
								<span style="position: absolute; right: 5px; width=195px; height=78px ; top: -5px;display:inline-block;filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src='<$HttpWebRoot$>images/iris/ECS_logo.png');">
									<div style="position: absolute; right: 5px; width: 195px; height: 78px ; filter:progid:DXImageTransform.Microsoft.Alpha(opacity=0);top: -5px; background-image: url(<$HttpWebRoot$>images/iris/ECS_logo.png);">
								</span>
							<![endif]-->

							<div style="position: absolute; right: 5px; width: 195px; height: 78px ; top: -5px; background-image: url(<$HttpWebRoot$>images/iris/ECS_logo.png);"></div>

						<$endif$>



				</td>
			</tr>
		</table>

	</div>

	<$include iris_menubar$>

<@end@>

<!-- Quicksearch form displayed in iris page header -->
<@dynamichtml iris_header_quicksearch@>

	<form action="<$HttpCgiPath$>" method="GET">
		<input type=hidden name=IdcService value="DOC_LISTING">
		<$include add_idc_token_to_form$>
		<input type=text name="qs">
		<input type=submit value='Quick Search'>
	</form>
	
<@end@>

<!-- footer at the bottom of every page. Contains ECS copyright notice, if this is an Iris page. -->
<@dynamichtml std_footer@>

	<$if isIris$>
		<div class="iris_footer">
			<div style="float:left">
				Copyright &copy; 2009 Extended Content Solutions Ltd.
			</div>
			<div style="float:right">
				<img src="<$HttpWebRoot$>images/iris/Oracle_Powered_By_Logo.gif" />
			</div>
		</div>
	<$else$>
		<$include super.std_footer$>
	<$endif$>

<@end@>

<!-- This is needed as the std_page_end definition in 11g is different to 10g. 
First we check if its an iris page, if it is then include the 10g code.  -->
<@dynamichtml std_page_end@>

	<$if isTrue(#active.isIris)$>
	<!--10g std_page_end idoc--> 
		<$if coreContentOnly$>
						</td>
				</tr>
				<tr height="1"><td>&nbsp;</td></tr>
				<tr height="1"><td>&nbsp;</td></tr>
				</table>

				<!-- Footer html -->
				<$include std_footer$>

				<!--Debug report-->
				<$include std_debug_report$>
		<$elseif useLayoutManager$>
				<script type="text/javascript">
						writeLayoutPageEnd();
				</script>
				<!--Debug report-->
				<$include std_debug_report$>
		<$else$>

				<!-- new page end -->
				<!--Main display area column end-->
				<!--End content table -->
				</td></tr></table>
				</td>
				</tr>
				<tr height="1"><td>&nbsp;</td></tr>
				<tr height="1"><td>&nbsp;</td></tr>
				</table>

				<!-- Footer html -->
				<$include std_footer$>

				<!--Debug report-->
				<$include std_debug_report$>

				<!-- End page table -->
				</td>
				</tr>
				</table>
		<$endif$>
	<$else$>
		<$include super.std_page_end$>
	<$endif$>

<@end@>






<!-- 	Displays an option list, containing a special list of document types taken
			from an environment variable. This is done to 'mask' the internal content
			types (e.g. LinkedNote, LinkedDoc) from the user and prevent them from
			selecting those types.
			-->
<@dynamichtml iris_doctype_list@>

<tr>
			<td width='40%'><span class=infoLabel>Type:</span></td>
			<td width='60%'>

	<$typeList = getValue("#env", "Iris_doctypes")$>

	<$if not typeList$>
		No default type list.
	<$else$>

		<$rsMakeFromString('DocTypeList', typeList, 'type')$>

		<select name=dDocType>

			<$loop DocTypeList$><$DocTypeList.type$>
				<option value='<$DocTypeList.type$>'><$DocTypeList.type$></option>
			<$endloop$>

		</select>

	<$endif$>
</td>
</tr>
<@end@>


<@dynamichtml iris_account_list@>

<select name="dDocAccount" onChange="getAliasMembers(this.value)" class="input_option_field" <$if tabIndex$>tabindex=<$tabIndex$><$endif$>>

	<$executeService("IRIS_GET_USER_WRITE_ACCOUNTS")$>

	<option value=""></option>

	<$loop rsWriteAccounts$>

		<$trace("found a write account: " & rsWriteAccounts.dAttributeName)$>

		<$if rsWriteAccounts.dAttributeName like '#all'$>
			<$showAllAccounts="Y"$>
			<$break$>
		<$endif$>

	<$endloop$>

	<$if showAllAccounts$>

		<$executeService("IRIS_GET_ACCOUNTS")$>

		<$loop rsAccounts$>
			<option value="<$ACCOUNT$>" <$if #active.dDocAccount like ACCOUNT$>SELECTED<$endif$>><$ACCOUNT$></option>
		<$endloop$>

	<$else$>

		<$loop rsWriteAccounts$>

			<$if not (rsWriteAccounts.dAttributeName like '#none')$>

				<$trace("checking '" & dDocAccount & "' against '" & rsWriteAccounts.dAttributeName & "'")$>

				<option value="<$rsWriteAccounts.dAttributeName$>" <$if #active.dDocAccount like rsWriteAccounts.dAttributeName$>SELECTED<$endif$>><$rsWriteAccounts.dAttributeName$></option>
			<$endif$>

		<$endloop$>

	<$endif$>

</select>

<@end@>

<@dynamichtml iris_checkin_metadata@>

	<tr>
		<td><span class="infoLabel">Account:</span></td>
		<td><$include iris_account_list$></td>
	</tr>

	<$if false$>
		<tr>
			<td><span class="infoLabel">ApproverX:</span></td>
			<td><$include iris_approver_list$></td>
		</tr>
	<$endif$>

	<tr><td><br></td></tr>

	<tr>
		<td><span class=infoLabel>Title:</span></td>
		<td><input type=text name=dDocTitle style="width: 100%"></td>
	</tr>

<@end@>

<@dynamichtml iris_approver_list@>

<select name="xApprover" class="input_option_field" tabindex=<$tabIndex$>>
	<$tabIndex = tabIndex + 1$>

	<option value=""></option>

	<$if #active.dDocAccount$>

		<$aliasName = dDocAccount$>

		<$slash = 0$>

		<$loopwhile slash >= 0$>
			<$slash = strIndexOf(aliasName,"/")$>
			<$aliasName = strReplace(aliasName,"/","_")$>
		<$endloop$>

		<$executeService("IRIS_GET_ALIAS_MEMBERS")$>

		<$trace("value of xApprover = " & #active.xApprover)$>

		<$loop rsAliasMembers$>

			<$trace("checking " & #active.xApprover & " against " & dUserName & "..")$>

			<option value="<$dUserName$>" <$if strEqualsIgnoreCase(#active.xApprover,dUserName)$>SELECTED<$endif$>><$dUserName$></option>
		<$endloop$>

	<$endif$>

</select>

<@end@>

<@dynamichtml iris_currency_list@>

	<select name="xCurrency">

		<option value=""></option>

		<!--getViewValuesResultSet("CurrencyList","","")-->
		<$dOptionListKey="CurrencyList"$>
		<$executeService("ECS_GETOPTIONLISTVALUES")$>
				<$loop SchemaData$>
					<$key = getValue("SchemaData", "dOption")$>

					<option value="<$key$>"><$key$></option>
				<$endloop$>
	</select>

<@end@>

<!-- Popup menu that is displayed when the 'Add new item' link in the
		header is clicked -->
<@dynamichtml new_item_menu@>

	<$menu_id 						="new_item_menu"$>
	<$menu_style_prefix		="top"$>
	<$menu_button_text		="Add new item"$>
	<$menu_justify				="bottom left"$>
	<$menu_button_attr		="style='cursor: hand; cursor: pointer'"$>

	<$actionMenu_CustomInclude="addNewItem_menu"$>

	<$include action_menu$>

<@end@>

<@dynamichtml addNewItem_menu@>

	<$typeList = getValue("#env", "Iris_doctypes")$>
	<$rsMakeFromString('DocTypeList', typeList, 'type')$>

	<$loop DocTypeList$>

		<tr>
			<td class="<$menu_style_prefix$>PopupLinkMenu" onClick="javascrip:getItemType(<$DocTypeList.type$>);" nowrap >
				<a class="<$menu_style_prefix$>PopupLink" href="<$HttpCgiPath$>?IdcService=IRIS_NEW_ITEM<$include add_idc_token_to_url$>"><$DocTypeList.type$></a>
			</td>
		</tr>

	<$endloop$>

<@end@>

<@dynamichtml iris_linked_audit_entries_table@>

	<$if #active.Iris_AllowNoteDeletions and userCanDelete$>
		<$showNoteActions=1$>
	<$endif$>

	<$auditRef=dDocName$>
	<$auditApp="IRIS"$>
	<$executeService("ECS_GET_AUDIT_ENTRIES_BY_REF")$>

	<table class="IssueBlock" cellspacing="1" cellpadding="4" border="0" bgcolor="#f6f6f4">
		<tr height=40 >
			<th class="sfHeader_start">Date</th>
			<th class="sfHeader_mid">Description</th>
			<th class="sfHeader_end">User</th>

			<$if showNoteActions$>
				<th></th>
			<$endif$>
		</tr>

		<$loop rsAuditEntries$>
			<tr class="resultrow_linked">
				<td class="sfResultCell"><$lDate$></td>
				<td class="sfResultCell">
					<$include iris_compute_audit_text$>
					<$auditText$>
				</td>
				<td class="sfResultCell">
				
					<$dDocAuthor = #active.lUser$>
					<$include AUTHOR_CustomIncludeScript$>
				</td>

				<$if showNoteActions$>
					<td class="sfResultCell"></td>
				<$endif$>

			</tr>
		<$endloop$>

	</table>

<@end@>

<!-- Standard thumbnail display -->
<@dynamichtml iris_thumbnail_std@>

  <$useThumbnails="1"$>

  <$ImageWidth=Iris_thumbWidth$>
  <$ImageHeight=Iris_thumbHeight$>

	<div class="iris_thumb_container">
		<$previewUrl = HttpCgiPath & "?IdcService=IRIS_THUMB_PREVIEW&dDocName=" & dDocName & "&sel=" & sel&inc("add_idc_token_to_url")$>
		<$if SR$>
			<$previewUrl = previewUrl & "&StartRow=" & SR$>
		<$endif$>

  	<a href="<$previewUrl$>" <$if openSearchResultInNewWindow$>target="_blank"<$endif$>><$include searchapi_result_table_content_begin_img$></a>

		<div class="iris_thumb_details">
			<$if strLength(dDocTitle) > 20$>
				<$picTitle=strSubstring(dDocTitle,0,17) & "..."$>
			<$else$>
				<$picTitle=dDocTitle$>
			<$endif$>

			<a href="<$previewUrl$>" title="<$dDocTitle$>" ><$picTitle$></a>
		</div>

	</div>
<@end@>

<!-- Displays nicer, larger thumbnails. Requires DAM component -->
<@dynamichtml iris_thumbnail_dam@>

	<$if xDamConversionType$>
		<$c="RENDITION_INFO needed to get rendition size. Then div class for portrait of landscape thumnail can be set"$>
		<$dDocName=SearchResults.dDocName$>
		<$dID=SearchResults.dID$>
		<$executeService("RENDITION_INFO")$>
		<$exec rsFindRowPrimary("manifest","SearchresultsThumbnail")$>
		<div class="iris_thumb_container">


			<div class="iris_thumb<$if extRenditionWidth > extRenditionHeight$> landscape<$endif$>" onclick="previewThumb('<$dDocName$>');">
				<$previewUrl = HttpCgiPath & "?IdcService=IRIS_THUMB_PREVIEW&dDocName=" & dDocName & "&sel=" & sel&inc("add_idc_token_to_url")$>
				<$if SR$>
					<$previewUrl = previewUrl & "&StartRow=" & SR$>
				<$endif$>

				<img src="<$HttpRelativeCgiRoot$>idcplg?IdcService=GET_FILE<$include add_idc_token_to_url$>&dID=<$SearchResults.dID$>&Rendition=SearchresultsThumbnail&RevisionSelectionMethod=Specific&noSaveAs=1"  border="0" alt="<$SearchResults.xIB_alt_tag$>" />
			</div>

			<div class="iris_thumb_details">
				<$if strLength(dDocTitle) > 25$>
					<$picTitle=strSubstring(dDocTitle,0,22) & "..."$>
				<$else$>
					<$picTitle=dDocTitle$>
				<$endif$>

				<a href="<$previewUrl$>" title="<$dDocTitle$>" ><$picTitle$></a>
			</div>

			<$if false$>

				<div class="imageDetails">
					<table border="0" cellpadding="10" cellspacing="5" width="95%" valign="top">
						<tr><td align=right><b>Select:</b></td>
								<td><input type="checkbox" name="attachpermission<$i$>" value="<$SearchResults.dDocName$>"<$isChecked$>></td>
						</tr>
						<tr><td align=right valign="top"><b>Title:</b></td>
								<td><a href="<$ssNodeLink(ImageBank_Info_Page)$>?dID=<$SearchResults.dID$>&dDocName=<$SearchResults.dDocName$>"><$eval(ssRowLink)$></a></td>
						</tr>
					<$if strLength(eval(ssRowLink)) lt 15$><tr><td>&nbsp;</td></td><$endif$>
						<tr><td align=right><b>Category:</b></td>
								<td><$xIB_category$>&nbsp;</td>
						</tr>
						<tr><td align=right><b>Expires:</b></td>
					<td><$if SearchResults.dOutDate$><$dOutDate$><$else$>None<$endif$></td></tr>

					<ul>
						<li><tr><td colspan=2 align=center><a href="<$ssNodeLink(ImageBank_Info_Page)$>?dID=<$SearchResults.dID$>&dDocName=<$SearchResults.dDocName$>">view details</a></td></tr></li>
							<$attachField=#env.attachIdMetaField$>
					    <$if not strEquals(eval("<$SearchResults." & attachField &"$>"),"")$>
								<li><tr><td colspan=2 align=center><a href="<$ssNodeLink(ImageBank_Info_Page)$>?dID=<$SearchResults.dID$>&dDocName=<$SearchResults.dDocName$>&viewPermFormMain=1" title="view permissions">view permissions</a></td></tr></li>
							<$else$>
								<li><tr><td colspan=2 align=center>&nbsp;</td></tr></li>
							<$endif$>
						<!--<$if userHasRole(#env.imagebankAdminRole)$>
						<li><tr><td colspan=2 align=center><a href="<$ssNodeLink(ImageBank_Info_Page)$>?IdcService=IMAGEBANK_GET_UPDATE_FORM&dID=<$SearchResults.dID$>&dDocName=<$SearchResults.dDocName$>&isImagebank=1">update metadata</a></td></tr></li>
						<$endif$>-->
					</ul>

					</table>
				</div>

			<$endif$>

		</div>
	<$endif$>
<@end@>

<!-- This include contains 2 stock AJAX functions:
			setupRequest()   -constructs an xmlHttp object and assigns
												it to the 'request' variable
			handleResponse() -handles the response of the above object

		 To make the best use of these functions, you should write your
		 own method 'handleReadyResponse(request)', which will be called
		 when the AJAX request completes.
		 -->
<@dynamichtml iris_ajax_js@>

<script type="text/javascript">

	 var request = null;

   function setupRequest() {

      try {
				request = new ActiveXObject("Msxml2.XMLHTTP");
			} catch(e) {
				try {
					request = new ActiveXObject("Microsoft.XMLHTTP");
				} catch(oc) {
					request = null;
				}
			}

		if(!request && typeof XMLHttpRequest != "undefined") {
			request = new XMLHttpRequest();
		}
   }

   function handleResponse() {

      if (request.readyState == 4) {

         if (request.status == 200) {

						handleReadyResponse(request);

         } else if (request.status == 404) {
            alert("Request URL does not exist");
         } else {
            alert("AJAX Error: status code is " + request.status);
         }

      }
   	}

</script>

<@end@>

<@dynamichtml group_actions_form@>
	<form action="<$HttpCgiPath$>" name="group_actions_form" method="GET" style="display: none">

		<input type=hidden name="IdcService" value="DOC_APPROVAL">
		<$include add_idc_token_to_form$>
		<!-- These two form fields are filled using javascript calls -->
		<input type=hidden id="selected" name="sel">
		<input type=hidden name="action">

	</form>
<@end@>

<@dynamichtml iris_new_note_panel@>

	<script type="text/javascript">
	
		// Used when submitting comments/notes. Checks for the
		// presence of a comment before submitting it
		function checkForComment()
		{
			if (document.getElementById("commentbox").value == "") {
				alert("You must enter a comment in the textbox.");
			} else {
				var frm = document.forms['commentform'];
				frm.submit();
				
				<$if viaPopUp$>
					var myParent = window.parent;
				<$else$>
					var myParent = window.opener;
					
					if (myParent) {
						myParent.location.reload(true);
						window.close();
					}
				<$endif$>
				
			}
		}
		
		function cancel()
		{
			<$if viaPopUp$>
				window.parent.closePopup();
			<$else$>	
				window.close();
			<$endif$>
		}
				
	</script>

	<$include orangeContainer_top$>

		<div class='panelheader' style="padding: 3px; border-bottom: 1px solid; margin-right: 3px">
			<$if bundleRef$>
				<b>Add new note to bundle <span class='docname'><$bundleRef$></span></b>
			<$else$>
				<b>Add new note to <span class='docname'><$dDocName$></span></b>
			<$endif$>
		</div>
		
		<div>
			
			<$if noteAdded$>
				
				<!-- Display confirmation of new note -->
				<table width="100%" cellpadding=0 cellspacing=2>
				
					<tr>
						<td align="center">
							<br/>
							Your note has been added.
							<br/>
							<br/>
							<$if viaPopUp$>
								<input type=button value=OK style="width: 120; display: block; margin: 2px;" onClick="window.parent.location.reload(true);">
							<$endif$>
						</td>
					</tr>
					
				</table>
			
			<$else$>
				
				<form name="actionform" id="commentform" method="get" action="<$HttpCgiPath$>">
					<!-- New table-based auditing submission form -->
					
					<input type=hidden name="IdcService" value="ECS_ADD_AUDIT_ENTRY">
					<$include add_idc_token_to_form$>
					<input type=hidden name="doAudit" value="1">
					<input type=hidden name="lApp" value="IRIS" />
					<input type=hidden name="lAction" value="USER-NOTE" />
					<input type=hidden name="lRef" value="<$if parentId$><$parentId$><$else$><$dDocName$><$endif$>" />
					
					<input type=hidden name="lParam1" value="<$if selDocName$><$selDocName$><$endif$>" />
					
					<$if bundleRef$>
						<input type=hidden name="lTitle" value="User note for bundle: <$bundleRef$>" />
					<$else$>
						<input type=hidden name="lTitle" value="User note for item: <$dDocName$>" />
					<$endif$>
					
					<input type=hidden name="lUser" value="<$dUser$>" />
					
					<input type="hidden" name="RedirectUrl" value="<$HttpCgiPath$>?IdcService=IRIS_NEW_NOTE<$include add_idc_token_to_url$>&dDocName=<$#local.dDocName$><$if bundleRef$>&bundleRef=<$bundleRef$><$endif$><$if viaPopUp$>&viaPopUp=1<$endif$>&noteAdded=1" />
			
					<br/>
					
					<table width="100%" cellpadding=0 cellspacing=2>
							
						<tr>
							<td>
								<!-- Comments text area -->
								<textarea style="border: thin inset; height: 5em; width: 98%;" id="commentbox" 
								 name="lMessage" ></textarea>
							</td>
						</tr>
						<tr>
							<td align="center">
								<input type=button value=Submit style="width: 120; margin: 2px;" onClick="checkForComment();">
								<input type=button value=Cancel style="width: 120; margin: 2px;" onClick="cancel();">
							</td>
						</tr>
					</table>
								
				</form>	
				
			<$endif$>
				
		</div>
		
	<$include orangeContainer_bottom$>

<@end@>

<!-- JavaScript hook into the pop-up toggle function.
		 Used to toggle the display of the context frame. -->
<@dynamichtml ecs_popup_hide_elements_extra@>
	
	<script type="text/javascript">
	
		function doHideElementsExtra(hideDivElements) {
			// cFrame is mapped to the iframe window object.
			// cFrameObj is mapped to the iframe object
			
			/* Hides/shows the content frame (Iris) */
			var cFrame = frames['contextFrame'];
			
			if (cFrame) {
				var cFrameDoc;
				try {
					if (cFrame.contentWindow)
						cFrameDoc = cFrame.contentWindow;
				
					if (!cFrameDoc)
						cFrameDoc = cFrame.contentDocument;
				} catch (e) {}
		
				if (typeof(cFrameDoc) != "undefined" && cFrameDoc.document)
					cFrameDoc = cFrameDoc.document;
				
				// inner frame used on batch document implementations
				if (typeof(cFrameDoc) != "undefined")
					var innerFrame = cFrameDoc.getElementById('contentFrame');
				
				if (innerFrame)
					cFrame = innerFrame;
				
				// Check if the iframe holds a PDF document. If it does, it must be
				// hidden/displayed.
				var toggleFrame = false;
				
				try {
					if (cFrame.location.href.search(/.pdf/i) > -1) {
						toggleFrame = true;
					}
				} catch (e) {
					toggleFrame = true;
				}
				
				if (toggleFrame) {
					var cFrameObj = document.getElementById("contextFrame");
					
					//alert("cFrame = " + cFrame + ", cFramObj = " + cFrameObj);
					
					if (cFrameObj.style.visibility && (cFrameObj.style.visibility == 'hidden')) {
						// PDF item must be reloaded so it is displayed correctly.
						//cFrame.location.reload();
						//cFrameObj.style.visibility = 'visible';
					} else {
						//cFrameObj.style.visibility = 'hidden';
						hideDivElements.push(cFrameObj);
					}
				}
				
			}
		}

	</script>
		
<@end@>

<@dynamichtml iris_paginator_styles@>

	<style type="text/css">

		/* Styles for browse icons */

			.pn_large {
				padding: 0.3em 0.1em 0.3em 0.1em;
				margin: 2px 10px 2px 10px;
			}

			.pn_icon_rest {
				height: 15px;
				display: inline;
				border: 1px solid #999999;
				background-color: #F6F6DD;
				margin: 2px;
				text-align: center;
				cursor: pointer;
			}

			.pn_icon_inactive {
				height: 15px;
				border: 1px solid #BBBBBB;
				background-color: #DDDDDD;
				color: #999999;
				margin: 2px;
				text-align: center;
				display: inline;
			}

			.pn_icon_hover {
				height: 15px;
				display: inline;
				margin: 2px;
				text-align: center;
				cursor: pointer;
				border: 1px solid #000000;
				background-color: #DADAF0;
			}

			.pn_icon_sel {
				height: 15px;
				display: inline;
				border: 1px solid #000000;
				font-weight: bold;
				color: #FFFFFF;
				background-color: #FF9933; /*#9BDF30;  #DADAF0; */
				margin: 2px;
				text-align: center;
			}

			.pn_small {
				padding: 0.3em 0.5em 0.3em 0.5em;
			}

			.browse_ellipsis {
				display: inline;
				border: none;
				margin: 2px 0px 2px 0px;
				text-align: center;
				padding: 0.3em 0.0em 0.1em 0.0em;
			}

			#browse_panel a {
				text-decoration: none;
			}

	</style>

<@end@>

<!-- 	Panel displayed via pop-up if workflow action validation fails.
     
			The panel gives a detailed breakdown of why the validation failed.
			-->
<@dynamichtml iris_wf_validation_report_panel@>

	<script type="text/javascript">
		
		// Selects the given batch item.
		function selThumb(docName) {
			window.parent.closePopup();
			window.parent.selThumbByDocName(docName);
		}
		
	</script>

	<$include orangeContainer_top$>

		<div class='panelheader error_icon' style="padding: 3px 3px 3px 20px; border-bottom: 1px solid; margin-right: 3px;">
		
			<$if validationFailed$>
				<b>Errors during validation</b>
			<$else$>
				<b>Validation successful</b>
			<$endif$>
			
		</div>
		
		<div>
			
			<$if validationPassed$>
				
				<!-- Display confirmation of successful validation -->
				<table width="100%" cellpadding=0 cellspacing=2>
				
					<tr>
						<td align="center">
							<br/>
							The document <$dDocName$> was validated successfully.
							<br/>
							<br/>
							<input type=button value=OK style="width: 120; display: block; margin: 2px;" onClick="window.parent.location.reload(true);">
						</td>
					</tr>
					
				</table>
			
			<$else$>
					
					<!-- Display validation errors -->
					<br/>
					
					<table width="100%" cellpadding=0 cellspacing=2>
							
						<tr>
							<td>
								<p>
									You cannot perform the required workflow action at this time. Please fix the errors listed below and try again.
								</p>
								
								<$if requiredBatchItemFieldsMissing$>
									<b>Required fields</b> were missing on <$rsBatchItemsMissingReqFields.#numRows$> documents:
									
									<ul>
										<$loop rsBatchItemsMissingReqFields$>
											<li>
												<a href="javascript:selThumb('<$rsBatchItemsMissingReqFields.docName$>');">
													<$rsBatchItemsMissingReqFields.docName$>
												</a>
											</li>
										<$endloop$>
									</ul>
									
								<$endif$>
								
							</td>
						</tr>
						<tr>
							<td align="center">
								<input type=button value="OK" style="width: 120; margin: 2px;" onClick="window.parent.closePopup();">
							</td>
						</tr>
						
					</table>
								
				</form>	
				
			<$endif$>
				
		</div>
		
	<$include orangeContainer_bottom$>

<@end@>

<@dynamichtml iris_linked_doc_listing_pre@>

	<$include iris_linked_docs_js$>

	<$isDocSearchAndFilter = 1$>

	<$custTableAttrs="class='IssueBlock' cellpadding='4' cellspacing='1' width='100%' border='0' bgcolor='#F6F6F4'"$>
  <$custRowAttrs="class='resultrow_linked'"$>
  <$custColumnHeaderEval="<$if columnCounter==0$> class='sfHeader_start' <$elseif columnCounter >= (totalColumns-1)$> class='sfHeader_end' <$else$> class='sfHeader_mid' <$endif$> height=40 cellpadding=1"$>

  <$hideLineBreak="1"$>
  <$displayColumnHeaderSortOptions="N"$>

  <$nodeFilterFieldWidth="1,64,15,15,5"$>
  <$nodeFilterFieldNames="SOMETHING,FILE,DATE,AUTHOR,DOCACTIONS"$>

  <$overrideFirstColumn="Y"$>
	<$inlineHeaderInclude=""$>

  <$nodeSearchQuery = "(xParentId <matches> `" & dDocName & "`) <and> (dDocType <matches> `LinkedDoc`)"$>

  <$SF_DISPLAYADVSEARCHLINK=""$>

  <$displayCountSummary="N"$>
  <$displayPagingOptions="N"$>
  <$displaySearchButton="N"$>
  <$displayFilterOptions="N"$>
  <$useAdvancedSearch="N"$>
  <$advSearchFieldList=""$>
	<$allowContentTypeLinkOverride="Y"$>
	<$hideInfoLink="Y"$>

  <$FILE_CustomIncludeScript="FILE_CustomIncludeScript"$>
  <$AUTHOR_CustomIncludeScript="AUTHOR_CustomIncludeScript"$>
  <$DOCACTIONS_CustomIncludeScript="DOCACTIONS_CustomIncludeScript"$>

	<$REF_CustomIncludeScript="CCLA_CHILD_DOC_REF_CustomIncludeScript"$>

  <$linkedDocType = "LinkedDoc"$>
  <$customSearchScript = "performLinkedItemSearch"$>

	<!-- 	Ensure user has read access on Public security group
		  	before displaying 'add new doc' form -->
	<$if userCanWrite$>
		<$include iris_add_linked_doc_header$>
	<$endif$>

<@end@>

<!-- 	Extra hidden fields which will be included on the core Iris Document 
		metadata form. -->
<@dynamichtml iris_document_extra_hidden_fields@>
	
	<input type="hidden" name="isDualIndexUpdate" value="1" />
	
<@end@>

</body></html>